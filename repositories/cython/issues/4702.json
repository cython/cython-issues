{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "\r\n**Describe the bug**\r\nAfter updating to VS Community 2022 and 0.29.28, a basic fused type compilation doesn't go through for reasons I can't understand.\r\n\r\n**To Reproduce**\r\nCode to reproduce the behaviour:\r\n```cython\r\ncimport cython\r\nimport numpy as np\r\n# cimport numpy as cnp\r\n# cnp.import_array()\r\n\r\nctypedef fused lapack_t:\r\n    float\r\n    double\r\n    (float complex)\r\n    (double complex)\r\n\r\ncdef int func(lapack_t a):\r\n    if lapack_t is float:\r\n        return 1\r\n    else:\r\n        return 0\r\n\r\nfunc(np.float32(3))\r\n```\r\n\r\nThis leads to the following behavior\r\n\r\n```bash\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\n    if lapack_t is float:\r\n        return 1\r\n    else:\r\n        return 0\r\n\r\nfunc(np.float32(3))\r\n   ^\r\n------------------------------------------------------------\r\n\r\nC:\\Users\\....\\.ipython\\cython\\_cython_magic_fdfd1e1fd238c58c7008f20cba69a995.pyx:18:4: ambiguous overloaded method\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\n    if lapack_t is float:\r\n        return 1\r\n    else:\r\n        return 0\r\n\r\nfunc(np.float32(3))\r\n^\r\n------------------------------------------------------------\r\n\r\nC:\\Users\\.....\\.ipython\\cython\\_cython_magic_fdfd1e1fd238c58c7008f20cba69a995.pyx:18:0: Invalid use of fused types, type cannot be specialized\r\n```\r\n\r\nIf I change the func type to `def` from `cdef` then I get `TypeError: No matching signature found` which is still unexpected but at least it shows the mismatch between `np.float32` single precision and `float` which we did not have before. I am wondering if I have blinded myself or alternatively something has changed recently in either MSVC or NumPy dtypes.\r\n\r\nAlso if I force the function type selection with `func[float](np.float32(3))` then no problem detected.\r\n\r\n**Expected behavior**\r\nThis should return 1 as it did with previous behavior. \r\n\r\n**Environment (please complete the following information):**\r\n - OS: Windows 10, 21H2, 19044.1620\r\n - Python version 3.9.6 (tags/v3.9.6:db3ff76, Jun 28 2021, 15:26:21) [MSC v.1929 64 bit (AMD64)]\r\n - Cython version 0.29.28\r\n\r\n**Additional context**\r\nThis is basically the standard machinery we have been using in SciPy for a quite long time which tells me that it is my problem and my system. But I can't find a reason why dtypes became incompatible.\r\n",
    "closed_at": "2022-03-28T16:26:06Z",
    "comment_data": [
        {
            "author_association": "COLLABORATOR",
            "body": "I went back a little way (0.28 ish) and couldn't find a recent release where this works (so I don't think it's a regression)...\r\n\r\n`np.float32` is basically just a Python object that Cython knows nothing about so I'm unsurprised that it can't resolve the fused function. We both know that it internally holds a C `float` but Cython doesn't, and especially not at compile-time (`cdef` calls are resolved at compile-time).\r\n\r\nI suspect you meant to use the C type definition:\r\n\r\n```\r\nfunc(<cnp.float32_t>(3))\r\n```\r\n\r\nThis works for me when I test it (it's just casting 3 to a C type).\r\n\r\nI'll close this issue because I don't think it's a bug. Let me know if you disagree (for example, you have some existing code that doesn't work). If you want to go into the detail about my answer, the cython-users mailing list would probably be the best place to do it.",
            "created_at": "2022-03-28T16:26:06Z",
            "html_url": "https://github.com/cython/cython/issues/4702#issuecomment-1080861190",
            "id": 1080861190,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4702",
            "node_id": "IC_kwDOABDGAc5AbKIG",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1080861190/reactions"
            },
            "updated_at": "2022-03-28T16:26:40Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1080861190",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "You are probably right. I just can't figure out how we made it working before. For example see \r\n\r\nhttps://github.com/scipy/scipy/blob/main/scipy/linalg/_decomp_update.pyx.in \r\n\r\nhttps://github.com/scipy/scipy/blob/main/scipy/linalg/_matfuncs_expm.pyx.in\r\n\r\nor a few other PRs I have authored but I'll dig deeper until I can catch a culprit or something that looks like it.",
            "created_at": "2022-03-28T17:37:20Z",
            "html_url": "https://github.com/cython/cython/issues/4702#issuecomment-1080951249",
            "id": 1080951249,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4702",
            "node_id": "IC_kwDOABDGAc5AbgHR",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1080951249/reactions"
            },
            "updated_at": "2022-03-28T17:39:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1080951249",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1303842?v=4",
                "events_url": "https://api.github.com/users/ilayn/events{/privacy}",
                "followers_url": "https://api.github.com/users/ilayn/followers",
                "following_url": "https://api.github.com/users/ilayn/following{/other_user}",
                "gists_url": "https://api.github.com/users/ilayn/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ilayn",
                "id": 1303842,
                "login": "ilayn",
                "node_id": "MDQ6VXNlcjEzMDM4NDI=",
                "organizations_url": "https://api.github.com/users/ilayn/orgs",
                "received_events_url": "https://api.github.com/users/ilayn/received_events",
                "repos_url": "https://api.github.com/users/ilayn/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ilayn/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ilayn/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ilayn"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4702/comments",
    "created_at": "2022-03-28T15:14:36Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2022-03-28T16:26:06Z",
            "event": "closed",
            "id": 6319990435,
            "node_id": "CE_lADOABDGAc5GjDCBzwAAAAF4s2aj",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6319990435"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2022-03-28T16:26:17Z",
            "event": "labeled",
            "id": 6319991789,
            "label": {
                "color": "444444",
                "name": "R: worksforme"
            },
            "node_id": "LE_lADOABDGAc5GjDCBzwAAAAF4s2vt",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6319991789"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4702/events",
    "html_url": "https://github.com/cython/cython/issues/4702",
    "id": 1183592577,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425556354,
            "name": "R: worksforme",
            "node_id": "MDU6TGFiZWw0MjU1NTYzNTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/R:%20worksforme"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4702/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5GjDCB",
    "number": 4702,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4702/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4702/timeline",
    "title": "[BUG] float and numpy.float32 datatypes are not treated the same as previous version",
    "updated_at": "2022-03-28T17:39:21Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4702",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1303842?v=4",
        "events_url": "https://api.github.com/users/ilayn/events{/privacy}",
        "followers_url": "https://api.github.com/users/ilayn/followers",
        "following_url": "https://api.github.com/users/ilayn/following{/other_user}",
        "gists_url": "https://api.github.com/users/ilayn/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ilayn",
        "id": 1303842,
        "login": "ilayn",
        "node_id": "MDQ6VXNlcjEzMDM4NDI=",
        "organizations_url": "https://api.github.com/users/ilayn/orgs",
        "received_events_url": "https://api.github.com/users/ilayn/received_events",
        "repos_url": "https://api.github.com/users/ilayn/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ilayn/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ilayn/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ilayn"
    }
}