{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "With Cython 0.28.1. Given the following method:\r\n```python\r\n    @staticmethod\r\n    def from_buffers(DataType type, length, buffers, null_count=-1, offset=0):\r\n        cdef:\r\n            Buffer buf\r\n            vector[shared_ptr[CBuffer]] c_buffers\r\n            shared_ptr[CArrayData] ad\r\n\r\n        for buf in buffers:\r\n            c_buffers.push_back(buf.buffer)\r\n        # [snip rest of method]\r\n```\r\n\r\nCython generates the following C snippet for the `for` loop:\r\n```c++\r\n  struct __pyx_obj_7pyarrow_3lib_Buffer *__pyx_v_buf = 0;\r\n  /* ... */\r\n  for (;;) {\r\n  /* ... */\r\n    if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_ptype_7pyarrow_3lib_Buffer))))) __PYX_ERR(2, 403, __pyx_L1_error)\r\n    __Pyx_XDECREF_SET(__pyx_v_buf, ((struct __pyx_obj_7pyarrow_3lib_Buffer *)__pyx_t_4));\r\n    __pyx_t_4 = 0;\r\n\r\n    /* \"../../pyarrow/array.pxi\":404\r\n * \r\n *         for buf in buffers:\r\n *             c_buffers.push_back(buf.buffer)             # <<<<<<<<<<<<<<\r\n *         ad = CArrayData.Make(type.sp_type, length, c_buffers,\r\n *                              null_count, offset)\r\n */\r\n    try {\r\n      __pyx_v_c_buffers.push_back(__pyx_v_buf->buffer);\r\n    } catch(...) {\r\n      __Pyx_CppExn2PyErr();\r\n      __PYX_ERR(2, 404, __pyx_L1_error)\r\n    }\r\n```\r\n\r\nAs you see `Py_None` is allowed and then blindly casted to a `struct __pyx_obj_7pyarrow_3lib_Buffer *`, from which the `buffer` member is then dereferenced.\r\n\r\nI would expect Cython to either refuse None here (letting me implement the required logic myself) or check for None when dereferencing an attribute (and raise an exception perhaps?).",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I agree that this can be surprising, but it's been like that ... maybe forever? I'm pretty sure that behaviour is documented somewhere.\r\n\r\nThe fact that None is allowed is ok, since all object typed variables necessarily support a None assignment. The cast is required afterwards to support the assignment of PyObject* to the cdef class typed variable.\r\n\r\nThe thing then is that accessing fields of cdef classes does not check for None, and that's for two reasons: performance, and to make them accessible inside of nogil sections. There is a somewhat hand-waving argument that accessing a cdef class field is an unsafe C operation and not a Python protocol, a bit of \"practicality beats purity\".\r\n\r\nI could imagine issuing an invisible warning for this, but a) that means that people still wouldn't normally see it, and b) if they increase the warning level, they'd probably be swamped with false positives, unless we implement very good None check tracing, which we currently do not do at all in the control flow analysis (we leave that to the C compiler, which does a very good job eliminating our generated None checks).\r\n\r\nI'm leaving this open as it might actually be worth revisiting the impact of this with recent compilers and CPUs, although that doesn't resolve the problem of breaking existing working (and correct) code that does not support raising an exception from a given function.",
            "created_at": "2018-03-21T19:24:52Z",
            "html_url": "https://github.com/cython/cython/issues/2170#issuecomment-375066342",
            "id": 375066342,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2170",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM3NTA2NjM0Mg==",
            "performed_via_github_app": null,
            "updated_at": "2018-03-21T19:24:52Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/375066342",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I see the \"nonecheck\" compiler directive which looks like a good enough solution for us.",
            "created_at": "2021-03-17T13:02:00Z",
            "html_url": "https://github.com/cython/cython/issues/2170#issuecomment-801062875",
            "id": 801062875,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2170",
            "node_id": "MDEyOklzc3VlQ29tbWVudDgwMTA2Mjg3NQ==",
            "performed_via_github_app": null,
            "updated_at": "2021-03-17T13:02:00Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/801062875",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1721820?v=4",
                "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
                "followers_url": "https://api.github.com/users/pitrou/followers",
                "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
                "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pitrou",
                "id": 1721820,
                "login": "pitrou",
                "node_id": "MDQ6VXNlcjE3MjE4MjA=",
                "organizations_url": "https://api.github.com/users/pitrou/orgs",
                "received_events_url": "https://api.github.com/users/pitrou/received_events",
                "repos_url": "https://api.github.com/users/pitrou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pitrou"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2170/comments",
    "created_at": "2018-03-21T14:25:40Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-03-23T08:59:30Z",
            "event": "labeled",
            "id": 1537378357,
            "label": {
                "color": "444444",
                "name": "enhancement"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE1MzczNzgzNTc=",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1537378357"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-03-23T08:59:30Z",
            "event": "labeled",
            "id": 1537378358,
            "label": {
                "color": "444444",
                "name": "Cython Language Feature"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE1MzczNzgzNTg=",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/1537378358"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-03-23T09:00:15Z",
            "event": "renamed",
            "id": 1537379826,
            "node_id": "MDE3OlJlbmFtZWRUaXRsZUV2ZW50MTUzNzM3OTgyNg==",
            "performed_via_github_app": null,
            "rename": {
                "from": "Cython generates unsafe None-tolerant code",
                "to": "no None check when accessing attributes of extension types"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/1537379826"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2170/events",
    "html_url": "https://github.com/cython/cython/issues/2170",
    "id": 307267170,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425559948,
            "name": "Cython Language Feature",
            "node_id": "MDU6TGFiZWw0MjU1NTk5NDg=",
            "url": "https://api.github.com/repos/cython/cython/labels/Cython%20Language%20Feature"
        },
        {
            "color": "444444",
            "default": true,
            "description": null,
            "id": 425556243,
            "name": "enhancement",
            "node_id": "MDU6TGFiZWw0MjU1NTYyNDM=",
            "url": "https://api.github.com/repos/cython/cython/labels/enhancement"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2170/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUzMDcyNjcxNzA=",
    "number": 2170,
    "performed_via_github_app": null,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "no None check when accessing attributes of extension types",
    "updated_at": "2021-03-17T13:02:00Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2170",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1721820?v=4",
        "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
        "followers_url": "https://api.github.com/users/pitrou/followers",
        "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
        "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/pitrou",
        "id": 1721820,
        "login": "pitrou",
        "node_id": "MDQ6VXNlcjE3MjE4MjA=",
        "organizations_url": "https://api.github.com/users/pitrou/orgs",
        "received_events_url": "https://api.github.com/users/pitrou/received_events",
        "repos_url": "https://api.github.com/users/pitrou/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/pitrou"
    }
}