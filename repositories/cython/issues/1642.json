{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "The example below should be self-explanatory. You can create struct `Foo`s without the gil, but the compiler won't let you create them with arguments like `Foo(3, 7)`. The same works fine without nogil.\r\n\r\n```\r\ncdef struct Foo:\r\n    int x\r\n    int y\r\n\r\ncdef Foo make_foo(int x, int y) nogil:\r\n    cdef Foo foo\r\n    foo.x = x\r\n    foo.y = y\r\n    return foo\r\n\r\ncdef Foo test1() nogil:\r\n    cdef Foo foo = make_foo(3, 7)   # this works\r\n\r\ncdef Foo test2() nogil:\r\n    cdef Foo foo = Foo(3, 7)        # this says \"Operation not allowed without gil\"\r\n```",
    "closed_at": "2023-12-14T21:08:57Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Some debugging on this:\r\n\r\n* `analyse_as_type_constructor` monkey-patches the `Foo(...)` call node to be a `DictNode`, and the `DictItemNodes` have `StringNodes` with the appropriate field names (here: `x`,`y`) as keys.\r\n* the gil check finds the `StringNode`, and since its type (the `str` builtin) is a Python object type, the default `nogil_check` in `ExprNode` throws the error.\r\n\r\nIt seems the use of a `DictNode` is a bit of a hack here.",
            "created_at": "2017-04-06T22:19:05Z",
            "html_url": "https://github.com/cython/cython/issues/1642#issuecomment-292340781",
            "id": 292340781,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1642",
            "node_id": "MDEyOklzc3VlQ29tbWVudDI5MjM0MDc4MQ==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/292340781/reactions"
            },
            "updated_at": "2017-04-06T22:19:05Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/292340781",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5740732?v=4",
                "events_url": "https://api.github.com/users/c-f-h/events{/privacy}",
                "followers_url": "https://api.github.com/users/c-f-h/followers",
                "following_url": "https://api.github.com/users/c-f-h/following{/other_user}",
                "gists_url": "https://api.github.com/users/c-f-h/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/c-f-h",
                "id": 5740732,
                "login": "c-f-h",
                "node_id": "MDQ6VXNlcjU3NDA3MzI=",
                "organizations_url": "https://api.github.com/users/c-f-h/orgs",
                "received_events_url": "https://api.github.com/users/c-f-h/received_events",
                "repos_url": "https://api.github.com/users/c-f-h/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/c-f-h/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/c-f-h/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/c-f-h"
            }
        },
        {
            "author_association": "NONE",
            "body": "I've just hit this as well, and it's super confusing because when reading the annotated output for the struct initialization, there's no indication of anything that would require the GIL.\r\n\r\nAlso, the suggested workaround (in `make_foo()` above) works, so thanks for that!",
            "created_at": "2017-07-03T08:38:11Z",
            "html_url": "https://github.com/cython/cython/issues/1642#issuecomment-312584655",
            "id": 312584655,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1642",
            "node_id": "MDEyOklzc3VlQ29tbWVudDMxMjU4NDY1NQ==",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/312584655/reactions"
            },
            "updated_at": "2017-07-03T08:38:11Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/312584655",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1995?v=4",
                "events_url": "https://api.github.com/users/kaiw/events{/privacy}",
                "followers_url": "https://api.github.com/users/kaiw/followers",
                "following_url": "https://api.github.com/users/kaiw/following{/other_user}",
                "gists_url": "https://api.github.com/users/kaiw/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/kaiw",
                "id": 1995,
                "login": "kaiw",
                "node_id": "MDQ6VXNlcjE5OTU=",
                "organizations_url": "https://api.github.com/users/kaiw/orgs",
                "received_events_url": "https://api.github.com/users/kaiw/received_events",
                "repos_url": "https://api.github.com/users/kaiw/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/kaiw/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/kaiw/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/kaiw"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I am not able to replicate it on master branch anymore (commit 0b3c45b):\r\n\r\n```\r\n$ cat delete.pyx\r\ncdef struct Foo:\r\n    int x\r\n    int y\r\n\r\ncdef Foo make_foo(int x, int y) nogil:\r\n    cdef Foo foo\r\n    foo.x = x\r\n    foo.y = y\r\n    return foo\r\n\r\ncdef Foo test1() nogil:\r\n    cdef Foo foo = make_foo(3, 7)   # this works\r\n\r\ncdef Foo test2() nogil:\r\n    cdef Foo foo = Foo(3, 7)        # this says \"Operation not allowed without gil\"\r\n\r\n$ cythonize -3fib delete.pyx\r\n[1/1] Cythonizing /Users/matus/dev/cython/test/delete.pyx\r\nperformance hint: delete.pyx:5:5: Exception check on 'make_foo' will always require the GIL to be acquired. Declare 'make_foo' as 'noexcept' if you control the definition and you're sure you don't want the function to raise exceptions.\r\nperformance hint: delete.pyx:11:5: Exception check on 'test1' will always require the GIL to be acquired. Declare 'test1' as 'noexcept' if you control the definition and you're sure you don't want the function to raise exceptions.\r\nperformance hint: delete.pyx:14:5: Exception check on 'test2' will always require the GIL to be acquired. Declare 'test2' as 'noexcept' if you control the definition and you're sure you don't want the function to raise exceptions.\r\nperformance hint: delete.pyx:12:27: Exception check after calling 'make_foo' will always require the GIL to be acquired. Declare 'make_foo' as 'noexcept' if you control the definition and you're sure you don't want the function to raise exceptions.\r\nrunning build_ext\r\nbuilding 'delete' extension\r\ncreating /Users/matus/dev/cython/test/tmprr172489/Users\r\ncreating /Users/matus/dev/cython/test/tmprr172489/Users/matus\r\ncreating /Users/matus/dev/cython/test/tmprr172489/Users/matus/dev\r\ncreating /Users/matus/dev/cython/test/tmprr172489/Users/matus/dev/cython\r\ncreating /Users/matus/dev/cython/test/tmprr172489/Users/matus/dev/cython/test\r\nclang -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -I/Users/matus/dev/cython311/include -I/usr/local/opt/python@3.11/Frameworks/Python.framework/Versions/3.11/include/python3.11 -c /Users/matus/dev/cython/test/delete.c -o /Users/matus/dev/cython/test/tmprr172489/Users/matus/dev/cython/test/delete.o\r\n/Users/matus/dev/cython/test/delete.c:1830:35: warning: unused function '__pyx_f_6delete_test1' [-Wunused-function]\r\nstatic struct __pyx_t_6delete_Foo __pyx_f_6delete_test1(void) {\r\n                                  ^\r\n/Users/matus/dev/cython/test/delete.c:1876:35: warning: unused function '__pyx_f_6delete_test2' [-Wunused-function]\r\nstatic struct __pyx_t_6delete_Foo __pyx_f_6delete_test2(void) {\r\n                                  ^\r\n2 warnings generated.\r\nclang -bundle -undefined dynamic_lookup /Users/matus/dev/cython/test/tmprr172489/Users/matus/dev/cython/test/delete.o -o /Users/matus/dev/cython/test/delete.cpython-311-darwin.so\r\n\r\n$ python -c 'import delete'\r\n```",
            "created_at": "2023-12-14T21:08:57Z",
            "html_url": "https://github.com/cython/cython/issues/1642#issuecomment-1856593313",
            "id": 1856593313,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1642",
            "node_id": "IC_kwDOABDGAc5uqV2h",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1856593313/reactions"
            },
            "updated_at": "2023-12-14T21:13:10Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1856593313",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/827060?v=4",
                "events_url": "https://api.github.com/users/matusvalo/events{/privacy}",
                "followers_url": "https://api.github.com/users/matusvalo/followers",
                "following_url": "https://api.github.com/users/matusvalo/following{/other_user}",
                "gists_url": "https://api.github.com/users/matusvalo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matusvalo",
                "id": 827060,
                "login": "matusvalo",
                "node_id": "MDQ6VXNlcjgyNzA2MA==",
                "organizations_url": "https://api.github.com/users/matusvalo/orgs",
                "received_events_url": "https://api.github.com/users/matusvalo/received_events",
                "repos_url": "https://api.github.com/users/matusvalo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matusvalo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matusvalo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matusvalo"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1642/comments",
    "created_at": "2017-03-26T06:24:53Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/827060?v=4",
                "events_url": "https://api.github.com/users/matusvalo/events{/privacy}",
                "followers_url": "https://api.github.com/users/matusvalo/followers",
                "following_url": "https://api.github.com/users/matusvalo/following{/other_user}",
                "gists_url": "https://api.github.com/users/matusvalo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matusvalo",
                "id": 827060,
                "login": "matusvalo",
                "node_id": "MDQ6VXNlcjgyNzA2MA==",
                "organizations_url": "https://api.github.com/users/matusvalo/orgs",
                "received_events_url": "https://api.github.com/users/matusvalo/received_events",
                "repos_url": "https://api.github.com/users/matusvalo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matusvalo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matusvalo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matusvalo"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-12-14T21:08:57Z",
            "event": "closed",
            "id": 11252939776,
            "node_id": "CE_lADOABDGAc4M76H9zwAAAAKeujwA",
            "performed_via_github_app": null,
            "state_reason": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/11252939776"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1642/events",
    "html_url": "https://github.com/cython/cython/issues/1642",
    "id": 217031165,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1642/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUyMTcwMzExNjU=",
    "number": 1642,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 8,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 8,
        "url": "https://api.github.com/repos/cython/cython/issues/1642/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/1642/timeline",
    "title": "C struct initializers don't work with nogil",
    "updated_at": "2023-12-14T21:13:10Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1642",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/5740732?v=4",
        "events_url": "https://api.github.com/users/c-f-h/events{/privacy}",
        "followers_url": "https://api.github.com/users/c-f-h/followers",
        "following_url": "https://api.github.com/users/c-f-h/following{/other_user}",
        "gists_url": "https://api.github.com/users/c-f-h/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/c-f-h",
        "id": 5740732,
        "login": "c-f-h",
        "node_id": "MDQ6VXNlcjU3NDA3MzI=",
        "organizations_url": "https://api.github.com/users/c-f-h/orgs",
        "received_events_url": "https://api.github.com/users/c-f-h/received_events",
        "repos_url": "https://api.github.com/users/c-f-h/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/c-f-h/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/c-f-h/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/c-f-h"
    }
}