{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nThe pure python mode of Cython is excellent, and should make it much easier to adopt cython code into Python codebases. However, there are a number of issues with the design choices around using type hints - specifically when using VSCode (and the Pyright type checker). Mypy also has similar issues.\r\n\r\nI think this is something we should care about. For a new user using VSCode, copying any cython example with the current library throws immediate \"unknown attribute\" errors that will definitely put people off. But this has already been somewhat improved in #4327 - so the next release should have a better new user experience. But I propose the API is further changed.\r\n\r\nHowever, the type hints and type stubs currently in use in Cython don't appear to conform to standard type specs, and the type stubs in the existing repo do not type check correctly.\r\n\r\nConsider the example below (ran against `master`)\n\n### Code to reproduce the behaviour:\n\n```python\r\nimport cython\r\nimport numpy as np\r\n\r\n@cython.ccall\r\ndef some_func_double(x: cython.double[:]) -> cython.double[:]:\r\n    y: cython.double[:] = np.zeros(N, dtype=np.float64)\r\n    return x\r\n```\r\n\n\n### Expected behaviour\n\nWith pyright, this produces the below output\r\n\r\n```\r\n<file>:6:39 - error: Expected no type arguments for class \"float\" (reportInvalidTypeArguments)\r\n<file>:6:60 - error: Expected no type arguments for class \"float\" (reportInvalidTypeArguments)  \r\n<file>:7:22 - error: Expected no type arguments for class \"float\" (reportInvalidTypeArguments)\r\n<file>:7:27 - error: Expression of type \"NDArray[floating[_64Bit]]\" is incompatible with declared type \"double\"\r\n    \"ndarray[Any, dtype[floating[_64Bit]]]\" is incompatible with \"float\" (reportAssignmentType)\r\n<file>:7:38 - error: Cannot access attribute \"shape\" for class \"double\"\r\n    Attribute \"shape\" is unknown (reportAttributeAccessIssue)\r\n```\r\n\r\nWith mypy, this code doesn't even type check!\r\n```\r\n<file>:1: error: Skipping analyzing \"cython\": module is installed, but missing library stubs or py.typed marker  [import-untyped]\r\n```\r\n\r\nI can fix this by changing the `import cython` to `import Cython.Shadow as cython`. Then, `mypy` produces a similar set of errors:\r\n\r\n```\r\ntest_cython.py:6: error: \"float\" expects no type arguments, but 1 given  [type-arg]\r\ntest_cython.py:6: error: Invalid type comment or annotation  [valid-type]\r\ntest_cython.py:6: note: did you mean to use ',' instead of ':' ?\r\ntest_cython.py:7: error: \"float\" expects no type arguments, but 1 given  [type-arg]\r\ntest_cython.py:7: error: Invalid type comment or annotation  [valid-type]\r\ntest_cython.py:7: note: did you mean to use ',' instead of ':' ?\r\ntest_cython.py:7: error: Incompatible types in assignment (expression has type \"ndarray[Any, dtype[floating[_64Bit]]]\", variable has type \"float\")  [assignment]\r\ntest_cython.py:7: error: \"float\" has no attribute \"shape\"  [attr-defined]\r\nFound 6 errors in 1 file (checked 1 source file)\r\n```\n\n### OS\n\nLinux\n\n### Python version\n\n3.12\n\n### Cython version\n\n3.0.10, and master (3.1.0a0)\n\n### Additional context\n\nThere are a few issues here:\r\n\r\n1. In `Shadow.pyi`, `cython.double` is set to equal `builtins.double`. This type doesn't take any type variables, producing the error.\r\n2. The use of slices (e.g. `cython.double[:]`, `cython.double[::1]`) is not recognized as a valid type parameter specification. As far as I can see, there is no way to hack this into the type system as the implementation. So even if we took type variables, these would not be valid.\r\n3. The use of the type variable syntax `cython.double[:]` suggests that the type is a subset of `cython.double`. This means that external code which calls these functions with (for example) a numpy array incorrectly fails a type check.\r\n\r\n### Suggestions for solving\r\n\r\nIn the short term, I suggest that in the type stubs we type all cython types as `typing.Any`. This at least makes it clear that the onus is on the caller to check whether it's `cython.double` or `cython.double[:]` or `cython.double[::1]`, etc. \r\n\r\nI made and tested this change. Although `cython.double[:]` is not valid type syntax, it passes for now in Pyright (as I guess it doesn't check the details of a `typing.Any` type.\r\n\r\nThe suggestion for users would then be to write a `.pyi` file alongside your `.py` file to define the Python API.\r\n\r\nI attempted to write a minimal set of stubs that would at least pass type checking.\r\n\r\nIn the longer term, I would suggest that cython introduces a more type-hint standard way of specifying these types. For example, `MemoryView[*T]`, `CContig[T]` etc. that still translates correctly into the appropriate cython type, but would be much easier for type checkers to check against. So the code becomes something like\r\n\r\n```python\r\nimport cython\r\nimport numpy as np\r\n\r\n@cython.ccall\r\ndef some_func(x: MemoryView[cython.double]) -> MemoryView[cython.double]:\r\n    ...\r\n\r\n@cython.ccall\r\ndef some_2d_func(x: MemoryView[cython.double, CContig[cython.double]]) -> MemoryView[cython.double, CContig[cython.double]]:\r\n    ...\r\n```\r\n\r\nThis should provide a much nicer API.\r\n\r\nAlongside this, there are some noted minor bugs in `master`, including\r\n- `@cython.nogil` does not type check\r\n- `cython` does not have a `py.typed` marker for `mypy` to use (but `pyright` figures it out).\r\n\r\nIf you like this idea I'd be happy to look at writing a PR. I'd need a bit of help on exactly what should typecheck to memoryview.",
    "closed_at": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6272/comments",
    "created_at": "2024-06-26T09:16:52Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6272/events",
    "html_url": "https://github.com/cython/cython/issues/6272",
    "id": 2374810081,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6272/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc6NjLnh",
    "number": 6272,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6272/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6272/timeline",
    "title": "[BUG] Memoryview pure python type hints don't conform to standard type spec",
    "updated_at": "2024-06-26T09:16:52Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6272",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/11441393?v=4",
        "events_url": "https://api.github.com/users/mwaddoups/events{/privacy}",
        "followers_url": "https://api.github.com/users/mwaddoups/followers",
        "following_url": "https://api.github.com/users/mwaddoups/following{/other_user}",
        "gists_url": "https://api.github.com/users/mwaddoups/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/mwaddoups",
        "id": 11441393,
        "login": "mwaddoups",
        "node_id": "MDQ6VXNlcjExNDQxMzkz",
        "organizations_url": "https://api.github.com/users/mwaddoups/orgs",
        "received_events_url": "https://api.github.com/users/mwaddoups/received_events",
        "repos_url": "https://api.github.com/users/mwaddoups/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/mwaddoups/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mwaddoups/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/mwaddoups"
    }
}