{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\r\n\r\nUse of `Py_LIMITED_API` sometimes results in implicit declaration of `PyTuple_SET_ITEM` function, and consequent `ImportError` when importing.\r\n\r\nWhen the code below is built with  `python3 setup.py build_ext --inplace`, the following warning is emitted:\r\n\r\n```\r\nmy_module.c: In function ‘__pyx_pf_9my_module_my_function’:\r\nmy_module.c:2246:3: warning: implicit declaration of function ‘PyTuple_SET_ITEM’; did you mean ‘PyTuple_SetItem’? [-Wimplicit-function-declaration]\r\n 2246 |   PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_v_firstword);\r\n      |   ^~~~~~~~~~~~~~~~\r\n      |   PyTuple_SetItem\r\n```\r\n\r\nAnd if an attempt is made to import and use the function from the built .so file, using `python3 -c 'import my_module as mm; print(mm.my_function())'`, the following error is emitted:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\nImportError: /home/user/cython_bug/my_module.cpython-310-x86_64-linux-gnu.so: undefined symbol: PyTuple_SET_ITEM\r\n```\r\n\r\n\r\n\r\n\r\n### Code to reproduce the behaviour:\r\n\r\nCython code (`my_module.pyx`):\r\n\r\n```cython\r\n# cython: language_level=3\r\n\r\ndef my_function():\r\n    firstword = \"greetings\"\r\n    mesg = f\"{firstword} {firstword}\"\r\n    return 42\r\n```\r\n\r\n`setup.py` script:\r\n\r\n```python\r\nfrom setuptools import setup, Extension\r\nfrom Cython.Build import cythonize\r\n\r\nextensions = [\r\n    Extension(\r\n        name=\"my_module\",\r\n        sources=[\"my_module.pyx\"],\r\n        language=\"c\",\r\n        extra_compile_args=[\"-DCYTHON_LIMITED_API=1\",\r\n                            \"-DPy_LIMITED_API=0x030a0000\",\r\n                            ],\r\n    )\r\n]\r\n\r\nsetup(\r\n    name=\"my_cython_project\",\r\n    version=\"0.1\",\r\n    description=\"A sample Cython project\",\r\n    packages=[\"my_module\"],\r\n    ext_modules=cythonize(extensions),\r\n)\r\n```\r\n\r\n### Expected behaviour\r\n\r\nWhen `-DCYTHON_LIMITED_API=1` and `-DPy_LIMITED_API=0x030a0000` are passed as compiler options, generated code should't refer to undeclared functions.\r\n\r\nIt should be possible to build a shared library with `python3 setup.py build_ext --inplace`, and then import and use it with `python3 -c 'import my_module as mm; print(mm.my_function())'`.\r\n\r\n(At which point, the result \"42\" should be printed, in this case.)\r\n\r\n\r\n### OS\r\n\r\nLinux\r\n\r\n### Python version\r\n\r\n3.10.12 (but also occurs for Python 3.11.9)\r\n\r\n### Cython version\r\n\r\n3.0.10\r\n\r\n### Additional context\r\n\r\nThe generated code constructs a tuple, and then attempts to set elements of the tuple using code like this:\r\n\r\n```c\r\n  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_v_firstword);\r\n```\r\n\r\nBut `PyTuple_SET_ITEM` never gets declared, if the `-DCYTHON_LIMITED_API=1` and\r\n`-DPy_LIMITED_API=0x030a0000` options are passed to the Cython compiler. (The code compiles without error if those options are not passed: but then the built .so file can't be used with other versions of Python.)\r\n\r\nThe call to `PyTuple_SET_ITEM` is generated due to the following bit of Python code:\r\n\r\n```python\r\n  mesg = f\"{firstword} {firstword}\"\r\n```\r\n\r\nIf the line is removed, or the f-string changed to just `f\"{firstword} \"`, that call no longer gets generated.\r\n\r\n\r\n\r\n",
    "closed_at": "2024-06-12T18:52:49Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "It's worth trying with the master branch (or the limited-api-preview branch which also contains a few unmerged PRs). The master branch has significant improvements in the limited API (but still isn't perfect).\r\n\r\nThe 3.0 branch only has absolutely minimal support for the limited API - while there are modules that compile, they don't do a lot.\r\n\r\nImprovements to the limited API are going in the master branch rather than the 3.0 release branch so if the limited API is important to you then you'll have to use that for now.",
            "created_at": "2024-06-12T18:47:35Z",
            "html_url": "https://github.com/cython/cython/issues/6244#issuecomment-2163692613",
            "id": 2163692613,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6244",
            "node_id": "IC_kwDOABDGAc6A91RF",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2163692613/reactions"
            },
            "updated_at": "2024-06-12T18:47:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2163692613",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I'll close this because I'm reasonably sure that f-strings are fixed in master. But do let me know if you try it and it isn't true.",
            "created_at": "2024-06-12T18:52:49Z",
            "html_url": "https://github.com/cython/cython/issues/6244#issuecomment-2163700355",
            "id": 2163700355,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6244",
            "node_id": "IC_kwDOABDGAc6A93KD",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2163700355/reactions"
            },
            "updated_at": "2024-06-12T18:52:49Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2163700355",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "I'll give the master branch a go - cheers.",
            "created_at": "2024-06-13T08:43:17Z",
            "html_url": "https://github.com/cython/cython/issues/6244#issuecomment-2165018283",
            "id": 2165018283,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6244",
            "node_id": "IC_kwDOABDGAc6BC46r",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2165018283/reactions"
            },
            "updated_at": "2024-06-13T08:43:17Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2165018283",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/18113700?v=4",
                "events_url": "https://api.github.com/users/phlummox/events{/privacy}",
                "followers_url": "https://api.github.com/users/phlummox/followers",
                "following_url": "https://api.github.com/users/phlummox/following{/other_user}",
                "gists_url": "https://api.github.com/users/phlummox/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/phlummox",
                "id": 18113700,
                "login": "phlummox",
                "node_id": "MDQ6VXNlcjE4MTEzNzAw",
                "organizations_url": "https://api.github.com/users/phlummox/orgs",
                "received_events_url": "https://api.github.com/users/phlummox/received_events",
                "repos_url": "https://api.github.com/users/phlummox/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/phlummox/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/phlummox/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/phlummox"
            }
        },
        {
            "author_association": "NONE",
            "body": "Can confirm that this bug is fixed in master :)\r\n\r\nBut hopefully this report will be useful to anyone else encountering the same problem. I was just using the latest release, not realizing `master` would be the better option.",
            "created_at": "2024-06-13T16:08:43Z",
            "html_url": "https://github.com/cython/cython/issues/6244#issuecomment-2166117745",
            "id": 2166117745,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6244",
            "node_id": "IC_kwDOABDGAc6BHFVx",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2166117745/reactions"
            },
            "updated_at": "2024-06-13T16:08:43Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2166117745",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/18113700?v=4",
                "events_url": "https://api.github.com/users/phlummox/events{/privacy}",
                "followers_url": "https://api.github.com/users/phlummox/followers",
                "following_url": "https://api.github.com/users/phlummox/following{/other_user}",
                "gists_url": "https://api.github.com/users/phlummox/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/phlummox",
                "id": 18113700,
                "login": "phlummox",
                "node_id": "MDQ6VXNlcjE4MTEzNzAw",
                "organizations_url": "https://api.github.com/users/phlummox/orgs",
                "received_events_url": "https://api.github.com/users/phlummox/received_events",
                "repos_url": "https://api.github.com/users/phlummox/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/phlummox/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/phlummox/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/phlummox"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6244/comments",
    "created_at": "2024-06-12T18:26:58Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-06-12T18:52:49Z",
            "event": "closed",
            "id": 13136108087,
            "node_id": "CE_lADOABDGAc6MCZuFzwAAAAMO-Ro3",
            "performed_via_github_app": null,
            "state_reason": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/13136108087"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6244/events",
    "html_url": "https://github.com/cython/cython/issues/6244",
    "id": 2349439877,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6244/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc6MCZuF",
    "number": 6244,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6244/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6244/timeline",
    "title": "[BUG] Use of `Py_LIMITED_API` sometimes results in references to nonexistent `PyTuple_SET_ITEM` function",
    "updated_at": "2024-06-13T16:08:45Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6244",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/18113700?v=4",
        "events_url": "https://api.github.com/users/phlummox/events{/privacy}",
        "followers_url": "https://api.github.com/users/phlummox/followers",
        "following_url": "https://api.github.com/users/phlummox/following{/other_user}",
        "gists_url": "https://api.github.com/users/phlummox/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/phlummox",
        "id": 18113700,
        "login": "phlummox",
        "node_id": "MDQ6VXNlcjE4MTEzNzAw",
        "organizations_url": "https://api.github.com/users/phlummox/orgs",
        "received_events_url": "https://api.github.com/users/phlummox/received_events",
        "repos_url": "https://api.github.com/users/phlummox/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/phlummox/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/phlummox/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/phlummox"
    }
}