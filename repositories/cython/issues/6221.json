{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Describe your issue\r\n\r\n* Identify scopes that need thread safety. That's basically everything except functions without parallel blocks in, and generators without parallel blocks in (since generators are already protected from being called when they're already running). Specifically we should assume most(?) closure scopes need thread safety, cdef classes need thread safety, and functions with parallel and a `with gil` block need thread safety.\r\n* Add a lock (`PyMutex`?) to those scopes. Note that cdef classes should already have a lock in their header in free-threading mode. I think per-scope locks are the right level of granularity here but per-variable would be another option especially at function scope.\r\n* Temps don't need locking\r\n* Chained attribute access needs transforming:\r\n    ```\r\n    x = a.b.c\r\n    # goes to:\r\n    lock a (and maybe scope of a)\r\n    temp1 = a.b\r\n    unlock a (and maybe scope of a)\r\n    lock b (and maybe x)\r\n    x = temp1.c\r\n    unlock b (and maybe x)\r\n    ```\r\n* Where two locks are needed (e.g. for assignment where we'd lock the lhs and rhs) we need to be careful and use a fixed order to avoid deadlock. The PEP for free-threading says that CPython just bases it on the addresses of the mutex so we could follow this example.\r\n* Add a compiler directive to turn this off.\r\n* Everything is guarded by `#if CYTHON_COMPILING_IN_CPYTHON_FREETHREADING` so should make little difference in other modes. The only exception is probably the chained assignment transform which will be applied universally.\r\n* We can close https://github.com/cython/cython/issues/6215 since memoryviews will be covered by this broader scheme.\r\n* There's a choice to be made about what types to apply this to\r\n    * definitely `PyObjects` and memoryviews.\r\n    * Some numeric types (e.g. float) can be inferred from valid plain Python code, so might be worth applying there,\r\n    * I also wonder about public attributes of cdef classes?",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "There's possibly also a question if a read-write mutex (e.g. `std::shared_mutex` in C++) would be a helpful optimization. I suspect it probably would, but it might mean we couldn't use `PyMutex`.",
            "created_at": "2024-05-29T07:41:46Z",
            "html_url": "https://github.com/cython/cython/issues/6221#issuecomment-2136750299",
            "id": 2136750299,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6221",
            "node_id": "IC_kwDOABDGAc5_XDjb",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2136750299/reactions"
            },
            "updated_at": "2024-05-29T07:41:46Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2136750299",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6221/comments",
    "created_at": "2024-05-29T07:34:08Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-05-29T07:34:08Z",
            "event": "labeled",
            "id": 12967268263,
            "label": {
                "color": "A37CC3",
                "name": "nogil CPython"
            },
            "node_id": "LE_lADOABDGAc6Kb-aHzwAAAAME6M-n",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/12967268263"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6221/events",
    "html_url": "https://github.com/cython/cython/issues/6221",
    "id": 2322589319,
    "labels": [
        {
            "color": "A37CC3",
            "default": false,
            "description": "",
            "id": 6871764375,
            "name": "nogil CPython",
            "node_id": "LA_kwDOABDGAc8AAAABmZbNlw",
            "url": "https://api.github.com/repos/cython/cython/labels/nogil%20CPython"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6221/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc6Kb-aH",
    "number": 6221,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6221/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6221/timeline",
    "title": "Rough plan for free-threading thread safety",
    "updated_at": "2024-05-29T07:43:00Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6221",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
        "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
        "followers_url": "https://api.github.com/users/da-woods/followers",
        "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
        "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/da-woods",
        "id": 10536947,
        "login": "da-woods",
        "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
        "organizations_url": "https://api.github.com/users/da-woods/orgs",
        "received_events_url": "https://api.github.com/users/da-woods/received_events",
        "repos_url": "https://api.github.com/users/da-woods/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/da-woods"
    }
}