{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Describe the bug\n\nI bisected this change of behavior to da405c6\r\n\r\nOriginally reported here: symengine/symengine.py#480\r\n\n\n### Code to reproduce the behaviour:\n\n```cython\r\nclass Foo:\r\n    bar = __class__\r\n```\r\n\r\n```console\r\n$ rm repro.c; python3 cythonize.py repro.pyx\r\nCompiling /home/bjorn/vc/cython/repro.pyx because it changed.\r\n[1/1] Cythonizing /home/bjorn/vc/cython/repro.pyx\r\n/home/bjorn/vc/cython/Cython/Compiler/Main.py:373: FutureWarning: Cython directive 'language_level' not set, using '3' (Py3). This has changed from earlier releases! File: /home/bjorn/vc/cython/repro.pyx                                                                   \r\n  tree = Parsing.p_module(s, pxd, full_module_name)                                                                                                                                                                                                                           \r\n                                                                                                                                                                                                                                                                              \r\nError compiling Cython file:                                                                                                                                                                                                                                                  \r\n------------------------------------------------------------                                                                                                                                                                                                                  \r\n...                                                                                                                                                                                                                                                                           \r\nclass Foo:                                                                                                                                                                                                                                                                    \r\n    bar = __class__                                                                                                                                                                                                                                                           \r\n          ^                                                                                                                                                                                                                                                                   \r\n------------------------------------------------------------                                                                                                                                                                                                                  \r\n                                                                                                                                                                                                                                                                              \r\nrepro.pyx:2:10: undeclared name not builtin: __class__                                                                                                                                                                                                                        \r\nTraceback (most recent call last):                                                                                                                                                                                                                                            \r\n  File \"/home/bjorn/vc/cython/cythonize.py\", line 9, in <module>                                                                                                                                                                                                              \r\n    main()                                                                                                                                                                                                                                                                    \r\n  File \"/home/bjorn/vc/cython/Cython/Build/Cythonize.py\", line 245, in main                                                                                                                                                                                                   \r\n    _cython_compile_files(all_paths, options)                                                                                                                                                                                                                                 \r\n  File \"/home/bjorn/vc/cython/Cython/Build/Cythonize.py\", line 61, in _cython_compile_files                                                                                                                                                                                   \r\n    ext_modules = cythonize(                                                                                                                                                                                                                                                  \r\n                  ^^^^^^^^^^                                                                                                                                                                                                                                                  \r\n  File \"/home/bjorn/vc/cython/Cython/Build/Dependencies.py\", line 1168, in cythonize                                                                                                                                                                                          \r\n    cythonize_one(*args)                                                                                                                                                                                                                                                      \r\n  File \"/home/bjorn/vc/cython/Cython/Build/Dependencies.py\", line 1331, in cythonize_one                                                                                                                                                                                      \r\n    raise CompileError(None, pyx_file)                                                                                                                                                                                                                                        \r\nCython.Compiler.Errors.CompileError: /home/bjorn/vc/cython/repro.pyx\r\n```\n\n### Expected behaviour\n\n_No response_\n\n### OS\n\n_No response_\n\n### Python version\n\n_No response_\n\n### Cython version\n\n_No response_\n\n### Additional context\n\n_No response_",
    "closed_at": "2024-05-27T19:57:09Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "It looks like it worked basically by accident before. `builtins.__class__` exists but only to tell us that `builtins` is a module. I suspect `__class__` just needs to be added to `scope_predefined_names` for `ClassScope`",
            "created_at": "2024-05-27T16:29:19Z",
            "html_url": "https://github.com/cython/cython/issues/6218#issuecomment-2133803980",
            "id": 2133803980,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6218",
            "node_id": "IC_kwDOABDGAc5_L0PM",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2133803980/reactions"
            },
            "updated_at": "2024-05-27T16:29:19Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2133803980",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I see. I should add that naming the file `.py` and executing under Python does raise a NameError.",
            "created_at": "2024-05-27T16:34:01Z",
            "html_url": "https://github.com/cython/cython/issues/6218#issuecomment-2133809290",
            "id": 2133809290,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6218",
            "node_id": "IC_kwDOABDGAc5_L1iK",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2133809290/reactions"
            },
            "updated_at": "2024-05-27T16:34:01Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2133809290",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/485936?v=4",
                "events_url": "https://api.github.com/users/bjodah/events{/privacy}",
                "followers_url": "https://api.github.com/users/bjodah/followers",
                "following_url": "https://api.github.com/users/bjodah/following{/other_user}",
                "gists_url": "https://api.github.com/users/bjodah/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bjodah",
                "id": 485936,
                "login": "bjodah",
                "node_id": "MDQ6VXNlcjQ4NTkzNg==",
                "organizations_url": "https://api.github.com/users/bjodah/orgs",
                "received_events_url": "https://api.github.com/users/bjodah/received_events",
                "repos_url": "https://api.github.com/users/bjodah/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bjodah/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bjodah/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bjodah"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Ah right...  that implies that Cython is now doing the right thing and was wrong before.\r\n\r\nIt looks like it ends up looking up the `__class__` of the module (i.e. `module`) which isn't a hugely helpful thing to do. I think we should keep the current behaviour unless there's a very good reason why this should work.",
            "created_at": "2024-05-27T17:58:18Z",
            "html_url": "https://github.com/cython/cython/issues/6218#issuecomment-2133889081",
            "id": 2133889081,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6218",
            "node_id": "IC_kwDOABDGAc5_MJA5",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2133889081/reactions"
            },
            "updated_at": "2024-05-27T17:58:18Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2133889081",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Yes, I agree. Especially if it resolves to the module.",
            "created_at": "2024-05-27T19:57:10Z",
            "html_url": "https://github.com/cython/cython/issues/6218#issuecomment-2133992711",
            "id": 2133992711,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6218",
            "node_id": "IC_kwDOABDGAc5_MiUH",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2133992711/reactions"
            },
            "updated_at": "2024-05-27T19:57:10Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2133992711",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/485936?v=4",
                "events_url": "https://api.github.com/users/bjodah/events{/privacy}",
                "followers_url": "https://api.github.com/users/bjodah/followers",
                "following_url": "https://api.github.com/users/bjodah/following{/other_user}",
                "gists_url": "https://api.github.com/users/bjodah/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bjodah",
                "id": 485936,
                "login": "bjodah",
                "node_id": "MDQ6VXNlcjQ4NTkzNg==",
                "organizations_url": "https://api.github.com/users/bjodah/orgs",
                "received_events_url": "https://api.github.com/users/bjodah/received_events",
                "repos_url": "https://api.github.com/users/bjodah/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bjodah/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bjodah/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bjodah"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6218/comments",
    "created_at": "2024-05-27T15:16:54Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/485936?v=4",
                "events_url": "https://api.github.com/users/bjodah/events{/privacy}",
                "followers_url": "https://api.github.com/users/bjodah/followers",
                "following_url": "https://api.github.com/users/bjodah/following{/other_user}",
                "gists_url": "https://api.github.com/users/bjodah/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bjodah",
                "id": 485936,
                "login": "bjodah",
                "node_id": "MDQ6VXNlcjQ4NTkzNg==",
                "organizations_url": "https://api.github.com/users/bjodah/orgs",
                "received_events_url": "https://api.github.com/users/bjodah/received_events",
                "repos_url": "https://api.github.com/users/bjodah/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bjodah/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bjodah/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bjodah"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-05-27T15:17:24Z",
            "event": "renamed",
            "id": 12947433048,
            "node_id": "RTE_lADOABDGAc6KPurUzwAAAAMDuiZY",
            "performed_via_github_app": null,
            "rename": {
                "from": "[BUG] Possibly regression on master branch, __class__ not available in class body during cythonize",
                "to": "[BUG] Possible regression on master branch, __class__ not available in class body during cythonize"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/12947433048"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/485936?v=4",
                "events_url": "https://api.github.com/users/bjodah/events{/privacy}",
                "followers_url": "https://api.github.com/users/bjodah/followers",
                "following_url": "https://api.github.com/users/bjodah/following{/other_user}",
                "gists_url": "https://api.github.com/users/bjodah/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/bjodah",
                "id": 485936,
                "login": "bjodah",
                "node_id": "MDQ6VXNlcjQ4NTkzNg==",
                "organizations_url": "https://api.github.com/users/bjodah/orgs",
                "received_events_url": "https://api.github.com/users/bjodah/received_events",
                "repos_url": "https://api.github.com/users/bjodah/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/bjodah/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/bjodah/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/bjodah"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-05-27T19:57:10Z",
            "event": "closed",
            "id": 12949254492,
            "node_id": "CE_lADOABDGAc6KPurUzwAAAAMD1fFc",
            "performed_via_github_app": null,
            "state_reason": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/12949254492"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6218/events",
    "html_url": "https://github.com/cython/cython/issues/6218",
    "id": 2319379156,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6218/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc6KPurU",
    "number": 6218,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6218/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6218/timeline",
    "title": "[BUG] Possible regression on master branch, __class__ not available in class body during cythonize",
    "updated_at": "2024-05-27T19:57:10Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6218",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/485936?v=4",
        "events_url": "https://api.github.com/users/bjodah/events{/privacy}",
        "followers_url": "https://api.github.com/users/bjodah/followers",
        "following_url": "https://api.github.com/users/bjodah/following{/other_user}",
        "gists_url": "https://api.github.com/users/bjodah/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/bjodah",
        "id": 485936,
        "login": "bjodah",
        "node_id": "MDQ6VXNlcjQ4NTkzNg==",
        "organizations_url": "https://api.github.com/users/bjodah/orgs",
        "received_events_url": "https://api.github.com/users/bjodah/received_events",
        "repos_url": "https://api.github.com/users/bjodah/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/bjodah/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bjodah/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/bjodah"
    }
}