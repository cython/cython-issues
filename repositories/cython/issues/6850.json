{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Describe the bug\n\nAs soon as Cython 3.1 has been released, a few hours ago, psycopg tests started failing. Example: [this workflow](https://github.com/psycopg/psycopg/actions/runs/14916373880).\n\nThe failing tests are tests counting that there are no leaks.\n\nUpon drilling down, the objects that leak seem to be PGresult. Code [here](https://github.com/psycopg/psycopg/blob/e63f3aa9/psycopg_c/psycopg_c/pq/pgresult.pyx).\n\nCuriously, but this might be an artifact of the way I am trying to drill down, what I see leaking are the _lists that contain the `PGresult`_ By changing the test the following way:\n\n<details>\n<summary>Patch to find the object leaking</summary>\n\n```diff\ndiff --git a/tests/test_cursor_raw.py b/tests/test_cursor_raw.py\nindex b12128cf..000ec72b 100644\n--- a/tests/test_cursor_raw.py\n+++ b/tests/test_cursor_raw.py\n@@ -92,17 +92,9 @@ def test_leak(conn_cls, dsn, faker, fmt, fmt_out, fetch, row_factory, gc):\n                         cur.executemany(faker.insert_stmt, faker.records)\n                     cur.execute(ph(cur, faker.select_stmt))\n \n-                    if fetch == \"one\":\n-                        while cur.fetchone() is not None:\n-                            pass\n-                    elif fetch == \"many\":\n-                        while cur.fetchmany(3):\n-                            pass\n-                    elif fetch == \"all\":\n-                        cur.fetchall()\n-                    elif fetch == \"iter\":\n-                        for rec in cur:\n-                            pass\n+    from gc import get_objects\n+    from typing import Any\n+    from psycopg_c.pq import PGresult  # type: ignore\n \n     n = []\n     gc.collect()\n@@ -110,4 +102,21 @@ def test_leak(conn_cls, dsn, faker, fmt, fmt_out, fetch, row_factory, gc):\n         work()\n         gc.collect()\n         n.append(gc.count())\n+\n+    leaked: list[list[Any]] = [[] for _ in range(3)]\n+\n+    for i in range(3):\n+        work()\n+        gc.collect()\n+        for obj in get_objects():\n+            if type(obj) is list and len(obj) == 1 and type(obj[0]) is PGresult:\n+                leaked[i].append(obj)\n+\n+        n.append(gc.count())\n+\n+    got = set(map(id, leaked[0]))\n+    more = [obj for obj in leaked[1] if id(obj) not in got]\n+    for obj in more:\n+        print(obj[0].command_status)\n+    breakpoint()\n     assert n[0] == n[1] == n[2], f\"objects leaked: {n[1] - n[0]}, {n[2] - n[1]}\"\n```\n\n</details>\n\nthen I could see that the objects leaked are 8 lists of precisely one item, being a PGresult instance, likely containing the query executed in the test. The print statement prints:\n\n```\nb'BEGIN'\nb'DROP TABLE'\nb'CREATE TABLE'\nb'SAVEPOINT'\nb'RELEASE'\nb'SELECT 10'\nb'ROLLBACK'\nb'DEALLOCATE ALL'\n```\n\nForcing Cython < 3.1 [in the build requirements](https://github.com/psycopg/psycopg/blob/e63f3aa94d1a72d57ecffe5251240525621242c9/psycopg_c/pyproject.toml#L22) the leak disappears.\n\n### Code to reproduce the behaviour:\n\nClone psycopg 3 on current master, create a virtualenv, build and install the Cython extension, the testing dependencies:\n\n```\n$ git clone git@github.com:psycopg/psycopg.git\n$ cd psycopg\n$ git checkout e63f3aa9\n$ python -m venv .venv\n$ source .venv/bin/activate\n(.venv) $ pip install ./psycopg[test] ./psycopg_c\n```\n\nPoint the env var to a scratch database to run tests, run this sample test. All similar gc count-based tests fail:\n\n```\n(.venv) $ export PSYCOPG_TEST_DSN=\"dbname=psycopg3_test\"\n(.venv) $ PSYCOPG_IMPL=c pytest \"tests/test_cursor_raw.py::test_leak[asyncio-tuple_row-iter-Format.BINARY-b]\"\n...\nFAILED tests/test_cursor_raw.py::test_leak[asyncio-tuple_row-iter-Format.BINARY-b] - AssertionError: objects leaked: 8, 8\n========================================== 1 failed in 0.18s ===========================================\n```\n\n\n### Expected behaviour\n\n_No response_\n\n### OS\n\nLinux, Windows, macOS\n\n### Python version\n\n3.10 to 3.13. Not 3.8 to 3.9\n\n### Cython version\n\n3.1.0\n\n### Additional context\n\n_No response_",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Note: I thought that the lists leaked were the one in the cursors. But that list is likely changed inplace [here](https://github.com/psycopg/psycopg/blob/e63f3aa94d1a72d57ecffe5251240525621242c9/psycopg/psycopg/_cursor_base.py#L521) so there shouldn't be more than one instance per cursor. That code is pure Python, not Cython.\n\nWhat I suspect is that the leak comes from the generator function where the list and the objects are created, which is in Cython too, [here](https://github.com/psycopg/psycopg/blob/e63f3aa94d1a72d57ecffe5251240525621242c9/psycopg_c/psycopg_c/_psycopg/generators.pyx#L163).\n",
            "created_at": "2025-05-08T23:42:10Z",
            "html_url": "https://github.com/cython/cython/issues/6850#issuecomment-2864698412",
            "id": 2864698412,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6850",
            "node_id": "IC_kwDOABDGAc6qv9Qs",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2864698412/reactions"
            },
            "updated_at": "2025-05-08T23:42:10Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2864698412",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/199429?v=4",
                "events_url": "https://api.github.com/users/dvarrazzo/events{/privacy}",
                "followers_url": "https://api.github.com/users/dvarrazzo/followers",
                "following_url": "https://api.github.com/users/dvarrazzo/following{/other_user}",
                "gists_url": "https://api.github.com/users/dvarrazzo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dvarrazzo",
                "id": 199429,
                "login": "dvarrazzo",
                "node_id": "MDQ6VXNlcjE5OTQyOQ==",
                "organizations_url": "https://api.github.com/users/dvarrazzo/orgs",
                "received_events_url": "https://api.github.com/users/dvarrazzo/received_events",
                "repos_url": "https://api.github.com/users/dvarrazzo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dvarrazzo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dvarrazzo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dvarrazzo",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Hacking more about these lists, adding the following to the test (and dropping the `leaked` lists):\n```python\n            # in the loops:\n            if type(obj) is list and len(obj) == 1 and type(obj[0]) is PGresult:\n                print(f\"{sys.getrefcount(obj)=}, {len(get_referrers(obj))=}\")\n\n    # after the loops\n    L = []\n    L2 = [L]\n    print(f\"{sys.getrefcount(L)=}, {len(get_referrers(L))=}\")\n\n```\nThese print:\n\n```\nsys.getrefcount(obj)=4, len(get_referrers(obj))=1\nsys.getrefcount(L)=3, len(get_referrers(L))=1\n```\n\nWhich, I might be totally wrong here, but seem to suggest that the lists created in the generator have the refcount off by one.",
            "created_at": "2025-05-09T00:09:33Z",
            "html_url": "https://github.com/cython/cython/issues/6850#issuecomment-2864733375",
            "id": 2864733375,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6850",
            "node_id": "IC_kwDOABDGAc6qwFy_",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2864733375/reactions"
            },
            "updated_at": "2025-05-09T00:09:33Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2864733375",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/199429?v=4",
                "events_url": "https://api.github.com/users/dvarrazzo/events{/privacy}",
                "followers_url": "https://api.github.com/users/dvarrazzo/followers",
                "following_url": "https://api.github.com/users/dvarrazzo/following{/other_user}",
                "gists_url": "https://api.github.com/users/dvarrazzo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dvarrazzo",
                "id": 199429,
                "login": "dvarrazzo",
                "node_id": "MDQ6VXNlcjE5OTQyOQ==",
                "organizations_url": "https://api.github.com/users/dvarrazzo/orgs",
                "received_events_url": "https://api.github.com/users/dvarrazzo/received_events",
                "repos_url": "https://api.github.com/users/dvarrazzo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dvarrazzo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dvarrazzo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dvarrazzo",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6850/comments",
    "created_at": "2025-05-08T23:33:53Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/199429?v=4",
                "events_url": "https://api.github.com/users/dvarrazzo/events{/privacy}",
                "followers_url": "https://api.github.com/users/dvarrazzo/followers",
                "following_url": "https://api.github.com/users/dvarrazzo/following{/other_user}",
                "gists_url": "https://api.github.com/users/dvarrazzo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dvarrazzo",
                "id": 199429,
                "login": "dvarrazzo",
                "node_id": "MDQ6VXNlcjE5OTQyOQ==",
                "organizations_url": "https://api.github.com/users/dvarrazzo/orgs",
                "received_events_url": "https://api.github.com/users/dvarrazzo/received_events",
                "repos_url": "https://api.github.com/users/dvarrazzo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dvarrazzo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dvarrazzo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dvarrazzo",
                "user_view_type": "public"
            },
            "commit_id": "b25af4f8427361f5f803b4e0945d525088a5bcd9",
            "commit_url": "https://api.github.com/repos/psycopg/psycopg/commits/b25af4f8427361f5f803b4e0945d525088a5bcd9",
            "created_at": "2025-05-08T23:48:36Z",
            "event": "referenced",
            "id": 17582274335,
            "node_id": "REFE_lADOABDGAc610O4ezwAAAAQX_Dcf",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/17582274335"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/199429?v=4",
                "events_url": "https://api.github.com/users/dvarrazzo/events{/privacy}",
                "followers_url": "https://api.github.com/users/dvarrazzo/followers",
                "following_url": "https://api.github.com/users/dvarrazzo/following{/other_user}",
                "gists_url": "https://api.github.com/users/dvarrazzo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dvarrazzo",
                "id": 199429,
                "login": "dvarrazzo",
                "node_id": "MDQ6VXNlcjE5OTQyOQ==",
                "organizations_url": "https://api.github.com/users/dvarrazzo/orgs",
                "received_events_url": "https://api.github.com/users/dvarrazzo/received_events",
                "repos_url": "https://api.github.com/users/dvarrazzo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dvarrazzo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dvarrazzo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dvarrazzo",
                "user_view_type": "public"
            },
            "commit_id": "91daf1bd3e6d28b8bc8a9c3860654429a76cd17a",
            "commit_url": "https://api.github.com/repos/psycopg/psycopg/commits/91daf1bd3e6d28b8bc8a9c3860654429a76cd17a",
            "created_at": "2025-05-09T00:17:30Z",
            "event": "referenced",
            "id": 17582456479,
            "node_id": "REFE_lADOABDGAc610O4ezwAAAAQX_v6f",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/17582456479"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6850/events",
    "html_url": "https://github.com/cython/cython/issues/6850",
    "id": 3050368542,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6850/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc610O4e",
    "number": 6850,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6850/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6850/timeline",
    "title": "[BUG] Objects created with Cython 3.1 leak memory.",
    "type": null,
    "updated_at": "2025-05-09T00:09:34Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6850",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/199429?v=4",
        "events_url": "https://api.github.com/users/dvarrazzo/events{/privacy}",
        "followers_url": "https://api.github.com/users/dvarrazzo/followers",
        "following_url": "https://api.github.com/users/dvarrazzo/following{/other_user}",
        "gists_url": "https://api.github.com/users/dvarrazzo/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/dvarrazzo",
        "id": 199429,
        "login": "dvarrazzo",
        "node_id": "MDQ6VXNlcjE5OTQyOQ==",
        "organizations_url": "https://api.github.com/users/dvarrazzo/orgs",
        "received_events_url": "https://api.github.com/users/dvarrazzo/received_events",
        "repos_url": "https://api.github.com/users/dvarrazzo/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/dvarrazzo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/dvarrazzo/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/dvarrazzo",
        "user_view_type": "public"
    }
}