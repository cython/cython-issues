{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "Indexing a 2d view in a `prange` will generate some unnecessary python interactions related to the GIL.\r\n\r\nHere is a reproducing example. LMK if I can help with anything.\r\n\r\n```python\r\n#cython: boundscheck=False\r\n#cython: language_level=3\r\nfrom cython.parallel import prange\r\n\r\n# Indexing a 2d view in a prange loop: generates lots of python interactions.\r\ndef sum_2d_a(float[:, :] view_2d):\r\n\r\n    cdef:\r\n        float out = 0\r\n        int row_idx = 0\r\n\r\n    for row_idx in prange(view_2d.shape[0], nogil=True):\r\n        out += sum_1d_a(view_2d[row_idx, :])\r\n        # lots of python interactions at the end of the loop\r\n\r\n    return out\r\n\r\ncdef float sum_1d_a(float[:] view_1d) nogil:\r\n    return 3.4  # irrelevant code\r\n\r\n\r\n# workaround: pass the whole 2d view and the row index. No interactions in this case.\r\ndef sum_2d_b(float[:, :] view_2d):\r\n\r\n    cdef:\r\n        float out = 0\r\n        int row_idx = 0\r\n\r\n    for row_idx in prange(view_2d.shape[0], nogil=True):\r\n        out += sum_1d_b(view_2d, row_idx)\r\n        # no python interaction\r\n\r\n    return out\r\n\r\ncdef float sum_1d_b(float[:, :] view_2d, int row_idx) nogil:\r\n    return 3.4  # irrelevant code\r\n```\r\n\r\nversion : 0.29.6",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Creation and (last) deletion of a slice require the GIL (to prevent the underlying memoryview from being deleted before the slice). If not done internally, this happens in the `__PYX_{INC,DEC}_MEMVIEW` utilities. Even if we had stronger analysis, we'd have to know that sum_1d_b doesn't cache it away somewhere, so it's hard to see how we'd do better here. ",
            "created_at": "2019-06-08T21:13:39Z",
            "html_url": "https://github.com/cython/cython/issues/2987#issuecomment-500164331",
            "id": 500164331,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2987",
            "node_id": "MDEyOklzc3VlQ29tbWVudDUwMDE2NDMzMQ==",
            "updated_at": "2019-06-08T21:13:39Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/500164331",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/486017?v=4",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "node_id": "MDQ6VXNlcjQ4NjAxNw==",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            }
        },
        {
            "author_association": "NONE",
            "body": "Thanks for your feedback.\r\n\r\nI'm a bit confused about memory views needing the GIL, because changing `prange` to `range` will remove the python interactions. Even in a `with nogil:` context manager.",
            "created_at": "2019-06-14T20:34:49Z",
            "html_url": "https://github.com/cython/cython/issues/2987#issuecomment-502254423",
            "id": 502254423,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2987",
            "node_id": "MDEyOklzc3VlQ29tbWVudDUwMjI1NDQyMw==",
            "updated_at": "2019-06-14T20:34:49Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/502254423",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1190450?v=4",
                "events_url": "https://api.github.com/users/NicolasHug/events{/privacy}",
                "followers_url": "https://api.github.com/users/NicolasHug/followers",
                "following_url": "https://api.github.com/users/NicolasHug/following{/other_user}",
                "gists_url": "https://api.github.com/users/NicolasHug/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/NicolasHug",
                "id": 1190450,
                "login": "NicolasHug",
                "node_id": "MDQ6VXNlcjExOTA0NTA=",
                "organizations_url": "https://api.github.com/users/NicolasHug/orgs",
                "received_events_url": "https://api.github.com/users/NicolasHug/received_events",
                "repos_url": "https://api.github.com/users/NicolasHug/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/NicolasHug/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/NicolasHug/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/NicolasHug"
            }
        },
        {
            "author_association": "NONE",
            "body": "@robertwb to clarify my comment above:\r\n\r\nWhen using `range`, no GIL-related interaction:\r\n\r\n```py\r\ndef sum_2d_a(float[:, :] view_2d):\r\n\r\n    cdef:\r\n        float out = 0\r\n        int row_idx = 0\r\n\r\n    for row_idx in range(view_2d.shape[0], nogil=True):\r\n        out += sum_1d_a(view_2d[row_idx, :])  # no interactions here\r\n```\r\n\r\nUsing `prange`, lots of GIL-related interactions:\r\n\r\n```py\r\ndef sum_2d_a(float[:, :] view_2d):\r\n\r\n    cdef:\r\n        float out = 0\r\n        int row_idx = 0\r\n\r\n    for row_idx in prange(view_2d.shape[0], nogil=True):\r\n        out += sum_1d_a(view_2d[row_idx, :])  # interactions here\r\n```\r\n\r\nAs you can see in the first example, the GIL is released when the slice is created.\r\n\r\nThe only difference between the two examples is the use of `range` vs `prange`.\r\n\r\nAgain I'm happy to assist any way I can\r\n\r\nThanks",
            "created_at": "2020-05-14T13:03:41Z",
            "html_url": "https://github.com/cython/cython/issues/2987#issuecomment-628620047",
            "id": 628620047,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2987",
            "node_id": "MDEyOklzc3VlQ29tbWVudDYyODYyMDA0Nw==",
            "updated_at": "2020-05-14T13:04:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/628620047",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1190450?v=4",
                "events_url": "https://api.github.com/users/NicolasHug/events{/privacy}",
                "followers_url": "https://api.github.com/users/NicolasHug/followers",
                "following_url": "https://api.github.com/users/NicolasHug/following{/other_user}",
                "gists_url": "https://api.github.com/users/NicolasHug/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/NicolasHug",
                "id": 1190450,
                "login": "NicolasHug",
                "node_id": "MDQ6VXNlcjExOTA0NTA=",
                "organizations_url": "https://api.github.com/users/NicolasHug/orgs",
                "received_events_url": "https://api.github.com/users/NicolasHug/received_events",
                "repos_url": "https://api.github.com/users/NicolasHug/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/NicolasHug/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/NicolasHug/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/NicolasHug"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> for row_idx in range(view_2d.shape[0], nogil=True):\r\n\r\nWe should make sure this raises an error. `range()` doesn't take keyword arguments (definitely not one called `nogil`). In any case, this does not release the GIL, and thus the loop does not need to re-acquire it.\r\n\r\n@NicolasHug, taking a slice of a memoryview needs to create a new reference to the buffer owner object. Refcounting requires the GIL. So there needs to be at least some interaction with the Python runtime. Maybe you can get away with calling the function once per (larger) slice and not once for each row? E.g. use `prange(N)` for N threads and then slice the data into N slices yourself, passing down a 2D view.",
            "created_at": "2020-05-14T14:13:21Z",
            "html_url": "https://github.com/cython/cython/issues/2987#issuecomment-628664002",
            "id": 628664002,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2987",
            "node_id": "MDEyOklzc3VlQ29tbWVudDYyODY2NDAwMg==",
            "updated_at": "2020-05-14T14:13:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/628664002",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "Thanks for the feedback @scoder.\r\n\r\nMy bad, what I meant to write was this, and I still don't see any Python interaction when creating the slices:\r\n\r\n```py\r\n    with nogil:\r\n        for row_idx in range(view_2d.shape[0]):\r\n            out += sum_1d_a(view_2d[row_idx, :])  # no interactions\r\n```\r\n\r\n>  Maybe you can get away with calling the function once per (larger) slice and not once for each row? E.g. use prange(N) for N threads and then slice the data into N slices yourself, passing down a 2D view.\r\n\r\nThis would work in this simple example but my actual use-case is more tricky than that and this workaround could not apply. I do need to have the prange over the rows (sometimes columns) of a big array with a custom dtype. [here is where](https://github.com/scikit-learn/scikit-learn/blob/master/sklearn/ensemble/_hist_gradient_boosting/histogram.pyx#L24), in case you're interested",
            "created_at": "2020-05-14T14:26:35Z",
            "html_url": "https://github.com/cython/cython/issues/2987#issuecomment-628671825",
            "id": 628671825,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2987",
            "node_id": "MDEyOklzc3VlQ29tbWVudDYyODY3MTgyNQ==",
            "updated_at": "2020-05-14T14:26:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/628671825",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1190450?v=4",
                "events_url": "https://api.github.com/users/NicolasHug/events{/privacy}",
                "followers_url": "https://api.github.com/users/NicolasHug/followers",
                "following_url": "https://api.github.com/users/NicolasHug/following{/other_user}",
                "gists_url": "https://api.github.com/users/NicolasHug/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/NicolasHug",
                "id": 1190450,
                "login": "NicolasHug",
                "node_id": "MDQ6VXNlcjExOTA0NTA=",
                "organizations_url": "https://api.github.com/users/NicolasHug/orgs",
                "received_events_url": "https://api.github.com/users/NicolasHug/received_events",
                "repos_url": "https://api.github.com/users/NicolasHug/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/NicolasHug/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/NicolasHug/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/NicolasHug"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2987/comments",
    "created_at": "2019-06-07T19:10:14Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/486017?v=4",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "node_id": "MDQ6VXNlcjQ4NjAxNw==",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2020-05-14T13:03:41Z",
            "event": "mentioned",
            "id": 3336503981,
            "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MzMzNjUwMzk4MQ==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/3336503981"
        },
        {
            "actor": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/486017?v=4",
                "events_url": "https://api.github.com/users/robertwb/events{/privacy}",
                "followers_url": "https://api.github.com/users/robertwb/followers",
                "following_url": "https://api.github.com/users/robertwb/following{/other_user}",
                "gists_url": "https://api.github.com/users/robertwb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/robertwb",
                "id": 486017,
                "login": "robertwb",
                "node_id": "MDQ6VXNlcjQ4NjAxNw==",
                "organizations_url": "https://api.github.com/users/robertwb/orgs",
                "received_events_url": "https://api.github.com/users/robertwb/received_events",
                "repos_url": "https://api.github.com/users/robertwb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/robertwb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/robertwb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/robertwb"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2020-05-14T13:03:41Z",
            "event": "subscribed",
            "id": 3336503985,
            "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDMzMzY1MDM5ODU=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/3336503985"
        },
        {
            "actor": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1190450?v=4",
                "events_url": "https://api.github.com/users/NicolasHug/events{/privacy}",
                "followers_url": "https://api.github.com/users/NicolasHug/followers",
                "following_url": "https://api.github.com/users/NicolasHug/following{/other_user}",
                "gists_url": "https://api.github.com/users/NicolasHug/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/NicolasHug",
                "id": 1190450,
                "login": "NicolasHug",
                "node_id": "MDQ6VXNlcjExOTA0NTA=",
                "organizations_url": "https://api.github.com/users/NicolasHug/orgs",
                "received_events_url": "https://api.github.com/users/NicolasHug/received_events",
                "repos_url": "https://api.github.com/users/NicolasHug/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/NicolasHug/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/NicolasHug/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/NicolasHug"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2020-05-14T14:13:21Z",
            "event": "mentioned",
            "id": 3336816123,
            "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MzMzNjgxNjEyMw==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/3336816123"
        },
        {
            "actor": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1190450?v=4",
                "events_url": "https://api.github.com/users/NicolasHug/events{/privacy}",
                "followers_url": "https://api.github.com/users/NicolasHug/followers",
                "following_url": "https://api.github.com/users/NicolasHug/following{/other_user}",
                "gists_url": "https://api.github.com/users/NicolasHug/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/NicolasHug",
                "id": 1190450,
                "login": "NicolasHug",
                "node_id": "MDQ6VXNlcjExOTA0NTA=",
                "organizations_url": "https://api.github.com/users/NicolasHug/orgs",
                "received_events_url": "https://api.github.com/users/NicolasHug/received_events",
                "repos_url": "https://api.github.com/users/NicolasHug/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/NicolasHug/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/NicolasHug/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/NicolasHug"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2020-05-14T14:13:21Z",
            "event": "subscribed",
            "id": 3336816129,
            "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDMzMzY4MTYxMjk=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/3336816129"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2020-05-14T14:26:36Z",
            "event": "mentioned",
            "id": 3336879065,
            "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MzMzNjg3OTA2NQ==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/3336879065"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2020-05-14T14:26:36Z",
            "event": "subscribed",
            "id": 3336879069,
            "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDMzMzY4NzkwNjk=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/3336879069"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2987/events",
    "html_url": "https://github.com/cython/cython/issues/2987",
    "id": 453655230,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2987/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU0NTM2NTUyMzA=",
    "number": 2987,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "prange generates unnecessary python interactions when indexing a 2d view",
    "updated_at": "2020-05-14T14:26:36Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2987",
    "user": {
        "avatar_url": "https://avatars2.githubusercontent.com/u/1190450?v=4",
        "events_url": "https://api.github.com/users/NicolasHug/events{/privacy}",
        "followers_url": "https://api.github.com/users/NicolasHug/followers",
        "following_url": "https://api.github.com/users/NicolasHug/following{/other_user}",
        "gists_url": "https://api.github.com/users/NicolasHug/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/NicolasHug",
        "id": 1190450,
        "login": "NicolasHug",
        "node_id": "MDQ6VXNlcjExOTA0NTA=",
        "organizations_url": "https://api.github.com/users/NicolasHug/orgs",
        "received_events_url": "https://api.github.com/users/NicolasHug/received_events",
        "repos_url": "https://api.github.com/users/NicolasHug/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/NicolasHug/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/NicolasHug/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/NicolasHug"
    }
}