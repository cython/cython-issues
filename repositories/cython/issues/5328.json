{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nI'm generating ufuncs for my fortran library by the new version 3.0.0b1 of cython, using the @cython.ufunc function decorator.\r\nI declare the function as nogil. and call it in python script. It works fine when the input array length is less than 500. When the input array length is greater than 500, it stops and throws a thread error.\r\n```\r\nFatal Python error: PyEval_SaveThread: the function must be called with the GIL held, but the GIL is released (the current Python thread state is NULL)\r\nPython runtime state: initialized\r\n```\r\nI'm using the mingw-w64 compiler provided by msys2 on windows, but that doesn't seem to be the cause of the error. I transferred the program to an ubuntu machine and found the same error.\n\n### Code to reproduce the behaviour:\n\n```cython\r\n# test_ufunc.pyx\r\ncimport cython\r\n\r\n@cython.ufunc\r\ncdef double add_one(double x) nogil:\r\n    return x+1\r\n```\r\n\r\n```python\r\nimport test_ufunc\r\nimport numpy as np\r\n\r\nx=np.linspace(-1,1,501)\r\nx_add=test_ufunc.add_one(x)\r\nprint(x_add)\r\n```\n\n### Expected behaviour\n\nNo errors, result returns successfully.\n\n### OS\n\nUbuntu and Windows\n\n### Python version\n\n3.10.6 (Ubuntu), 3.11.2 (Windows)\n\n### Cython version\n\n3.0.0b1\n\n### Additional context\n\n_No response_",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "So it looks like I misunderstood ufuncs and the GIL. I'd assumed that it was up to the user to release the GIL in a ufunc (on the basis that they'd documented macros to do so https://numpy.org/doc/stable/reference/c-api/ufunc.html#macros). But it looks like Numpy releases it automatically. It only becomes an issue for large arrays though.\r\n\r\nIt also looks like I wasn't the only one to find this confusing https://github.com/numpy/numpy/issues/2067.\r\n\r\nShould be fairly easy to fix I think.\r\n\r\nThanks for the report\r\n",
            "created_at": "2023-03-21T08:33:10Z",
            "html_url": "https://github.com/cython/cython/issues/5328#issuecomment-1477443317",
            "id": 1477443317,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5328",
            "node_id": "IC_kwDOABDGAc5YD_71",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1477443317/reactions"
            },
            "updated_at": "2023-03-21T08:33:29Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1477443317",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5328/comments",
    "created_at": "2023-03-21T05:59:25Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5328/events",
    "html_url": "https://github.com/cython/cython/issues/5328",
    "id": 1633279368,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5328/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5hWd2I",
    "number": 5328,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5328/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5328/timeline",
    "title": "Fatal Python error: PyEval_SaveThread when creating ufunc with nogil [BUG] ",
    "updated_at": "2023-03-21T08:33:29Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5328",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/50480607?v=4",
        "events_url": "https://api.github.com/users/hiyominato/events{/privacy}",
        "followers_url": "https://api.github.com/users/hiyominato/followers",
        "following_url": "https://api.github.com/users/hiyominato/following{/other_user}",
        "gists_url": "https://api.github.com/users/hiyominato/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/hiyominato",
        "id": 50480607,
        "login": "hiyominato",
        "node_id": "MDQ6VXNlcjUwNDgwNjA3",
        "organizations_url": "https://api.github.com/users/hiyominato/orgs",
        "received_events_url": "https://api.github.com/users/hiyominato/received_events",
        "repos_url": "https://api.github.com/users/hiyominato/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/hiyominato/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/hiyominato/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/hiyominato"
    }
}