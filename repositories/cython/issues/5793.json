{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Describe the bug\n\nHello everyone,\r\n\r\nI was trying to compile a class with a `cdef object __weakref__` attribute in the limited api and it crashes with:\r\n\r\n```\r\nclang -Wsign-compare -Wunreachable-code -fno-common -dynamic -DNDEBUG -g -fwrapv -O3 -Wall -isysroot /Library/Developer/CommandLineTools/SDKs/MacOSX14.sdk -DCYTHON_LIMITED_API=1 -DPy_LIMITED_API=0x030B0000 -I/private/var/folders/l4/gpyzwv455hzbmbv78x05555h0000gn/T/build-env-x8r7d7re/include -I/opt/homebrew/opt/python@3.11/Frameworks/Python.framework/Versions/3.11/include/python3.11 -c limited_weakref.cpp -o build/temp.macosx-14-arm64-cpython-311/limited_weakref.o\r\nlimited_weakref.cpp:3707:38: error: member access into incomplete type 'PyTypeObject' (aka '_typeobject')\r\n  if (__pyx_ptype_15limited_weakref_A->tp_weaklistoffset == 0) __pyx_ptype_15limited_weakref_A->tp_weaklistoffset = offsetof(struct __pyx_obj_15limited_weakref_A, __weakref__);\r\n                                     ^\r\n/opt/homebrew/opt/python@3.11/Frameworks/Python.framework/Versions/3.11/include/python3.11/pytypedefs.h:20:16: note: forward declaration of '_typeobject'\r\ntypedef struct _typeobject PyTypeObject;\r\n               ^\r\nlimited_weakref.cpp:3707:95: error: member access into incomplete type 'PyTypeObject' (aka '_typeobject')\r\n  if (__pyx_ptype_15limited_weakref_A->tp_weaklistoffset == 0) __pyx_ptype_15limited_weakref_A->tp_weaklistoffset = offsetof(struct __pyx_obj_15limited_weakref_A, __weakref__);\r\n                                                                                              ^\r\n/opt/homebrew/opt/python@3.11/Frameworks/Python.framework/Versions/3.11/include/python3.11/pytypedefs.h:20:16: note: forward declaration of '_typeobject'\r\ntypedef struct _typeobject PyTypeObject;\r\n               ^\r\n2 errors generated.\r\nerror: command '/usr/bin/clang' failed with exit code 1\r\n```\r\n\r\n-Andreas\n\n### Code to reproduce the behaviour:\n\n```cython\r\n# limited_weakref.pyx\r\n\r\ncdef class A:\r\n    cdef object __weakref__\r\n```\n\n### Expected behaviour\n\nIt should compile.\n\n### OS\n\n_No response_\n\n### Python version\n\n_No response_\n\n### Cython version\n\n_No response_\n\n### Additional context\n\nThe relevant compiler code seems to be here: https://github.com/cython/cython/blob/bc32b7ec3f15f532c0ae59b930544c23172e8c50/Cython/Compiler/Nodes.py#L5817-L5831",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I think the solution here would be to add `__weakref__` to `Py_tp_members` (or possibly to use `[Py_TPFLAGS_MANAGED_WEAKREF](https://docs.python.org/3/c-api/typeobj.html#c.Py_TPFLAGS_MANAGED_WEAKREF)` if the version of Python is high enough).\r\n\r\n> If it is not possible to switch to a MANAGED flag (for example, for vectorcall or to support Python older than 3.12), specify the offset in [Py_tp_members](https://docs.python.org/3/c-api/typeobj.html#c.PyTypeObject.tp_members).\r\n\r\n(https://docs.python.org/3/c-api/type.html#c.PyType_Slot.slot)\r\n\r\nUnfortunately that doesn't do the \"already set\" check that our current code does so it isn't identical, but that's an edge case that I don't think we can cover with the limited API.\r\n\r\n-----------------------------------------------\r\n\r\nIt's probably worth using the MANAGED flags (for both `__dict__` and `__weakref__`) in the regular API too on suitable Python versions and in the common case where we aren't inheriting from an extern class or builtin. In this case we know that we don't need the \"already set\" check. And I think Python is hoping that this'll be the optimized structure in future.\r\n\r\n--------------------------------------------\r\n\r\nIt's all slightly fiddly though because it's generating code in multiple places.",
            "created_at": "2023-11-04T16:47:36Z",
            "html_url": "https://github.com/cython/cython/issues/5793#issuecomment-1793493275",
            "id": 1793493275,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5793",
            "node_id": "IC_kwDOABDGAc5q5okb",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1793493275/reactions"
            },
            "updated_at": "2023-11-04T16:48:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1793493275",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5793/comments",
    "created_at": "2023-11-04T11:33:36Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1463443?v=4",
                "events_url": "https://api.github.com/users/ap--/events{/privacy}",
                "followers_url": "https://api.github.com/users/ap--/followers",
                "following_url": "https://api.github.com/users/ap--/following{/other_user}",
                "gists_url": "https://api.github.com/users/ap--/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ap--",
                "id": 1463443,
                "login": "ap--",
                "node_id": "MDQ6VXNlcjE0NjM0NDM=",
                "organizations_url": "https://api.github.com/users/ap--/orgs",
                "received_events_url": "https://api.github.com/users/ap--/received_events",
                "repos_url": "https://api.github.com/users/ap--/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ap--/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ap--/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ap--"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-11-04T11:35:24Z",
            "event": "renamed",
            "id": 10862552591,
            "node_id": "RTE_lADOABDGAc512xgHzwAAAAKHdWYP",
            "performed_via_github_app": null,
            "rename": {
                "from": "[BUG] classes with `__weakref__` don't compile",
                "to": "[BUG] classes with `__weakref__` don't compile in the limited api"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/10862552591"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1463443?v=4",
                "events_url": "https://api.github.com/users/ap--/events{/privacy}",
                "followers_url": "https://api.github.com/users/ap--/followers",
                "following_url": "https://api.github.com/users/ap--/following{/other_user}",
                "gists_url": "https://api.github.com/users/ap--/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ap--",
                "id": 1463443,
                "login": "ap--",
                "node_id": "MDQ6VXNlcjE0NjM0NDM=",
                "organizations_url": "https://api.github.com/users/ap--/orgs",
                "received_events_url": "https://api.github.com/users/ap--/received_events",
                "repos_url": "https://api.github.com/users/ap--/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ap--/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ap--/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ap--"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-11-04T11:35:44Z",
            "event": "renamed",
            "id": 10862553055,
            "node_id": "RTE_lADOABDGAc512xgHzwAAAAKHdWff",
            "performed_via_github_app": null,
            "rename": {
                "from": "[BUG] classes with `__weakref__` don't compile in the limited api",
                "to": "[BUG] classes with `__weakref__` don't compile using the limited api"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/10862553055"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5793/events",
    "html_url": "https://github.com/cython/cython/issues/5793",
    "id": 1977292807,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5793/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc512xgH",
    "number": 5793,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5793/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5793/timeline",
    "title": "[BUG] classes with `__weakref__` don't compile using the limited api",
    "updated_at": "2023-11-04T16:48:09Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5793",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1463443?v=4",
        "events_url": "https://api.github.com/users/ap--/events{/privacy}",
        "followers_url": "https://api.github.com/users/ap--/followers",
        "following_url": "https://api.github.com/users/ap--/following{/other_user}",
        "gists_url": "https://api.github.com/users/ap--/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ap--",
        "id": 1463443,
        "login": "ap--",
        "node_id": "MDQ6VXNlcjE0NjM0NDM=",
        "organizations_url": "https://api.github.com/users/ap--/orgs",
        "received_events_url": "https://api.github.com/users/ap--/received_events",
        "repos_url": "https://api.github.com/users/ap--/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ap--/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ap--/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ap--"
    }
}