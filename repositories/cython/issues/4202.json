{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "<!--\r\n**PLEASE READ THIS FIRST:**\r\n- Do not use the bug and feature tracker for support requests. Use the `cython-users` mailing list instead.\r\n- Did you search for similar issues already? Please do, it helps to save us precious time that we otherwise could not invest into development.\r\n- Did you try the latest master branch or pre-release? It might already have what you want to report. Also see the [Changelog](https://github.com/cython/cython/blob/master/CHANGES.rst) regarding recent changes.\r\n-->\r\n\r\n**Describe the bug**\r\n\r\nI build Cython using `pip wheel .` on [GitHub Actions](https://github.com/imba-tjd/build-cython/blob/master/.github/workflows/build.yml) windows.\r\n\r\nBuild failed after this commit https://github.com/cython/cython/commit/70be8d1bd837f4c0995456be343046ea96a3915d\r\n\r\nI tried building on GitHub Codespaces (Ubuntu 20) also by using `pip wheel .` and it succeed, so I think the build failure on Win is not expected.\r\n\r\n```\r\n  running build_ext\r\n  building 'Cython.Plex.Scanners' extension\r\n  creating build\\temp.win-amd64-3.9\r\n  creating build\\temp.win-amd64-3.9\\Release\r\n  creating build\\temp.win-amd64-3.9\\Release\\Users\r\n  creating build\\temp.win-amd64-3.9\\Release\\Users\\runneradmin\r\n  creating build\\temp.win-amd64-3.9\\Release\\Users\\runneradmin\\AppData\r\n  creating build\\temp.win-amd64-3.9\\Release\\Users\\runneradmin\\AppData\\Local\r\n  creating build\\temp.win-amd64-3.9\\Release\\Users\\runneradmin\\AppData\\Local\\Temp\r\n  creating build\\temp.win-amd64-3.9\\Release\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\r\n  creating build\\temp.win-amd64-3.9\\Release\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\r\n  creating build\\temp.win-amd64-3.9\\Release\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\r\n  C:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Enterprise\\VC\\Tools\\MSVC\\14.28.29910\\bin\\HostX86\\x64\\cl.exe /c /nologo /Ox /W3 /GL /DNDEBUG /MD -Ic:\\hostedtoolcache\\windows\\python\\3.9.5\\x64\\include -Ic:\\hostedtoolcache\\windows\\python\\3.9.5\\x64\\include -IC:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Enterprise\\VC\\Tools\\MSVC\\14.28.29910\\ATLMFC\\include -IC:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Enterprise\\VC\\Tools\\MSVC\\14.28.29910\\include -IC:\\Program Files (x86)\\Windows Kits\\NETFXSDK\\4.8\\include\\um -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.19041.0\\ucrt -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.19041.0\\shared -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.19041.0\\um -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.19041.0\\winrt -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.19041.0\\cppwinrt /TcC:\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\\Scanners.c /Fobuild\\temp.win-amd64-3.9\\Release\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\\Scanners.obj\r\n  Scanners.c\r\n  C:\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\\Scanners.c(11284): warning C4002: too many arguments for function-like macro invocation '__Pyx_Py_XDECREF_SET'\r\n  C:\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\\Scanners.c(11284): error C2121: '#': invalid character: possibly the result of a macro expansion\r\n  C:\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\\Scanners.c(11284): error C2059: syntax error: 'if'\r\n  C:\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\\Scanners.c(11284): error C2143: syntax error: missing ';' before '<'\r\n  C:\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\\Scanners.c(11276): error C2064: term does not evaluate to a function taking 347 arguments\r\n  C:\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\\Scanners.c(11284): error C2059: syntax error: 'else'\r\n  error: command 'C:\\\\Program Files (x86)\\\\Microsoft Visual Studio\\\\2019\\\\Enterprise\\\\VC\\\\Tools\\\\MSVC\\\\14.28.29910\\\\bin\\\\HostX86\\\\x64\\\\cl.exe' failed with exit code 2\r\n```\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Windows\r\n - Python version 3.9\r\n - Cython version master (3.0a7+)\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "COLLABORATOR",
            "body": "Thanks. It looks to be broken on our Windows Appveyor build too https://ci.appveyor.com/project/cython/cython/build/job/t1ym242ryqlofokd, so it isn't just you. (I guess it'd be nice if the Appveyor build was a bit more visible in Github so this kind of thing got noticed a bit quicker)",
            "created_at": "2021-05-30T11:49:14Z",
            "html_url": "https://github.com/cython/cython/issues/4202#issuecomment-850987029",
            "id": 850987029,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4202",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg1MDk4NzAyOQ==",
            "performed_via_github_app": null,
            "updated_at": "2021-05-30T11:49:14Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/850987029",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "The last \"working\" Appveyor build was https://ci.appveyor.com/project/cython/cython/builds/39311244, although there's a few that didn't get run so it's difficult to pin down the exact point it broke",
            "created_at": "2021-05-30T11:51:10Z",
            "html_url": "https://github.com/cython/cython/issues/4202#issuecomment-850987312",
            "id": 850987312,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4202",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg1MDk4NzMxMg==",
            "performed_via_github_app": null,
            "updated_at": "2021-05-30T11:51:10Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/850987312",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "~Could you attach C:\\Users\\runneradmin\\AppData\\Local\\Temp\\pip-req-build-3mnsp_ju\\Cython\\Plex\\Scanners.c (if it still exists)? I'm struggling to match up line numbers to the file generated by my PC (on Linux)~\r\n\r\nIgnore this... I think I've got it",
            "created_at": "2021-05-30T11:59:01Z",
            "html_url": "https://github.com/cython/cython/issues/4202#issuecomment-850988350",
            "id": 850988350,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4202",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg1MDk4ODM1MA==",
            "performed_via_github_app": null,
            "updated_at": "2021-05-30T12:11:10Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/850988350",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "Right... I think the problem is:\r\n\r\n```\r\n/* CythonFunctionShared */\r\nstatic CYTHON_INLINE void __Pyx__CyFunction_SetClassObj(__pyx_CyFunctionObject* f, PyObject* classobj) {\r\n    __Pyx_Py_XDECREF_SET(\r\n#if PY_VERSION_HEX < 0x030900B1\r\n        __Pyx_CyFunction_GetClassObj(f),\r\n#else\r\n        ((PyCMethodObject *) (f))->mm_class,\r\n        (PyTypeObject*)\r\n#endif\r\n            ((classobj) ? __Pyx_NewRef(classobj) : NULL)\r\n    );\r\n}\r\n```\r\n\r\nHere's a simplified example: https://godbolt.org/z/TcTd7x3q5. MSVC doesn't like `#if/#else` in a macro call while GCC is happy with it",
            "created_at": "2021-05-30T12:10:18Z",
            "html_url": "https://github.com/cython/cython/issues/4202#issuecomment-850989926",
            "id": 850989926,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4202",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg1MDk4OTkyNg==",
            "performed_via_github_app": null,
            "updated_at": "2021-05-30T12:10:18Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/850989926",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4202/comments",
    "created_at": "2021-05-30T11:45:44Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": "e7dda9bad53b86d849e63672fb0f75a7fc325307",
            "commit_url": "https://api.github.com/repos/da-woods/cython/commits/e7dda9bad53b86d849e63672fb0f75a7fc325307",
            "created_at": "2021-05-30T12:20:52Z",
            "event": "referenced",
            "id": 4817079658,
            "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDQ4MTcwNzk2NTg=",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/4817079658"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4202/events",
    "html_url": "https://github.com/cython/cython/issues/4202",
    "id": 906729043,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4202/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU5MDY3MjkwNDM=",
    "number": 4202,
    "performed_via_github_app": null,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "[BUG] Build failed on Windows",
    "updated_at": "2021-05-30T12:11:10Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4202",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/24759802?v=4",
        "events_url": "https://api.github.com/users/imba-tjd/events{/privacy}",
        "followers_url": "https://api.github.com/users/imba-tjd/followers",
        "following_url": "https://api.github.com/users/imba-tjd/following{/other_user}",
        "gists_url": "https://api.github.com/users/imba-tjd/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/imba-tjd",
        "id": 24759802,
        "login": "imba-tjd",
        "node_id": "MDQ6VXNlcjI0NzU5ODAy",
        "organizations_url": "https://api.github.com/users/imba-tjd/orgs",
        "received_events_url": "https://api.github.com/users/imba-tjd/received_events",
        "repos_url": "https://api.github.com/users/imba-tjd/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/imba-tjd/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/imba-tjd/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/imba-tjd"
    }
}