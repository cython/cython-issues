{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "**Describe the bug**\r\n\r\nSome linkage/hierarchical clustering methods fail for some combination of parameters, as noticed by https://github.com/scikit-learn/scikit-learn/pull/19562#issuecomment-800264542.\r\n\r\n**To Reproduce**\r\nModified from [@tliu68's reproducer](https://gist.github.com/tliu68/ff8a7dfd076ec9311f6486e992dc1576):\r\n```cython\r\nimport numpy as np\r\nfrom sklearn.datasets import make_blobs\r\nfrom sklearn.utils._testing import create_memmap_backed_data\r\nfrom sklearn.cluster import AgglomerativeClustering\r\n\r\nX, y = make_blobs(n_samples=50, random_state=1)\r\nX, y = create_memmap_backed_data([X, y])\r\n\r\n# does not fail\r\nag = AgglomerativeClustering(n_clusters=3)\r\nag.fit(X)\r\n\r\n# fails\r\nag = AgglomerativeClustering(affinity=\"euclidean\", linkage=\"single\")\r\nag.fit(X)\r\n```\r\n\r\n<details>\r\n<summary> Reproducer Full trace </summary>\r\n\r\n<pre>\r\n---------------------------------------------------------------------------\r\nValueError                                Traceback (most recent call last)\r\n<ipython-input-11-aafe80706453> in <module>\r\n----> 1 ag.fit(X)\r\n\r\n~/dev/scikit-learn/sklearn/cluster/_agglomerative.py in fit(self, X, y)\r\n    895         )\r\n    896 \r\n--> 897         out = memory.cache(tree_builder)(X, connectivity=connectivity,\r\n    898                                          n_clusters=n_clusters,\r\n    899                                          return_distance=return_distance,\r\n\r\n~/.virtualenvs/sk/lib64/python3.9/site-packages/joblib/memory.py in __call__(self, *args, **kwargs)\r\n    350 \r\n    351     def __call__(self, *args, **kwargs):\r\n--> 352         return self.func(*args, **kwargs)\r\n    353 \r\n    354     def call_and_shelve(self, *args, **kwargs):\r\n\r\n~/dev/scikit-learn/sklearn/cluster/_agglomerative.py in _single_linkage(*args, **kwargs)\r\n    617 def _single_linkage(*args, **kwargs):\r\n    618     kwargs['linkage'] = 'single'\r\n--> 619     return linkage_tree(*args, **kwargs)\r\n    620 \r\n    621 \r\n\r\n~/dev/scikit-learn/sklearn/cluster/_agglomerative.py in linkage_tree(X, connectivity, n_clusters, linkage, affinity, return_distance)\r\n    484             X = np.ascontiguousarray(X, dtype=np.double)\r\n    485 \r\n--> 486             mst = _hierarchical.mst_linkage_core(X, dist_metric)\r\n    487             # Sort edges of the min_spanning_tree by weight\r\n    488             mst = mst[np.argsort(mst.T[2], kind='mergesort'), :]\r\n\r\n~/dev/scikit-learn/sklearn/cluster/_hierarchical_fast.pyx in sklearn.cluster._hierarchical_fast.mst_linkage_core()\r\n    456 @cython.nonecheck(False)\r\n    457 def mst_linkage_core(\r\n--> 458         DTYPE_t [:, ::1] raw_data,\r\n    459         DistanceMetric dist_metric):\r\n    460     \"\"\"\r\n\r\n~/dev/scikit-learn/sklearn/cluster/_hierarchical_fast.cpython-39-x86_64-linux-gnu.so in View.MemoryView.memoryview_cwrapper()\r\n\r\n~/dev/scikit-learn/sklearn/cluster/_hierarchical_fast.cpython-39-x86_64-linux-gnu.so in View.MemoryView.memoryview.__cinit__()\r\n\r\nValueError: buffer source array is read-only\r\n</pre>\r\n\r\n</details>\r\n\r\n**Expected behavior**\r\n\r\nLinkage/Hierarchical clustering methods should support readonly memmapped datasets\r\n\r\n**Additional context**\r\n\r\nLinkage/Hierarchical clustering methods rely on Cython.\r\nYet, those implementations in python do not support `const` memory view obtained by coercion of readonly memmapped datasets (mainly because `const` memory view with fused tupe were not implemented within cython at that time). \r\n\r\nIt should be fixable using `const` memory view.\r\n\r\n**Environment:**\r\n - OS: Linux 5.11.11-200.fc33.x86_64\r\n - Python version: 3.8, 3.9\r\n - Cython version: 0.29.21",
    "closed_at": "2021-04-13T08:53:19Z",
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "Wrong repository ðŸ¤¦",
            "created_at": "2021-04-13T08:53:19Z",
            "html_url": "https://github.com/cython/cython/issues/4114#issuecomment-818569088",
            "id": 818569088,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4114",
            "node_id": "MDEyOklzc3VlQ29tbWVudDgxODU2OTA4OA==",
            "performed_via_github_app": null,
            "updated_at": "2021-04-13T08:53:19Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/818569088",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13029839?v=4",
                "events_url": "https://api.github.com/users/jjerphan/events{/privacy}",
                "followers_url": "https://api.github.com/users/jjerphan/followers",
                "following_url": "https://api.github.com/users/jjerphan/following{/other_user}",
                "gists_url": "https://api.github.com/users/jjerphan/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jjerphan",
                "id": 13029839,
                "login": "jjerphan",
                "node_id": "MDQ6VXNlcjEzMDI5ODM5",
                "organizations_url": "https://api.github.com/users/jjerphan/orgs",
                "received_events_url": "https://api.github.com/users/jjerphan/received_events",
                "repos_url": "https://api.github.com/users/jjerphan/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jjerphan/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jjerphan/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jjerphan"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4114/comments",
    "created_at": "2021-04-13T08:52:13Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/13029839?v=4",
                "events_url": "https://api.github.com/users/jjerphan/events{/privacy}",
                "followers_url": "https://api.github.com/users/jjerphan/followers",
                "following_url": "https://api.github.com/users/jjerphan/following{/other_user}",
                "gists_url": "https://api.github.com/users/jjerphan/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jjerphan",
                "id": 13029839,
                "login": "jjerphan",
                "node_id": "MDQ6VXNlcjEzMDI5ODM5",
                "organizations_url": "https://api.github.com/users/jjerphan/orgs",
                "received_events_url": "https://api.github.com/users/jjerphan/received_events",
                "repos_url": "https://api.github.com/users/jjerphan/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jjerphan/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jjerphan/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jjerphan"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-04-13T08:53:19Z",
            "event": "closed",
            "id": 4586744145,
            "node_id": "MDExOkNsb3NlZEV2ZW50NDU4Njc0NDE0NQ==",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/4586744145"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4114/events",
    "html_url": "https://github.com/cython/cython/issues/4114",
    "id": 856741561,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4114/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU4NTY3NDE1NjE=",
    "number": 4114,
    "performed_via_github_app": null,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "[BUG] Linkage/Hierarchical clustering methods fail on readonly memmapped datasets",
    "updated_at": "2021-04-13T08:53:20Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4114",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/13029839?v=4",
        "events_url": "https://api.github.com/users/jjerphan/events{/privacy}",
        "followers_url": "https://api.github.com/users/jjerphan/followers",
        "following_url": "https://api.github.com/users/jjerphan/following{/other_user}",
        "gists_url": "https://api.github.com/users/jjerphan/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/jjerphan",
        "id": 13029839,
        "login": "jjerphan",
        "node_id": "MDQ6VXNlcjEzMDI5ODM5",
        "organizations_url": "https://api.github.com/users/jjerphan/orgs",
        "received_events_url": "https://api.github.com/users/jjerphan/received_events",
        "repos_url": "https://api.github.com/users/jjerphan/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/jjerphan/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jjerphan/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/jjerphan"
    }
}