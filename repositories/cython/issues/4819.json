{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "**Is your feature request related to a problem? Please describe.**\r\n\r\nSuppose you have a comparison of an untyped variable with an int\r\n\r\n```cython\r\ndef f(x):\r\n    if x == 1:\r\n        return \"xxx\"\r\n```\r\n\r\nCython assumes that `x` is likely an int and has an optimized function to compare it to the C value `1` (`__Pyx_PyInt_EqObjC`). However this function returns a Python `True`/`False` object. In this case (which I imagine is fairly common) the value is fed to an `if` statement and so is immediately converted to a C True/False value:\r\n\r\n```\r\n__pyx_t_1 = __Pyx_PyInt_EqObjC(__pyx_v_x, __pyx_int_1, 1, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 2, __pyx_L1_error)\r\n__Pyx_GOTREF(__pyx_t_1);\r\n__pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_2 < 0))) __PYX_ERR(0, 2, __pyx_L1_error)\r\n__Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;\r\n```\r\n\r\n**Describe the solution you'd like**\r\n\r\nIt'd be nice to be able to skip this PyObject intermediate. It'd be needed only in the fallback case right at the end of `__Pyx_PyInt_EqObjC`.\r\n\r\nI imagine there's other similar optimized comparison functions that would also benefit from skipping the PyObject intermediate in the event that they're fed immediately to a C if statement (but I haven't looked in detail).\r\n\r\n----------------------------\r\n\r\n- [x] comparison - #4821\r\n- [ ] arithmetic",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I can see why this doesn't work - `OptimizeBuiltinCallsTransform` can't easily change the return type. There's a similar failure to optimize in `cdef int y = x + 1`",
            "created_at": "2022-06-02T06:53:48Z",
            "html_url": "https://github.com/cython/cython/issues/4819#issuecomment-1144506616",
            "id": 1144506616,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4819",
            "node_id": "IC_kwDOABDGAc5EN8j4",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1144506616/reactions"
            },
            "updated_at": "2022-06-02T06:53:48Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1144506616",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "The transform also handles CoerceFromPyTypeNode and calls coerce_to() in some cases. As long as there is a known C integer result type (so that we can safely assume a valid integer range for the result), coercion could change the return type after the fact by replacing the implementation again.\n",
            "created_at": "2022-06-02T09:09:26Z",
            "html_url": "https://github.com/cython/cython/issues/4819#issuecomment-1144631214",
            "id": 1144631214,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4819",
            "node_id": "IC_kwDOABDGAc5EOa-u",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1144631214/reactions"
            },
            "updated_at": "2022-06-02T09:09:26Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1144631214",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4819/comments",
    "created_at": "2022-06-01T22:12:24Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": "331eb87091017f7a377148949287bdd212a45ee2",
            "commit_url": "https://api.github.com/repos/da-woods/cython/commits/331eb87091017f7a377148949287bdd212a45ee2",
            "created_at": "2022-06-02T07:50:03Z",
            "event": "referenced",
            "id": 6726189818,
            "node_id": "REFE_lADOABDGAc5K7rlNzwAAAAGQ6YL6",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6726189818"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": "39a4862e5f52ac0872edca34786ae02210125ed4",
            "commit_url": "https://api.github.com/repos/da-woods/cython/commits/39a4862e5f52ac0872edca34786ae02210125ed4",
            "created_at": "2022-06-02T07:51:19Z",
            "event": "referenced",
            "id": 6726198197,
            "node_id": "REFE_lADOABDGAc5K7rlNzwAAAAGQ6aO1",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6726198197"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": "69b6107922efe895f83441b4b9d4dd64ff3d46b6",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/69b6107922efe895f83441b4b9d4dd64ff3d46b6",
            "created_at": "2023-01-23T21:39:40Z",
            "event": "referenced",
            "id": 8338481829,
            "node_id": "REFE_lADOABDGAc5K7rlNzwAAAAHxAyKl",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/8338481829"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4819/events",
    "html_url": "https://github.com/cython/cython/issues/4819",
    "id": 1257158989,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4819/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5K7rlN",
    "number": 4819,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4819/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4819/timeline",
    "title": "[ENH] Missed optimization in untyped int comparison",
    "updated_at": "2023-01-23T21:41:24Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4819",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
        "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
        "followers_url": "https://api.github.com/users/da-woods/followers",
        "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
        "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/da-woods",
        "id": 10536947,
        "login": "da-woods",
        "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
        "organizations_url": "https://api.github.com/users/da-woods/orgs",
        "received_events_url": "https://api.github.com/users/da-woods/received_events",
        "repos_url": "https://api.github.com/users/da-woods/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/da-woods"
    }
}