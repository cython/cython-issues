{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Describe the bug\r\n\r\nWhen raising an exception within cython nogil function returning pointer value following error is raised:\r\n\r\n```\r\nCompiling /Users/matus/dev/cython/test/nogil.pyx because it changed.\r\n[1/1] Cythonizing /Users/matus/dev/cython/test/nogil.pyx\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\n\r\ncdef int *bar() nogil:\r\n    raise ValueError\r\n    ^\r\n------------------------------------------------------------\r\n\r\nnogil.pyx:10:4: Raising exception not allowed without gil\r\nTraceback (most recent call last):\r\n  File \"/Users/matus/dev/cython39/bin/cythonize\", line 33, in <module>\r\n    sys.exit(load_entry_point('Cython', 'console_scripts', 'cythonize')())\r\n  File \"/Users/matus/dev/cython/Cython/Build/Cythonize.py\", line 243, in main\r\n    _cython_compile_files(all_paths, options)\r\n  File \"/Users/matus/dev/cython/Cython/Build/Cythonize.py\", line 70, in _cython_compile_files\r\n    ext_modules = cythonize(\r\n  File \"/Users/matus/dev/cython/Cython/Build/Dependencies.py\", line 1134, in cythonize\r\n    cythonize_one(*args)\r\n  File \"/Users/matus/dev/cython/Cython/Build/Dependencies.py\", line 1301, in cythonize_one\r\n    raise CompileError(None, pyx_file)\r\nCython.Compiler.Errors.CompileError: /Users/matus/dev/cython/test/nogil.pyx\r\n```\r\n\r\n### Code to reproduce the behaviour:\r\n\r\n```cython\r\ncdef int *bar() nogil:\r\n    raise ValueError\r\n\r\nbar()\r\n```\r\n\r\n\r\n### Expected behaviour\r\n\r\nCompilation is successful\r\n\r\n### OS\r\n\r\nMacOS\r\n\r\n### Python version\r\n\r\n3.9\r\n\r\n### Cython version\r\n\r\nmaster\r\n\r\n### Additional context\r\n\r\nCompilation is successful for pure-python variant of example:\r\n```python\r\nimport cython\r\n\r\n@cython.cfunc\r\n@cython.nogil\r\ndef bar() -> cython.p_int:\r\n    raise ValueError\r\n\r\nbar()\r\n```\r\n\r\nAlso compilation is successful when function returns simple value (instead of pointer):\r\n```cython\r\ncdef int bar() nogil:\r\n    raise ValueError\r\n\r\nbar()\r\n```\r\n\r\nThis bug is also present in Cython 0.29.X.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "OK I found the reason why it fails when function returns pointer. In this line \r\n\r\nhttps://github.com/cython/cython/blob/0713b78ac3b2619d056792e75d42e67e933f8ffa/Cython/Compiler/ParseTreeTransforms.py#L3480\r\n\r\n`node.declarator` is instance of `Cython.Compiler.Nodes.CPtrDeclaratorNode` in case when function returns pointer. Hence `self.nogil` is kept set to `False`. This causes that `GILStatNode` is not called:\r\n\r\nhttps://github.com/cython/cython/blob/0713b78ac3b2619d056792e75d42e67e933f8ffa/Cython/Compiler/ParseTreeTransforms.py#L3459-L3460",
            "created_at": "2023-07-16T22:12:52Z",
            "html_url": "https://github.com/cython/cython/issues/5530#issuecomment-1637201955",
            "id": 1637201955,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5530",
            "node_id": "IC_kwDOABDGAc5hlbgj",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1637201955/reactions"
            },
            "updated_at": "2023-07-16T22:14:59Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1637201955",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/827060?v=4",
                "events_url": "https://api.github.com/users/matusvalo/events{/privacy}",
                "followers_url": "https://api.github.com/users/matusvalo/followers",
                "following_url": "https://api.github.com/users/matusvalo/following{/other_user}",
                "gists_url": "https://api.github.com/users/matusvalo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matusvalo",
                "id": 827060,
                "login": "matusvalo",
                "node_id": "MDQ6VXNlcjgyNzA2MA==",
                "organizations_url": "https://api.github.com/users/matusvalo/orgs",
                "received_events_url": "https://api.github.com/users/matusvalo/received_events",
                "repos_url": "https://api.github.com/users/matusvalo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matusvalo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matusvalo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matusvalo"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5530/comments",
    "created_at": "2023-07-16T21:49:07Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/827060?v=4",
                "events_url": "https://api.github.com/users/matusvalo/events{/privacy}",
                "followers_url": "https://api.github.com/users/matusvalo/followers",
                "following_url": "https://api.github.com/users/matusvalo/following{/other_user}",
                "gists_url": "https://api.github.com/users/matusvalo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matusvalo",
                "id": 827060,
                "login": "matusvalo",
                "node_id": "MDQ6VXNlcjgyNzA2MA==",
                "organizations_url": "https://api.github.com/users/matusvalo/orgs",
                "received_events_url": "https://api.github.com/users/matusvalo/received_events",
                "repos_url": "https://api.github.com/users/matusvalo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matusvalo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matusvalo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matusvalo"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-07-16T22:17:17Z",
            "event": "labeled",
            "id": 9831858172,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "node_id": "LE_lADOABDGAc5rsIQ7zwAAAAJKBj_8",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/9831858172"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5530/events",
    "html_url": "https://github.com/cython/cython/issues/5530",
    "id": 1806730299,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425553654,
            "name": "defect",
            "node_id": "MDU6TGFiZWw0MjU1NTM2NTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5530/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5rsIQ7",
    "number": 5530,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5530/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5530/timeline",
    "title": "[BUG] Compilation failure when raising an exception within nogil function returning pointer",
    "updated_at": "2023-07-17T06:22:29Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5530",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/827060?v=4",
        "events_url": "https://api.github.com/users/matusvalo/events{/privacy}",
        "followers_url": "https://api.github.com/users/matusvalo/followers",
        "following_url": "https://api.github.com/users/matusvalo/following{/other_user}",
        "gists_url": "https://api.github.com/users/matusvalo/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/matusvalo",
        "id": 827060,
        "login": "matusvalo",
        "node_id": "MDQ6VXNlcjgyNzA2MA==",
        "organizations_url": "https://api.github.com/users/matusvalo/orgs",
        "received_events_url": "https://api.github.com/users/matusvalo/received_events",
        "repos_url": "https://api.github.com/users/matusvalo/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/matusvalo/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/matusvalo/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/matusvalo"
    }
}