{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "<!--\r\n**Note:**\r\n- Do not use the bug and feature tracker for support requests. Use the `cython-users` mailing list instead.\r\n- Did you search for similar issues already? Please do, it helps to save us precious time that we otherwise could not invest into development.\r\n- Did you try the latest master branch or pre-release? It might already have what you want to report. Also see the [Changelog](https://github.com/cython/cython/blob/master/CHANGES.rst) regarding recent changes.\r\n-->\r\n\r\n**Is your feature request related to a problem? Please describe.**\r\nA common scenario for an extension type is to wrap a native (opaque or not) structure from some C library, e.g.\r\n```cython\r\ncdef class Spam:\r\n    cdef Ham* ham\r\n\r\n    def __dealloc__(self):\r\n        # ...\r\n\r\n    @staticmethod\r\n    cdef from_ptr(self, ham):\r\n        self = Spam.__new__(Spam)\r\n        self.ham = ham\r\n        return self\r\n```\r\n\r\nDepending on C library structure, such structures don't always have a meaningful way to implement a constructor, as such you would like them to not be constructible from Python code. \r\n\r\n**Describe the solution you'd like**\r\nFor that, the Python API supports leaving `tp_new` to `NULL`, and also added [`Py_TPFLAGS_DISALLOW_INSTANTIATION`](https://docs.python.org/3.10/c-api/typeobj.html#Py_TPFLAGS_DISALLOW_INSTANTIATION) for heap types to support this as well.\r\n\r\nWhat the Cython syntax for this should be like, I don't know. Perhaps a decorator? Note that we we likely still need to generate the `tp_new` function itself to be used to allocate the object from the generated C code, just leaving it not registered in the `PyTypeObject` itself, and possibly using `Py_TPFLAGS_DISALLOW_INSTANTIATION` when available if Cython uses heap types.\r\n\r\n**Describe alternatives you've considered**\r\nI can make an `__init__` that raises an exception, but the user can still call `__new__`, as such, the class will still have to protect itself from an uninitialized state in each function it implements, even if this is a case where it could have been avoided (e.g. A class that you can't `close()`)\r\n\r\n**Additional context**\r\nEncountered while making this: https://github.com/segevfiner/cypcap\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "There is the `@cython.internal` decorator, which at least prevents classes from showing up in the module dict. Unless you're after security and not just safety, that should usually be enough to keep users from playing with it.\r\n\r\nI can understand that this might still be useful in a few cases, though. A feature decorator should probably be adapted to those.\r\n\r\n`Py_TPFLAGS_DISALLOW_INSTANTIATION` is new in Python 3.10, so we'd have to go the `tp_new = NULL` path in older versions.",
            "created_at": "2021-11-03T13:01:08Z",
            "html_url": "https://github.com/cython/cython/issues/4429#issuecomment-959013971",
            "id": 959013971,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4429",
            "node_id": "IC_kwDOABDGAc45KWRT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/959013971/reactions"
            },
            "updated_at": "2021-11-03T13:01:08Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/959013971",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Python 3.10 sets `Py_TPFLAGS_DISALLOW_INSTANTIATION` if `tp_new` is `NULL` and you don't inherit from any class for static types but not for heap types.\r\n\r\n`@cython.internal` removes the class object from the module which prevents me from generating documentation.",
            "created_at": "2021-11-03T13:11:19Z",
            "html_url": "https://github.com/cython/cython/issues/4429#issuecomment-959037428",
            "id": 959037428,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4429",
            "node_id": "IC_kwDOABDGAc45Kb_0",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/959037428/reactions"
            },
            "updated_at": "2021-11-03T14:06:55Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/959037428",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24731903?v=4",
                "events_url": "https://api.github.com/users/segevfiner/events{/privacy}",
                "followers_url": "https://api.github.com/users/segevfiner/followers",
                "following_url": "https://api.github.com/users/segevfiner/following{/other_user}",
                "gists_url": "https://api.github.com/users/segevfiner/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/segevfiner",
                "id": 24731903,
                "login": "segevfiner",
                "node_id": "MDQ6VXNlcjI0NzMxOTAz",
                "organizations_url": "https://api.github.com/users/segevfiner/orgs",
                "received_events_url": "https://api.github.com/users/segevfiner/received_events",
                "repos_url": "https://api.github.com/users/segevfiner/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/segevfiner/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/segevfiner/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/segevfiner"
            }
        },
        {
            "author_association": "NONE",
            "body": "@segevfiner : (for reference)\r\nPossible workaround is to use 'key' object in __cinit__:\r\n``` python\r\ncdef object init_key = object()\r\n\r\ncdef class FrameData:\r\n    cdef FrameCanvas __owner                      # FrameData needs to keep FrameCanvas alive\r\n    cdef const char* __data\r\n    cdef readonly size_t size                     # size is available to python\r\n    def __cinit__(self, key=None, FrameCanvas owner=None):\r\n        if key is not init_key:\r\n            raise TypeError(\"This class cannot be instantiated directly.\");\r\n        self.__owner = owner\r\n\r\n    @staticmethod\r\n    cdef FrameData __create(FrameCanvas owner, const char* data, size_t size):\r\n        cdef FrameData fd = FrameData(init_key, owner)\r\n        fd.__data = data\r\n        fd.size = size\r\n        return fd\r\n",
            "created_at": "2023-07-20T15:49:04Z",
            "html_url": "https://github.com/cython/cython/issues/4429#issuecomment-1644169640",
            "id": 1644169640,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4429",
            "node_id": "IC_kwDOABDGAc5iAAmo",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1644169640/reactions"
            },
            "updated_at": "2023-07-20T15:49:04Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1644169640",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/2318015?v=4",
                "events_url": "https://api.github.com/users/ledvinap/events{/privacy}",
                "followers_url": "https://api.github.com/users/ledvinap/followers",
                "following_url": "https://api.github.com/users/ledvinap/following{/other_user}",
                "gists_url": "https://api.github.com/users/ledvinap/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ledvinap",
                "id": 2318015,
                "login": "ledvinap",
                "node_id": "MDQ6VXNlcjIzMTgwMTU=",
                "organizations_url": "https://api.github.com/users/ledvinap/orgs",
                "received_events_url": "https://api.github.com/users/ledvinap/received_events",
                "repos_url": "https://api.github.com/users/ledvinap/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ledvinap/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ledvinap/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ledvinap"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4429/comments",
    "created_at": "2021-10-27T23:32:25Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-11-03T13:01:50Z",
            "event": "labeled",
            "id": 5561731172,
            "label": {
                "color": "444444",
                "name": "Cython Language Feature"
            },
            "node_id": "LE_lADOABDGAc493caFzwAAAAFLgUhk",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5561731172"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-11-03T13:01:50Z",
            "event": "labeled",
            "id": 5561731176,
            "label": {
                "color": "c2e0c6",
                "name": "feature"
            },
            "node_id": "LE_lADOABDGAc493caFzwAAAAFLgUho",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5561731176"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24731903?v=4",
                "events_url": "https://api.github.com/users/segevfiner/events{/privacy}",
                "followers_url": "https://api.github.com/users/segevfiner/followers",
                "following_url": "https://api.github.com/users/segevfiner/following{/other_user}",
                "gists_url": "https://api.github.com/users/segevfiner/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/segevfiner",
                "id": 24731903,
                "login": "segevfiner",
                "node_id": "MDQ6VXNlcjI0NzMxOTAz",
                "organizations_url": "https://api.github.com/users/segevfiner/orgs",
                "received_events_url": "https://api.github.com/users/segevfiner/received_events",
                "repos_url": "https://api.github.com/users/segevfiner/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/segevfiner/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/segevfiner/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/segevfiner"
            },
            "commit_id": "a72cc2b41c64d621fa678e604628d43a894bb1c3",
            "commit_url": "https://api.github.com/repos/segevfiner/cypcap/commits/a72cc2b41c64d621fa678e604628d43a894bb1c3",
            "created_at": "2022-01-03T09:54:09Z",
            "event": "referenced",
            "id": 5834438359,
            "node_id": "REFE_lADOABDGAc493caFzwAAAAFbwnbX",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5834438359"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24731903?v=4",
                "events_url": "https://api.github.com/users/segevfiner/events{/privacy}",
                "followers_url": "https://api.github.com/users/segevfiner/followers",
                "following_url": "https://api.github.com/users/segevfiner/following{/other_user}",
                "gists_url": "https://api.github.com/users/segevfiner/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/segevfiner",
                "id": 24731903,
                "login": "segevfiner",
                "node_id": "MDQ6VXNlcjI0NzMxOTAz",
                "organizations_url": "https://api.github.com/users/segevfiner/orgs",
                "received_events_url": "https://api.github.com/users/segevfiner/received_events",
                "repos_url": "https://api.github.com/users/segevfiner/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/segevfiner/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/segevfiner/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/segevfiner"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-07-20T15:49:04Z",
            "event": "mentioned",
            "id": 9876295828,
            "node_id": "MEE_lADOABDGAc493caFzwAAAAJMrFCU",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/9876295828"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/24731903?v=4",
                "events_url": "https://api.github.com/users/segevfiner/events{/privacy}",
                "followers_url": "https://api.github.com/users/segevfiner/followers",
                "following_url": "https://api.github.com/users/segevfiner/following{/other_user}",
                "gists_url": "https://api.github.com/users/segevfiner/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/segevfiner",
                "id": 24731903,
                "login": "segevfiner",
                "node_id": "MDQ6VXNlcjI0NzMxOTAz",
                "organizations_url": "https://api.github.com/users/segevfiner/orgs",
                "received_events_url": "https://api.github.com/users/segevfiner/received_events",
                "repos_url": "https://api.github.com/users/segevfiner/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/segevfiner/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/segevfiner/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/segevfiner"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-07-20T15:49:04Z",
            "event": "subscribed",
            "id": 9876295841,
            "node_id": "SE_lADOABDGAc493caFzwAAAAJMrFCh",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/9876295841"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4429/events",
    "html_url": "https://github.com/cython/cython/issues/4429",
    "id": 1037944453,
    "labels": [
        {
            "color": "c2e0c6",
            "default": false,
            "description": null,
            "id": 414805463,
            "name": "feature",
            "node_id": "MDU6TGFiZWw0MTQ4MDU0NjM=",
            "url": "https://api.github.com/repos/cython/cython/labels/feature"
        },
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425559948,
            "name": "Cython Language Feature",
            "node_id": "MDU6TGFiZWw0MjU1NTk5NDg=",
            "url": "https://api.github.com/repos/cython/cython/labels/Cython%20Language%20Feature"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4429/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc493caF",
    "number": 4429,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4429/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4429/timeline",
    "title": "[ENH] Support defining extension types (cdef class) with NULL tp_new",
    "updated_at": "2023-07-20T15:49:04Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4429",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/24731903?v=4",
        "events_url": "https://api.github.com/users/segevfiner/events{/privacy}",
        "followers_url": "https://api.github.com/users/segevfiner/followers",
        "following_url": "https://api.github.com/users/segevfiner/following{/other_user}",
        "gists_url": "https://api.github.com/users/segevfiner/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/segevfiner",
        "id": 24731903,
        "login": "segevfiner",
        "node_id": "MDQ6VXNlcjI0NzMxOTAz",
        "organizations_url": "https://api.github.com/users/segevfiner/orgs",
        "received_events_url": "https://api.github.com/users/segevfiner/received_events",
        "repos_url": "https://api.github.com/users/segevfiner/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/segevfiner/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/segevfiner/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/segevfiner"
    }
}