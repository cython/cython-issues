{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Describe the bug\n\nWe have Cython code equivalent to the following:\r\n\r\n```cython\r\ndef summer():\r\n    cdef:\r\n        cnp.npy_intp c = 0\r\n\r\n    mask = np.zeros(3, dtype=np.uint8)\r\n    c += mask.sum()\r\n    return c\r\n```\r\n\r\nWhen run, the generated file gives:\r\n\r\n```\r\nsum_uint8.pyx:9: in sum_uint8.summer\r\n    c += mask.sum()\r\nE   TypeError: 'numpy.float64' object cannot be interpreted as an integer\r\n```\r\n\r\nThe return type from the sum operation in Python is:\r\n\r\n```\r\n[ins] In [3]: type(np.zeros(3, dtype=np.uint8).sum())\r\nOut[3]: numpy.uint64\r\n```\r\n\r\nI only get this error for current `main` and Cython 3, not Cython < 3.\r\n\r\nI do not get the error when the type of `c` is `np_uint64` or `np_int`.\n\n### Code to reproduce the behaviour:\n\n```\r\ngit clone https://github.com/matthew-brett/mincy\r\ncd mincy\r\npip install -r requirements.txt\r\nmake\r\n```\n\n### Expected behaviour\n\nNo error, as output type from sum operation should be interpretable as an integer.\n\n### OS\n\nmacOS\n\n### Python version\n\n3.11.5\n\n### Cython version\n\nCommit 2f3236d49\n\n### Additional context\n\n_No response_",
    "closed_at": "2023-10-01T18:36:26Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Cython's behaviour hasn't actually changed between 3.0 and 0.29.x. What's changed is the definition of `npy_intp`.\r\n\r\nIn 0.29.x:\r\n\r\n```\r\ncdef extern from \"Python.h\":\r\n    ctypedef int Py_intptr_t\r\n\r\ncdef extern from \"numpy/arrayobject.h\":\r\n    ctypedef Py_intptr_t npy_intp\r\n```\r\n\r\nand in master\r\n\r\n```\r\ncdef extern from \"Python.h\":\r\n    ctypedef Py_ssize_t Py_intptr_t\r\n\r\ncdef extern from \"numpy/arrayobject.h\":\r\n    ctypedef Py_intptr_t npy_intp\r\n```\r\n\r\nNote that in master the Numpy pxd file will end up coming from Numpy itself, not us. Cython no longer maintains it.\r\n\r\nRunning the code in Python:\r\n\r\n```\r\n>>> a = no.zeros(3, dtype=no.uint8)\r\n>>> x = 0\r\n>>> x += a.sum()\r\n>>> x\r\n0.0\r\n```\r\n\r\nNote that it returns a floating point number. Again, not a Cython decision.\r\n\r\nInternally Cython converts `c` to a Python `int`, adds that to `a.sum()` and then converts back and assigns it to `c`.\r\n\r\nThe difference is in the conversion back. The difference between `Py_ssize_t` and a C `int` from Cython's point of view is that Cython uses a stricter conversion for `Py_ssize_t` and only accepts values where `PyNumber_Index` is valid (which evidently doesn't include floating point numbers). In contrast, with a C `int` Cython calls `PyNumber_Long` which is less strict and will convert `0.0`.\r\n\r\nI suspect the special-casing of `Py_ssize_t` to be a strict index is something we don't want to change at this stage. And `ctypedef` of `np_intp` is now outside our control.",
            "created_at": "2023-09-26T17:53:02Z",
            "html_url": "https://github.com/cython/cython/issues/5727#issuecomment-1736015718",
            "id": 1736015718,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5727",
            "node_id": "IC_kwDOABDGAc5neX9m",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1736015718/reactions"
            },
            "updated_at": "2023-09-26T17:53:02Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1736015718",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Thanks - sorry - was travelling - and only got back to think about this now.\r\n\r\nSo, to check I understand, in Cython 2, `npy_intp` resolves to `int`, but in Cython 3, it resolves to `Py_ssize_t`.   This results in stricter conversion checks, hence the error.  The change in resolution to give `Py_ssize_t` was intended.\r\n\r\nI did check return return type of `a.sum()` in Numpy before posting, and now I check again, I still get:\r\n\r\n```python\r\n[ins] In [1]: import numpy as np\r\n\r\n[ins] In [2]: a = np.zeros(3, dtype=np.uint8)\r\n\r\n[ins] In [3]: a.sum()\r\nOut[3]: 0\r\n```\r\n\r\nAm I running a different Numpy from you?   I tried on 1.25.2 and 1.26.0.",
            "created_at": "2023-10-01T17:39:58Z",
            "html_url": "https://github.com/cython/cython/issues/5727#issuecomment-1742149372",
            "id": 1742149372,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5727",
            "node_id": "IC_kwDOABDGAc5n1xb8",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1742149372/reactions"
            },
            "updated_at": "2023-10-01T17:39:58Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1742149372",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/67612?v=4",
                "events_url": "https://api.github.com/users/matthew-brett/events{/privacy}",
                "followers_url": "https://api.github.com/users/matthew-brett/followers",
                "following_url": "https://api.github.com/users/matthew-brett/following{/other_user}",
                "gists_url": "https://api.github.com/users/matthew-brett/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matthew-brett",
                "id": 67612,
                "login": "matthew-brett",
                "node_id": "MDQ6VXNlcjY3NjEy",
                "organizations_url": "https://api.github.com/users/matthew-brett/orgs",
                "received_events_url": "https://api.github.com/users/matthew-brett/received_events",
                "repos_url": "https://api.github.com/users/matthew-brett/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matthew-brett/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matthew-brett/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matthew-brett"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> I did check return return type of a.sum() in Numpy before posting, and now I check again, I still get: [...]\r\n\r\nSorry - don't think I was completely clear with that part. For the result of `a.sum()` I get `np.uint64` (like you do).\r\n\r\nWhen I add a Python `int` that that `np.uint64` I get `np.float64`. It's this `float64` that fails to convert back to `Py_ssize_t`.\r\n\r\n> So, to check I understand, in Cython 2, npy_intp resolves to int, but in Cython 3, it resolves to Py_ssize_t. This results in stricter conversion checks, hence the error. The change in resolution to give Py_ssize_t was intended.\r\n\r\nYes - with one complication: Numpy now provides the files that are used with `cimport cython`. It actually provides two version (one for [Cython 0.29.x](https://github.com/numpy/numpy/blob/main/numpy/__init__.pxd) and one for [Cython 3](https://github.com/numpy/numpy/blob/main/numpy/__init__.cython-30.pxd)) - these have slightly different definitions. To further complicate things we haven't yet deleted this file from Cython. At least for Cython 3 the version provided by Numpy should be preferred but I'm not sure what happens for older version of Cython. It doesn't matter in terms of this issue though",
            "created_at": "2023-10-01T18:03:51Z",
            "html_url": "https://github.com/cython/cython/issues/5727#issuecomment-1742155117",
            "id": 1742155117,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5727",
            "node_id": "IC_kwDOABDGAc5n1y1t",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1742155117/reactions"
            },
            "updated_at": "2023-10-01T18:03:51Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1742155117",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Ah - thank you - that's a very helpful clarification - sorry for missing your well-placed `x +=` before.",
            "created_at": "2023-10-01T18:36:26Z",
            "html_url": "https://github.com/cython/cython/issues/5727#issuecomment-1742163221",
            "id": 1742163221,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5727",
            "node_id": "IC_kwDOABDGAc5n100V",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1742163221/reactions"
            },
            "updated_at": "2023-10-01T18:36:26Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1742163221",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/67612?v=4",
                "events_url": "https://api.github.com/users/matthew-brett/events{/privacy}",
                "followers_url": "https://api.github.com/users/matthew-brett/followers",
                "following_url": "https://api.github.com/users/matthew-brett/following{/other_user}",
                "gists_url": "https://api.github.com/users/matthew-brett/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matthew-brett",
                "id": 67612,
                "login": "matthew-brett",
                "node_id": "MDQ6VXNlcjY3NjEy",
                "organizations_url": "https://api.github.com/users/matthew-brett/orgs",
                "received_events_url": "https://api.github.com/users/matthew-brett/received_events",
                "repos_url": "https://api.github.com/users/matthew-brett/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matthew-brett/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matthew-brett/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matthew-brett"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5727/comments",
    "created_at": "2023-09-26T11:01:51Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/67612?v=4",
                "events_url": "https://api.github.com/users/matthew-brett/events{/privacy}",
                "followers_url": "https://api.github.com/users/matthew-brett/followers",
                "following_url": "https://api.github.com/users/matthew-brett/following{/other_user}",
                "gists_url": "https://api.github.com/users/matthew-brett/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matthew-brett",
                "id": 67612,
                "login": "matthew-brett",
                "node_id": "MDQ6VXNlcjY3NjEy",
                "organizations_url": "https://api.github.com/users/matthew-brett/orgs",
                "received_events_url": "https://api.github.com/users/matthew-brett/received_events",
                "repos_url": "https://api.github.com/users/matthew-brett/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matthew-brett/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matthew-brett/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matthew-brett"
            },
            "commit_id": "a0a9ac7a3925a61dc68834bfb9cb4bfbcd69b73b",
            "commit_url": "https://api.github.com/repos/stefanv/nipy/commits/a0a9ac7a3925a61dc68834bfb9cb4bfbcd69b73b",
            "created_at": "2023-09-26T11:02:56Z",
            "event": "referenced",
            "id": 10473599565,
            "node_id": "REFE_lADOABDGAc5yCfjizwAAAAJwRnJN",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/10473599565"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/67612?v=4",
                "events_url": "https://api.github.com/users/matthew-brett/events{/privacy}",
                "followers_url": "https://api.github.com/users/matthew-brett/followers",
                "following_url": "https://api.github.com/users/matthew-brett/following{/other_user}",
                "gists_url": "https://api.github.com/users/matthew-brett/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matthew-brett",
                "id": 67612,
                "login": "matthew-brett",
                "node_id": "MDQ6VXNlcjY3NjEy",
                "organizations_url": "https://api.github.com/users/matthew-brett/orgs",
                "received_events_url": "https://api.github.com/users/matthew-brett/received_events",
                "repos_url": "https://api.github.com/users/matthew-brett/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matthew-brett/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matthew-brett/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matthew-brett"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-10-01T18:36:26Z",
            "event": "closed",
            "id": 10520216382,
            "node_id": "CE_lADOABDGAc5yCfjizwAAAAJzDcM-",
            "performed_via_github_app": null,
            "state_reason": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/10520216382"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5727/events",
    "html_url": "https://github.com/cython/cython/issues/5727",
    "id": 1913256162,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5727/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5yCfji",
    "number": 5727,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5727/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5727/timeline",
    "title": "[BUG] Incorrect return type from np.sum in Cython 3",
    "updated_at": "2023-10-01T18:36:26Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5727",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/67612?v=4",
        "events_url": "https://api.github.com/users/matthew-brett/events{/privacy}",
        "followers_url": "https://api.github.com/users/matthew-brett/followers",
        "following_url": "https://api.github.com/users/matthew-brett/following{/other_user}",
        "gists_url": "https://api.github.com/users/matthew-brett/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/matthew-brett",
        "id": 67612,
        "login": "matthew-brett",
        "node_id": "MDQ6VXNlcjY3NjEy",
        "organizations_url": "https://api.github.com/users/matthew-brett/orgs",
        "received_events_url": "https://api.github.com/users/matthew-brett/received_events",
        "repos_url": "https://api.github.com/users/matthew-brett/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/matthew-brett/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/matthew-brett/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/matthew-brett"
    }
}