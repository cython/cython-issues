{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "I'm new to cython (in fact I've learnt it today) and I found that a slight modification of code could significantly hurt cython performance (I've already simplified the codes).\r\n\r\nVersion 1\r\n```python\r\ncdef long[::1] _core(const long n_id, const long n_sample, char** id_column, char** unique_id_list):    \r\n    cdef long rs[n_id + n_sample]\r\n    cdef unsigned int i, k=0\r\n    cdef long j, cur=0\r\n    \r\n    rs[0] = 0\r\n    for i in range(n_id):\r\n        if i > 0:\r\n            cur = rs[i-1]\r\n        idx = unique_id_list[i]\r\n        for j in range(n_sample):\r\n            if strcmp(idx, id_column[j]) == 0:\r\n                cur = cur + 1\r\n        rs[i] = cur\r\n\r\n    return rs\r\n```\r\n\r\nVersion 2\r\n```python\r\ncdef long[::1] _core2(const long n_id, const long n_sample, char** id_column, char** unique_id_list):    \r\n    cdef long rs[n_id + n_sample]\r\n    cdef unsigned int i, k=0\r\n    cdef long j, cur=0\r\n    \r\n    rs[0] = 0\r\n    for i in range(n_id):\r\n        if i > 0:\r\n            cur = rs[i-1]\r\n        idx = unique_id_list[i]\r\n        for j in range(n_sample):\r\n            if strcmp(idx, id_column[j]) == 0:\r\n                pass\r\n            cur = cur + 1\r\n        rs[i] = cur\r\n\r\n    return rs\r\n```\r\n\r\nThe only difference is that I put `cur=cur+1` outside `if` statement in Version 2, which seems to be more time consuming because `cur=cur+1` will be hit more.\r\n\r\nWrapper codes\r\n```python\r\ncimport cython\r\nfrom libc.string cimport strcmp\r\nfrom libc.stdlib cimport malloc, free\r\n\r\ncdef extern from \"Python.h\":\r\n    char* PyUnicode_AsUTF8(object unicode)\r\n\r\ncdef char ** to_cstring_array(list_str):\r\n    cdef unsigned i\r\n    cdef char **ret = <char **>malloc(len(list_str) * sizeof(char *))\r\n    for i in range(len(list_str)):\r\n        ret[i] = PyUnicode_AsUTF8(list_str[i])\r\n    return ret\r\n\r\ndef test(id_column, unique_id_list):\r\n    cdef unsigned long n_sample = len(id_column)\r\n    cdef unsigned long n_id = len(unique_id_list)\r\n    cdef char **c_id_column = to_cstring_array(id_column)\r\n    cdef char **c_unique_id_list = to_cstring_array(unique_id_list)\r\n    cdef long[::1] rs = _core(n_id, n_sample, c_id_column, c_unique_id_list)\r\n    free(c_id_column)\r\n    free(c_unique_id_list)\r\n\r\ndef test2(id_column, unique_id_list):\r\n    cdef unsigned long n_sample = len(id_column)\r\n    cdef unsigned long n_id = len(unique_id_list)\r\n    cdef char **c_id_column = to_cstring_array(id_column)\r\n    cdef char **c_unique_id_list = to_cstring_array(unique_id_list)\r\n    cdef long[::1] rs = _core2(n_id, n_sample, c_id_column, c_unique_id_list)\r\n    free(c_id_column)\r\n    free(c_unique_id_list)\r\n```\r\nand the performances are as follows, Version 2 is up to ~4 times faster, and seems to be faster when input array size grows larger:\r\n```python\r\nunique_id_list = list(\"abcdefg\")\r\nid_column = random.choices(unique_id_list, k=10 ** 1)\r\n%timeit test(id_column, unique_id_list)\r\n%timeit test2(id_column, unique_id_list)\r\n\r\n1.76 µs ± 535 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)\r\n1.17 µs ± 138 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)\r\n\r\nunique_id_list = list(\"abcdefg\")\r\nid_column = random.choices(unique_id_list, k=10 ** 2)\r\n%timeit test(id_column, unique_id_list)\r\n%timeit test2(id_column, unique_id_list)\r\n\r\n5.03 µs ± 809 ns per loop (mean ± std. dev. of 7 runs, 100000 loops each)\r\n1.95 µs ± 264 ns per loop (mean ± std. dev. of 7 runs, 1000000 loops each)\r\n\r\nunique_id_list = list(\"abcdefg\")\r\nid_column = random.choices(unique_id_list, k=10 ** 4)\r\n%timeit test(id_column, unique_id_list)\r\n%timeit test2(id_column, unique_id_list)\r\n\r\n319 µs ± 8.28 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)\r\n78.9 µs ± 9 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)\r\n```\r\n\r\nPlatform : CentOS Linux 7 (Core)\r\nPython version : 3.6.8, (Anaconda)\r\nTest Environment : Jupyter Notebook (version 4.4.0)\r\nCPU : Intel(R) Xeon(R) CPU E5-2695 v4 @ 2.10GHz\r\nArchitecture:          x86_64\r\nCPU op-mode(s):        32-bit, 64-bit\r\nByte Order:            Little Endian\r\nCPU(s):                72\r\nOn-line CPU(s) list:   0-71\r\nThread(s) per core:    2\r\nCore(s) per socket:    18\r\nCPU MHz：             2599.877\r\nCPU max MHz:           3300.0000\r\nCPU min MHz:           1200.0000\r\nBogoMIPS：            4199.86\r\n\r\nI've been struggling for hours and really hope that someone could give me a hand, thanks in advance! ",
    "closed_at": "2019-08-03T18:01:16Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "The C compiler will probably just optimise away much of your code since it does not contribute to the result in version 2.\r\nPlease don't use the bug tracker for support requests. Use the cython-users mailing list instead.",
            "created_at": "2019-08-03T18:01:16Z",
            "html_url": "https://github.com/cython/cython/issues/3067#issuecomment-517943429",
            "id": 517943429,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3067",
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxNzk0MzQyOQ==",
            "updated_at": "2019-08-03T18:01:16Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/517943429",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "Sorry for posting at the wrong place, I'll re-post it using the cython-users mailing list instead.",
            "created_at": "2019-08-03T18:12:11Z",
            "html_url": "https://github.com/cython/cython/issues/3067#issuecomment-517944166",
            "id": 517944166,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3067",
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxNzk0NDE2Ng==",
            "updated_at": "2019-08-03T18:12:11Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/517944166",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/15677328?v=4",
                "events_url": "https://api.github.com/users/carefree0910/events{/privacy}",
                "followers_url": "https://api.github.com/users/carefree0910/followers",
                "following_url": "https://api.github.com/users/carefree0910/following{/other_user}",
                "gists_url": "https://api.github.com/users/carefree0910/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/carefree0910",
                "id": 15677328,
                "login": "carefree0910",
                "node_id": "MDQ6VXNlcjE1Njc3MzI4",
                "organizations_url": "https://api.github.com/users/carefree0910/orgs",
                "received_events_url": "https://api.github.com/users/carefree0910/received_events",
                "repos_url": "https://api.github.com/users/carefree0910/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/carefree0910/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/carefree0910/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/carefree0910"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/3067/comments",
    "created_at": "2019-08-03T15:34:12Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-08-03T18:01:16Z",
            "event": "closed",
            "id": 2531419991,
            "node_id": "MDExOkNsb3NlZEV2ZW50MjUzMTQxOTk5MQ==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2531419991"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-08-03T18:01:26Z",
            "event": "labeled",
            "id": 2531420062,
            "label": {
                "color": "fef2c0",
                "name": "support question"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDI1MzE0MjAwNjI=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2531420062"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/3067/events",
    "html_url": "https://github.com/cython/cython/issues/3067",
    "id": 476462586,
    "labels": [
        {
            "color": "fef2c0",
            "default": false,
            "id": 414800623,
            "name": "support question",
            "node_id": "MDU6TGFiZWw0MTQ4MDA2MjM=",
            "url": "https://api.github.com/repos/cython/cython/labels/support%20question"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/3067/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU0NzY0NjI1ODY=",
    "number": 3067,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "[BUG?] Very strange performance behavior when assigning values to C-list",
    "updated_at": "2019-08-03T18:12:11Z",
    "url": "https://api.github.com/repos/cython/cython/issues/3067",
    "user": {
        "avatar_url": "https://avatars1.githubusercontent.com/u/15677328?v=4",
        "events_url": "https://api.github.com/users/carefree0910/events{/privacy}",
        "followers_url": "https://api.github.com/users/carefree0910/followers",
        "following_url": "https://api.github.com/users/carefree0910/following{/other_user}",
        "gists_url": "https://api.github.com/users/carefree0910/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/carefree0910",
        "id": 15677328,
        "login": "carefree0910",
        "node_id": "MDQ6VXNlcjE1Njc3MzI4",
        "organizations_url": "https://api.github.com/users/carefree0910/orgs",
        "received_events_url": "https://api.github.com/users/carefree0910/received_events",
        "repos_url": "https://api.github.com/users/carefree0910/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/carefree0910/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/carefree0910/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/carefree0910"
    }
}