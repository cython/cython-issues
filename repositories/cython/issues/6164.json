{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Describe your issue\n\nMy proposal is that we should probably be using `CYTHON_AVOID_BORROWED_REFS` for the nogil build, because borrowed references are an opportunity for nasty reference-counting races.\r\n\r\nHowever, there are also places where it's unnecessary - for example in Cython utility code where we're dealing an element of a tuple that we've just created and has not yet been exposed to any other threads.\r\n\r\nMy proposal is that we add two levels of `CYTHON_AVOID_BORROWED_REFS`:\r\n\r\n* `CYTHON_AVOID_BORROWED_REFS == 1` is what we currently do. It's largely targeted at implementations like PyPy where borrowed references confuse their C API implementation, and it tries to be fairly thorough.\r\n* `CYTHON_AVOID_BORROWED_REFS == 2` is targeted at the nogil build and only avoids borrowed references where there's a danger than objects might be on multiple threads.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I've split the feature flags at need more than once. This seems reasonable. Something like \"avoid long borrowed refs\" or \"avoid unique borrowed refs\" might catch the idea of not keeping borrowed refs around for too long, and of not even keeping borrowed refs of things that we control.\n\nIt's worth trying out to see if this has a practical advantage, though. The two PyPy specific feature flags ended up going hand in hand almost all of the time, so there wasn't really a good reason to keep them after I had introduced them everywhere. They're still there.\n",
            "created_at": "2024-04-25T20:50:40Z",
            "html_url": "https://github.com/cython/cython/issues/6164#issuecomment-2078150500",
            "id": 2078150500,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6164",
            "node_id": "IC_kwDOABDGAc573g9k",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2078150500/reactions"
            },
            "updated_at": "2024-04-25T20:50:40Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2078150500",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6164/comments",
    "created_at": "2024-04-25T17:48:08Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6164/events",
    "html_url": "https://github.com/cython/cython/issues/6164",
    "id": 2264160208,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6164/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc6G9FfQ",
    "number": 6164,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6164/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6164/timeline",
    "title": "Split CYTHON_AVOID_BORROWED_REFS into two levels?",
    "updated_at": "2024-04-25T20:50:41Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6164",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
        "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
        "followers_url": "https://api.github.com/users/da-woods/followers",
        "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
        "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/da-woods",
        "id": 10536947,
        "login": "da-woods",
        "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
        "organizations_url": "https://api.github.com/users/da-woods/orgs",
        "received_events_url": "https://api.github.com/users/da-woods/received_events",
        "repos_url": "https://api.github.com/users/da-woods/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/da-woods"
    }
}