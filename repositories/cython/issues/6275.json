{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nI'm trying to call a function returning an enum with an error value specified via `except`. It fails to compile in C++ mode with gcc but works in C mode. It also works when I remove the `except`.\n\n### Code to reproduce the behaviour:\n\ncython_enum_except_bug.pyx:\r\n```cython\r\nctypedef enum H5S_sel_type:\r\n    H5S_SEL_ERROR = -1,  #Error\r\n    H5S_SEL_NONE = 0,  #Nothing selected\r\n    H5S_SEL_POINTS = 1,  #Sequence of points selected\r\n    H5S_SEL_HYPERSLABS = 2,  #\"New-style\" hyperslab selection defined\r\n    H5S_SEL_ALL = 3,  #Entire extent selected\r\n    H5S_SEL_N = 4  #/*THIS MUST BE LAST\r\n\r\ncdef extern from \"hdf5.h\":\r\n    # HDF5 types\r\n    ctypedef long int hid_t\r\n    # The function with an enum except type\r\n    cdef H5S_sel_type H5Sget_select_type(hid_t space_id) except <H5S_sel_type> -1\r\n\r\n\r\ncdef f():\r\n    space_id: hid_t = <hid_t>0\r\n    sel_type: H5S_sel_type = <H5S_sel_type> H5Sget_select_type(space_id)\r\n    assert sel_type != H5S_SEL_ERROR\r\n```\r\n\r\nresults in\r\n```\r\n$ cythonize -a -i -3 --cplus cython_enum_except_bug.pyx\r\n[...]\r\n/opt/rh/gcc-toolset-10/root/usr/bin/gcc -pthread -Wno-unused-result -Wsign-compare -DDYNAMIC_ANNOTATIONS_ENABLED=1 -DNDEBUG -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -D_GNU_SOURCE -fPIC -fwrapv -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -gdwarf-2 -D_GNU_SOURCE -fPIC -fwrapv -O2 -g -pipe -Wall -Werror=format-security -Wp,-D_FORTIFY_SOURCE=2 -Wp,-D_GLIBCXX_ASSERTIONS -fexceptions -fstack-protector-strong -grecord-gcc-switches -m64 -mtune=generic -fasynchronous-unwind-tables -fstack-clash-protection -fcf-protection -gdwarf-2 -D_GNU_SOURCE -fPIC -fwrapv -fPIC -I/codemill/bessen/ndindex_3.10_venv/include -I/opt/python/python-3.10/include/python3.10 -c /codemill/bessen/opensource/versioned-hdf5/cython_enum_except_bug.cpp -o /codemill/bessen/opensource/versioned-hdf5/tmp8yx3tecj/codemill/bessen/opensource/versioned-hdf5/cython_enum_except_bug.o\r\n/codemill/bessen/opensource/versioned-hdf5/cython_enum_except_bug.cpp: In function ‘PyObject* __pyx_f_22cython_enum_except_bug_f()’:\r\n/codemill/bessen/opensource/versioned-hdf5/cython_enum_except_bug.cpp:2012:33: error: cannot convert ‘H5S_sel_type’ to ‘__pyx_t_22cython_enum_except_bug_H5S_sel_type’ in assignment\r\n 2012 |   __pyx_t_1 = H5Sget_select_type(__pyx_v_space_id); if (unlikely(__pyx_t_1 == ((__pyx_t_22cython_enum_except_bug_H5S_sel_type)((__pyx_t_22cython_enum_except_bug_H5S_sel_type)-1L)))) __PYX_ERR(0, 18, __pyx_L1_error)\r\n      |               ~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~\r\n      |                                 |\r\n      |                                 H5S_sel_type\r\n[...]\r\nerror: command '/opt/rh/gcc-toolset-10/root/usr/bin/gcc' failed with exit code 1\r\n```\n\n### Expected behaviour\n\nI expect the compilation to succeed. This passes if I either\r\n1. remove the `except` clause\r\n2. drop the `--cplus` flag to use a C compiler\n\n### OS\n\nLinux\n\n### Python version\n\n3.10.4\n\n### Cython version\n\n3.0.10\n\n### Additional context\n\n```\r\n$ /opt/rh/gcc-toolset-10/root/usr/bin/gcc --version\r\ngcc (GCC) 10.3.1 20210422 (Red Hat 10.3.1-1)\r\n```",
    "closed_at": "2024-06-27T22:11:52Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "No - this is a bug in your code. \r\n\r\n`H5S_sel_type` should be in a `cdef extern` block because it's defined elsewhere. Your code causes Cython to generate its own definition with a different name. It looks like C++ is stricter than C about assignments between unrelated enums, hence the error. \r\n\r\nHowever - does `H5Sget_select_type` raise a *Python* exception on error? Because this is what the except clause is saying and I doubt it's true.\r\n",
            "created_at": "2024-06-27T22:11:53Z",
            "html_url": "https://github.com/cython/cython/issues/6275#issuecomment-2195752061",
            "id": 2195752061,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6275",
            "node_id": "IC_kwDOABDGAc6C4IR9",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2195752061/reactions"
            },
            "updated_at": "2024-06-27T22:11:53Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2195752061",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "Thanks @da-woods, that was extremely helpful, moving the typedef into the `cdef extern` block fixes the issue.\r\n\r\nAlso, the except clause there is indeed incorrect, I had misunderstood the `except` clause. This [section at the end of the docs on errors](https://cython.readthedocs.io/en/stable/src/userguide/language_basics.html#checking-return-values-of-non-cython-functions) explains my misunderstanding. Should this perhaps be made a compilation warning? I must not be the first person to make that mistake?",
            "created_at": "2024-06-27T22:37:18Z",
            "html_url": "https://github.com/cython/cython/issues/6275#issuecomment-2195778499",
            "id": 2195778499,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6275",
            "node_id": "IC_kwDOABDGAc6C4OvD",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2195778499/reactions"
            },
            "updated_at": "2024-06-27T22:37:18Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2195778499",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/17654416?v=4",
                "events_url": "https://api.github.com/users/ArvidJB/events{/privacy}",
                "followers_url": "https://api.github.com/users/ArvidJB/followers",
                "following_url": "https://api.github.com/users/ArvidJB/following{/other_user}",
                "gists_url": "https://api.github.com/users/ArvidJB/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ArvidJB",
                "id": 17654416,
                "login": "ArvidJB",
                "node_id": "MDQ6VXNlcjE3NjU0NDE2",
                "organizations_url": "https://api.github.com/users/ArvidJB/orgs",
                "received_events_url": "https://api.github.com/users/ArvidJB/received_events",
                "repos_url": "https://api.github.com/users/ArvidJB/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ArvidJB/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ArvidJB/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ArvidJB"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Should this perhaps be made a compilation warning?\r\n\r\nThe trouble is that Cython has no way of knowing what 3rd party libraries might do, so it has to trust you on this.",
            "created_at": "2024-06-28T05:45:28Z",
            "html_url": "https://github.com/cython/cython/issues/6275#issuecomment-2196184935",
            "id": 2196184935,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6275",
            "node_id": "IC_kwDOABDGAc6C5x9n",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2196184935/reactions"
            },
            "updated_at": "2024-06-28T05:45:28Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2196184935",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6275/comments",
    "created_at": "2024-06-27T21:47:10Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-06-27T22:11:53Z",
            "event": "closed",
            "id": 13324027207,
            "node_id": "CE_lADOABDGAc6NzsauzwAAAAMaLIVH",
            "performed_via_github_app": null,
            "state_reason": "not_planned",
            "url": "https://api.github.com/repos/cython/cython/issues/events/13324027207"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-06-27T22:12:04Z",
            "event": "labeled",
            "id": 13324028669,
            "label": {
                "color": "444444",
                "name": "R: invalid"
            },
            "node_id": "LE_lADOABDGAc6NzsauzwAAAAMaLIr9",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/13324028669"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-06-27T22:37:19Z",
            "event": "mentioned",
            "id": 13324189741,
            "node_id": "MEE_lADOABDGAc6NzsauzwAAAAMaLwAt",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/13324189741"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-06-27T22:37:19Z",
            "event": "subscribed",
            "id": 13324189748,
            "node_id": "SE_lADOABDGAc6NzsauzwAAAAMaLwA0",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/13324189748"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6275/events",
    "html_url": "https://github.com/cython/cython/issues/6275",
    "id": 2379138734,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425557122,
            "name": "R: invalid",
            "node_id": "MDU6TGFiZWw0MjU1NTcxMjI=",
            "url": "https://api.github.com/repos/cython/cython/labels/R:%20invalid"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6275/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc6Nzsau",
    "number": 6275,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6275/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "state_reason": "not_planned",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6275/timeline",
    "title": "[BUG] compiler error with function returning enum in C++ mode",
    "updated_at": "2024-06-28T05:45:28Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6275",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/17654416?v=4",
        "events_url": "https://api.github.com/users/ArvidJB/events{/privacy}",
        "followers_url": "https://api.github.com/users/ArvidJB/followers",
        "following_url": "https://api.github.com/users/ArvidJB/following{/other_user}",
        "gists_url": "https://api.github.com/users/ArvidJB/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ArvidJB",
        "id": 17654416,
        "login": "ArvidJB",
        "node_id": "MDQ6VXNlcjE3NjU0NDE2",
        "organizations_url": "https://api.github.com/users/ArvidJB/orgs",
        "received_events_url": "https://api.github.com/users/ArvidJB/received_events",
        "repos_url": "https://api.github.com/users/ArvidJB/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ArvidJB/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ArvidJB/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ArvidJB"
    }
}