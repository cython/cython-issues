{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nI am generating some cython code to compare arbitrary numpy dtypes (not important). Latest cython `3.1.4` refuses to preprocess one (see the code). The error:\n\n```\ncode = <Cython.Compiler.Code.CCodeWriter object at 0x7fa680828ec0>\ndtype = <CNumericType int>, maxdepth = 0\n\n    def get_type_information_cname(code, dtype, maxdepth=None):\n        \"\"\"\n        Output the run-time type information (__Pyx_TypeInfo) for given dtype,\n        and return the name of the type info struct.\n    \n        Structs with two floats of the same size are encoded as complex numbers.\n        One can separate between complex numbers declared as struct or with native\n        encoding by inspecting to see if the fields field of the type is\n        filled in.\n        \"\"\"\n        namesuffix = mangle_dtype_name(dtype)\n        name = \"__Pyx_TypeInfo_%s\" % namesuffix\n        structinfo_name = \"__Pyx_StructFields_%s\" % namesuffix\n    \n        if dtype.is_error: return \"<error>\"\n    \n        # It's critical that walking the type info doesn't use more stack\n        # depth than dtype.struct_nesting_depth() returns, so use an assertion for this\n        if maxdepth is None: maxdepth = dtype.struct_nesting_depth()\n        if maxdepth <= 0:\n>           assert False\n                   ^^^^^\nE           AssertionError\n```\n\nHelp appreciated.\n\n### Code to reproduce the behaviour:\n\n```cython\nimport cython\ncdef packed struct struct_1:\n  int f0\n  char f1[5]\ncdef double compare_struct_1(const struct_1 a, const struct_1 b):\n  cdef double result = 0\n  cdef Py_ssize_t i0\n  result += a.f0 == b.f0\n  for i0 in range(5):\n    result += a.f1[i0] == b.f1[i0]\n  return result / 6\ncdef packed struct struct_0:\n  long long f0\n  struct_1 f1[2]\ncdef double compare_struct_0(const struct_0 a, const struct_0 b):\n  cdef double result = 0\n  cdef Py_ssize_t i0\n  result += a.f0 == b.f0\n  for i0 in range(2):\n    result += compare_struct_1(a.f1[i0], b.f1[i0])\n  return result / 3\ncdef class Backend:\n  cdef const struct_0[:] a\n  cdef const struct_0[:] b\n  def __init__(self, const struct_0[:] a not None, const struct_0[:] b not None):\n    self.a = a\n    self.b = b\n  @cython.initializedcheck(False)\n  @cython.wraparound(False)\n  cdef double compare(self, Py_ssize_t i, Py_ssize_t j):\n    return compare_struct_0(self.a[i], self.b[j])\n```\n\n\n### Expected behaviour\n\nI expect nested structs/record array dtypes to work in cython as described in the docs.\n\n### OS\n\nFedora\n\n### Python version\n\n3.13\n\n### Cython version\n\n3.1.4\n\n### Additional context\n\nFor the context, this is the corresponding numpy dtype. I was simply writing a unit test to check whether it all works with nested structs so there should really be nothing special about it: the thing is a mixture of types and options to maximize test coverage.\n\n```\ndtype_inner = np.dtype([(\"ix\", \"i4\"), (\"name\", \"S5\")])\ndtype = np.dtype([(\"pair_ix\", \"i8\"), (\"pair\", dtype_inner, 2)])\n```\n\nNot sure what MWE would be. ",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "Further debugging shows that arrays of struct are not supported:\n```cython\n  struct_1 f1[2]  # '[2]' causes the issue\n```\n\nIt looks like cython assumes that any array is of atomic type and `struct_nesting_depth` gives the wrong number.",
            "created_at": "2025-10-04T16:35:01Z",
            "html_url": "https://github.com/cython/cython/issues/7191#issuecomment-3368398927",
            "id": 3368398927,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7191",
            "node_id": "IC_kwDOABDGAc7IxbBP",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3368398927/reactions"
            },
            "updated_at": "2025-10-04T16:35:01Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3368398927",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/14786764?v=4",
                "events_url": "https://api.github.com/users/pulkin/events{/privacy}",
                "followers_url": "https://api.github.com/users/pulkin/followers",
                "following_url": "https://api.github.com/users/pulkin/following{/other_user}",
                "gists_url": "https://api.github.com/users/pulkin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pulkin",
                "id": 14786764,
                "login": "pulkin",
                "node_id": "MDQ6VXNlcjE0Nzg2NzY0",
                "organizations_url": "https://api.github.com/users/pulkin/orgs",
                "received_events_url": "https://api.github.com/users/pulkin/received_events",
                "repos_url": "https://api.github.com/users/pulkin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pulkin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pulkin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pulkin",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Thanks for the detailed report. If numpy supports this kind of nested struct then Cython probably should too",
            "created_at": "2025-10-05T12:44:36Z",
            "html_url": "https://github.com/cython/cython/issues/7191#issuecomment-3369033745",
            "id": 3369033745,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7191",
            "node_id": "IC_kwDOABDGAc7Iz2AR",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3369033745/reactions"
            },
            "updated_at": "2025-10-05T12:44:52Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3369033745",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/7191/comments",
    "created_at": "2025-10-04T15:59:11Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/14786764?v=4",
                "events_url": "https://api.github.com/users/pulkin/events{/privacy}",
                "followers_url": "https://api.github.com/users/pulkin/followers",
                "following_url": "https://api.github.com/users/pulkin/following{/other_user}",
                "gists_url": "https://api.github.com/users/pulkin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pulkin",
                "id": 14786764,
                "login": "pulkin",
                "node_id": "MDQ6VXNlcjE0Nzg2NzY0",
                "organizations_url": "https://api.github.com/users/pulkin/orgs",
                "received_events_url": "https://api.github.com/users/pulkin/received_events",
                "repos_url": "https://api.github.com/users/pulkin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pulkin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pulkin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pulkin",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-10-04T18:18:45Z",
            "event": "renamed",
            "id": 20097897423,
            "node_id": "RTE_lADOABDGAc7PqCsAzwAAAASt7ZPP",
            "performed_via_github_app": null,
            "rename": {
                "from": "[BUG] Fails to preprocess a numpy record dtype",
                "to": "[BUG] Fails to preprocess an array of struct inside another struct"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/20097897423"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-10-05T12:45:26Z",
            "event": "labeled",
            "id": 20101427562,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "node_id": "LE_lADOABDGAc7PqCsAzwAAAASuI3Fq",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/20101427562"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-10-05T12:45:26Z",
            "event": "labeled",
            "id": 20101427566,
            "label": {
                "color": "444444",
                "name": "Type Analysis"
            },
            "node_id": "LE_lADOABDGAc7PqCsAzwAAAASuI3Fu",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/20101427566"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/7191/events",
    "html_url": "https://github.com/cython/cython/issues/7191",
    "id": 3483904768,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425553654,
            "name": "defect",
            "node_id": "MDU6TGFiZWw0MjU1NTM2NTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        },
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425558824,
            "name": "Type Analysis",
            "node_id": "MDU6TGFiZWw0MjU1NTg4MjQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/Type%20Analysis"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/7191/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc7PqCsA",
    "number": 7191,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/7191/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/7191/timeline",
    "title": "[BUG] Fails to preprocess an array of struct inside another struct",
    "type": null,
    "updated_at": "2025-10-05T12:45:26Z",
    "url": "https://api.github.com/repos/cython/cython/issues/7191",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/14786764?v=4",
        "events_url": "https://api.github.com/users/pulkin/events{/privacy}",
        "followers_url": "https://api.github.com/users/pulkin/followers",
        "following_url": "https://api.github.com/users/pulkin/following{/other_user}",
        "gists_url": "https://api.github.com/users/pulkin/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/pulkin",
        "id": 14786764,
        "login": "pulkin",
        "node_id": "MDQ6VXNlcjE0Nzg2NzY0",
        "organizations_url": "https://api.github.com/users/pulkin/orgs",
        "received_events_url": "https://api.github.com/users/pulkin/received_events",
        "repos_url": "https://api.github.com/users/pulkin/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/pulkin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/pulkin/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/pulkin",
        "user_view_type": "public"
    }
}