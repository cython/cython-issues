{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "COLLABORATOR",
    "body": "<!--\r\n**PLEASE READ THIS FIRST:**\r\n- Do not use the bug and feature tracker for support requests. Use the `cython-users` mailing list instead.\r\n- Did you search for similar issues already? Please do, it helps to save us precious time that we otherwise could not invest into development.\r\n- Did you try the latest master branch or pre-release? It might already have what you want to report. Also see the [Changelog](https://github.com/cython/cython/blob/master/CHANGES.rst) regarding recent changes.\r\n-->\r\n\r\n**Describe the bug**\r\n\r\nIt takes a very long time for the C compiler to run on large files like ExprNodes.py and Nodes.py. This is seen in the CI `-all` tests repeatedly timing out (although partly this is because we can't compile them in parallel on Python 2.7)\r\n\r\nOne possible indicator is the warning from gcc:\r\n\r\n> `note: variable tracking size limit exceeded with ‘-fvar-tracking-assignments’, retrying without`\r\n\r\n(although that could potentially be toggled independently or the limit increased)\r\n\r\nObviously it's inevitable that a big Cython file will generate a big C file and that a big C file will take a while to compile, but potentially we could do better.\r\n\r\nThere's a few gcc flags to try to profile compilation time (https://stackoverflow.com/questions/13559818/profiling-the-c-compilation-process), and they suggest that the module init function (where all the module-level user code goes) is the main culprit (unsurprisingly)\r\n\r\n**Environment (please complete the following information):**\r\n - Linux, CI, most obviously in Python 2.7\r\n\r\n**Additional context**\r\n\r\nI tried a couple of approaches to fix the problem.\r\n\r\n1. First I created small sub-scopes within the module init function. https://github.com/da-woods/cython/tree/morelocaltemps. This didn't achieve any speedup or get rid of the warning, but may be worth using some of the change for other reasons (https://github.com/da-woods/cython/commit/c9014165baaf56bf3af0e08971f7e3eda46b428e#commitcomment-57239451)\r\n2. Second, I tried to split each stat at module-level into a separate function (https://github.com/cython/cython/pull/4386). This gave appreciable speed-ups for large modules. However the PR was very intended as a proof of concept with little attention to code quality....\r\n\r\nI think a variant of the second approach is probably worthwhile. My current thought that we shouldn't do it on a \"per-stat\" basis but maybe give each class creation a separate function (that's easy to do for `cdef` classes, slightly harder for regular classes). That would likely give the appropriate granularity and keep things grouped in logical units.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Looking around a bit, [it seems](https://gcc.gnu.org/wiki/Var_Tracking_Assignments) that variable tracking is mostly a debugging feature. Would be nice to locally disable it somehow, but I can't find a way to do that. In any case, the fact that large files break that feature shouldn't trouble us.\r\n\r\nI feel inclined to give a low priority to this issue. Not zero – if we can reduce the C compiler runtime, cool (also in terms of CO2 emissions), but it's only really an issue for large and very large modules, which are rare for simply practical reasons.",
            "created_at": "2021-10-24T09:05:54Z",
            "html_url": "https://github.com/cython/cython/issues/4425#issuecomment-950288163",
            "id": 950288163,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4425",
            "node_id": "IC_kwDOABDGAc44pD8j",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/950288163/reactions"
            },
            "updated_at": "2021-10-24T09:05:54Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/950288163",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "> Looking around a bit, [it seems](https://gcc.gnu.org/wiki/Var_Tracking_Assignments) that variable tracking is mostly a debugging feature. Would be nice to locally disable it somehow, but I can't find a way to do that. In any case, the fact that large files break that feature shouldn't trouble us.\r\n\r\nYeah - I also looked and couldn't find a way to disable it locally\r\n\r\n> \r\n> I feel inclined to give a low priority to this issue. Not zero – if we can reduce the C compiler runtime, cool (also in terms of CO2 emissions), but it's only really an issue for very large modules, which are rare for simply practical reasons.\r\n\r\nI agree - I was only really interested because it's causing the python 2.7 -all jobs to time out. I mainly created the issue because I _wasn't_ planning to do any more on it for now and wanted to record where I'd got to before forgetting it. So low priority!\r\n\r\n",
            "created_at": "2021-10-24T09:58:41Z",
            "html_url": "https://github.com/cython/cython/issues/4425#issuecomment-950295024",
            "id": 950295024,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4425",
            "node_id": "IC_kwDOABDGAc44pFnw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/950295024/reactions"
            },
            "updated_at": "2021-10-24T09:58:41Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/950295024",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "To add some more data points, the slowest test files to compile in clang are actually not those that have the most complex module init functions but a large number of types (including closures) and functions:\r\n```\r\ncompile-c   :  1425.27 sec  (1071,  1.331 / run) - slowest: 'c:test_unicode' (28.38s), 'c:test_coroutines_pep492' (27.53s), 'c:test_asyncgen' (14.11s), 'c:memslice' (13.31s), 'c:exttype_total_ordering' (13.10s), 'c:test_grammar' (12.91s), 'c:fused_def' (12.85s), 'c:numpy_test' (12.06s)\r\n```\r\nhttps://github.com/cython/cython/runs/3996856486?check_suite_focus=true\r\n\r\nCan't say why that is. clang seems really slow here in comparison to gcc:\r\n```\r\ncompile-c   :   161.93 sec  (1078,  0.150 / run) - slowest: 'c:numpy_test' (20.83s), 'c:test_unicode' (0.48s), 'c:relaxed_strides' (0.47s), 'c:test_coroutines_pep492' (0.46s), 'c:libc_stdio' (0.42s), 'c:behnel4' (0.40s), 'c:embedded' (0.38s), 'c:a_capi' (0.34s)\r\n```\r\nhttps://github.com/cython/cython/runs/3996853937?check_suite_focus=true\r\n\r\nI checked the CFLAGS and they should say `-O0' in both cases, which should be honoured by both gcc and clang alike as saying \"do not spend time optimising the code\".",
            "created_at": "2021-10-25T13:18:58Z",
            "html_url": "https://github.com/cython/cython/issues/4425#issuecomment-950921570",
            "id": 950921570,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4425",
            "node_id": "IC_kwDOABDGAc44reli",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/950921570/reactions"
            },
            "updated_at": "2021-10-25T13:18:58Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/950921570",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "On my laptop (just running `test_unicode`) I get\r\n\r\nclang:\r\n```\r\ncompile-c   :    45.93 sec  (   1, 45.928 / run) - slowest: 'c:test_unicode' (45.93s)\r\ncompile-cpp :    42.76 sec  (   1, 42.757 / run) - slowest: 'cpp:test_unicode' (42.76s)\r\n```\r\n\r\ngcc\r\n```\r\ncompile-c   :    57.95 sec  (   1, 57.948 / run) - slowest: 'c:test_unicode' (57.95s)\r\ncompile-cpp :    48.91 sec  (   1, 48.909 / run) - slowest: 'cpp:test_unicode' (48.91s)\r\n```\r\n\r\n(that's with `CLAGS=-Og`, just because `-O0` produces a lot of warnings when I use it).\r\n\r\nI'd say there's `ccache` is probably doing something here?",
            "created_at": "2021-10-25T17:43:05Z",
            "html_url": "https://github.com/cython/cython/issues/4425#issuecomment-951155889",
            "id": 951155889,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4425",
            "node_id": "IC_kwDOABDGAc44sXyx",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/951155889/reactions"
            },
            "updated_at": "2021-10-25T17:43:05Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/951155889",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Ah, yeah, right. We don't have ccache on macOS. Probably something we should change.\n",
            "created_at": "2021-10-25T19:48:35Z",
            "html_url": "https://github.com/cython/cython/issues/4425#issuecomment-951253408",
            "id": 951253408,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4425",
            "node_id": "IC_kwDOABDGAc44svmg",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/951253408/reactions"
            },
            "updated_at": "2021-10-25T19:48:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/951253408",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4425/comments",
    "created_at": "2021-10-23T13:52:15Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-10-23T13:54:05Z",
            "event": "labeled",
            "id": 5508301321,
            "label": {
                "color": "444444",
                "name": "Code Generation"
            },
            "node_id": "LE_lADOABDGAc49pDfezwAAAAFIUgIJ",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5508301321"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4425/events",
    "html_url": "https://github.com/cython/cython/issues/4425",
    "id": 1034172382,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425556330,
            "name": "Code Generation",
            "node_id": "MDU6TGFiZWw0MjU1NTYzMzA=",
            "url": "https://api.github.com/repos/cython/cython/labels/Code%20Generation"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4425/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc49pDfe",
    "number": 4425,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4425/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4425/timeline",
    "title": "[BUG] Large files compile very slowly in the C compiler",
    "updated_at": "2021-10-25T19:48:36Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4425",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
        "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
        "followers_url": "https://api.github.com/users/da-woods/followers",
        "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
        "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/da-woods",
        "id": 10536947,
        "login": "da-woods",
        "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
        "organizations_url": "https://api.github.com/users/da-woods/orgs",
        "received_events_url": "https://api.github.com/users/da-woods/received_events",
        "repos_url": "https://api.github.com/users/da-woods/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/da-woods"
    }
}