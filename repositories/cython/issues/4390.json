{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "COLLABORATOR",
    "body": "<!--\r\n**PLEASE READ THIS FIRST:**\r\n- Do not use the bug and feature tracker for support requests. Use the `cython-users` mailing list instead.\r\n- Did you search for similar issues already? Please do, it helps to save us precious time that we otherwise could not invest into development.\r\n- Did you try the latest master branch or pre-release? It might already have what you want to report. Also see the [Changelog](https://github.com/cython/cython/blob/master/CHANGES.rst) regarding recent changes.\r\n-->\r\n\r\nCopied from the users mailing list (https://groups.google.com/g/cython-users/c/VNuQKATGuss)\r\n\r\nI'm running cython (cloned from github mid-May 2021) and Python 3.6/3.7.9.  I've encountered an issue with circular imports, one that Python runs without a problem.  At its simplest, it's the following sequence of operations:\r\n\r\n```\r\nimport A.B         \r\n  from . import C      # <-- in A/B.py\r\n    from . import D    # <-- in A/C.py\r\n      from . import C  # <-- in A/D.py\r\n```\r\n\r\nIf you run this scenario in CPython, it runs without error, but if I compile all the .py files into C extensions using Cython, the last import fails with the error:\r\n\r\n> `ImportError: cannot import name C`\r\n\r\nEach of the above statements seems to be implemented by Cython with a pair of `__Pyx_Import` and `__Pyx_ImportFrom` calls.  The `__Pyx_Import` call attempts to do the import, and returns the parent package (in all cases above, it returns `A`).  The `__Pyx_ImportFrom` call just looks inside the returned module for an attribute with the requested name (`C`, or `D` in the above examples).  If the requested name ('C') in `__Pyx_ImportFrom` is actually a module that has not finished initializing yet, then it is not yet set as an attribute in its parent ('A') so this fails.\r\n\r\nIn CPython, I think, if the above attribute access (i.e. not `hasattr(A, 'C')`) fails, then it checks if it is a module (i.e. `__import__('A.C')`) probably to address this exact case.  Any chance `__Pyx_ImportFrom` could do this too to mimic CPython behavior?  Obviously the above scenario is silly, but the pattern shows up in an existing library that I'm trying to embed into a static Python interpreter and it seems like it is supported by the language.\r\n\r\nBelow is a list of commands that will generate the source files and test the above scenario on CentOS/RedHat 7, presumably minimal changes for other Linux variants.  Thanks for your help!\r\n\r\n```\r\nmkdir circular_import\r\ncd circular_import\r\nmkdir -p src/A\r\nmkdir -p install/A\r\necho \"from . import C\" > src/A/B.py\r\necho \"from . import D\" > src/A/C.py\r\necho \"from . import C\" > src/A/D.py\r\nfor i in A/{B,C,D} ; do cython src/\"${i}\".py ; gcc -shared -pthread -fPIC -fwrapv -O2 -Wall -fno-strict-aliasing -I/usr/include/python3.6m -o install/\"${i}\".so src/\"${i}\".c ; done\r\n\r\n(cd src && echo \"import A.B\" | python3 )  # succeeds\r\n(cd install && echo \"import A.B\" | python3 )  # fails\r\n```",
    "closed_at": "2021-12-18T11:49:28Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "I'm the original poster, thanks for bringing this over.  I've prototyped the following and it avoids the error above, but don't know if it's the most appropriate solution (or whether it follows code guidelines!):\r\n\r\n```diff --git a/Cython/Utility/ImportExport.c b/Cython/Utility/ImportExport.c\r\nindex a7e18c73c..22ea3ec15 100644\r\n--- a/Cython/Utility/ImportExport.c\r\n+++ b/Cython/Utility/ImportExport.c\r\n@@ -238,6 +238,23 @@ static PyObject* __Pyx_ImportFrom(PyObject* module, PyObject* name); /*proto*/\r\n static PyObject* __Pyx_ImportFrom(PyObject* module, PyObject* name) {\r\n     PyObject* value = __Pyx_PyObject_GetAttrStr(module, name);\r\n     if (unlikely(!value) && PyErr_ExceptionMatches(PyExc_AttributeError)) {\r\n+        /* in case name refers to a (sub-)module, try importing it by full name */\r\n+        PyErr_Clear();\r\n+        PyObject* module_name = PyModule_GetNameObject(module);\r\n+        if (module_name) {\r\n+            PyObject* dot = PyUnicode_FromString(\".\");\r\n+            PyObject* module_dot = PyUnicode_Concat(module_name, dot);\r\n+            PyObject* full_name = PyUnicode_Concat(module_dot, name);\r\n+            if (full_name) {\r\n+                value = __Pyx_Import(full_name, (PyObject *)NULL, 0);\r\n+            }\r\n+            Py_XDECREF(full_name);\r\n+            Py_XDECREF(module_dot);\r\n+            Py_XDECREF(dot);\r\n+            Py_XDECREF(module_name);\r\n+        }\r\n+    }\r\n+    if (unlikely(!value)) {\r\n         PyErr_Format(PyExc_ImportError,\r\n         #if PY_MAJOR_VERSION < 3\r\n             \"cannot import name %.230s\", PyString_AS_STRING(name));\r\n```",
            "created_at": "2021-09-30T20:35:09Z",
            "html_url": "https://github.com/cython/cython/issues/4390#issuecomment-931645439",
            "id": 931645439,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4390",
            "node_id": "IC_kwDOABDGAc43h8f_",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/931645439/reactions"
            },
            "updated_at": "2021-09-30T20:35:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/931645439",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1247460?v=4",
                "events_url": "https://api.github.com/users/SyamGadde/events{/privacy}",
                "followers_url": "https://api.github.com/users/SyamGadde/followers",
                "following_url": "https://api.github.com/users/SyamGadde/following{/other_user}",
                "gists_url": "https://api.github.com/users/SyamGadde/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/SyamGadde",
                "id": 1247460,
                "login": "SyamGadde",
                "node_id": "MDQ6VXNlcjEyNDc0NjA=",
                "organizations_url": "https://api.github.com/users/SyamGadde/orgs",
                "received_events_url": "https://api.github.com/users/SyamGadde/received_events",
                "repos_url": "https://api.github.com/users/SyamGadde/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/SyamGadde/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/SyamGadde/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/SyamGadde"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "I can see a tiny C89 change that we'd ask for:\r\n\r\n```\r\nPyErr_Clear();\r\nPyObject* module_name = ...\r\n```\r\n\r\nWe're trying to keep things C89 compatible for now, so declarations come at the start of the block (for `module_name`).\r\n\r\nI think a PR with that would be welcome. We'd want a test case, but the one in your post would be fine. Add it in a srctree file in tests/run.\r\n\r\n(I'm not an expert in the fine details of the import mechanism so there may be some details that I'm missing of course!)",
            "created_at": "2021-09-30T20:53:09Z",
            "html_url": "https://github.com/cython/cython/issues/4390#issuecomment-931661907",
            "id": 931661907,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4390",
            "node_id": "IC_kwDOABDGAc43iAhT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/931661907/reactions"
            },
            "updated_at": "2021-09-30T20:53:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/931661907",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "Also some `NULL` checks on the results of the unicode concats (as unlikely as it would be to trigger those)",
            "created_at": "2021-09-30T21:04:20Z",
            "html_url": "https://github.com/cython/cython/issues/4390#issuecomment-931699250",
            "id": 931699250,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4390",
            "node_id": "IC_kwDOABDGAc43iJoy",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/931699250/reactions"
            },
            "updated_at": "2021-09-30T21:04:20Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/931699250",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I'll work on a PR, thanks for the advice!",
            "created_at": "2021-09-30T21:17:48Z",
            "html_url": "https://github.com/cython/cython/issues/4390#issuecomment-931711855",
            "id": 931711855,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4390",
            "node_id": "IC_kwDOABDGAc43iMtv",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/931711855/reactions"
            },
            "updated_at": "2021-09-30T21:17:48Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/931711855",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1247460?v=4",
                "events_url": "https://api.github.com/users/SyamGadde/events{/privacy}",
                "followers_url": "https://api.github.com/users/SyamGadde/followers",
                "following_url": "https://api.github.com/users/SyamGadde/following{/other_user}",
                "gists_url": "https://api.github.com/users/SyamGadde/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/SyamGadde",
                "id": 1247460,
                "login": "SyamGadde",
                "node_id": "MDQ6VXNlcjEyNDc0NjA=",
                "organizations_url": "https://api.github.com/users/SyamGadde/orgs",
                "received_events_url": "https://api.github.com/users/SyamGadde/received_events",
                "repos_url": "https://api.github.com/users/SyamGadde/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/SyamGadde/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/SyamGadde/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/SyamGadde"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4390/comments",
    "created_at": "2021-09-30T19:07:59Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-09-30T19:21:35Z",
            "event": "labeled",
            "id": 5389875352,
            "label": {
                "color": "444444",
                "name": "Python Semantics"
            },
            "node_id": "LE_lADOABDGAc48Weg3zwAAAAFBQviY",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5389875352"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-12-15T11:43:14Z",
            "event": "labeled",
            "id": 5770755543,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "node_id": "LE_lADOABDGAc48Weg3zwAAAAFX9r3X",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5770755543"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-12-15T11:43:18Z",
            "event": "milestoned",
            "id": 5770755888,
            "milestone": {
                "title": "3.0"
            },
            "node_id": "MIE_lADOABDGAc48Weg3zwAAAAFX9r8w",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5770755888"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": "617a9592726e5d779a1de2973c83f510e0d4c7d6",
            "commit_url": "https://api.github.com/repos/cython/cython/commits/617a9592726e5d779a1de2973c83f510e0d4c7d6",
            "created_at": "2021-12-18T11:49:28Z",
            "event": "closed",
            "id": 5787945015,
            "node_id": "CE_lADOABDGAc48Weg3zwAAAAFY_Qg3",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5787945015"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4390/events",
    "html_url": "https://github.com/cython/cython/issues/4390",
    "id": 1012525111,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425553654,
            "name": "defect",
            "node_id": "MDU6TGFiZWw0MjU1NTM2NTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        },
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425556315,
            "name": "Python Semantics",
            "node_id": "MDU6TGFiZWw0MjU1NTYzMTU=",
            "url": "https://api.github.com/repos/cython/cython/labels/Python%20Semantics"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4390/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 519,
        "created_at": "2018-08-18T06:33:08Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
            "events_url": "https://api.github.com/users/scoder/events{/privacy}",
            "followers_url": "https://api.github.com/users/scoder/followers",
            "following_url": "https://api.github.com/users/scoder/following{/other_user}",
            "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/scoder",
            "id": 491659,
            "login": "scoder",
            "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
            "organizations_url": "https://api.github.com/users/scoder/orgs",
            "received_events_url": "https://api.github.com/users/scoder/received_events",
            "repos_url": "https://api.github.com/users/scoder/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/scoder"
        },
        "description": "Goals:\r\n– New version scheme: 3.x instead of 0.x.\r\n– Change default `language_level` from `2` to `3`.\r\n– Change default for `binding` directive from `False` to `True`.\r\n– Fix some Python compatibility issues (if possible, allowing for breaking changes).\r\n",
        "due_on": null,
        "html_url": "https://github.com/cython/cython/milestone/58",
        "id": 3580387,
        "labels_url": "https://api.github.com/repos/cython/cython/milestones/58/labels",
        "node_id": "MDk6TWlsZXN0b25lMzU4MDM4Nw==",
        "number": 58,
        "open_issues": 30,
        "state": "open",
        "title": "3.0",
        "updated_at": "2021-12-18T11:49:28Z",
        "url": "https://api.github.com/repos/cython/cython/milestones/58"
    },
    "node_id": "I_kwDOABDGAc48Weg3",
    "number": 4390,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4390/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4390/timeline",
    "title": "[BUG] Partially loaded circular imports don't import",
    "updated_at": "2021-12-18T11:49:28Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4390",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
        "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
        "followers_url": "https://api.github.com/users/da-woods/followers",
        "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
        "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/da-woods",
        "id": 10536947,
        "login": "da-woods",
        "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
        "organizations_url": "https://api.github.com/users/da-woods/orgs",
        "received_events_url": "https://api.github.com/users/da-woods/received_events",
        "repos_url": "https://api.github.com/users/da-woods/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/da-woods"
    }
}