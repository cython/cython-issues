{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Describe your issue\n\nWarning - there's a big ABI-Compatibility issue here that I haven't yet got a great solution to.\n\n------------------\n\nOne issue with typed memoryviews is that the memoryviewslice structure is huge (just over 200 bytes):\n\nhttps://github.com/cython/cython/blob/f9519726a7dfe74ce4b10904848fdb611c03b656/Cython/Utility/MemoryView_C.c#L9-L15\n\nThey're usually passed by value, which makes simply passing around and copying this structure a significant amount of work.\n\nHowever: we do actually know in advance how many dimensions each memoryviewslice has (usually significantly less than 8), whether it's contiguous (which would allow us to eliminate `strides`), and whether it's direct (which would allow us to eliminate `suboffsets`).\n\nMy feeling is that it'd be worth specializing into a bunch of different structs each containing just enough data to represent the exact memoryview we're handling.\n\nThere's a couple of complications:\n* It'd make the code-deduplication/shared library harder. I don't think this is too difficult to solve but I haven't yet looked in detail.\n* ABI compatibility. My current theory involves splitting `__pyx_capi__` into something versioned (and leaving compatibility shims in `__pyx_capi__` for now). I think this is a different problem to #7029. But slightly related so shouldn't be considered completely in isolation.",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I'd guess (and that's really a guess) that the C compiler can probably avoid actually passing the data around in many cases, as long as we're staying inside of the current module. When crossing module borders, we'd have to take care of ABI issues either way, so that case is already less likely to provide an advantage. So it doesn't seem entirely obvious that it'll be worth the effort (once we know how much that is). I doubt that we'd ever bring it down to the efficiency of register passing.\n\nSince we're passing the structs by value, we could start small and _always_ copy the struct semantically into the expected target struct rather than byte-wise, whatever the target side expects. External function calls would then use the full current size (at least as long as we don't have a good solution to the ABI problem), whereas module internal calls could strip down the size to a tightly adapted struct. That has the potential of slowing things down, because it would probably prevent the C compiler from applying tricks to avoid the value passing. But it could also detect overlaps in the structs (or layout identity) and speed up the copying again.\n\nMy assumption is that the number of different memory view configurations inside of a given module would be small, often just one number of dimensions with contiguous and non-contiguous variants due to slicing, maybe direct/indirect variants. But then, anything coming form the outside is probably unpredictable and still needs to be allowed by all functions, and we'd need to generate wrappers for the boundaries and possibly still duplicate code to support the internal and (arbitrary) external cases.\n\nOverall, it seems a lot of effort with unclear gain. Probably still worth investigating a little more to reduce the guessing, though.",
            "created_at": "2025-12-27T06:41:54Z",
            "html_url": "https://github.com/cython/cython/issues/7433#issuecomment-3693759408",
            "id": 3693759408,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7433",
            "node_id": "IC_kwDOABDGAc7cKkuw",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3693759408/reactions"
            },
            "updated_at": "2025-12-27T06:41:54Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3693759408",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I think the investigation is fairly easy - the maximum number of dimensions is configurable so it's simple enough to run some benchmarks with 8 dimensions and 1 or 2 dimensions and see if there's a noticeable difference. And suboffsets is hardly ever used to could be commented out just for the benchmarks to see what happens.\n\nSo it's definitely possible to find out the likely effect without solving all the corner cases for module boundaries.\n\nI haven't done any of that yet though. I'll try to have a look in the fairly near future though",
            "created_at": "2025-12-27T09:45:28Z",
            "html_url": "https://github.com/cython/cython/issues/7433#issuecomment-3693869493",
            "id": 3693869493,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7433",
            "node_id": "IC_kwDOABDGAc7cK_m1",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3693869493/reactions"
            },
            "updated_at": "2025-12-27T09:45:28Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3693869493",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "```\n2025-12-27 11:55:32  ### Benchmark 'bm_mview_const_char_bytes' (min/median/max/ ±% of median):\n2025-12-27 11:55:32      Cython 'max_dims2'        =   3.163 usec,   3.275 usec,   3.401 usec\n2025-12-27 11:55:32      Cython 'master'            =   7.158 usec,   7.308 usec,   7.578 usec  (  +123.2 %)\n2025-12-27 11:55:32      Cython 'max_dims1'          =   2.924 usec,   3.051 usec,   3.279 usec  (    -6.8 %)\n2025-12-27 11:55:32  ### Benchmark 'bm_mview_const_char_bytearray' (min/median/max/ ±% of median):\n2025-12-27 11:55:32      Cython 'max_dims2'        =   3.200 usec,   3.385 usec,   3.467 usec\n2025-12-27 11:55:32      Cython 'master'            =   7.541 usec,   8.619 usec,  12.265 usec  (  +154.6 %)\n2025-12-27 11:55:32      Cython 'max_dims1'          =   4.566 usec,   4.699 usec,   4.859 usec  (   +38.8 %)\n2025-12-27 11:55:32  ### Benchmark 'bm_mview_const_char_pyarray' (min/median/max/ ±% of median):\n2025-12-27 11:55:32      Cython 'max_dims2'        =   3.268 usec,   3.304 usec,   3.358 usec\n2025-12-27 11:55:32      Cython 'master'            =   7.256 usec,   7.361 usec,   8.325 usec  (  +122.8 %)\n2025-12-27 11:55:32      Cython 'max_dims1'          =   4.162 usec,   4.408 usec,   5.241 usec  (   +33.4 %)\n2025-12-27 11:55:32  ### Benchmark 'bm_slice_memoryview' (min/median/max/ ±% of median):\n2025-12-27 11:55:32      Cython 'max_dims2'        =   2.860 usec,   2.938 usec,   3.308 usec\n2025-12-27 11:55:32      Cython 'master'            =   6.639 usec,   6.780 usec,   7.194 usec  (  +130.8 %)\n2025-12-27 11:55:32      Cython 'max_dims1'          =   3.827 usec,   4.463 usec,   4.687 usec  (   +51.9 %)\n```\n\nTo me, it looks like there's a worthwhile speed-up to be had by reducing the number of dimensions. It isn't completely straightforward (i.e. 1 dim seems consistently slightly slower than 2 dims).  My impression is that the amount of actual work in those benchmarks is pretty small so that's probably a fairly extreme case where it will help a lot.\n\nRemoving suboffsets was more trouble than it was worth for a quick test.\n\nI'd definitely be in favour of avoiding too much complexity here though. I wonder if there's an easy subset that's worth doing initially (i.e. just reducing the number of dimensions without worrying about suboffsets/steps).",
            "created_at": "2025-12-27T12:11:46Z",
            "html_url": "https://github.com/cython/cython/issues/7433#issuecomment-3693938889",
            "id": 3693938889,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7433",
            "node_id": "IC_kwDOABDGAc7cLQjJ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3693938889/reactions"
            },
            "updated_at": "2025-12-27T12:11:46Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3693938889",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/7433/comments",
    "created_at": "2025-12-26T15:22:28Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5534781?v=4",
                "events_url": "https://api.github.com/users/leofang/events{/privacy}",
                "followers_url": "https://api.github.com/users/leofang/followers",
                "following_url": "https://api.github.com/users/leofang/following{/other_user}",
                "gists_url": "https://api.github.com/users/leofang/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/leofang",
                "id": 5534781,
                "login": "leofang",
                "node_id": "MDQ6VXNlcjU1MzQ3ODE=",
                "organizations_url": "https://api.github.com/users/leofang/orgs",
                "received_events_url": "https://api.github.com/users/leofang/received_events",
                "repos_url": "https://api.github.com/users/leofang/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/leofang/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/leofang/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/leofang",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-12-26T17:46:20Z",
            "event": "subscribed",
            "id": 21760904392,
            "node_id": "SE_lADOABDGAc7gVGhXzwAAAAURDQzI",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/21760904392"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/7433/events",
    "html_url": "https://github.com/cython/cython/issues/7433",
    "id": 3763628119,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/7433/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc7gVGhX",
    "number": 7433,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/7433/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/7433/timeline",
    "title": "[ENH] Reduce size of memoryviewslice struct",
    "type": null,
    "updated_at": "2025-12-27T12:11:46Z",
    "url": "https://api.github.com/repos/cython/cython/issues/7433",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
        "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
        "followers_url": "https://api.github.com/users/da-woods/followers",
        "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
        "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/da-woods",
        "id": 10536947,
        "login": "da-woods",
        "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
        "organizations_url": "https://api.github.com/users/da-woods/orgs",
        "received_events_url": "https://api.github.com/users/da-woods/received_events",
        "repos_url": "https://api.github.com/users/da-woods/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/da-woods",
        "user_view_type": "public"
    }
}