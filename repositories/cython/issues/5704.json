{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\r\n\r\nWhen trying to run the fastavro CI with Cython 3, I get the following error. It works when I use Cython<3, but I'd like to be able to upgrade and unfortunately I'm not sure what the problem is. Here's a [link to the PR that uses Cython 3](https://github.com/fastavro/fastavro/pull/703), but the error itself is below:\r\n\r\n```\r\n[1/1] Cythonizing fastavro/_read.pyx\r\n...\r\n            writer_schema, named_schemas, offset, size, options,\r\n        )\r\n\r\n\r\nclass Block:\r\n    def __init__(\r\n    ^\r\n------------------------------------------------------------\r\n\r\nfastavro/_read.pyx:962:4: Compiler crash in AnalyseDeclarationsTransform\r\n\r\nFile 'ModuleNode.py', line 203, in analyse_declarations: ModuleNode(_read.pyx:1:0,\r\n    doc = 'Python code for reading AVRO files',\r\n    full_module_name = 'fastavro._read')\r\nFile 'Nodes.py', line 393, in analyse_declarations: StatListNode(_read.pyx:10:0)\r\nFile 'Nodes.py', line 393, in analyse_declarations: StatListNode(_read.pyx:961:0)\r\nFile 'Nodes.py', line 5169, in analyse_declarations: PyClassDefNode(_read.pyx:961:0,\r\n    name = 'Block')\r\nFile 'Nodes.py', line 393, in analyse_declarations: StatListNode(_read.pyx:962:4)\r\nFile 'Nodes.py', line 2712, in analyse_declarations: CFuncDefNode(_read.pyx:962:4,\r\n    args = [...]/10,\r\n    modifiers = [...]/0,\r\n    outer_attrs = [...]/2,\r\n    overridable = True,\r\n    visibility = 'private')\r\nFile 'Nodes.py', line 27[23](https://github.com/fastavro/fastavro/actions/runs/6193366151/job/16814773207?pr=703#step:7:24), in declare_cpdef_wrapper: CFuncDefNode(_read.pyx:962:4,\r\n    args = [...]/10,\r\n    modifiers = [...]/0,\r\n    outer_attrs = [...]/2,\r\n    overridable = True,\r\n    visibility = 'private')\r\nFile 'Nodes.py', line 2789, in call_self_node: CFuncDefNode(_read.pyx:962:4,\r\n    args = [...]/10,\r\n    modifiers = [...]/0,\r\n    outer_attrs = [...]/2,\r\n    overridable = True,\r\n    visibility = 'private')\r\n\r\nCompiler crash traceback from this point on:\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/Cython/Compiler/Nodes.py\", line 2789, in call_self_node\r\n    type_entry = self.type.args[0].type.entry\r\n                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'PyObjectType' object has no attribute 'entry'\r\nTraceback (most recent call last):\r\n  File \"/Users/runner/work/fastavro/fastavro/setup.py\", line 37, in <module>\r\n    setup(\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/__init__.py\", line 87, in setup\r\n    return distutils.core.setup(**attrs)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/_distutils/core.py\", line 185, in setup\r\n    return run_commands(dist)\r\n           ^^^^^^^^^^^^^^^^^^\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/_distutils/core.py\", line 201, in run_commands\r\n    dist.run_commands()\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/_distutils/dist.py\", line 968, in run_commands\r\n    self.run_command(cmd)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/dist.py\", line 1217, in run_command\r\n    super().run_command(command)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/_distutils/dist.py\", line 987, in run_command\r\n    cmd_obj.run()\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/command/build_ext.py\", line 84, in run\r\n    _build_ext.run(self)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/_distutils/command/build_ext.py\", line 346, in run\r\n    self.build_extensions()\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/_distutils/command/build_ext.py\", line 466, in build_extensions\r\n    self._build_extensions_serial()\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/_distutils/command/build_ext.py\", line 492, in _build_extensions_serial\r\n    self.build_extension(ext)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/setuptools/command/build_ext.py\", line [24](https://github.com/fastavro/fastavro/actions/runs/6193366151/job/16814773207?pr=703#step:7:25)6, in build_extension\r\n    _build_ext.build_extension(self, ext)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/Cython/Distutils/build_ext.py\", line 122, in build_extension\r\n    new_ext = cythonize(\r\n              ^^^^^^^^^^\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/Cython/Build/Dependencies.py\", line 1134, in cythonize\r\n    cythonize_one(*args)\r\n  File \"/Library/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/Cython/Build/Dependencies.py\", line 1[30](https://github.com/fastavro/fastavro/actions/runs/6193366151/job/16814773207?pr=703#step:7:31)1, in cythonize_one\r\n    raise CompileError(None, pyx_file)\r\nCython.Compiler.Errors.CompileError: fastavro/_read.pyx\r\nError: Process completed with exit code 1.\r\n```\r\n\r\n### Code to reproduce the behaviour:\r\n\r\nUnfortunately I don't have a minimal reproducible case because I don't fully understand the error. But this does reproduce the problem currently\r\n\r\n```\r\ngit clone git@github.com:fastavro/fastavro.git\r\ncd fastavro\r\ngit checkout dependabot/pip/cython-lt-4\r\npython3.11 -m venv py311\r\nsource py311/bin/activate\r\npip install .\r\n```\r\n\r\n### Expected behaviour\r\n\r\nNo error\r\n\r\n### OS\r\n\r\nLinux, Windows, and macOS\r\n\r\n### Python version\r\n\r\nAt least 3.9, 3.10, 3.11\r\n\r\n### Cython version\r\n\r\n3.0.2\r\n\r\n### Additional context\r\n\r\n_No response_",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "This bisects to 16aba7eb35b2a6f0c88b53da00539a5d875ebfdf\r\n\r\nIt really isn't obvious what's going wrong right now - it looks like a fairly standard definition of `__init__`",
            "created_at": "2023-09-17T19:13:20Z",
            "html_url": "https://github.com/cython/cython/issues/5704#issuecomment-1722545601",
            "id": 1722545601,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5704",
            "node_id": "IC_kwDOABDGAc5mq_XB",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1722545601/reactions"
            },
            "updated_at": "2023-09-17T19:13:20Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1722545601",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Actually, the one unusual thing you're doing is `# cython: auto_cpdef=True` which practically isn't used much (so probably isn't tested much). At very least `__init__` should excluded from `cpdef`.\r\n\r\nWe seem to be missing tests for auto_cpdef and classes.",
            "created_at": "2023-09-17T19:15:01Z",
            "html_url": "https://github.com/cython/cython/issues/5704#issuecomment-1722545963",
            "id": 1722545963,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5704",
            "node_id": "IC_kwDOABDGAc5mq_cr",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1722545963/reactions"
            },
            "updated_at": "2023-09-17T19:16:31Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1722545963",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "Thanks for the hint. I think this might be on the right track. I removed those `auto_cpdef` comments and it still failed, but with RuntimeErrors about generators that I should be able to look into further myself. When I have time to look at that I'll comment back and let you know the outcome.",
            "created_at": "2023-09-18T12:15:17Z",
            "html_url": "https://github.com/cython/cython/issues/5704#issuecomment-1723288742",
            "id": 1723288742,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5704",
            "node_id": "IC_kwDOABDGAc5mt0ym",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1723288742/reactions"
            },
            "updated_at": "2023-09-18T12:15:17Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1723288742",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6951699?v=4",
                "events_url": "https://api.github.com/users/scottbelden/events{/privacy}",
                "followers_url": "https://api.github.com/users/scottbelden/followers",
                "following_url": "https://api.github.com/users/scottbelden/following{/other_user}",
                "gists_url": "https://api.github.com/users/scottbelden/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scottbelden",
                "id": 6951699,
                "login": "scottbelden",
                "node_id": "MDQ6VXNlcjY5NTE2OTk=",
                "organizations_url": "https://api.github.com/users/scottbelden/orgs",
                "received_events_url": "https://api.github.com/users/scottbelden/received_events",
                "repos_url": "https://api.github.com/users/scottbelden/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scottbelden/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scottbelden/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scottbelden"
            }
        },
        {
            "author_association": "NONE",
            "body": "I removed the auto_cpdef and it revealed the underlying issue with my code. I'm not sure if there's anything to be done on the cython side, so feel free to close this if you'd like.",
            "created_at": "2023-09-19T02:35:24Z",
            "html_url": "https://github.com/cython/cython/issues/5704#issuecomment-1724746123",
            "id": 1724746123,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5704",
            "node_id": "IC_kwDOABDGAc5mzYmL",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1724746123/reactions"
            },
            "updated_at": "2023-09-19T02:35:24Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1724746123",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/6951699?v=4",
                "events_url": "https://api.github.com/users/scottbelden/events{/privacy}",
                "followers_url": "https://api.github.com/users/scottbelden/followers",
                "following_url": "https://api.github.com/users/scottbelden/following{/other_user}",
                "gists_url": "https://api.github.com/users/scottbelden/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scottbelden",
                "id": 6951699,
                "login": "scottbelden",
                "node_id": "MDQ6VXNlcjY5NTE2OTk=",
                "organizations_url": "https://api.github.com/users/scottbelden/orgs",
                "received_events_url": "https://api.github.com/users/scottbelden/received_events",
                "repos_url": "https://api.github.com/users/scottbelden/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scottbelden/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scottbelden/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scottbelden"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I think we should at least have some tests for methods+`auto_cpdef` so I'll leave this open for now. Since I'm not convinced the bug is completely on your side",
            "created_at": "2023-09-19T06:37:57Z",
            "html_url": "https://github.com/cython/cython/issues/5704#issuecomment-1724912157",
            "id": 1724912157,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5704",
            "node_id": "IC_kwDOABDGAc5m0BId",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1724912157/reactions"
            },
            "updated_at": "2023-09-19T06:37:57Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1724912157",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5704/comments",
    "created_at": "2023-09-15T03:34:32Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5704/events",
    "html_url": "https://github.com/cython/cython/issues/5704",
    "id": 1897647935,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5704/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5xG88_",
    "number": 5704,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5704/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5704/timeline",
    "title": "[BUG] AttributeError: 'PyObjectType' object has no attribute 'entry'",
    "updated_at": "2023-09-19T06:37:57Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5704",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/6951699?v=4",
        "events_url": "https://api.github.com/users/scottbelden/events{/privacy}",
        "followers_url": "https://api.github.com/users/scottbelden/followers",
        "following_url": "https://api.github.com/users/scottbelden/following{/other_user}",
        "gists_url": "https://api.github.com/users/scottbelden/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/scottbelden",
        "id": 6951699,
        "login": "scottbelden",
        "node_id": "MDQ6VXNlcjY5NTE2OTk=",
        "organizations_url": "https://api.github.com/users/scottbelden/orgs",
        "received_events_url": "https://api.github.com/users/scottbelden/received_events",
        "repos_url": "https://api.github.com/users/scottbelden/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/scottbelden/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scottbelden/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/scottbelden"
    }
}