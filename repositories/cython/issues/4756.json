{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "I would like to access return type hints for `cpdef` functions for static type validation. This works as expected for `def` functions and arguments for both , thank you! It would be great to also support this for `cpdef` functions. ~Similarly, accessing default values for parameters would be useful.~ (edit: default values are in the signature on `master` already). Having this information available could also help with #3150. Here's an example.\r\n\r\n```cython\r\n# cython: embedsignature=True\r\n# cython: binding=True\r\nimport inspect\r\n\r\n\r\ncpdef double cpdef_example(a: int, b: float = 3):\r\n    pass\r\n\r\n\r\ndef def_example(a: int, b: float = 3) -> double:\r\n    pass\r\n\r\n\r\nfor func in [def_example, cpdef_example]:\r\n    signature = inspect.signature(func)\r\n    print(signature)\r\n\r\n# Output (ideally, the following two lines should be identical).\r\n# (a: 'int', b: 'float' = 3.0) -> 'double'\r\n# (a: 'int', b: 'float')\r\n```\r\n\r\nI've had a look at the parser, and it seems that type hints for `cpdef` functions could be included here\r\n\r\nhttps://github.com/cython/cython/blob/b7674bc7412d2b87347a7f4ad10e50c1153bdb66/Cython/Compiler/Nodes.py#L2631-L2639\r\n\r\nakin to the same return type annotation for `def` functions here\r\n\r\nhttps://github.com/cython/cython/blob/b7674bc7412d2b87347a7f4ad10e50c1153bdb66/Cython/Compiler/Parsing.py#L3514-L3517\r\n\r\nHowever, my understanding of the parser isn't deep enough to address the issue. I've not been able to find the relevant code section for including default values yet.\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "It's probably `PyCFunctionNode` that you want to look at (https://github.com/cython/cython/blob/d48d0a038e2838d3bd2981e2687557a86936076b/Cython/Compiler/ExprNodes.py#L9441) - that's what sets up most of the introspectable bits of the cyfunction type",
            "created_at": "2022-04-23T11:04:37Z",
            "html_url": "https://github.com/cython/cython/issues/4756#issuecomment-1107453145",
            "id": 1107453145,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4756",
            "node_id": "IC_kwDOABDGAc5CAmTZ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1107453145/reactions"
            },
            "updated_at": "2022-04-23T11:04:37Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1107453145",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "On a closer look I was a little uncomfortable with this. Comments are summarised from #4759. Essentially I can see that types can be generated from annotations but I'm not necessarily convinced annotations should be generated from types. Mainly because I'm not sure the user intent was there.\r\n\r\nI raised the example of:\r\n\r\n```\r\ncpdef f(x: double, double y):\r\n    return [x, y]\r\n```\r\n\r\nwhich generates an annotation for `x` but not for `y`, which I think was reasonable (because it's what the user asked us to do). I think we should probably do the same thing for arguments and return types.\r\n\r\nReasons not to generate an annotation were\r\n* It feels like it might conflict with user intent - it's possible (if not recommended) to use annotations for anything you like so seems possible that Cython-generated annotations might conflict with users who are using them for more creative things. I don't know how likely it is - I think most people just use them for types.\r\n* I think it'd be possible to give both an old-style Cython type and an annotation on the same variable (obviously not impossible but just something we'd have to handle)\r\n* Some Cython-generated annotations might conflict with Python type-checkers - e.g. `libcpp.vector.vector[double]` wouldn't mean much to a type-checker (and from a Cython point of view means \"any iterable of floating point elements\" when used as an input, or \"list of floats\" when returned). Obviously we allow these as annotations, but that is at least a user choice.\r\n* We don't quite know what will happen with PEP563 - currently Cython converts all annotations to strings and that's fine, but that might have to change, and it might be harder to deal with annotations for C types in that case.\r\n\r\nI note that I'm not a big user of annotations (or type-checking tools based on them) in Python so probably am not the right person to comment. But I'm unsure what the right thing to do is.\r\n\r\n-----------------------------\r\n\r\nFinally, `cpdef f() -> list` isn't allowed, and\r\n\r\n```\r\n@cython.ccall\r\ndef f() -> list:\r\n    ....\r\n```\r\n\r\ndoesn't generate an annotation.\r\n\r\nMy personal view is that we should allow explicit return type annotations on `cpdef` functions (be they \"pure Python\" or defined in the traditional Cython `cpdef` way) and make sure they create the correct annotations. But I'm not sure we should auto-convert Cython types into annotations (and definitely not without a good way to turn it off).",
            "created_at": "2022-04-27T18:56:12Z",
            "html_url": "https://github.com/cython/cython/issues/4756#issuecomment-1111367781",
            "id": 1111367781,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4756",
            "node_id": "IC_kwDOABDGAc5CPiBl",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1111367781/reactions"
            },
            "updated_at": "2022-04-27T18:56:12Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1111367781",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> My personal view is that we should allow explicit return type annotations on cpdef functions (be they \"pure Python\" or defined in the traditional Cython cpdef way) and make sure they create the correct annotations.\r\n\r\nThis sounds like an excellent plan.",
            "created_at": "2022-04-28T11:34:44Z",
            "html_url": "https://github.com/cython/cython/issues/4756#issuecomment-1112097038",
            "id": 1112097038,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4756",
            "node_id": "IC_kwDOABDGAc5CSUEO",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1112097038/reactions"
            },
            "updated_at": "2022-04-28T11:34:44Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1112097038",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/966348?v=4",
                "events_url": "https://api.github.com/users/tillahoffmann/events{/privacy}",
                "followers_url": "https://api.github.com/users/tillahoffmann/followers",
                "following_url": "https://api.github.com/users/tillahoffmann/following{/other_user}",
                "gists_url": "https://api.github.com/users/tillahoffmann/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/tillahoffmann",
                "id": 966348,
                "login": "tillahoffmann",
                "node_id": "MDQ6VXNlcjk2NjM0OA==",
                "organizations_url": "https://api.github.com/users/tillahoffmann/orgs",
                "received_events_url": "https://api.github.com/users/tillahoffmann/received_events",
                "repos_url": "https://api.github.com/users/tillahoffmann/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/tillahoffmann/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/tillahoffmann/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/tillahoffmann"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4756/comments",
    "created_at": "2022-04-23T10:46:04Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/966348?v=4",
                "events_url": "https://api.github.com/users/tillahoffmann/events{/privacy}",
                "followers_url": "https://api.github.com/users/tillahoffmann/followers",
                "following_url": "https://api.github.com/users/tillahoffmann/following{/other_user}",
                "gists_url": "https://api.github.com/users/tillahoffmann/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/tillahoffmann",
                "id": 966348,
                "login": "tillahoffmann",
                "node_id": "MDQ6VXNlcjk2NjM0OA==",
                "organizations_url": "https://api.github.com/users/tillahoffmann/orgs",
                "received_events_url": "https://api.github.com/users/tillahoffmann/received_events",
                "repos_url": "https://api.github.com/users/tillahoffmann/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/tillahoffmann/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/tillahoffmann/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/tillahoffmann"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2022-04-24T15:29:04Z",
            "event": "renamed",
            "id": 6486001559,
            "node_id": "RTE_lADOABDGAc5IUQRazwAAAAGCmIeX",
            "performed_via_github_app": null,
            "rename": {
                "from": "[ENH] Return type hints and parameter defaults for `cpdef` functions.",
                "to": "[ENH] Return type hints for `cpdef` functions."
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/6486001559"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4756/events",
    "html_url": "https://github.com/cython/cython/issues/4756",
    "id": 1213269082,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4756/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5IUQRa",
    "number": 4756,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4756/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4756/timeline",
    "title": "[ENH] Return type hints for `cpdef` functions.",
    "updated_at": "2022-04-28T11:34:44Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4756",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/966348?v=4",
        "events_url": "https://api.github.com/users/tillahoffmann/events{/privacy}",
        "followers_url": "https://api.github.com/users/tillahoffmann/followers",
        "following_url": "https://api.github.com/users/tillahoffmann/following{/other_user}",
        "gists_url": "https://api.github.com/users/tillahoffmann/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/tillahoffmann",
        "id": 966348,
        "login": "tillahoffmann",
        "node_id": "MDQ6VXNlcjk2NjM0OA==",
        "organizations_url": "https://api.github.com/users/tillahoffmann/orgs",
        "received_events_url": "https://api.github.com/users/tillahoffmann/received_events",
        "repos_url": "https://api.github.com/users/tillahoffmann/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/tillahoffmann/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/tillahoffmann/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/tillahoffmann"
    }
}