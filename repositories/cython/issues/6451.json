{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\r\n\r\n\r\nCompile failed when using the following configuration\r\n```\r\n define_macros=[(\"Py_LIMITED_API\", 0x03070000), ], py_limited_api=True\r\n```\r\nerror：There are many\r\n```\r\ntest_add.c: In function ‘__Pyx_CyFunction_clear’:\r\ntest_add.c:3976:16: error: ‘PyCFunctionObject’ undeclared (first use in this function)\r\n     Py_CLEAR(((PyCFunctionObject*)m)->m_module);\r\n                ^\r\n/usr/local/include/python3.7m/object.h:844:42: note: in definition of macro ‘Py_CLEAR’\r\n         PyObject *_py_tmp = (PyObject *)(op);   \\\r\n                                          ^\r\ntest_add.c:3976:34: error: expected expression before ‘)’ token\r\n     Py_CLEAR(((PyCFunctionObject*)m)->m_module);\r\n                                  ^\r\n/usr/local/include/python3.7m/object.h:844:42: note: in definition of macro ‘Py_CLEAR’\r\n         PyObject *_py_tmp = (PyObject *)(op);   \\\r\n                                          ^\r\ntest_add.c:3976:33: error: invalid operands to binary * (have ‘struct PyMemberDef *’ and ‘struct PyMemberDef *’)\r\n     Py_CLEAR(((PyCFunctionObject*)m)->m_module);\r\n                                 ^\r\n/usr/local/include/python3.7m/object.h:844:42: note: in definition of macro ‘Py_CLEAR’\r\n         PyObject *_py_tmp = (PyObject *)(op);   \\\r\n                                          ^\r\ntest_add.c:3976:37: error: ‘PyMemberDef’ has no member named ‘m_module’\r\n     Py_CLEAR(((PyCFunctionObject*)m)->m_module);\r\n                                     ^\r\n/usr/local/include/python3.7m/object.h:844:42: note: in definition of macro ‘Py_CLEAR’\r\n         PyObject *_py_tmp = (PyObject *)(op);   \\\r\n                                          ^\r\ntest_add.c:3976:34: error: expected expression before ‘)’ token\r\n     Py_CLEAR(((PyCFunctionObject*)m)->m_module);\r\n                                  ^\r\n/usr/local/include/python3.7m/object.h:846:14: note: in definition of macro ‘Py_CLEAR’\r\n             (op) = NULL;                        \\\r\n              ^\r\ntest_add.c:3976:33: error: invalid operands to binary * (have ‘struct PyMemberDef *’ and ‘struct PyMemberDef *’)\r\n     Py_CLEAR(((PyCFunctionObject*)m)->m_module);\r\n                                 ^\r\n/usr/local/include/python3.7m/object.h:846:14: note: in definition of macro ‘Py_CLEAR’\r\n             (op) = NULL;                        \\\r\n              ^\r\ntest_add.c:3976:37: error: ‘PyMemberDef’ has no member named ‘m_module’\r\n     Py_CLEAR(((PyCFunctionObject*)m)->m_module);\r\n                                     ^\r\n/usr/local/include/python3.7m/object.h:846:14: note: in definition of macro ‘Py_CLEAR’\r\n             (op) = NULL;                        \\\r\n              ^\r\n/usr/local/include/python3.7m/object.h:846:13: warning: statement with no effect [-Wunused-value]\r\n             (op) = NULL;                        \\\r\n             ^\r\ntest_add.c:3976:5: note: in expansion of macro ‘Py_CLEAR’\r\n     Py_CLEAR(((PyCFunctionObject*)m)->m_module);\r\n     ^\r\ntest_add.c: In function ‘__Pyx__CyFunction_dealloc’:\r\ntest_add.c:3897:49: error: ‘PyCFunctionObject’ undeclared (first use in this function)\r\n #define __Pyx_CyFunction_weakreflist(cyfunc) (((PyCFunctionObject*)cyfunc)->m_weakreflist)\r\n                                                 ^\r\ntest_add.c:4011:9: note: in expansion of macro ‘__Pyx_CyFunction_weakreflist’\r\n     if (__Pyx_CyFunction_weakreflist(m) != NULL)\r\n         ^\r\ntest_add.c:3897:67: error: expected expression before ‘)’ token\r\n #define __Pyx_CyFunction_weakreflist(cyfunc) (((PyCFunctionObject*)cyfunc)->m_weakreflist)\r\n                                                                   ^\r\ntest_add.c:4011:9: note: in expansion of macro ‘__Pyx_CyFunction_weakreflist’\r\n     if (__Pyx_CyFunction_weakreflist(m) != NULL)\r\n         ^\r\ntest_add.c:3897:66: error: invalid operands to binary * (have ‘struct PyMemberDef *’ and ‘struct PyMemberDef *’)\r\n #define __Pyx_CyFunction_weakreflist(cyfunc) (((PyCFunctionObject*)cyfunc)->m_weakreflist)\r\n                                                                  ^\r\ntest_add.c:4011:9: note: in expansion of macro ‘__Pyx_CyFunction_weakreflist’\r\n     if (__Pyx_CyFunction_weakreflist(m) != NULL)\r\n         ^\r\ntest_add.c:3897:75: error: ‘PyMemberDef’ has no member named ‘m_weakreflist’\r\n #define __Pyx_CyFunction_weakreflist(cyfunc) (((PyCFunctionObject*)cyfunc)->m_weakreflist)\r\n                                                                           ^\r\ntest_add.c:4011:9: note: in expansion of macro ‘__Pyx_CyFunction_weakreflist’\r\n     if (__Pyx_CyFunction_weakreflist(m) != NULL)\r\n         ^\r\nIn file included from /usr/local/include/python3.7m/Python.h:91:0,\r\n                 from test_add.c:34:\r\ntest_add.c: In function ‘__Pyx_CyFunction_traverse’:\r\ntest_add.c:4027:16: error: ‘PyCFunctionObject’ undeclared (first use in this function)\r\n     Py_VISIT(((PyCFunctionObject*)m)->m_module);\r\n                ^\r\n/usr/local/include/python3.7m/objimpl.h:357:13: note: in definition of macro ‘Py_VISIT’\r\n         if (op) {                                                       \\\r\n             ^\r\n```\r\n\r\n### Code to reproduce the behaviour:\r\n\r\n```cython\r\nfrom setuptools import  setup\r\nfrom Cython.Build import cythonize\r\nfrom Cython.Distutils.extension import Extension\r\nsetup(\r\n    ext_modules=cythonize([\r\n        Extension(\r\n            name=\"cy_code\",\r\n            sources=[\"test_add.py\"],\r\n            define_macros=[\r\n                (\"Py_LIMITED_API\", 0x03070000),\r\n            ],\r\n            py_limited_api=True\r\n        ),\r\n    ],language_level=3),    options={'bdist_wheel': {'py_limited_api': 'cp37'}},)\r\n```\r\n\r\n```python\r\n#test_add.py\r\n\r\ndef add_test(a,b):\r\n    return a+b\r\n```\r\n```python\r\npython3.7 setup.py bdist_wheel\r\n```\r\n\r\n### Expected behaviour\r\n\r\nHow can I do it? It can be compiled successfully and compatible with abi3, and can be used on other Python versions\r\n\r\n### OS\r\n\r\nwindows、linux\r\n\r\n### Python version\r\n\r\npython3.7\r\n\r\n### Cython version\r\n\r\n3.0.11\r\n\r\n### Additional context\r\n\r\n_No response_",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Duplicate of https://github.com/cython/cython/issues/2542\r\nPlease try Cython 3.1 instead (latest master branch).",
            "created_at": "2024-10-25T09:15:36Z",
            "html_url": "https://github.com/cython/cython/issues/6451#issuecomment-2437295217",
            "id": 2437295217,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6451",
            "node_id": "IC_kwDOABDGAc6RRixx",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2437295217/reactions"
            },
            "updated_at": "2024-10-25T09:15:36Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2437295217",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "The latest one is 3.0.11\r\nhttps://github.com/cython/cython/releases/tag/3.0.11-1\r\n﻿\r\n﻿\r\nDo I need to compile the master branch myself?",
            "created_at": "2024-10-25T09:39:48Z",
            "html_url": "https://github.com/cython/cython/issues/6451#issuecomment-2437343803",
            "id": 2437343803,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6451",
            "node_id": "IC_kwDOABDGAc6RRuo7",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2437343803/reactions"
            },
            "updated_at": "2024-10-25T09:39:48Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2437343803",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/38684327?v=4",
                "events_url": "https://api.github.com/users/houxinlin/events{/privacy}",
                "followers_url": "https://api.github.com/users/houxinlin/followers",
                "following_url": "https://api.github.com/users/houxinlin/following{/other_user}",
                "gists_url": "https://api.github.com/users/houxinlin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/houxinlin",
                "id": 38684327,
                "login": "houxinlin",
                "node_id": "MDQ6VXNlcjM4Njg0MzI3",
                "organizations_url": "https://api.github.com/users/houxinlin/orgs",
                "received_events_url": "https://api.github.com/users/houxinlin/received_events",
                "repos_url": "https://api.github.com/users/houxinlin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/houxinlin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/houxinlin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/houxinlin",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "I found that I cannot compile methods with `async`\r\n\r\n```python\r\nasync def add_test(a,b):\r\n    return a+b\r\n```\r\n```java\r\n[root@localhost test]# python3.11 setup.py  bdist_wheel\r\nCompiling test_add.py because it changed.\r\n[1/1] Cythonizing test_add.py\r\nrunning bdist_wheel\r\nrunning build\r\nrunning build_ext\r\nbuilding 'cy_code' extension\r\ngcc -pthread -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -std=c99 -fPIC -DPy_LIMITED_API=50790400 -I/usr/local/include/python3.11 -c test_add.c -o build/temp.linux-x86_64-cpython-311/test_add.o\r\ntest_add.c: In function ‘__Pyx_CoroutineAwait_reduce_ex’:\r\ntest_add.c:8062:39: error: dereferencing pointer to incomplete type\r\n                          Py_TYPE(self)->tp_name);\r\n                                       ^\r\nerror: command '/usr/bin/gcc' failed with exit code 1\r\n```",
            "created_at": "2024-10-25T10:16:06Z",
            "html_url": "https://github.com/cython/cython/issues/6451#issuecomment-2437414322",
            "id": 2437414322,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6451",
            "node_id": "IC_kwDOABDGAc6RR_2y",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2437414322/reactions"
            },
            "updated_at": "2024-10-25T10:44:49Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2437414322",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/38684327?v=4",
                "events_url": "https://api.github.com/users/houxinlin/events{/privacy}",
                "followers_url": "https://api.github.com/users/houxinlin/followers",
                "following_url": "https://api.github.com/users/houxinlin/following{/other_user}",
                "gists_url": "https://api.github.com/users/houxinlin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/houxinlin",
                "id": 38684327,
                "login": "houxinlin",
                "node_id": "MDQ6VXNlcjM4Njg0MzI3",
                "organizations_url": "https://api.github.com/users/houxinlin/orgs",
                "received_events_url": "https://api.github.com/users/houxinlin/received_events",
                "repos_url": "https://api.github.com/users/houxinlin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/houxinlin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/houxinlin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/houxinlin",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Yeah there's plenty of stuff that doesn't work. Limited API support is still experimental.",
            "created_at": "2024-10-25T17:56:52Z",
            "html_url": "https://github.com/cython/cython/issues/6451#issuecomment-2438452715",
            "id": 2438452715,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6451",
            "node_id": "IC_kwDOABDGAc6RV9Xr",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2438452715/reactions"
            },
            "updated_at": "2024-10-25T17:56:52Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2438452715",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "If the compilation is successful, does it mean compatibility can be achieved at runtime?\r\nIs it possible to run successfully on Python 3.7 and encounter exceptions on Python 3.8",
            "created_at": "2024-10-26T00:35:43Z",
            "html_url": "https://github.com/cython/cython/issues/6451#issuecomment-2439085038",
            "id": 2439085038,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6451",
            "node_id": "IC_kwDOABDGAc6RYXvu",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2439085038/reactions"
            },
            "updated_at": "2024-10-26T00:35:43Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2439085038",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/38684327?v=4",
                "events_url": "https://api.github.com/users/houxinlin/events{/privacy}",
                "followers_url": "https://api.github.com/users/houxinlin/followers",
                "following_url": "https://api.github.com/users/houxinlin/following{/other_user}",
                "gists_url": "https://api.github.com/users/houxinlin/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/houxinlin",
                "id": 38684327,
                "login": "houxinlin",
                "node_id": "MDQ6VXNlcjM4Njg0MzI3",
                "organizations_url": "https://api.github.com/users/houxinlin/orgs",
                "received_events_url": "https://api.github.com/users/houxinlin/received_events",
                "repos_url": "https://api.github.com/users/houxinlin/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/houxinlin/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/houxinlin/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/houxinlin",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "That's the aim. However, \r\n\r\n1. Python-level APIs can change. Both the ones you call from your code, and ones that Cython calls internally (e.g. to create code objects).\r\n2. Internal behaviour can change. For example [`PyType_GetSlot`](https://docs.python.org/3/c-api/type.html#c.PyType_GetSlot) changed in Python 3.10, `__weakref__` doesn't work in 3.9 because of an interpreter bug.",
            "created_at": "2024-10-26T07:14:25Z",
            "html_url": "https://github.com/cython/cython/issues/6451#issuecomment-2439410455",
            "id": 2439410455,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6451",
            "node_id": "IC_kwDOABDGAc6RZnMX",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2439410455/reactions"
            },
            "updated_at": "2024-10-26T07:14:25Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2439410455",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6451/comments",
    "created_at": "2024-10-25T08:59:45Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6451/events",
    "html_url": "https://github.com/cython/cython/issues/6451",
    "id": 2613513874,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6451/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc6bxw6S",
    "number": 6451,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6451/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6451/timeline",
    "title": "[BUG] Unable to compile using Py_LIMITED_API",
    "updated_at": "2024-10-26T07:14:26Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6451",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/38684327?v=4",
        "events_url": "https://api.github.com/users/houxinlin/events{/privacy}",
        "followers_url": "https://api.github.com/users/houxinlin/followers",
        "following_url": "https://api.github.com/users/houxinlin/following{/other_user}",
        "gists_url": "https://api.github.com/users/houxinlin/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/houxinlin",
        "id": 38684327,
        "login": "houxinlin",
        "node_id": "MDQ6VXNlcjM4Njg0MzI3",
        "organizations_url": "https://api.github.com/users/houxinlin/orgs",
        "received_events_url": "https://api.github.com/users/houxinlin/received_events",
        "repos_url": "https://api.github.com/users/houxinlin/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/houxinlin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/houxinlin/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/houxinlin",
        "user_view_type": "public"
    }
}