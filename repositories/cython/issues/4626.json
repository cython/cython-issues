{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "Assigning to a slice of a typed memoryview causes error \"TypeError: only size-1 arrays can be converted to Python scalars\".\r\n\r\nThis seems like such a fundamental issue that I'm wondering if I'm doing something wrong.\r\n\r\n**To Reproduce**\r\nCode to reproduce the behaviour:\r\n```cython\r\n# file: slicing.pyx\r\n# cython: language_level=3\r\nimport numpy as np\r\n\r\ncdef double[:] b\r\nb = np.ones((10,))\r\nb[3:6] = np.ones((3,))\r\n```\r\n\r\nThen, e.g., `cythonize -i slicing.pyx && python -c 'import slicing'` leads to:\r\n\r\n```\r\nTraceback (most recent call last):\r\n  File \"<string>\", line 1, in <module>\r\n  File \"slicing.pyx\", line 6, in init slicing\r\n    b[3:6] = np.ones((3,))\r\nTypeError: only size-1 arrays can be converted to Python scalars\r\n```\r\n\r\n**Expected behavior**\r\nNo error should occurs and the assignment into the slice should take place.\r\n\r\nIt works if I use the underlying numpy array by, say, `np.asanyarray(b)[3:6]`, but it seems like something that should just work.\r\n\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Ubuntu 18.04 on WSL\r\n - Python version 3.7.4 (conda)\r\n - Cython version 0.29.20",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Memory views use broadcasting on slice assignment. This means that the single value you assign will be written into all elements of the slice. It needs to be a scalar (non-array) value for that.\r\n\r\nGiven that this currently produces an error, there is an opportunity to open this up, but I'm not sure if it's a good idea. Sometimes, overloading an operation with multiple meaning ends up making it more error prone. (Compare, for example, Python's `max()` and `min()` functions, which fail if you only provide a single argument. That's a relict of also accepting iterables.)",
            "created_at": "2022-02-08T20:00:24Z",
            "html_url": "https://github.com/cython/cython/issues/4626#issuecomment-1033007909",
            "id": 1033007909,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4626",
            "node_id": "IC_kwDOABDGAc49knMl",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1033007909/reactions"
            },
            "updated_at": "2022-02-08T20:00:24Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1033007909",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Maybe I'm misunderstanding but I'm not sure how broadcasting plays into this - the slice being assigned to and the array on the right-hand side have the same shape?",
            "created_at": "2022-02-09T08:29:55Z",
            "html_url": "https://github.com/cython/cython/issues/4626#issuecomment-1033484227",
            "id": 1033484227,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4626",
            "node_id": "IC_kwDOABDGAc49mbfD",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1033484227/reactions"
            },
            "updated_at": "2022-02-09T08:29:55Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1033484227",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5740732?v=4",
                "events_url": "https://api.github.com/users/c-f-h/events{/privacy}",
                "followers_url": "https://api.github.com/users/c-f-h/followers",
                "following_url": "https://api.github.com/users/c-f-h/following{/other_user}",
                "gists_url": "https://api.github.com/users/c-f-h/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/c-f-h",
                "id": 5740732,
                "login": "c-f-h",
                "node_id": "MDQ6VXNlcjU3NDA3MzI=",
                "organizations_url": "https://api.github.com/users/c-f-h/orgs",
                "received_events_url": "https://api.github.com/users/c-f-h/received_events",
                "repos_url": "https://api.github.com/users/c-f-h/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/c-f-h/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/c-f-h/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/c-f-h"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "What I meant was, that the value you assign (apparently) needs to be a single scalar value (and not an array), because it looks like the assignment is trying to broadcast it over the slice. It's clearly not doing a slice assignment here.",
            "created_at": "2022-02-09T08:33:20Z",
            "html_url": "https://github.com/cython/cython/issues/4626#issuecomment-1033486995",
            "id": 1033486995,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4626",
            "node_id": "IC_kwDOABDGAc49mcKT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1033486995/reactions"
            },
            "updated_at": "2022-02-09T08:33:20Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1033486995",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I see. That seems to be a clear deviation from the expected ndarray semantics. I wouldn't really call this assignment \"overloading\" the operation because these semantics are well-established and expected from numpy.\r\n\r\nAlso, the assignment works both if I (1) use the underlying untyped ndarray on the LHS or (2) make also the RHS a typed memoryview. So the unexpected behavior only happens when mixing typed/untyped arrays.\r\n\r\nAt the very least the error message is confusing, I didn't really understand the problem before this discussion.",
            "created_at": "2022-02-09T10:04:04Z",
            "html_url": "https://github.com/cython/cython/issues/4626#issuecomment-1033582691",
            "id": 1033582691,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4626",
            "node_id": "IC_kwDOABDGAc49mzhj",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1033582691/reactions"
            },
            "updated_at": "2022-02-09T10:04:04Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1033582691",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5740732?v=4",
                "events_url": "https://api.github.com/users/c-f-h/events{/privacy}",
                "followers_url": "https://api.github.com/users/c-f-h/followers",
                "following_url": "https://api.github.com/users/c-f-h/following{/other_user}",
                "gists_url": "https://api.github.com/users/c-f-h/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/c-f-h",
                "id": 5740732,
                "login": "c-f-h",
                "node_id": "MDQ6VXNlcjU3NDA3MzI=",
                "organizations_url": "https://api.github.com/users/c-f-h/orgs",
                "received_events_url": "https://api.github.com/users/c-f-h/received_events",
                "repos_url": "https://api.github.com/users/c-f-h/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/c-f-h/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/c-f-h/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/c-f-h"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "> That seems to be a clear deviation from the expected ndarray semantics.\r\n\r\nIt's probably worth saying that Cython memoryviews aren't really expected to provide ndarray semantics. They're largely designed to provide fast, single-element indexing into an array, and fast creation of other memoryviews by slicing. Anything else is largely a bonus.\r\n\r\nIn terms of assignment I believe:\r\n\r\n1. assignment of an array to a whole memoryview sets the memoryview to be a view on that array:\r\n    ```\r\n    cdef double[:] a\r\n    a = some_array\r\n    ```\r\n2. assignment of a memoryview slice to another memoryview slice of the same type and with the same number of dimensions copies element-by-element (checking that the two slices are the same size at runtime).\r\n    ```\r\n    cdef double[:] a = ...\r\n    cdef double[:] b = ...\r\n    a[:] = b  # copy elements from by\r\n\r\n3. assignment of a C value to a memoryview slice fills the memoryview slice with that value\r\n    ```\r\n    cdef double val = 1.\r\n    cdef double[:] a = ...\r\n    a[:] = val\r\n    ```\r\n\r\n4. Assignment of a Python object to a memoryview slice tries to coerce the python object to a single C value, then does \"3\".\r\n\r\n\"2\" and \"3\" (and by \"4\", by extension) are implemented as very efficient C loops preceded by a quick runtime checks.\r\n\r\nIf we were to implement what you're asking it would make case 4 perform worse - it'd need to work out whether the Python object was a suitable array-like structure or a single numeric value. There's also the complication: do we require that the right-hand side can be coerced to a memoryview of the same time (essentially trying `a[:] = <double[:]>b`) or do we accept any generic iterable? The latter would give people unexpectedly worse performance (but me much more flexible).\r\n\r\nWe could definitely improve the error message at no runtime cost. Maybe even suggest the right code in the error message. That's definitely worthwhile because you aren't the first the first person to be confused by this - the error message assumes that you know why it's being coerced.\r\n\r\nI sort of think that the \"try to coerce to right-hand side to a memoryview\" option might be worthwhile. But it does have a cost. Anything more complicated than that I'd definitely be opposed to.",
            "created_at": "2022-02-09T19:06:21Z",
            "html_url": "https://github.com/cython/cython/issues/4626#issuecomment-1034098790",
            "id": 1034098790,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4626",
            "node_id": "IC_kwDOABDGAc49oxhm",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1034098790/reactions"
            },
            "updated_at": "2022-02-09T19:06:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1034098790",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4626/comments",
    "created_at": "2022-02-08T11:25:58Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4626/events",
    "html_url": "https://github.com/cython/cython/issues/4626",
    "id": 1127129191,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4626/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5DLqBn",
    "number": 4626,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4626/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4626/timeline",
    "title": "[BUG] Assigning an ndarray to a slice of a typed memoryview fails",
    "updated_at": "2022-02-09T19:06:21Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4626",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/5740732?v=4",
        "events_url": "https://api.github.com/users/c-f-h/events{/privacy}",
        "followers_url": "https://api.github.com/users/c-f-h/followers",
        "following_url": "https://api.github.com/users/c-f-h/following{/other_user}",
        "gists_url": "https://api.github.com/users/c-f-h/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/c-f-h",
        "id": 5740732,
        "login": "c-f-h",
        "node_id": "MDQ6VXNlcjU3NDA3MzI=",
        "organizations_url": "https://api.github.com/users/c-f-h/orgs",
        "received_events_url": "https://api.github.com/users/c-f-h/received_events",
        "repos_url": "https://api.github.com/users/c-f-h/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/c-f-h/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/c-f-h/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/c-f-h"
    }
}