{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Describe your issue\n\nIn https://github.com/cython/cython/blob/master/Cython/Includes/cpython/complex.pxd, there are references to `Py_complex`, which is opaque in the limited API. This file appears to be slurped up when cythonizing as part of `complex_type_declarations`. My cython-fu is weak, but it looks like it should be possible to make the cval an opaque object (https://github.com/cython/cython/blob/master/Cython/Includes/cpython/complex.pxd#L16C14-L16C24) and use \r\n[PyComplex_RealAsDouble](https://docs.python.org/3/c-api/complex.html#c.PyComplex_RealAsDouble) and friends in the implementation of `cdef inline double real(self)`, with similar implementations for other methods.\r\n",
    "closed_at": "2023-08-18T15:03:14Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I don't think we use complex.pxd unless the user does `from cpython cimport complex` or similar. From that point of view I think it's low priority because it's something the user has deliberately used rather than something they've chosen to use. It also doesn't do anything they can't do themselves (i.e. it's just a bunch of extern declarations).\r\n\r\nWe do use Cython/Utility/Complex.c which I think is what you're probably looking at. This is Cython internal utility code and should be updated. The only place I can immediately see that needs changing is\r\n\r\nhttps://github.com/cython/cython/blob/d455d51bf31379f47c074e40517e24857d4d9cc0/Cython/Utility/Complex.c#L135-L146\r\n\r\nbut maybe there's something else I missed.",
            "created_at": "2023-08-18T06:53:56Z",
            "html_url": "https://github.com/cython/cython/issues/5630#issuecomment-1683439731",
            "id": 1683439731,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5630",
            "node_id": "IC_kwDOABDGAc5kV0Bz",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1683439731/reactions"
            },
            "updated_at": "2023-08-18T06:53:56Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1683439731",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Seems worth having a guard CYTHON_USE_COMPLEX_INTERNALS, as we do for PyLong or lists.\n",
            "created_at": "2023-08-18T06:59:12Z",
            "html_url": "https://github.com/cython/cython/issues/5630#issuecomment-1683444786",
            "id": 1683444786,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5630",
            "node_id": "IC_kwDOABDGAc5kV1Qy",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1683444786/reactions"
            },
            "updated_at": "2023-08-18T06:59:12Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1683444786",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "The other place that might need changing:\r\n\r\nhttps://github.com/cython/cython/blob/d455d51bf31379f47c074e40517e24857d4d9cc0/Cython/Compiler/Builtin.py#L287-L289\r\n\r\n`cval` is fine as-is because it's useless without `Py_complex` anyway, and won't generate code unless used.\r\n`real` and `imag` will need updating.\r\n\r\n`BuiltinProperty` now exists that'll probably help.",
            "created_at": "2023-08-18T07:15:16Z",
            "html_url": "https://github.com/cython/cython/issues/5630#issuecomment-1683461909",
            "id": 1683461909,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5630",
            "node_id": "IC_kwDOABDGAc5kV5cV",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1683461909/reactions"
            },
            "updated_at": "2023-08-18T07:15:16Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1683461909",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "I don't have any complex imports in my code, at least directly. The specific error I'm seeing is:\r\n\r\n`‘PyComplexObject’ was not declared in this scope; did you mean ‘PyTypeObject’?`\r\n\r\nThe relevant code is:\r\n\r\n`static CYTHON_INLINE double __pyx_f_7cpython_7complex_7complex_4real_real(PyComplexObject *__pyx_v_self); /* proto*/`\r\n\r\nThat appears to be emitted here: https://github.com/cython/cython/blob/master/Cython/Compiler/Nodes.py#L2878\r\n\r\n",
            "created_at": "2023-08-18T14:13:09Z",
            "html_url": "https://github.com/cython/cython/issues/5630#issuecomment-1683983093",
            "id": 1683983093,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5630",
            "node_id": "IC_kwDOABDGAc5kX4r1",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1683983093/reactions"
            },
            "updated_at": "2023-08-18T14:33:11Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1683983093",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/57725958?v=4",
                "events_url": "https://api.github.com/users/aws-taylor/events{/privacy}",
                "followers_url": "https://api.github.com/users/aws-taylor/followers",
                "following_url": "https://api.github.com/users/aws-taylor/following{/other_user}",
                "gists_url": "https://api.github.com/users/aws-taylor/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/aws-taylor",
                "id": 57725958,
                "login": "aws-taylor",
                "node_id": "MDQ6VXNlcjU3NzI1OTU4",
                "organizations_url": "https://api.github.com/users/aws-taylor/orgs",
                "received_events_url": "https://api.github.com/users/aws-taylor/received_events",
                "repos_url": "https://api.github.com/users/aws-taylor/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/aws-taylor/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/aws-taylor/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/aws-taylor"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Now that you post the code that does look like it's coming from complex.pxd. I can get it with a file consisting of\r\n\r\n```\r\nfrom cpython cimport complex\r\n```\r\n\r\nbut it goes away if i remove it. Unless I'm missing something, you can only get that by a direct or indirect `cimport`.\r\nThe file is a mixture of\r\n*  declarations for the complex C API declarations (which you obviously won't get access to if their outside the limited API, but Cython knowing about them doesn't generate any code and so won't hurt), \r\n* definitions allowing for internal access into the `PyComplexObject` structure, which obviously will never work with the limited API.\r\n\r\nUnfortunately I don't think we currently have a good mechanism for making this kind of definition conditional, so it isn't an easy fix.\r\n\r\n> That appears to be emitted here: https://github.com/cython/cython/blob/master/Cython/Compiler/Nodes.py#L2878\r\n\r\nThat's not hugely revealing - that's basically where any prototype for a `cdef` function will be written from.",
            "created_at": "2023-08-18T14:45:17Z",
            "html_url": "https://github.com/cython/cython/issues/5630#issuecomment-1684027492",
            "id": 1684027492,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5630",
            "node_id": "IC_kwDOABDGAc5kYDhk",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1684027492/reactions"
            },
            "updated_at": "2023-08-18T14:45:17Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1684027492",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Aha, your comment about `cimport` was the clue I needed. I was calling:\r\n`from cpython cimport PyBytes_AS_STRING`\r\n\r\nIn `cpython/__init__.pdx` file, this implicitly includes complex.pdx.\r\n\r\nChanging my code to the following fixes the issue.\r\n\r\n`from cpython.bytes cimport PyBytes_AS_STRING`\r\n\r\nIn fairness, there is a big warning in the init file:\r\n\r\n```\r\n# Do NOT cimport any names directly from the cpython package,\r\n# despite of the star-imports below.  They will be removed at\r\n# some point.\r\n# Instead, use the correct sub-module to draw your cimports from.\r\n#\r\n# A direct cimport from the package will make your code depend on\r\n# all of the existing declarations. This may have side-effects\r\n# and reduces the portability of your code.\r\n```\r\n\r\nUnfortunately there appears to be a ton of examples in the wild that do this, including seemingly cython's own tutorials - https://cython.readthedocs.io/en/latest/src/tutorial/array.html \r\n",
            "created_at": "2023-08-18T15:03:14Z",
            "html_url": "https://github.com/cython/cython/issues/5630#issuecomment-1684051288",
            "id": 1684051288,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5630",
            "node_id": "IC_kwDOABDGAc5kYJVY",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1684051288/reactions"
            },
            "updated_at": "2023-08-18T15:03:14Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1684051288",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/57725958?v=4",
                "events_url": "https://api.github.com/users/aws-taylor/events{/privacy}",
                "followers_url": "https://api.github.com/users/aws-taylor/followers",
                "following_url": "https://api.github.com/users/aws-taylor/following{/other_user}",
                "gists_url": "https://api.github.com/users/aws-taylor/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/aws-taylor",
                "id": 57725958,
                "login": "aws-taylor",
                "node_id": "MDQ6VXNlcjU3NzI1OTU4",
                "organizations_url": "https://api.github.com/users/aws-taylor/orgs",
                "received_events_url": "https://api.github.com/users/aws-taylor/received_events",
                "repos_url": "https://api.github.com/users/aws-taylor/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/aws-taylor/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/aws-taylor/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/aws-taylor"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Glad you got it sorted. I suspect we will need to deal with some of this stuff for the limited API and come up with a good way of making our supplied .pxd files not incompatible. But I'm inclined to put that off for later and focus on the really low-hanging stuff now.\r\n\r\nI created an issue to remove the pattern from the documentation",
            "created_at": "2023-08-18T15:54:33Z",
            "html_url": "https://github.com/cython/cython/issues/5630#issuecomment-1684116044",
            "id": 1684116044,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5630",
            "node_id": "IC_kwDOABDGAc5kYZJM",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1684116044/reactions"
            },
            "updated_at": "2023-08-18T15:54:33Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1684116044",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 7,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5630/comments",
    "created_at": "2023-08-17T22:47:20Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-08-18T07:15:27Z",
            "event": "labeled",
            "id": 10126804767,
            "label": {
                "color": "F5AB5D",
                "name": "limited api"
            },
            "node_id": "LE_lADOABDGAc5unUDtzwAAAAJbmscf",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/10126804767"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/57725958?v=4",
                "events_url": "https://api.github.com/users/aws-taylor/events{/privacy}",
                "followers_url": "https://api.github.com/users/aws-taylor/followers",
                "following_url": "https://api.github.com/users/aws-taylor/following{/other_user}",
                "gists_url": "https://api.github.com/users/aws-taylor/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/aws-taylor",
                "id": 57725958,
                "login": "aws-taylor",
                "node_id": "MDQ6VXNlcjU3NzI1OTU4",
                "organizations_url": "https://api.github.com/users/aws-taylor/orgs",
                "received_events_url": "https://api.github.com/users/aws-taylor/received_events",
                "repos_url": "https://api.github.com/users/aws-taylor/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/aws-taylor/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/aws-taylor/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/aws-taylor"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-08-18T15:03:14Z",
            "event": "closed",
            "id": 10130977812,
            "node_id": "CE_lADOABDGAc5unUDtzwAAAAJb2nQU",
            "performed_via_github_app": null,
            "state_reason": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/10130977812"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5630/events",
    "html_url": "https://github.com/cython/cython/issues/5630",
    "id": 1855799533,
    "labels": [
        {
            "color": "F5AB5D",
            "default": false,
            "description": "",
            "id": 4210073287,
            "name": "limited api",
            "node_id": "LA_kwDOABDGAc768J7H",
            "url": "https://api.github.com/repos/cython/cython/labels/limited%20api"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5630/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5unUDt",
    "number": 5630,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5630/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5630/timeline",
    "title": "[ENH] Refactor complex.pxd to use limited API",
    "updated_at": "2023-08-18T15:54:33Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5630",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/57725958?v=4",
        "events_url": "https://api.github.com/users/aws-taylor/events{/privacy}",
        "followers_url": "https://api.github.com/users/aws-taylor/followers",
        "following_url": "https://api.github.com/users/aws-taylor/following{/other_user}",
        "gists_url": "https://api.github.com/users/aws-taylor/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/aws-taylor",
        "id": 57725958,
        "login": "aws-taylor",
        "node_id": "MDQ6VXNlcjU3NzI1OTU4",
        "organizations_url": "https://api.github.com/users/aws-taylor/orgs",
        "received_events_url": "https://api.github.com/users/aws-taylor/received_events",
        "repos_url": "https://api.github.com/users/aws-taylor/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/aws-taylor/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/aws-taylor/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/aws-taylor"
    }
}