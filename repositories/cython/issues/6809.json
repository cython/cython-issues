{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Describe the bug\n\nCython introduces **__pyx_r** as an intermediate return variable, but the extra assignment is not transparent.\n\nIn the case below, no assignment operator is available, so the compilation fails.\n\nThe equivalent C++ compiles just fine, applying return value optimisation to avoid the assignment entirely. I think C++17 mandates this. Perhaps Cython should not be generating the additional assignment.\n\n### Code to reproduce the behaviour:\n\n```cython\n# distutils: language=c++\nfrom libcpp.memory cimport unique_ptr\n\ncdef cppclass A:\n    A():\n        pass\n\ncdef class C:\n    cdef unique_ptr[A] foo(self):\n        return unique_ptr[A](new A())\n\n    cdef unique_ptr[A] bar(self):\n        cdef unique_ptr[A] u = unique_ptr[A](new A()) # error: object of type 'std::unique_ptr<__pyx_t_4uniq_A>' cannot be assigned because its copy assignment operator is implicitly deleted\n        return u\n```\n\nGenerated function bar:\n\n```C++\nstatic std::unique_ptr<__pyx_t_4uniq_A>  __pyx_f_4uniq_1C_bar(CYTHON_UNUSED struct __pyx_obj_4uniq_C *__pyx_v_self) {\n  std::unique_ptr<__pyx_t_4uniq_A>  __pyx_v_u;\n  std::unique_ptr<__pyx_t_4uniq_A>  __pyx_r;\n\n  __pyx_v_u = std::unique_ptr<__pyx_t_4uniq_A> (new __pyx_t_4uniq_A());\n\n  __pyx_r = __pyx_v_u; // error: object of type 'std::unique_ptr<__pyx_t_4uniq_A>' cannot be assigned because its copy assignment operator is implicitly deleted\n  goto __pyx_L0;\n\n  __pyx_L0:;\n  return __pyx_r;\n}\n```\n\nThis fails to compile. Note, the **first** assignment is optimised away by the compiler, and error is for the **second** assignment.\n\n\n\n### Expected behaviour\n\nNo compile error.\n\n### OS\n\nLinux\n\n### Python version\n\n3.12.7\n\n### Cython version\n\n3.1.0b1\n\n### Additional context\n\nC++ that just works:\n\n```C++\n#include <memory>\n\nusing namespace std;\n\nclass A {\n    public:\n        int x;\n        A() : x(0) {}\n};\n\nclass C {\npublic:\n    unique_ptr<A> foo() {\n        return unique_ptr<A>(new A());\n    }\n\n    unique_ptr<A> bar() {\n        unique_ptr<A> u = unique_ptr<A>(new A());\n        return u;\n    }\n};\n\nint main(){\nC c;\nreturn c.bar()->x;\n}\n```",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "The assignment to `__pyx_r` is needed in our code-generation scheme, at least in general. Obviously in your simple example it could be omitted, but it's needed to handle cases where there's multiple return paths.\n\nIn principle we might be able to move from `__pyx_v_u` into `__pyx_r`. However there's currently two places where it'd fail I think:\n\n```\ntry:\n    return u\nfinally:\n    ... # code that uses `u`\n```\n\nand returning from `prange`/`parallel`.\n\n[PEP 765](https://peps.python.org/pep-0765/) suggests we should be banning return from finally anyway, so that probably might go away in future. And `prange`/`parallel` could be handled with a little care I think.\n\nIn the short-term I think you can manually add the `move` yourself. I know that isn't what you'd write in C++ (because it kills the RVO) but\n\n```\nreturn move(u)\n```\n\nshould work in Cython.",
            "created_at": "2025-04-27T08:01:11Z",
            "html_url": "https://github.com/cython/cython/issues/6809#issuecomment-2833282459",
            "id": 2833282459,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6809",
            "node_id": "IC_kwDOABDGAc6o4HWb",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2833282459/reactions"
            },
            "updated_at": "2025-04-27T08:01:11Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2833282459",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Thanks @da-woods for your timely and detailed explanation.\n\nYour suggestion of return move fixes the error. I guess using this \"move on return\" generously could improve performance by way of fewer copies, even in the absence of a compile error. I'll do that.\n",
            "created_at": "2025-04-27T09:32:22Z",
            "html_url": "https://github.com/cython/cython/issues/6809#issuecomment-2833352383",
            "id": 2833352383,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6809",
            "node_id": "IC_kwDOABDGAc6o4Ya_",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2833352383/reactions"
            },
            "updated_at": "2025-04-27T09:33:30Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2833352383",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5720904?v=4",
                "events_url": "https://api.github.com/users/CypherGrue/events{/privacy}",
                "followers_url": "https://api.github.com/users/CypherGrue/followers",
                "following_url": "https://api.github.com/users/CypherGrue/following{/other_user}",
                "gists_url": "https://api.github.com/users/CypherGrue/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/CypherGrue",
                "id": 5720904,
                "login": "CypherGrue",
                "node_id": "MDQ6VXNlcjU3MjA5MDQ=",
                "organizations_url": "https://api.github.com/users/CypherGrue/orgs",
                "received_events_url": "https://api.github.com/users/CypherGrue/received_events",
                "repos_url": "https://api.github.com/users/CypherGrue/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/CypherGrue/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/CypherGrue/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/CypherGrue",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6809/comments",
    "created_at": "2025-04-26T23:49:05Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-04-27T09:32:23Z",
            "event": "mentioned",
            "id": 17423203577,
            "node_id": "MEE_lADOABDGAc60J0MSzwAAAAQOgPz5",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/17423203577"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-04-27T09:32:24Z",
            "event": "subscribed",
            "id": 17423203580,
            "node_id": "SE_lADOABDGAc60J0MSzwAAAAQOgPz8",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/17423203580"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6809/events",
    "html_url": "https://github.com/cython/cython/issues/6809",
    "id": 3022471954,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6809/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc60J0MS",
    "number": 6809,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6809/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6809/timeline",
    "title": "[BUG] temporary assignment can cause compile error as standard return value optimisation is ignored",
    "type": null,
    "updated_at": "2025-04-27T09:33:30Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6809",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/5720904?v=4",
        "events_url": "https://api.github.com/users/CypherGrue/events{/privacy}",
        "followers_url": "https://api.github.com/users/CypherGrue/followers",
        "following_url": "https://api.github.com/users/CypherGrue/following{/other_user}",
        "gists_url": "https://api.github.com/users/CypherGrue/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/CypherGrue",
        "id": 5720904,
        "login": "CypherGrue",
        "node_id": "MDQ6VXNlcjU3MjA5MDQ=",
        "organizations_url": "https://api.github.com/users/CypherGrue/orgs",
        "received_events_url": "https://api.github.com/users/CypherGrue/received_events",
        "repos_url": "https://api.github.com/users/CypherGrue/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/CypherGrue/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/CypherGrue/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/CypherGrue",
        "user_view_type": "public"
    }
}