{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nI've observed that Cython crashes when analyzing a `cdef class` with a `cdef` method taking fused type arguments and optional arguments, but not always consistently, and only on Python 3.11. It seemed to affect all versions of Cython 3, including the current master branch.\r\n\r\n```\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\n        return self._discover_peaks(mz_array, intensity_array, _start_mz, _stop_mz, _start_index, _stop_index)\r\n\r\n    @cython.nonecheck(False)\r\n    @cython.cdivision(True)\r\n    @cython.boundscheck(False)\r\n    cpdef size_t _discover_peaks(self, np.ndarray[cython.floating, ndim=1, mode='c'] mz_array, np.ndarray[cython.floating, ndim=1, mode='c'] intensity_array,\r\n          ^\r\n------------------------------------------------------------\r\n\r\nsrc\\ms_peak_picker\\_c\\peak_picker.pyx:248:10: Compiler crash in AnalyseDeclarationsTransform\r\n\r\nModuleNode.body = StatListNode(peak_picker.pyx:1:0)\r\nStatListNode.stats[22] = StatListNode(peak_picker.pyx:140:5)\r\nStatListNode.stats[0] = CClassDefNode(peak_picker.pyx:140:5,\r\n    as_name = 'PeakProcessor',\r\n    class_name = 'PeakProcessor',\r\n    module_name = '',\r\n    punycode_class_name = 'PeakProcessor',\r\n    visibility = 'private')\r\nCClassDefNode.body = StatListNode(peak_picker.pyx:142:4)\r\nStatListNode.stats[8] = CompilerDirectivesNode(peak_picker.pyx:248:10)\r\nCompilerDirectivesNode.body = StatListNode(peak_picker.pyx:248:10)\r\nStatListNode.stats[0] = CFuncDefNode(peak_picker.pyx:248:10,\r\n    args = [...]/7,\r\n    doc = 'Carries out the peak picking process on `mz_array` and `intensity_array`. All\\n        peaks picked are appended to :attr:`peak_data`.\\n\\n        Parameters\\n        ----------\\n        mz_array : np.ndarray\\n            The m/z values to pick peaks from\\n        intensity_array : np.ndarray\\n            The intensity values to pick peaks from\\n        start_mz : float, optional\\n            The minimum m/z to pick peaks above\\n        stop_mz : float, optional\\n        \r\n    The maximum m/z to pick peaks below\\n\\n        Returns\\n        -------\\n        int\\n            The current number of peaks accumulated\\n        ',\r\n    has_fused_arguments = True,\r\n    is_c_class_method = 1,\r\n    modifiers = [...]/0,\r\n    outer_attrs = [...]/2,\r\n    overridable = 1,\r\n    visibility = 'private')\r\nFile 'FusedNode.py', line 60, in __init__: FusedCFuncDefNode(peak_picker.pyx:248:10,\r\n    fused_compound_types = [...]/1,\r\n    match = \"dest_sig[{{dest_sig_idx}}] = '{{specialized_type_name}}'\",\r\n    no_match = 'dest_sig[{{dest_sig_idx}}] = None',\r\n    nodes = [...]/2)\r\nFile 'FusedNode.py', line 201, in copy_cdef: FusedCFuncDefNode(peak_picker.pyx:248:10,\r\n    fused_compound_types = [...]/1,\r\n    match = \"dest_sig[{{dest_sig_idx}}] = '{{specialized_type_name}}'\",\r\n    no_match = 'dest_sig[{{dest_sig_idx}}] = None',\r\n    nodes = [...]/2)\r\n\r\nCompiler crash traceback from this point on:\r\n  File \"c:\\users\\joshua\\dev\\cython\\Cython\\Compiler\\FusedNode.py\", line 200, in copy_cdef\r\n    cindex = env.cfunc_entries.index(self.node.entry)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"c:\\users\\joshua\\dev\\cython\\Cython\\Compiler\\Symtab.py\", line 255, in __repr__\r\n    return \"%s(<%x>, name=%s, type=%s)\" % (type(self).__name__, id(self), self.name, self.type)\r\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n  File \"c:\\users\\joshua\\dev\\cython\\Cython\\Compiler\\PyrexTypes.py\", line 299, in __str__\r\n    return self.declaration_code(\"\", for_display = 1).strip()\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"c:\\users\\joshua\\dev\\cython\\Cython\\Compiler\\PyrexTypes.py\", line 3297, in declaration_code\r\n    arg_decl_list.append(self.op_arg_struct.declaration_code(Naming.optional_args_cname))\r\n                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAttributeError: 'NoneType' object has no attribute 'declaration_code'\r\n```\r\n\r\nAs the traceback seems to show, the `op_arg_struct` attribute of the `CFuncType` node behind the declaration is left as `None`. I was not able to trace out where it should have been set.\r\n\r\nThe method signature in question is \r\n```cython\r\n    @cython.nonecheck(False)\r\n    @cython.cdivision(True)\r\n    @cython.boundscheck(False)\r\n    cpdef size_t _discover_peaks(self, np.ndarray[cython.floating, ndim=1, mode='c'] mz_array, np.ndarray[cython.floating, ndim=1, mode='c'] intensity_array,\r\n                                 double start_mz, double stop_mz, Py_ssize_t start_index=0, Py_ssize_t stop_index=0) noexcept:\r\n        \"\"\"Carries out the peak picking process on `mz_array` and `intensity_array`. All\r\n        peaks picked are appended to :attr:`peak_data`.\r\n\r\n```\r\nIf the default arguments are removed, the code compiles without issue.\r\n\n\n### Code to reproduce the behaviour:\n\n_No response_\n\n### Expected behaviour\n\n_No response_\n\n### OS\n\nWindows, Linux\n\n### Python version\n\n3.11.5\n\n### Cython version\n\n<= 3.0.6\n\n### Additional context\n\nThe project compiles without issue on Python 3.8-3.10 without issue. The full project is https://github.com/mobiusklein/ms_peak_picker, with the tag for the last released version with the defect https://github.com/mobiusklein/ms_peak_picker/releases/tag/v0.1.43\r\n\r\nI was unable reduce this to a minimal example as it seemed to interact with `Cython.Compiler.FusedNode` the `env` context variable passed through much of Cython which holds state beyond just the class.\r\n\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "This actually turns out to be a duplicate of something we thought was a PyPy specific bug: https://github.com/cython/cython/issues/5588#issuecomment-1666928527. I'll fix it properly now",
            "created_at": "2023-12-05T18:07:15Z",
            "html_url": "https://github.com/cython/cython/issues/5894#issuecomment-1841340294",
            "id": 1841340294,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5894",
            "node_id": "IC_kwDOABDGAc5twJ-G",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1841340294/reactions"
            },
            "updated_at": "2023-12-05T18:07:15Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1841340294",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I've reported it as a bug to CPython, because they have changed the behaviour when generating certain exceptions. I plan to fix it here anyway, whatever they decide to do in CPython.",
            "created_at": "2023-12-05T18:40:35Z",
            "html_url": "https://github.com/cython/cython/issues/5894#issuecomment-1841400596",
            "id": 1841400596,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5894",
            "node_id": "IC_kwDOABDGAc5twYsU",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1841400596/reactions"
            },
            "updated_at": "2023-12-05T18:40:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1841400596",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5894/comments",
    "created_at": "2023-12-05T03:25:44Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1426041?v=4",
                "events_url": "https://api.github.com/users/mobiusklein/events{/privacy}",
                "followers_url": "https://api.github.com/users/mobiusklein/followers",
                "following_url": "https://api.github.com/users/mobiusklein/following{/other_user}",
                "gists_url": "https://api.github.com/users/mobiusklein/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mobiusklein",
                "id": 1426041,
                "login": "mobiusklein",
                "node_id": "MDQ6VXNlcjE0MjYwNDE=",
                "organizations_url": "https://api.github.com/users/mobiusklein/orgs",
                "received_events_url": "https://api.github.com/users/mobiusklein/received_events",
                "repos_url": "https://api.github.com/users/mobiusklein/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mobiusklein/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mobiusklein/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mobiusklein"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-12-05T03:26:10Z",
            "event": "renamed",
            "id": 11147334290,
            "node_id": "RTE_lADOABDGAc54tiOdzwAAAAKYbtKS",
            "performed_via_github_app": null,
            "rename": {
                "from": "[BUG] ",
                "to": "Compiler crashes while analyzing fused method with optional arguments only on Python 3.11"
            },
            "url": "https://api.github.com/repos/cython/cython/issues/events/11147334290"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": "773667a0e45546267bfbd8ba1f06c8202e2dfef9",
            "commit_url": "https://api.github.com/repos/da-woods/cython/commits/773667a0e45546267bfbd8ba1f06c8202e2dfef9",
            "created_at": "2023-12-05T18:22:37Z",
            "event": "referenced",
            "id": 11157485045,
            "node_id": "REFE_lADOABDGAc54tiOdzwAAAAKZCbX1",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/11157485045"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5894/events",
    "html_url": "https://github.com/cython/cython/issues/5894",
    "id": 2025202589,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5894/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc54tiOd",
    "number": 5894,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5894/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5894/timeline",
    "title": "Compiler crashes while analyzing fused method with optional arguments only on Python 3.11",
    "updated_at": "2023-12-05T18:40:36Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5894",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1426041?v=4",
        "events_url": "https://api.github.com/users/mobiusklein/events{/privacy}",
        "followers_url": "https://api.github.com/users/mobiusklein/followers",
        "following_url": "https://api.github.com/users/mobiusklein/following{/other_user}",
        "gists_url": "https://api.github.com/users/mobiusklein/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/mobiusklein",
        "id": 1426041,
        "login": "mobiusklein",
        "node_id": "MDQ6VXNlcjE0MjYwNDE=",
        "organizations_url": "https://api.github.com/users/mobiusklein/orgs",
        "received_events_url": "https://api.github.com/users/mobiusklein/received_events",
        "repos_url": "https://api.github.com/users/mobiusklein/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/mobiusklein/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mobiusklein/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/mobiusklein"
    }
}