{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Is your feature request related to a problem? Please describe.\n\nAs far as I have seen, `PyObject_RichCompare` is not used very often in `C`.\n```bash\n~/local/code/cpython/wt4 wt4 ❯ g 'PyObject_RichCompare\\(' | wc -l\n      32\n~/local/code/cpython/wt4 wt4 ❯ g 'PyObject_RichCompareBool\\(' | wc -l\n     151\n```\nMost of the time, `PyObject_RichCompareBool` is used to avoid creating `PyLongObject` and checking its truthfulness, via `PyObject_IsTrue`.\n\nThus, I think it could have some benefit to improve Cython in this regard a bit.\n\n---\n\nI think the most common and useful optimization would be for statement conditionals.\n\n```python\ndef foo():\n    a = 1\n    if a < 2:\n        a += 1\n```\n\n```c\n *     if a < 2:             # <<<<<<<<<<<<<<\n *         a += 1\n * \n*/\n  __pyx_t_1 = PyObject_RichCompare(__pyx_v_a, __pyx_mstate_global->__pyx_int_2, Py_LT); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 3, __pyx_L1_error)\n  __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely((__pyx_t_2 < 0))) __PYX_ERR(0, 3, __pyx_L1_error)\n  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;\n```\n\n---\n\nHere is another case. Not as common as the above.\nAnd might not be worthwhile to specialise it.\n\nThis (for 100K `int`s) runs in 1.2 ms\n```python\nv0 = arr[0]\ni: cy_pst = 0\nn: cy_pst = len(arr)\nwhile i < n:\n    v0 < arr[i]\n    i += 1\n```\n\nWhile this takes ~7 ms\n```python\ni: cy_pst = 0\ns: cy_pst = 0\nn: cy_pst = len(arr)\nwhile i < n:\n    s += v0 < arr[i]\n    i += 1\n```\n\nIt seem that there is a lot of conversion taking place:\n1. converts `s` to `PyLongObject`\n2. Calls `PyObject_RichCompare` -> `PyLongObject`\n3. `PyNumber_InPlaceAdd`\n4. Converts `s` back to `Py_ssize_t`\n\nThe above can be improved manually:\n```python\ni: cy_pst = 0\ns: cy_pst = 0\nn: cy_pst = len(arr)\nwhile i < n:\n    s += cython.cast(cy_pst, v0 < arr[i])\n    i += 1\n```\n\nSo now, only 1 conversion is needed. And this, at least to me, is sufficient.\nWhat is left, again, is unnecessary `PyLongObject` creation (for cases where it can be avoided).\n\nThus, what might be enough is to optimize:\n```py\na: cy_pst = v0 < arr[i]\n```\nSo that whenever comparison is assigned to `C`s integral type, it returns `C` object.\nThus, the user has a way to avoid it.\n\n---\n\nSo I am not sure what is possible / desirable here, but the 2 above might cover it with minimal effort:\n1. Comparisons in statement conditionals\n2. Comparison assignment to `C` integral objects (user needs to do explicitly)\n\n(2) only partially covers (1), but if it was extended to walrus as well, then could also be done explicitly by the user:\n```python\nwhile (i: cy_pst = a < b):\n    pass\n```\nHowever, (1) is arguably the most common case, thus convenience could be worth it.\n\n---\n\nI think this, together with https://github.com/cython/cython/issues/7447 would pretty much cover `C` speed level comparisons for Cython. Or at least very large part of important cases.\n",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "> `PyObject_RichCompareBool` is used to avoid creating `PyLongObject` and checking its truthfulness, via `PyObject_IsTrue`.\n\nUsually, `PyObject_RichCompareBool` does _not_ avoid the result object creation but only relieves the caller from unpacking it, i.e. it does the truth test internally and frees the object reference before returning the C integer result.\n\nAlso note that `PyObject_RichCompareBool` does not actually obey Python semantics completely because it returns true for `NaN == NaN` due to the initial object identity test.",
            "created_at": "2026-01-09T14:01:35Z",
            "html_url": "https://github.com/cython/cython/issues/7453#issuecomment-3729030754",
            "id": 3729030754,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7453",
            "node_id": "IC_kwDOABDGAc7eRH5i",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3729030754/reactions"
            },
            "updated_at": "2026-01-09T14:01:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3729030754",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "What I think should be done here (in `ExprNodes.py`) is\n\n- Separate the `.type` of `CmpNode` (and its primary and cascade subclasses) from the result type of its condition (e.g. `self.eval_type`).\n- Remove the upcall to `ExprNode.coerce_to_boolean()` in `PrimaryCmpNode.coerce_to_boolean()` and simply change the result `.type` to `PyrexTypes.c_bint_type`, thus removing the coercion node that would otherside apply the truthiness test.\n- Move the final truthiness test into `CmpNode.generate_operation_code()` and apply it only if the `.eval_type` differs from `.type`\n\nThen there's probably a bunch of details that needs fixing around that, but this seems the most sensible approach to me.",
            "created_at": "2026-01-09T14:13:24Z",
            "html_url": "https://github.com/cython/cython/issues/7453#issuecomment-3729076710",
            "id": 3729076710,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7453",
            "node_id": "IC_kwDOABDGAc7eRTHm",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3729076710/reactions"
            },
            "updated_at": "2026-01-09T14:13:24Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3729076710",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Also note that `PyObject_RichCompareBool` does not actually obey Python semantics completely because it returns true for `NaN == NaN` due to the initial object identity test.\n\nI removed risky usages as part of PR https://github.com/cython/cython/pull/7452 in https://github.com/cython/cython/pull/7452/commits/3f8f86e059d2932a1b3dd37176470257c0dfc930",
            "created_at": "2026-01-10T08:14:18Z",
            "html_url": "https://github.com/cython/cython/issues/7453#issuecomment-3732138839",
            "id": 3732138839,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7453",
            "node_id": "IC_kwDOABDGAc7ec-tX",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3732138839/reactions"
            },
            "updated_at": "2026-01-10T08:14:18Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3732138839",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "I think what is important to me here most is to bypass `PyLongObject` creation when optimizations from https://github.com/cython/cython/issues/7447 take place.\n\nAnd yes, `PyObject_RichCompareBool` doesn't avoid it for the general case, so I suppose the best that can be done here is to avoid the long path of conversions such as in case 2 where possible and sensible.",
            "created_at": "2026-01-10T08:42:27Z",
            "html_url": "https://github.com/cython/cython/issues/7453#issuecomment-3732163637",
            "id": 3732163637,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7453",
            "node_id": "IC_kwDOABDGAc7edEw1",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3732163637/reactions"
            },
            "updated_at": "2026-01-10T08:42:27Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3732163637",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3577712?v=4",
                "events_url": "https://api.github.com/users/dg-pb/events{/privacy}",
                "followers_url": "https://api.github.com/users/dg-pb/followers",
                "following_url": "https://api.github.com/users/dg-pb/following{/other_user}",
                "gists_url": "https://api.github.com/users/dg-pb/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/dg-pb",
                "id": 3577712,
                "login": "dg-pb",
                "node_id": "MDQ6VXNlcjM1Nzc3MTI=",
                "organizations_url": "https://api.github.com/users/dg-pb/orgs",
                "received_events_url": "https://api.github.com/users/dg-pb/received_events",
                "repos_url": "https://api.github.com/users/dg-pb/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/dg-pb/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/dg-pb/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/dg-pb",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I tried simply removing the `is_pycmp` flag in https://github.com/cython/cython/pull/7452/commits/23581d60858bf7af063eb465c6ee2205847358ff and https://github.com/cython/cython/pull/7452/commits/6497c9b9e0146b969baa0ed3fe35f68b540e34a6 and it seems to work, mostly, avoiding the Python True/False results whenever we need the result to be a simple boolean value (i.e. in `if` conditions).",
            "created_at": "2026-01-12T10:32:09Z",
            "html_url": "https://github.com/cython/cython/issues/7453#issuecomment-3737865290",
            "id": 3737865290,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7453",
            "node_id": "IC_kwDOABDGAc7ey0xK",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3737865290/reactions"
            },
            "updated_at": "2026-01-12T10:32:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3737865290",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/7453/comments",
    "created_at": "2026-01-09T08:23:44Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2026-01-09T14:13:46Z",
            "event": "labeled",
            "id": 21948367369,
            "label": {
                "color": "c2e0c6",
                "name": "feature"
            },
            "node_id": "LE_lADOABDGAc7iQahtzwAAAAUcOYIJ",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/21948367369"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2026-01-09T14:13:46Z",
            "event": "labeled",
            "id": 21948367382,
            "label": {
                "color": "444444",
                "name": "Type Analysis"
            },
            "node_id": "LE_lADOABDGAc7iQahtzwAAAAUcOYIW",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/21948367382"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/7453/events",
    "html_url": "https://github.com/cython/cython/issues/7453",
    "id": 3795953773,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "c2e0c6",
            "default": false,
            "description": null,
            "id": 414805463,
            "name": "feature",
            "node_id": "MDU6TGFiZWw0MTQ4MDU0NjM=",
            "url": "https://api.github.com/repos/cython/cython/labels/feature"
        },
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425558824,
            "name": "Type Analysis",
            "node_id": "MDU6TGFiZWw0MjU1NTg4MjQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/Type%20Analysis"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/7453/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc7iQaht",
    "number": 7453,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/7453/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/7453/timeline",
    "title": "[ENH] Optimize PyLongObject creation out of comparisons (where appropriate)",
    "type": null,
    "updated_at": "2026-01-12T10:32:09Z",
    "url": "https://api.github.com/repos/cython/cython/issues/7453",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/3577712?v=4",
        "events_url": "https://api.github.com/users/dg-pb/events{/privacy}",
        "followers_url": "https://api.github.com/users/dg-pb/followers",
        "following_url": "https://api.github.com/users/dg-pb/following{/other_user}",
        "gists_url": "https://api.github.com/users/dg-pb/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/dg-pb",
        "id": 3577712,
        "login": "dg-pb",
        "node_id": "MDQ6VXNlcjM1Nzc3MTI=",
        "organizations_url": "https://api.github.com/users/dg-pb/orgs",
        "received_events_url": "https://api.github.com/users/dg-pb/received_events",
        "repos_url": "https://api.github.com/users/dg-pb/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/dg-pb/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/dg-pb/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/dg-pb",
        "user_view_type": "public"
    }
}