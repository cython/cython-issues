{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "Opening an issue in cython due to a [discussion in NumPy](https://github.com/numpy/numpy/pull/16938#issuecomment-908520249).\r\n\r\nThe currently ValueError when the size of a struct changed (i.e. shrank), is pretty confusing for users.  In the case of NumPy we added (basically private) fields to the end of the `ndarray` struct.  This is perfectly ABI compatible so long there are no subclasses involved.  (Subclassing `ndarray` in cython does not work at all, so nobody is doing it.)\r\n\r\nSome projects incorrectly compile against a newer NumPy versions and release older wheels:  For them, this is annoying to track down, but I think they are happy to learn.  But it seems even some end-users run into it occsionally (since they write their own cython modules).\r\n\r\nFor NumPy, a solution would be if we could call `import_array()` before the size check, since I believe that already raises the error correctly (assuming we bump the C-API feature version).\r\n\r\nIn general, I am not sure what best to do.  Maybe just adding additional information saying that typically you should compile using the oldest support version?  Or maybe we could add some special feature to end a class definition with a `__variable_private__` so that cython can decide to only complain if someone actually subclasses that specific class?",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Or maybe the fix is to change the behaviour of `size_check ignore` to completely ignore the size so long it is still larger than the fields already imported in cython?  The behaviour when a subclass is actually created should probably remain as it is (or even be more strict!)",
            "created_at": "2021-09-07T18:08:42Z",
            "html_url": "https://github.com/cython/cython/issues/4366#issuecomment-914515269",
            "id": 914515269,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4366",
            "node_id": "IC_kwDOABDGAc42gmVF",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/914515269/reactions"
            },
            "updated_at": "2021-09-07T18:08:42Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/914515269",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/61977?v=4",
                "events_url": "https://api.github.com/users/seberg/events{/privacy}",
                "followers_url": "https://api.github.com/users/seberg/followers",
                "following_url": "https://api.github.com/users/seberg/following{/other_user}",
                "gists_url": "https://api.github.com/users/seberg/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/seberg",
                "id": 61977,
                "login": "seberg",
                "node_id": "MDQ6VXNlcjYxOTc3",
                "organizations_url": "https://api.github.com/users/seberg/orgs",
                "received_events_url": "https://api.github.com/users/seberg/received_events",
                "repos_url": "https://api.github.com/users/seberg/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/seberg/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/seberg/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/seberg"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Given https://github.com/cython/cython/issues/4827, I'm wondering if we should have some way for the user to specify an \"expected size\" that overrides sizeof:\r\n\r\n```\r\ncdef extern from *:\r\n   ctypedef class mod.cls [object PySomethingObject expected_size 100]:\r\n      pass\r\n```\r\nThere's quite a few classes which don't _quite_ do what we expect with size (`bytes` for example, although that's special-cased within Cython anyway).\r\n\r\nFor Numpy it might let you specify the minimum size that you know is OK from backwards compatibility.\r\n\r\nThe danger is that everyone uses it as a way to ignore legitimate errors, and then posts bugs reports about asking why their program is crashing (see the ` enum { __pyx_check_sizeof_voidp = 1 / (int)(SIZEOF_VOID_P == sizeof(void*))` check...).\r\n\r\n------------------------------------------\r\n\r\n>  Or maybe we could add some special feature to end a class definition with a `__variable_private__` so that cython can decide to only complain if someone actually subclasses that specific class?\r\n\r\nThe `cython.final` decorator should do some of that I think. Not sure if it can be applied to extern types",
            "created_at": "2022-07-02T11:07:33Z",
            "html_url": "https://github.com/cython/cython/issues/4366#issuecomment-1172880275",
            "id": 1172880275,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4366",
            "node_id": "IC_kwDOABDGAc5F6LuT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1172880275/reactions"
            },
            "updated_at": "2022-07-02T11:07:33Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1172880275",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4366/comments",
    "created_at": "2021-09-07T17:50:41Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4366/events",
    "html_url": "https://github.com/cython/cython/issues/4366",
    "id": 990214470,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4366/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU5OTAyMTQ0NzA=",
    "number": 4366,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4366/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4366/timeline",
    "title": "[ENH] Improve the error message for struct size change",
    "updated_at": "2022-07-02T11:07:33Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4366",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/61977?v=4",
        "events_url": "https://api.github.com/users/seberg/events{/privacy}",
        "followers_url": "https://api.github.com/users/seberg/followers",
        "following_url": "https://api.github.com/users/seberg/following{/other_user}",
        "gists_url": "https://api.github.com/users/seberg/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/seberg",
        "id": 61977,
        "login": "seberg",
        "node_id": "MDQ6VXNlcjYxOTc3",
        "organizations_url": "https://api.github.com/users/seberg/orgs",
        "received_events_url": "https://api.github.com/users/seberg/received_events",
        "repos_url": "https://api.github.com/users/seberg/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/seberg/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/seberg/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/seberg"
    }
}