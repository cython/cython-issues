{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "## Context\r\n__File tree:__\r\n```\r\n│   setup.py\r\n│\r\n└───translation\r\n        test_anot.c\r\n        test_anot.pyx\r\n```\r\n\r\n## Bug\r\nCython incorrectly translates the code, not seeing the wrong use of `declare`. As a result, the translated code is invalid and does not compile.\r\n### Output:\r\n```\r\nCompiling translation/test_anot.pyx because it changed.\r\n[1/1] Cythonizing translation/test_anot.pyx\r\nrunning build_ext\r\nbuilding 'test_anot' extension\r\nC:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Enterprise\\VC\\Tools\\MSVC\\14.28.29333\\bin\\HostX86\\x64\\cl.exe /c /nologo /Ox /W3 /GL /DNDEBUG /MD -IC:\\Program Files\\Python3.9.0\\include -IC:\\Program Files\\Python3.9.0\\include -IC:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Enterprise\\VC\\Tools\\MSVC\\14.28.29333\\ATLMFC\\include -IC:\\Program Files (x86)\\Microsoft Visual Studio\\2019\\Enterprise\\VC\\Tools\\MSVC\\14.28.29333\\include -IC:\\Program Files (x86)\\Windows Kits\\NETFXSDK\\4.8\\include\\um -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.18362.0\\ucrt -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.18362.0\\shared -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.18362.0\\um -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.18362.0\\winrt -IC:\\Program Files (x86)\\Windows Kits\\10\\include\\10.0.18362.0\\cppwinrt /Tctranslation/test_anot.c /Fobuild\\temp.win-amd64-3.9\\Release\\translation/test_anot.obj\r\ntest_anot.c\r\ntranslation/test_anot.c(3494): error C2065: a: undeclared identifier\r\nerror: command 'C:\\\\Program Files (x86)\\\\Microsoft Visual Studio\\\\2019\\\\Enterprise\\\\VC\\\\Tools\\\\MSVC\\\\14.28.29333\\\\bin\\\\HostX86\\\\x64\\\\cl.exe' failed with exit code 2\r\n```\r\n### translation/test_anot.c:\r\nLines 1038 - 1051:\r\n```c\r\n/*--- Type declarations ---*/\r\nstruct __pyx_obj_9test_anot_Foo;\r\n\r\n/* \"test_anot.pyx\":4\r\n * \r\n * @cython.cclass\r\n * class Foo:             # <<<<<<<<<<<<<<\r\n *     a = cython.declare(cython.int, 6)\r\n * \r\n */\r\nstruct __pyx_obj_9test_anot_Foo {\r\n  PyObject_HEAD\r\n  int a;\r\n};\r\n```\r\nLines 3487 - 3494:\r\n```c\r\n  /* \"test_anot.pyx\":5\r\n * @cython.cclass\r\n * class Foo:\r\n *     a = cython.declare(cython.int, 6)             # <<<<<<<<<<<<<<\r\n * \r\n * \r\n */\r\n  a = 6;\r\n```\r\nThe rest of the `a` in the code are local variables, not related to this one.\r\n\r\n## To Reproduce\r\n- Short:\r\n  ### translation/test_anot.pyx:\r\n  ```cython\r\n  import cython\r\n  \r\n  @cython.cclass\r\n  class Foo:\r\n      a = cython.declare(cython.int, 6)\r\n  ```\r\n- More details:\r\n\r\n  run command `py -3.9 setup.py build_ext --inplace`\r\n  ### setup.py:\r\n  ```python\r\n  from setuptools import setup\r\n  from Cython.Build import cythonize\r\n  \r\n  setup(\r\n      ext_modules=cythonize(\r\n          \"translation/test_anot.pyx\",\r\n          language_level=3,\r\n      ),\r\n      zip_safe=False,\r\n  )\r\n  ```\r\n\r\n## Expected behavior\r\nRoughly the same as when trying to cythonize\r\n```cython\r\ncdef class Bar:\r\n    cdef int a = 6\r\n```\r\nsomething like this:\r\n```\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\ncdef class Bar:\r\n    cdef int a = 6\r\n            ^\r\n------------------------------------------------------------\r\n\r\ntranslation\\test_anot.pyx:2:13: Cannot assign default value to fields in cdef classes, structs or unions\r\nTraceback (most recent call last):\r\n  .\r\n  .\r\n  .\r\nCython.Compiler.Errors.CompileError: translation/test_anot.pyx\r\n```\r\n\r\n## Environment:\r\n - OS: Microsoft Windows 10\r\n - Python version Python: 3.9.0\r\n - Checked Cython versions: 3.0a7, 0.29.23\r\n\r\n## Additional context\r\nHighly related issue #4221 ",
    "closed_at": null,
    "comment_data": [],
    "comments": 0,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4220/comments",
    "created_at": "2021-06-10T19:50:43Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4220/events",
    "html_url": "https://github.com/cython/cython/issues/4220",
    "id": 917819519,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4220/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU5MTc4MTk1MTk=",
    "number": 4220,
    "performed_via_github_app": null,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Default value for class member using `declare` decorator",
    "updated_at": "2021-06-10T19:51:31Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4220",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/52697657?v=4",
        "events_url": "https://api.github.com/users/0dminnimda/events{/privacy}",
        "followers_url": "https://api.github.com/users/0dminnimda/followers",
        "following_url": "https://api.github.com/users/0dminnimda/following{/other_user}",
        "gists_url": "https://api.github.com/users/0dminnimda/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/0dminnimda",
        "id": 52697657,
        "login": "0dminnimda",
        "node_id": "MDQ6VXNlcjUyNjk3NjU3",
        "organizations_url": "https://api.github.com/users/0dminnimda/orgs",
        "received_events_url": "https://api.github.com/users/0dminnimda/received_events",
        "repos_url": "https://api.github.com/users/0dminnimda/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/0dminnimda/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/0dminnimda/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/0dminnimda"
    }
}