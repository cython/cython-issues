{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nStringIOTree.insert() causes a segmentation fault when a tree is inserted into itself, resulting in infinite recursion that crashes the Python interpreter with a memory violation.\n\n### Code to reproduce the behaviour:\n\n```python\nfrom Cython.StringIOTree import StringIOTree\n\ntree = StringIOTree()\n\ntree.write('x')\n\nprint(\"Attempting self-insertion...\")\ntree.insert(tree)\n\nprint(\"Self-insertion completed\")\nresult = tree.getvalue()\nprint(f\"Result: {result}\")\n```\n\n\n### Expected behaviour\n\nSomething other than `segmentation fault`. Raise an exception probably?\n\n### OS\n\nVerified on Linux, MacOS\n\n### Python version\n\n3.9, 3.13\n\n### Cython version\n\n3.14, and HEAD\n\n### Additional context\n\nI discovered this bug as part of a project where we are use LLMs to search for bugs in popular open source repositories. Before filing this bug, we paid for three expert human reviewers to validate this bug, and I also manually validated the bug on my own machines. I am confident that the bug is real, I wrote and filed this report manually, and take responsibility for this bug report.\n\nThe LLM provided the following additional context which we have not verified. Please feel free to disregard this additional information if you prefer.\n\n<details>\n<summary>LLM written additional information</summary>\n\n```\nKey Methods Involved:\n- insert() (lines 97-103): Adds the tree to prepended_children without checking for self-reference\n- _collect_in() (lines 63-69): Recursively traverses children without cycle detection\n- getvalue() (lines 58-61): Triggers the infinite recursion\n- copyto() (lines 71-79): Also affected, would cause same crash\n\nProposed Fix:\n--- a/Cython/StringIOTree.py\n+++ b/Cython/StringIOTree.py\n@@ -97,6 +97,9 @@ class StringIOTree:\n     def insert(self, iotree):\n         \"\"\"\n         Insert a StringIOTree (and all of its contents) at this location.\n         Further writing to self appears after what is inserted.\n         \"\"\"\n+        if iotree is self:\n+            raise ValueError(\"Cannot insert a StringIOTree into itself\")\n+\n         self.commit()\n         self.prepended_children.append(iotree)\n\nAlternative fix for graceful handling by copying content:\n\n--- a/Cython/StringIOTree.py\n+++ b/Cython/StringIOTree.py\n@@ -97,6 +97,11 @@ class StringIOTree:\n     def insert(self, iotree):\n         \"\"\"\n         Insert a StringIOTree (and all of its contents) at this location.\n         Further writing to self appears after what is inserted.\n         \"\"\"\n+        if iotree is self:\n+            # Create a snapshot of current content to avoid infinite recursion\n+            snapshot = StringIOTree()\n+            snapshot.write(self.getvalue())\n+            iotree = snapshot\n+\n         self.commit()\n         self.prepended_children.append(iotree)\n\n```\n</details>",
    "closed_at": "2025-10-12T00:18:57Z",
    "closed_by": {
        "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
        "events_url": "https://api.github.com/users/scoder/events{/privacy}",
        "followers_url": "https://api.github.com/users/scoder/followers",
        "following_url": "https://api.github.com/users/scoder/following{/other_user}",
        "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/scoder",
        "id": 491659,
        "login": "scoder",
        "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
        "organizations_url": "https://api.github.com/users/scoder/orgs",
        "received_events_url": "https://api.github.com/users/scoder/received_events",
        "repos_url": "https://api.github.com/users/scoder/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/scoder",
        "user_view_type": "public"
    },
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Thanks for the report but we don't do that, so it's not an issue.",
            "created_at": "2025-10-12T00:18:57Z",
            "html_url": "https://github.com/cython/cython/issues/7209#issuecomment-3393760976",
            "id": 3393760976,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7209",
            "node_id": "IC_kwDOABDGAc7KSK7Q",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3393760976/reactions"
            },
            "updated_at": "2025-10-12T00:18:57Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3393760976",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/7209/comments",
    "created_at": "2025-10-11T21:19:13Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-10-12T00:18:57Z",
            "event": "closed",
            "id": 20227718422,
            "node_id": "CE_lADOABDGAc7Q_skUzwAAAAS1qn0W",
            "performed_via_github_app": null,
            "state_reason": "not_planned",
            "url": "https://api.github.com/repos/cython/cython/issues/events/20227718422"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-10-12T00:19:14Z",
            "event": "labeled",
            "id": 20227720174,
            "label": {
                "color": "444444",
                "name": "R: wontfix"
            },
            "node_id": "LE_lADOABDGAc7Q_skUzwAAAAS1qoPu",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/20227720174"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/7209/events",
    "html_url": "https://github.com/cython/cython/issues/7209",
    "id": 3506358548,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425557400,
            "name": "R: wontfix",
            "node_id": "MDU6TGFiZWw0MjU1NTc0MDA=",
            "url": "https://api.github.com/repos/cython/cython/labels/R:%20wontfix"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/7209/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc7Q_skU",
    "number": 7209,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/7209/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "state_reason": "not_planned",
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/7209/timeline",
    "title": "[BUG] StringIOTree segfaults when insert()ing a tree into itself",
    "type": null,
    "updated_at": "2025-10-12T00:19:14Z",
    "url": "https://api.github.com/repos/cython/cython/issues/7209",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1269300?v=4",
        "events_url": "https://api.github.com/users/carlini/events{/privacy}",
        "followers_url": "https://api.github.com/users/carlini/followers",
        "following_url": "https://api.github.com/users/carlini/following{/other_user}",
        "gists_url": "https://api.github.com/users/carlini/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/carlini",
        "id": 1269300,
        "login": "carlini",
        "node_id": "MDQ6VXNlcjEyNjkzMDA=",
        "organizations_url": "https://api.github.com/users/carlini/orgs",
        "received_events_url": "https://api.github.com/users/carlini/received_events",
        "repos_url": "https://api.github.com/users/carlini/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/carlini/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/carlini/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/carlini",
        "user_view_type": "public"
    }
}