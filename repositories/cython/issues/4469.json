{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "Hello Everyone,\r\n\r\nI hope i'm the right place for this bug,  as I have very little experience with cython.\r\nWhile trying to apply cython on my code, I encountered a problem with sklearn \"clone\" method. This seems to be due to some variable \"disapearing\" in the `__init__` method when a variable is typed as float. I haven't found any similar bug reported elsewhere, so I made a minimal code example so that everyone can reproduce the bug.\r\n\r\n**To Reproduce**\r\n\r\nI used the basic tutorial from https://cython.readthedocs.io/en/latest/src/tutorial/cython_tutorial.html to generate an example that reproduces the bug.\r\n\r\nThe following compilation produces unexpected results at runtime on 0.29.24 :\r\n\r\nhelloworld.pyx\r\n```cython\r\n\r\nfrom sklearn.base import clone, BaseEstimator, TransformerMixin\r\nimport numpy as np\r\n\r\n\r\nclass MyTransform(BaseEstimator, TransformerMixin):\r\n    def __init__(self, var_float: float = 0.01):\r\n        self.var_float = var_float\r\n\r\n    def transform(self, X: np.ndarray):\r\n        return X\r\n\r\n    def fit(self, X):\r\n        return self\r\n\r\n    def _more_tags(self):\r\n        return {\"no_validation\": True, \"stateless\": True}\r\n\r\n    def __sklearn_is_fitted__(self):\r\n        \"\"\"Return True since Functors are stateless.\"\"\"\r\n        return True\r\n\r\n\r\nX = np.random.randn(100, 10)\r\nmy_transform = MyTransform()\r\ncloned_transform = clone(my_transform)\r\nnew_X = my_transform.fit_transform(X)\r\n\r\nprint(\"Hello World\")\r\n```\r\n\r\nsetup.py (unchanged)\r\n```\r\nfrom setuptools import setup\r\nfrom Cython.Build import cythonize\r\n\r\nsetup(ext_modules=cythonize(\"helloworld.pyx\"))\r\n```\r\n\r\n**Expected behavior**\r\nLike in the basic tutorial, this should print \"Hello World\" when calling `import helloworld`\r\n\r\nInstead, i get `RuntimeError: Cannot clone object MyTransform(), as the constructor either does not set or modifies parameter var_float`\r\n\r\nThe python code works fine when not compiled through cython\r\n\r\n**Important Additional information !**\r\n\r\nIf var_float is no longer typed as float, then the resulting compiled code works just fine\r\n\r\n\r\n**Environment :**\r\n - OS: Windows, Linux\r\n - Python version : 3.8.11\r\n - Cython version : 0.29.24\r\n",
    "closed_at": "2021-11-19T17:32:37Z",
    "comment_data": [
        {
            "author_association": "COLLABORATOR",
            "body": "It's a bug in sklearn - https://github.com/scikit-learn/scikit-learn/blob/74016abcdffe67cdc58fc326c58fb5033371d96b/sklearn/base.py#L91 - they do an \"is not\" check. Since typing the variable as float involves unboxing the Python value to a C float this check can never pass.\r\n\r\nIf you don't intend for Cython to use your annotations then turn the annotation_typing directive off.",
            "created_at": "2021-11-19T17:32:37Z",
            "html_url": "https://github.com/cython/cython/issues/4469#issuecomment-974268909",
            "id": 974268909,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4469",
            "node_id": "IC_kwDOABDGAc46Eint",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/974268909/reactions"
            },
            "updated_at": "2021-11-19T17:32:37Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/974268909",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4469/comments",
    "created_at": "2021-11-19T16:13:14Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-11-19T17:32:37Z",
            "event": "closed",
            "id": 5646808551,
            "node_id": "CE_lADOABDGAc4_GmZtzwAAAAFQk3Xn",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5646808551"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-11-19T17:32:47Z",
            "event": "labeled",
            "id": 5646809311,
            "label": {
                "color": "000000",
                "name": "R: third party"
            },
            "node_id": "LE_lADOABDGAc4_GmZtzwAAAAFQk3jf",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5646809311"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4469/events",
    "html_url": "https://github.com/cython/cython/issues/4469",
    "id": 1058694765,
    "labels": [
        {
            "color": "000000",
            "default": false,
            "description": "",
            "id": 1840758668,
            "name": "R: third party",
            "node_id": "MDU6TGFiZWwxODQwNzU4NjY4",
            "url": "https://api.github.com/repos/cython/cython/labels/R:%20third%20party"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4469/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc4_GmZt",
    "number": 4469,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4469/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4469/timeline",
    "title": "[BUG] Typing an attribute to float in an __init__ makes slearn \"clone\" method fail on compiled version.",
    "updated_at": "2021-11-19T17:32:47Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4469",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/94701676?v=4",
        "events_url": "https://api.github.com/users/ElVynz/events{/privacy}",
        "followers_url": "https://api.github.com/users/ElVynz/followers",
        "following_url": "https://api.github.com/users/ElVynz/following{/other_user}",
        "gists_url": "https://api.github.com/users/ElVynz/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ElVynz",
        "id": 94701676,
        "login": "ElVynz",
        "node_id": "U_kgDOBaUIbA",
        "organizations_url": "https://api.github.com/users/ElVynz/orgs",
        "received_events_url": "https://api.github.com/users/ElVynz/received_events",
        "repos_url": "https://api.github.com/users/ElVynz/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ElVynz/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ElVynz/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ElVynz"
    }
}