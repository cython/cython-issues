{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "**Describe the bug**\r\nIn shards 1 and 6 of the C tests some of the test don't pass on Python 3.11 (`3.11.0-beta.1`). See the full log below.\r\n\r\n**To Reproduce**\r\nRun Tools/ci-run.sh as [defined](https://github.com/cython/cython/blob/master/.github/workflows/ci.yml#L226) in the CI configuration with Python 3.11. See [this test run](https://github.com/cython/cython/runs/6368576607?check_suite_focus=true).\r\n\r\n**Expected behavior**\r\nAll CI tests pass, as on other Python versions.\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Linux (Ubuntu 18.04)\r\n - Python version: `3.11.0-beta.1`\r\n - Cython version: 812585935131125f8988c38417bb73bfd5a81c05\r\n\r\n<details><summary>Full error log</summary>\r\n\r\n```\r\nSharded tests run in 590 seconds (9.8 minutes)\r\nErrors found in shards 1, 6\r\n\r\nErrors from shard 1:\r\n======================================================================\r\nFAIL: fail_on_line_trace (line_trace)\r\nDoctest: line_trace.fail_on_line_trace\r\n----------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"/opt/hostedtoolcache/Python/3.11.0-beta.1/x64/lib/python3.11/doctest.py\", line 2217, in runTest\r\n    raise self.failureException(self.format_failure(new.getvalue()))\r\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAssertionError: Failed doctest test for line_trace.fail_on_line_trace\r\n  File \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line unknown line number, in fail_on_line_trace\r\n\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result = fail_on_line_trace(None, py_add, py_add_with_nogil)\r\nExpected nothing\r\nGot:\r\n    unsupported operand type(s) for -: 'NoneType' and 'int'\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    len(result)\r\nExpected:\r\n    17\r\nGot:\r\n    3\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result[:5]  # py\r\nExpected:\r\n    ['NO ERROR', ('call', 0), ('line', 1), ('line', 2), ('return', 2)]\r\nGot:\r\n    ['NO ERROR', ('call', 2), ('line', 2)]\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result[5:10]  # py\r\nExpected:\r\n    [('call', 0), ('line', 1), ('line', 2), ('line', 3), ('line', 4)]\r\nGot:\r\n    []\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result[10:14]  # py\r\nExpected:\r\n    [('call', 0), ('line', 1), ('line', 2), ('return', 2)]\r\nGot:\r\n    []\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result[14:]  # py\r\nExpected:\r\n    [('line', 2), ('line', 5), ('return', 5)]\r\nGot:\r\n    []\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result = fail_on_line_trace('py_add_with_nogil', py_add, py_add_with_nogil)  # py\r\nExpected:\r\n    failing line trace!\r\nGot:\r\n    unsupported operand type(s) for -: 'NoneType' and 'int'\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result  # py\r\nExpected:\r\n    ['py_add_with_nogil', ('call', 0), ('line', 1), ('line', 2), ('return', 2), ('call', 0)]\r\nGot:\r\n    ['NO ERROR', ('call', 2), ('line', 2)]\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result = fail_on_line_trace('py_add', py_add, py_add_with_nogil)  # py\r\nExpected:\r\n    failing line trace!\r\nGot:\r\n    unsupported operand type(s) for -: 'NoneType' and 'int'\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result[:5]  # py\r\nExpected:\r\n    ['py_add', ('call', 0), ('line', 1), ('line', 2), ('return', 2)]\r\nGot:\r\n    ['NO ERROR', ('call', 2), ('line', 2)]\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.fail_on_line_trace\r\nFailed example:\r\n    result[5:]  # py\r\nExpected:\r\n    [('call', 0), ('line', 1), ('line', 2), ('line', 3), ('line', 4), ('call', 0)]\r\nGot:\r\n    []\r\n\r\n\r\n======================================================================\r\nFAIL: run_trace (line_trace)\r\nDoctest: line_trace.run_trace\r\n----------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"/opt/hostedtoolcache/Python/3.11.0-beta.1/x64/lib/python3.11/doctest.py\", line 2217, in runTest\r\n    raise self.failureException(self.format_failure(new.getvalue()))\r\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAssertionError: Failed doctest test for line_trace.run_trace\r\n  File \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line unknown line number, in run_trace\r\n\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.run_trace\r\nFailed example:\r\n    run_trace(py_add, 1, 2)\r\nException raised:\r\n    Traceback (most recent call last):\r\n      File \"/opt/hostedtoolcache/Python/3.11.0-beta.1/x64/lib/python3.11/doctest.py\", line 1346, in __run\r\n        exec(compile(example.source, filename, \"single\",\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"<doctest line_trace.run_trace[2]>\", line 1, in <module>\r\n        run_trace(py_add, 1, 2)\r\n        ^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"tests/run/line_trace.pyx\", line 231, in line_trace.run_trace (line_trace.c:7047)\r\n        func(*args)\r\n      File \"tests/run/line_trace.pyx\", line 60, in line_trace.trace_trampoline (line_trace.c:3507)\r\n        raise\r\n      File \"tests/run/line_trace.pyx\", line 54, in line_trace.trace_trampoline (line_trace.c:3406)\r\n        result = callback(frame, what, arg)\r\n      File \"tests/run/line_trace.pyx\", line 81, in line_trace._create_trace_func._trace_func (line_trace.c:3974)\r\n        trace.append((map_trace_types(event, event), frame.f_lineno - frame.f_code.co_firstlineno))\r\n    TypeError: unsupported operand type(s) for -: 'NoneType' and 'int'\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/1/run/c/line_trace/line_trace.cpython-311-x86_64-linux-gnu.so\", line ?, in line_trace.run_trace\r\nFailed example:\r\n    run_trace(py_add, 1, 2, with_sys=True)\r\nException raised:\r\n    Traceback (most recent call last):\r\n      File \"/opt/hostedtoolcache/Python/3.11.0-beta.1/x64/lib/python3.11/doctest.py\", line 1346, in __run\r\n        exec(compile(example.source, filename, \"single\",\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"<doctest line_trace.run_trace[4]>\", line 1, in <module>\r\n        run_trace(py_add, 1, 2, with_sys=True)\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"tests/run/line_trace.pyx\", line 231, in line_trace.run_trace (line_trace.c:7047)\r\n        func(*args)\r\n      File \"<doctest line_trace.run_trace[0]>\", line 3, in py_add\r\n        return x\r\n        ^^^^^^^^\r\n      File \"tests/run/line_trace.pyx\", line 81, in line_trace._create_trace_func._trace_func (line_trace.c:3974)\r\n        trace.append((map_trace_types(event, event), frame.f_lineno - frame.f_code.co_firstlineno))\r\n    TypeError: unsupported operand type(s) for -: 'NoneType' and 'int'\r\n\r\n\r\n\r\nErrors from shard 6:\r\n======================================================================\r\nFAIL: test_deduplicated_args (tuple_constants)\r\nDoctest: tuple_constants.test_deduplicated_args\r\n----------------------------------------------------------------------\r\nTraceback (most recent call last):\r\n  File \"/opt/hostedtoolcache/Python/3.11.0-beta.1/x64/lib/python3.11/doctest.py\", line 2217, in runTest\r\n    raise self.failureException(self.format_failure(new.getvalue()))\r\n    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\nAssertionError: Failed doctest test for tuple_constants.test_deduplicated_args\r\n  File \"/home/runner/work/cython/cython/TEST_TMP/6/run/c/tuple_constants/tuple_constants.cpython-311-x86_64-linux-gnu.so\", line unknown line number, in test_deduplicated_args\r\n\r\n----------------------------------------------------------------------\r\nFile \"/home/runner/work/cython/cython/TEST_TMP/6/run/c/tuple_constants/tuple_constants.cpython-311-x86_64-linux-gnu.so\", line ?, in tuple_constants.test_deduplicated_args\r\nFailed example:\r\n    test_deduplicated_args()\r\nException raised:\r\n    Traceback (most recent call last):\r\n      File \"/opt/hostedtoolcache/Python/3.11.0-beta.1/x64/lib/python3.11/doctest.py\", line 1346, in __run\r\n        exec(compile(example.source, filename, \"single\",\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"<doctest tuple_constants.test_deduplicated_args[0]>\", line 1, in <module>\r\n        test_deduplicated_args()\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^\r\n      File \"tests/run/tuple_constants.pyx\", line 40, in tuple_constants.test_deduplicated_args (tuple_constants.c:3004)\r\n        assert func1.__code__.co_varnames is func2.__code__.co_varnames\r\n    AssertionError\r\n```\r\n</details>\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "The issues with line trace are probably a legitimate unresolved bug.\r\n\r\nIt's possible that the `test_deduplicated_args` is just a change in how code objects handle `co_varnames` in Python 3.11. It needs investigating to confirm that, but it may well just need disabling. It doesn't look like a major bug to me.",
            "created_at": "2022-05-10T16:42:51Z",
            "html_url": "https://github.com/cython/cython/issues/4781#issuecomment-1122632902",
            "id": 1122632902,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4781",
            "node_id": "IC_kwDOABDGAc5C6gTG",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1122632902/reactions"
            },
            "updated_at": "2022-05-10T16:42:51Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1122632902",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4781/comments",
    "created_at": "2022-05-10T11:40:12Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4781/events",
    "html_url": "https://github.com/cython/cython/issues/4781",
    "id": 1231026199,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4781/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5JX_gX",
    "number": 4781,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4781/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4781/timeline",
    "title": "[BUG] C tests fail with Python 3.11",
    "updated_at": "2022-05-10T16:42:51Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4781",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/15776622?v=4",
        "events_url": "https://api.github.com/users/EwoutH/events{/privacy}",
        "followers_url": "https://api.github.com/users/EwoutH/followers",
        "following_url": "https://api.github.com/users/EwoutH/following{/other_user}",
        "gists_url": "https://api.github.com/users/EwoutH/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/EwoutH",
        "id": 15776622,
        "login": "EwoutH",
        "node_id": "MDQ6VXNlcjE1Nzc2NjIy",
        "organizations_url": "https://api.github.com/users/EwoutH/orgs",
        "received_events_url": "https://api.github.com/users/EwoutH/received_events",
        "repos_url": "https://api.github.com/users/EwoutH/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/EwoutH/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/EwoutH/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/EwoutH"
    }
}