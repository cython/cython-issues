{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "**Describe the bug**\r\nI'm getting this crash trying to compile a modified PyArrow with Cython 0.29.28.\r\nIt's not obvious to me whether the missing attribute on \"PyByteArray_FromStringAndSize\" is legitimate or just part of the compiler crash...\r\n```\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\n\r\n    def __reduce_ex__(self, protocol):\r\n        if protocol >= 5:\r\n            bufobj = builtin_pickle.PickleBuffer(self)\r\n        elif self.is_mutable:\r\n            bufobj = cp.PyByteArray_FromStringAndSize(\r\n                      ^\r\n------------------------------------------------------------\r\n\r\npyarrow/io.pxi:1122:23: cimported module has no attribute 'PyByteArray_FromStringAndSize'\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\n\r\n    def __reduce_ex__(self, protocol):\r\n        if protocol >= 5:\r\n            bufobj = builtin_pickle.PickleBuffer(self)\r\n        elif self.is_mutable:\r\n            bufobj = cp.PyByteArray_FromStringAndSize(\r\n                      ^\r\n------------------------------------------------------------\r\n\r\npyarrow/io.pxi:1122:23: Compiler crash in AnalyseExpressionsTransform\r\n\r\nModuleNode.body = StatListNode(lib.pyx:22:0)\r\nStatListNode.stats[65] = StatListNode(io.pxi:21:0)\r\nStatListNode.stats[22] = StatListNode(io.pxi:979:5)\r\nStatListNode.stats[0] = CClassDefNode(io.pxi:979:5,\r\n    as_name = 'Buffer',\r\n    class_name = 'Buffer',\r\n    doc = '\\n    The base class for all Arrow buffers.\\n\\n    A buffer represents a contiguous memory area.  Many buffers will own\\n    their memory, though not all of them do.\\n    ',\r\n    module_name = '',\r\n    visibility = 'private')\r\nCClassDefNode.body = StatListNode(io.pxi:980:4)\r\nStatListNode.stats[15] = DefNode(io.pxi:1118:4,\r\n    modifiers = [...]/0,\r\n    name = '__reduce_ex__',\r\n    np_args_idx = [...]/0,\r\n    num_required_args = 2,\r\n    outer_attrs = [...]/2,\r\n    py_wrapper_required = True,\r\n    reqd_kw_flags_cname = '0',\r\n    used = True)\r\nFile 'ExprNodes.py', line 5362, in infer_type: SimpleCallNode(io.pxi:1122:53,\r\n    result_is_used = True,\r\n    use_managed_ref = True)\r\nFile 'ExprNodes.py', line 6845, in infer_type: AttributeNode(io.pxi:1122:23,\r\n    attribute = 'PyByteArray_FromStringAndSize',\r\n    is_attribute = 1,\r\n    needs_none_check = True,\r\n    result_is_used = True,\r\n    use_managed_ref = True)\r\n\r\nCompiler crash traceback from this point on:\r\n  File \"/home/antoine/miniconda3/envs/pyarrow/lib/python3.9/site-packages/Cython/Compiler/ExprNodes.py\", line 6845, in infer_type\r\n    if node.entry.type and node.entry.type.is_cfunction:\r\nAttributeError: 'NoneType' object has no attribute 'type'\r\n ```\r\n\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Ubuntu 20.04\r\n - Python version: 3.9.10 (conda-forge version)\r\n - Cython version: 0.29.28 (conda-forge version)\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "COLLABORATOR",
            "body": "I suspect that the \"no attribute\" is the original cause of the whole thing.\r\n\r\nHave you tried `from cpython.bytearray cimport PyByteArray_FromStringAndSize`. I'm not quite sure what exactly is available under the `cpython` module, but we've been trying (unsuccessfully) to encourage people to use the submodules instead. If `PyByteArray_FromStringAndSize` was added recently then it may not have been added to the `cpython` module",
            "created_at": "2022-03-30T17:39:56Z",
            "html_url": "https://github.com/cython/cython/issues/4707#issuecomment-1083430015",
            "id": 1083430015,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4707",
            "node_id": "IC_kwDOABDGAc5Ak9R_",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1083430015/reactions"
            },
            "updated_at": "2022-03-30T17:39:56Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1083430015",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Hmm, I see. Perhaps one way to steer people towards the \"right\" way would be to document it? I see no mention of this bytearray C API: https://cython.readthedocs.io/en/stable/search.html?q=PyByteArray_FromStringAndSize\r\n",
            "created_at": "2022-03-30T17:48:14Z",
            "html_url": "https://github.com/cython/cython/issues/4707#issuecomment-1083436939",
            "id": 1083436939,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4707",
            "node_id": "IC_kwDOABDGAc5Ak--L",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1083436939/reactions"
            },
            "updated_at": "2022-03-30T17:48:14Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1083436939",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1721820?v=4",
                "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
                "followers_url": "https://api.github.com/users/pitrou/followers",
                "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
                "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pitrou",
                "id": 1721820,
                "login": "pitrou",
                "node_id": "MDQ6VXNlcjE3MjE4MjA=",
                "organizations_url": "https://api.github.com/users/pitrou/orgs",
                "received_events_url": "https://api.github.com/users/pitrou/received_events",
                "repos_url": "https://api.github.com/users/pitrou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pitrou"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "I've proposed a documentation change for it. It is documented within the include file itself, but that's probably too obscure https://github.com/cython/cython/blob/c23195ddc3bf4c139e85439c06de9b87c7bc752c/Cython/Includes/cpython/__init__.pxd#L124-L137\r\n\r\nI definitely wouldn't expect `PyByteArray_FromStringAndSize` to be individually documented in the Cython documentation. We have nothing to say about it specifically.\r\n\r\nI think all that's happened is that the bytearray C API functions were added fairly recently, and so (rightly) aren't available under the global cimport. It shouldn't crash, of course",
            "created_at": "2022-03-30T18:29:30Z",
            "html_url": "https://github.com/cython/cython/issues/4707#issuecomment-1083476612",
            "id": 1083476612,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4707",
            "node_id": "IC_kwDOABDGAc5AlIqE",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1083476612/reactions"
            },
            "updated_at": "2022-03-30T18:29:30Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1083476612",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4707/comments",
    "created_at": "2022-03-30T09:56:49Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": "6a0c07511bfba1d4dcc758db4381df7737440f06",
            "commit_url": "https://api.github.com/repos/da-woods/cython/commits/6a0c07511bfba1d4dcc758db4381df7737440f06",
            "created_at": "2022-03-30T18:27:14Z",
            "event": "referenced",
            "id": 6337382483,
            "node_id": "REFE_lADOABDGAc5Gs-Z0zwAAAAF5vMhT",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6337382483"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4707/events",
    "html_url": "https://github.com/cython/cython/issues/4707",
    "id": 1186195060,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4707/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5Gs-Z0",
    "number": 4707,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4707/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4707/timeline",
    "title": "[BUG] Compiler crash with PyByteArray_FromStringAndSize",
    "updated_at": "2022-03-30T18:29:30Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4707",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1721820?v=4",
        "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
        "followers_url": "https://api.github.com/users/pitrou/followers",
        "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
        "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/pitrou",
        "id": 1721820,
        "login": "pitrou",
        "node_id": "MDQ6VXNlcjE3MjE4MjA=",
        "organizations_url": "https://api.github.com/users/pitrou/orgs",
        "received_events_url": "https://api.github.com/users/pitrou/received_events",
        "repos_url": "https://api.github.com/users/pitrou/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/pitrou"
    }
}