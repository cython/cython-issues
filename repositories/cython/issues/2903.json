{
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "[PEP 557](https://www.python.org/dev/peps/pep-0557/) defines dataclasses, a new feature in Py3.7. It would be nice if Cython could generate equivalent code for cdef classes directly at translation time when it finds an `@dataclass` constructor on them.\r\n\r\nThis can be done by generating Cython code and injecting it into the module, similar to what we do for fused types (see `FusedNode.py`) or auto-pickling (see the `AnalyseDeclarationsTransform` in `ParserTreeTransforms.py`). The latter would probably also be a good place to implement the `@dataclass` decorator, although it seems worth keeping the main part of the implementation in a separate module instead of the transform itself, e.g. `Cython.Compiler.Dataclasses`.\r\n\r\nSince this only applies to cdef classes, it seems better to use a safe and dedicated separate decorator `@cython.dataclass` than to rely on the generic Python decorator, at least initially.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "I have a 60% complete implementation of this. A few design questions:\r\n\r\nWhat attributes should be included? Definitely annotated variables. Maybe regular `cdef` variables?\r\n\r\nWhat should the visibility of the attributes be? There's a few options:\r\n1. Default to invisible, like for a standard `cdef class`. This is obviously consistent. The issue with this is that there's a few functions in the `dataclasses` module like [`asdict`](https://docs.python.org/3/library/dataclasses.html#dataclasses.asdict) which assume that every attribute declared in `__dataclass_fields__` is readable. If they aren't then the classes won't be compatible with those interfaces.\r\n\r\n     If so, should non-public attributes be omitted from `__dataclass_fields__`? This seems inconsistent since they do appear in the destructor, the repr, and affect the comparisons.\r\n\r\n2. Default to visible. This is inconsistent with the standard `cdef class` behaviour, but would make them as compatible as possible with standard `dataclasses`. It would also make sense for most use-cases I think. One problem is that the syntax doesn't really exist of override that (only `public` and `readonly` are defined).\r\n\r\n3. Annotated variables default to visible, `cdef` variables to invisible? It kind of makes sense and gives a way to control visibility, but it seems a little odd to me.\r\n\r\nThe likely implementation deviates from the normal `cdef class` behaviour where\r\n```\r\ncdef class C:\r\n   a: `int` = 0\r\n```\r\nmakes a class variable. I think this is unavoidable and makes sense in this case, but any other ideas?\r\n\r\n------------------------\r\n\r\nNone of these questions are major blockers for progressing on it though.",
            "created_at": "2020-03-07T14:51:53Z",
            "html_url": "https://github.com/cython/cython/issues/2903#issuecomment-596096323",
            "id": 596096323,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2903",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU5NjA5NjMyMw==",
            "updated_at": "2020-03-07T14:52:20Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/596096323",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "I have a bit of Python code with several `@dataclass` classes in there. Once you have figured out the desing choices, how will using them in Cython look like?\r\n\r\nFor example, if I have a\r\n\r\n    @dataclass\r\n    class House:\r\n        rooms: int\r\n        inhabitants: List[Person] = field(default_factory=list)\r\n\r\nwill that just become\r\n\r\n    @dataclass\r\n    @cython.cclass\r\n    class House:\r\n        rooms: cython.int\r\n        inhabitants: List[Person] = field(default_factory=list)\r\n\r\nor will there be more tweaking necessary? Currently, I encounter a whole load of problems (enough to discourage me from using Cython) when sticking `@dataclass` on a class and then compiling that with Cython, should I expect it to be easier or harder with `@cython.cclass`es?",
            "created_at": "2020-04-25T15:23:08Z",
            "html_url": "https://github.com/cython/cython/issues/2903#issuecomment-619395508",
            "id": 619395508,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2903",
            "node_id": "MDEyOklzc3VlQ29tbWVudDYxOTM5NTUwOA==",
            "updated_at": "2020-04-25T15:23:17Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/619395508",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/1579723?v=4",
                "events_url": "https://api.github.com/users/Anaphory/events{/privacy}",
                "followers_url": "https://api.github.com/users/Anaphory/followers",
                "following_url": "https://api.github.com/users/Anaphory/following{/other_user}",
                "gists_url": "https://api.github.com/users/Anaphory/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Anaphory",
                "id": 1579723,
                "login": "Anaphory",
                "node_id": "MDQ6VXNlcjE1Nzk3MjM=",
                "organizations_url": "https://api.github.com/users/Anaphory/orgs",
                "received_events_url": "https://api.github.com/users/Anaphory/received_events",
                "repos_url": "https://api.github.com/users/Anaphory/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Anaphory/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Anaphory/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Anaphory"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": ">  I encounter a whole load of problems (enough to discourage me from using Cython) when sticking `@dataclass` on a class and then compiling that with Cython\r\n\r\nWell currently Cython doesn't support dataclasses at all on either `cdef class` (because my implementation of it needs finishing) or on regular classes (because class-level annotations aren't yet supported). So if you want to use dataclasses then right now you definitely shouldn't use them with Cython. However, that needn't stop you from compiling other modules with Cython (you can pick and choose what to compile).\r\n\r\n>  how will using them in Cython look like?\r\n\r\nProbably pretty similar to what you've outlined. Note that `List[Person]` will accomplish nothing in terms of typing (but hopefully shouldn't break anything). You may have to [c]import `field` and `dataclass` from Cython, but that should be the main difference.\r\n\r\n--------------------------------------------\r\n\r\nThe main design decision is just figuring out how public (i.e. visible from Python) the attributes should be. They probably should be public where possible, but this is a bit of a design break from regular cdef classes.\r\n\r\nI'm not really sure how useful a special implementation for cdef classes is - adding class annotations so they dataclasses can work on regular classes is probably a more useful solution generally.",
            "created_at": "2020-04-25T15:35:35Z",
            "html_url": "https://github.com/cython/cython/issues/2903#issuecomment-619397298",
            "id": 619397298,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2903",
            "node_id": "MDEyOklzc3VlQ29tbWVudDYxOTM5NzI5OA==",
            "updated_at": "2020-04-25T15:35:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/619397298",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2903/comments",
    "created_at": "2019-03-24T15:54:22Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-03-24T15:54:22Z",
            "event": "labeled",
            "id": 2224924398,
            "label": {
                "color": "0e8a16",
                "name": "help wanted"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIyMjQ5MjQzOTg=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2224924398"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-03-24T15:54:22Z",
            "event": "labeled",
            "id": 2224924399,
            "label": {
                "color": "c2e0c6",
                "name": "feature"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIyMjQ5MjQzOTk=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2224924399"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-03-24T15:54:22Z",
            "event": "labeled",
            "id": 2224924400,
            "label": {
                "color": "444444",
                "name": "Cython Language Feature"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDIyMjQ5MjQ0MDA=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2224924400"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": "1298172e6348b8719ef10f39faf9fcec611f6c13",
            "commit_url": "https://api.github.com/repos/da-woods/cython/commits/1298172e6348b8719ef10f39faf9fcec611f6c13",
            "created_at": "2020-03-07T22:18:55Z",
            "event": "referenced",
            "id": 3108024311,
            "node_id": "MDE1OlJlZmVyZW5jZWRFdmVudDMxMDgwMjQzMTE=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/3108024311"
        },
        {
            "actor": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/7909561?v=4",
                "events_url": "https://api.github.com/users/DataClass/events{/privacy}",
                "followers_url": "https://api.github.com/users/DataClass/followers",
                "following_url": "https://api.github.com/users/DataClass/following{/other_user}",
                "gists_url": "https://api.github.com/users/DataClass/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/DataClass",
                "id": 7909561,
                "login": "DataClass",
                "node_id": "MDEyOk9yZ2FuaXphdGlvbjc5MDk1NjE=",
                "organizations_url": "https://api.github.com/users/DataClass/orgs",
                "received_events_url": "https://api.github.com/users/DataClass/received_events",
                "repos_url": "https://api.github.com/users/DataClass/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/DataClass/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/DataClass/subscriptions",
                "type": "Organization",
                "url": "https://api.github.com/users/DataClass"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2020-04-25T15:23:08Z",
            "event": "mentioned",
            "id": 3272016895,
            "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50MzI3MjAxNjg5NQ==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/3272016895"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2903/events",
    "html_url": "https://github.com/cython/cython/issues/2903",
    "id": 424628247,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425559948,
            "name": "Cython Language Feature",
            "node_id": "MDU6TGFiZWw0MjU1NTk5NDg=",
            "url": "https://api.github.com/repos/cython/cython/labels/Cython%20Language%20Feature"
        },
        {
            "color": "c2e0c6",
            "default": false,
            "description": null,
            "id": 414805463,
            "name": "feature",
            "node_id": "MDU6TGFiZWw0MTQ4MDU0NjM=",
            "url": "https://api.github.com/repos/cython/cython/labels/feature"
        },
        {
            "color": "0e8a16",
            "default": true,
            "description": null,
            "id": 414800879,
            "name": "help wanted",
            "node_id": "MDU6TGFiZWw0MTQ4MDA4Nzk=",
            "url": "https://api.github.com/repos/cython/cython/labels/help%20wanted"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2903/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU0MjQ2MjgyNDc=",
    "number": 2903,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Implement @dataclass for cdef classes",
    "updated_at": "2020-04-25T15:35:35Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2903",
    "user": {
        "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
        "events_url": "https://api.github.com/users/scoder/events{/privacy}",
        "followers_url": "https://api.github.com/users/scoder/followers",
        "following_url": "https://api.github.com/users/scoder/following{/other_user}",
        "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/scoder",
        "id": 491659,
        "login": "scoder",
        "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
        "organizations_url": "https://api.github.com/users/scoder/orgs",
        "received_events_url": "https://api.github.com/users/scoder/received_events",
        "repos_url": "https://api.github.com/users/scoder/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/scoder"
    }
}