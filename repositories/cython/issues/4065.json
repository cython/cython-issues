{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "**Describe the bug**\r\nCython fails when naming the loop variable in a list comprehension the same as a local variable, while also using this local variable to create whatever is being iterated over. Example:\r\n```cython\r\ndef bug():\r\n    a = 10\r\n    result = [a for a in (a + 1, a + 2)]\r\n```\r\nRunning the above in Cython, we get\r\n\r\n    UnboundLocalError: local variable 'a' referenced before assignment\r\n\r\n\r\n**To Reproduce**\r\nConsider the above example, which works fine in Python. The fact that `a` is used for generating the results of the comprehension is not important. Also, the way `a` is used to generate the iterable does not matter. A simpler (though quite synthetic) example is then\r\n```cython\r\ndef bug():\r\n    a = 10\r\n    result = [5 for a in f(a)]\r\n```\r\nwith an arbitrary definition of `f`. Even `f = None` will do, as the error happens before calling `f`.\r\n\r\nThe exact way in which this fails depend upon whether this is inside a function or not, and whether `a` is typed. Using e.g.\r\n```cython\r\ndef f(x):\r\n    return [x]\r\ndef bug():\r\n    cdef int a\r\n    a = 10\r\n    result = [a+5 for a in f(a)]\r\n    print(result)\r\n```\r\nthe code now runs, though I get the wrong result `[5]` as opposed to `[15]`. I also get a `maybe-uninitialized` compilation warning, matching this.\r\n\r\n**Expected behavior**\r\nIn all cases, the name used for the loop variable inside the comprehension should not matter. This variable should be internal to the comprehension and have nothing to do with the surrounding scopes. That is, the first `a` in `[... for a in f(a)]` should be understood as a new variable, completely separate from the second `a`, and indeed separate from all other variables. The second `a` should (and do) refer to some pre-existing variable named `a`.\r\nAdding in two extra `a`'s for completeness, `[r(a) for a in f(a) if c(a)]`, these two new `a`'s should now refer to the comprehension-local `a` *first* (if this is indeed the name used), and *then* look in the outer scopes. This works as expected, though of course it can't be tested fully as long as having `f(a)` doesn't work.\r\n\r\n**Environment**\r\n - OS: Linux Mint 20\r\n - Python version: 3.9.0\r\n - Cython version: 0.29.21\r\n - GCC: 9.3.0\r\n\r\n**Additional context**\r\nThe same problem exists for `dict` and `set` comprehensions. Minimal not-working examples:\r\n```cython\r\n{0: 0 for a in f(a)}\r\n```\r\n```cython\r\n{0 for a in f(a)}\r\n```\r\nFor generator expressions, the `UnboundLocalError` does not appear until the iteration is performed:\r\n```cython\r\nresult = (0 for a in f(a))\r\nlist(result)  # triggers error\r\n```\r\n\r\n",
    "closed_at": "2021-03-27T15:56:35Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Duplicate of #1159.",
            "created_at": "2021-03-27T15:56:35Z",
            "html_url": "https://github.com/cython/cython/issues/4065#issuecomment-808753268",
            "id": 808753268,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4065",
            "node_id": "MDEyOklzc3VlQ29tbWVudDgwODc1MzI2OA==",
            "performed_via_github_app": null,
            "updated_at": "2021-03-27T15:56:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/808753268",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4065/comments",
    "created_at": "2021-03-27T15:45:32Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-03-27T15:56:20Z",
            "event": "labeled",
            "id": 4517192351,
            "label": {
                "color": "444444",
                "name": "R: duplicate"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDQ1MTcxOTIzNTE=",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/4517192351"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-03-27T15:56:35Z",
            "event": "closed",
            "id": 4517192611,
            "node_id": "MDExOkNsb3NlZEV2ZW50NDUxNzE5MjYxMQ==",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/4517192611"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4065/events",
    "html_url": "https://github.com/cython/cython/issues/4065",
    "id": 842534630,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425556894,
            "name": "R: duplicate",
            "node_id": "MDU6TGFiZWw0MjU1NTY4OTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/R:%20duplicate"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4065/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU4NDI1MzQ2MzA=",
    "number": 4065,
    "performed_via_github_app": null,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "title": "[BUG] Wrong variable name resolution in comprehensions",
    "updated_at": "2021-03-27T15:56:35Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4065",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/9202794?v=4",
        "events_url": "https://api.github.com/users/jmd-dk/events{/privacy}",
        "followers_url": "https://api.github.com/users/jmd-dk/followers",
        "following_url": "https://api.github.com/users/jmd-dk/following{/other_user}",
        "gists_url": "https://api.github.com/users/jmd-dk/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/jmd-dk",
        "id": 9202794,
        "login": "jmd-dk",
        "node_id": "MDQ6VXNlcjkyMDI3OTQ=",
        "organizations_url": "https://api.github.com/users/jmd-dk/orgs",
        "received_events_url": "https://api.github.com/users/jmd-dk/received_events",
        "repos_url": "https://api.github.com/users/jmd-dk/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/jmd-dk/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jmd-dk/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/jmd-dk"
    }
}