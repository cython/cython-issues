{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "<!--\r\n**PLEASE READ THIS FIRST:**\r\n- Do not use the bug and feature tracker for support requests. Use the `cython-users` mailing list instead.\r\n- Did you search for similar issues already? Please do, it helps to save us precious time that we otherwise could not invest into development.\r\n- Did you try the latest master branch or pre-release? It might already have what you want to report. Also see the [Changelog](https://github.com/cython/cython/blob/master/CHANGES.rst) regarding recent changes.\r\n-->\r\n\r\n**Describe the bug**\r\nMiniaudio is a library which allows recording and playback of audio using a C callback which Miniaudio calls on another thread. This callback receives two pointers, input and output, which I am converting to Python memory view objects before passing them to my Python callback. However if the Python callback does something like: output[0] = 5, a strange exception is raised. However things like: output[...] = input work.\r\n**To Reproduce**\r\nI was unable to reproduce this bug by casting a pointer obtained by calling malloc to a memory view, so I made a zip file containing the test code along with Miniaudio which is a single header file.\r\n[testcase.zip](https://github.com/cython/cython/files/7771461/testcase.zip)\r\nOpen it, cd into it, \"cythonize -i -3 testcase.pyx\", then open Python and \"import testcase\"\r\n**Expected behavior**\r\nThe resulting array object is indexable.\r\n**Environment (please complete the following information):**\r\nWindows 10 (64-bit), Python 3.9.5, Cython 0.29.26\r\n\r\n**Additional context**\r\nThe exception that's raised when indexing into the array is:\r\nTraceback (most recent call last):\r\n  File \"stringsource\", line 493, in View.MemoryView.memoryview.convert_item_to_object\r\nstruct.error: bad char in struct format\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"testcase.pyx\", line 25, in testcase.data_callback\r\n    print(data[0]) # exception\r\n  File \"stringsource\", line 237, in View.MemoryView.array.__getitem__\r\n  File \"stringsource\", line 414, in View.MemoryView.memoryview.__getitem__\r\n  File \"stringsource\", line 495, in View.MemoryView.memoryview.convert_item_to_object\r\nValueError: Unable to convert item to object\r\n\r\nIf I explicitly declare a C variable of type float[:] in the testcase and return it to Python, that results in a ValueError with no additional information.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "COLLABORATOR",
            "body": "I think this is a bit complex for me to reasonably manage to debug at least. It feels like a memory corruption error to me - somewhere along the line the format string that defines what type of array it is is getting overwritten?\r\n\r\nOne hint:\r\n\r\n```\r\ndata = <float[:sample_count]>(input)\r\nprint(data[0])\r\n```\r\n\r\nThis is creating a Python object that wraps the array `input`. `data[0]` goes through the standard Python object `__getitem__` lookup (i.e. is fairly slow).\r\n\r\nWhat you probably want is \r\n\r\n```\r\ncdef float[:] data\r\ndata = <float[:sample_count]>(input)\r\nprint(data[0])\r\n```\r\n\r\nYou'll still create the Python object, but have the advantage of the faster direct memory lookup.\r\n\r\nI doubt it'll solve your errors though.",
            "created_at": "2021-12-24T09:12:21Z",
            "html_url": "https://github.com/cython/cython/issues/4521#issuecomment-1000741671",
            "id": 1000741671,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4521",
            "node_id": "IC_kwDOABDGAc47phsn",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1000741671/reactions"
            },
            "updated_at": "2021-12-24T09:12:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1000741671",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "Assigning data as a Python object was pretty much intensional. The intention of:\r\nprint(data[0])\r\nis to demonstrate how accessing the array from Python causes an error. Also, my Miniaudio bindings are creating arrays like this so they can be passed on to pure Python callback functions which can modify the data.\r\nHow could a format string get overwritten? Shouldn't it be a constant?\r\nActually, you've reminded me of something. Replace the line which indexes data with this and see if you get a UnicodeDecodeError:\r\nprint(memoryview(data).format)",
            "created_at": "2021-12-29T18:49:35Z",
            "html_url": "https://github.com/cython/cython/issues/4521#issuecomment-1002731741",
            "id": 1002731741,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4521",
            "node_id": "IC_kwDOABDGAc47xHjd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1002731741/reactions"
            },
            "updated_at": "2021-12-29T18:49:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1002731741",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/47483928?v=4",
                "events_url": "https://api.github.com/users/Keithcat1/events{/privacy}",
                "followers_url": "https://api.github.com/users/Keithcat1/followers",
                "following_url": "https://api.github.com/users/Keithcat1/following{/other_user}",
                "gists_url": "https://api.github.com/users/Keithcat1/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Keithcat1",
                "id": 47483928,
                "login": "Keithcat1",
                "node_id": "MDQ6VXNlcjQ3NDgzOTI4",
                "organizations_url": "https://api.github.com/users/Keithcat1/orgs",
                "received_events_url": "https://api.github.com/users/Keithcat1/received_events",
                "repos_url": "https://api.github.com/users/Keithcat1/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Keithcat1/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Keithcat1/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Keithcat1"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "> How could a format string get overwritten? Shouldn't it be a constant?\r\n\r\nUnintentionally, for example, by something writing beyond the end of an array. It is a guess at what might have gone wrong though",
            "created_at": "2021-12-29T18:55:21Z",
            "html_url": "https://github.com/cython/cython/issues/4521#issuecomment-1002734426",
            "id": 1002734426,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4521",
            "node_id": "IC_kwDOABDGAc47xINa",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1002734426/reactions"
            },
            "updated_at": "2021-12-29T18:55:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1002734426",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4521/comments",
    "created_at": "2021-12-23T21:44:57Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4521/events",
    "html_url": "https://github.com/cython/cython/issues/4521",
    "id": 1088006815,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4521/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5A2aqf",
    "number": 4521,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4521/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4521/timeline",
    "title": "[BUG] Converting a pointer from a C callback to a memory view causes an exception when trying to index into the array",
    "updated_at": "2021-12-29T18:55:22Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4521",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/47483928?v=4",
        "events_url": "https://api.github.com/users/Keithcat1/events{/privacy}",
        "followers_url": "https://api.github.com/users/Keithcat1/followers",
        "following_url": "https://api.github.com/users/Keithcat1/following{/other_user}",
        "gists_url": "https://api.github.com/users/Keithcat1/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Keithcat1",
        "id": 47483928,
        "login": "Keithcat1",
        "node_id": "MDQ6VXNlcjQ3NDgzOTI4",
        "organizations_url": "https://api.github.com/users/Keithcat1/orgs",
        "received_events_url": "https://api.github.com/users/Keithcat1/received_events",
        "repos_url": "https://api.github.com/users/Keithcat1/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Keithcat1/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Keithcat1/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Keithcat1"
    }
}