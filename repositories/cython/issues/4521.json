{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "<!--\r\n**PLEASE READ THIS FIRST:**\r\n- Do not use the bug and feature tracker for support requests. Use the `cython-users` mailing list instead.\r\n- Did you search for similar issues already? Please do, it helps to save us precious time that we otherwise could not invest into development.\r\n- Did you try the latest master branch or pre-release? It might already have what you want to report. Also see the [Changelog](https://github.com/cython/cython/blob/master/CHANGES.rst) regarding recent changes.\r\n-->\r\n\r\n**Describe the bug**\r\nMiniaudio is a library which allows recording and playback of audio using a C callback which Miniaudio calls on another thread. This callback receives two pointers, input and output, which I am converting to Python memory view objects before passing them to my Python callback. However if the Python callback does something like: output[0] = 5, a strange exception is raised. However things like: output[...] = input work.\r\n**To Reproduce**\r\nI was unable to reproduce this bug by casting a pointer obtained by calling malloc to a memory view, so I made a zip file containing the test code along with Miniaudio which is a single header file.\r\n[testcase.zip](https://github.com/cython/cython/files/7771461/testcase.zip)\r\nOpen it, cd into it, \"cythonize -i -3 testcase.pyx\", then open Python and \"import testcase\"\r\n**Expected behavior**\r\nThe resulting array object is indexable.\r\n**Environment (please complete the following information):**\r\nWindows 10 (64-bit), Python 3.9.5, Cython 0.29.26\r\n\r\n**Additional context**\r\nThe exception that's raised when indexing into the array is:\r\nTraceback (most recent call last):\r\n  File \"stringsource\", line 493, in View.MemoryView.memoryview.convert_item_to_object\r\nstruct.error: bad char in struct format\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"testcase.pyx\", line 25, in testcase.data_callback\r\n    print(data[0]) # exception\r\n  File \"stringsource\", line 237, in View.MemoryView.array.__getitem__\r\n  File \"stringsource\", line 414, in View.MemoryView.memoryview.__getitem__\r\n  File \"stringsource\", line 495, in View.MemoryView.memoryview.convert_item_to_object\r\nValueError: Unable to convert item to object\r\n\r\nIf I explicitly declare a C variable of type float[:] in the testcase and return it to Python, that results in a ValueError with no additional information.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I think this is a bit complex for me to reasonably manage to debug at least. It feels like a memory corruption error to me - somewhere along the line the format string that defines what type of array it is is getting overwritten?\r\n\r\nOne hint:\r\n\r\n```\r\ndata = <float[:sample_count]>(input)\r\nprint(data[0])\r\n```\r\n\r\nThis is creating a Python object that wraps the array `input`. `data[0]` goes through the standard Python object `__getitem__` lookup (i.e. is fairly slow).\r\n\r\nWhat you probably want is \r\n\r\n```\r\ncdef float[:] data\r\ndata = <float[:sample_count]>(input)\r\nprint(data[0])\r\n```\r\n\r\nYou'll still create the Python object, but have the advantage of the faster direct memory lookup.\r\n\r\nI doubt it'll solve your errors though.",
            "created_at": "2021-12-24T09:12:21Z",
            "html_url": "https://github.com/cython/cython/issues/4521#issuecomment-1000741671",
            "id": 1000741671,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4521",
            "node_id": "IC_kwDOABDGAc47phsn",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1000741671/reactions"
            },
            "updated_at": "2021-12-24T09:12:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1000741671",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "Assigning data as a Python object was pretty much intensional. The intention of:\r\nprint(data[0])\r\nis to demonstrate how accessing the array from Python causes an error. Also, my Miniaudio bindings are creating arrays like this so they can be passed on to pure Python callback functions which can modify the data.\r\nHow could a format string get overwritten? Shouldn't it be a constant?\r\nActually, you've reminded me of something. Replace the line which indexes data with this and see if you get a UnicodeDecodeError:\r\nprint(memoryview(data).format)",
            "created_at": "2021-12-29T18:49:35Z",
            "html_url": "https://github.com/cython/cython/issues/4521#issuecomment-1002731741",
            "id": 1002731741,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4521",
            "node_id": "IC_kwDOABDGAc47xHjd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1002731741/reactions"
            },
            "updated_at": "2021-12-29T18:49:35Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1002731741",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/47483928?v=4",
                "events_url": "https://api.github.com/users/Keithcat1/events{/privacy}",
                "followers_url": "https://api.github.com/users/Keithcat1/followers",
                "following_url": "https://api.github.com/users/Keithcat1/following{/other_user}",
                "gists_url": "https://api.github.com/users/Keithcat1/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Keithcat1",
                "id": 47483928,
                "login": "Keithcat1",
                "node_id": "MDQ6VXNlcjQ3NDgzOTI4",
                "organizations_url": "https://api.github.com/users/Keithcat1/orgs",
                "received_events_url": "https://api.github.com/users/Keithcat1/received_events",
                "repos_url": "https://api.github.com/users/Keithcat1/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Keithcat1/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Keithcat1/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Keithcat1"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> How could a format string get overwritten? Shouldn't it be a constant?\r\n\r\nUnintentionally, for example, by something writing beyond the end of an array. It is a guess at what might have gone wrong though",
            "created_at": "2021-12-29T18:55:21Z",
            "html_url": "https://github.com/cython/cython/issues/4521#issuecomment-1002734426",
            "id": 1002734426,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4521",
            "node_id": "IC_kwDOABDGAc47xINa",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1002734426/reactions"
            },
            "updated_at": "2021-12-29T18:55:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1002734426",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "I was somehow able to solve this problem by manually determining the\narrays info and calling cython.view.array() with the proper format\nstring, ETC.\nI thought that at some point recently I managed to reproduce this\nweird bug without Miniaudio, but I can't seem to duplicate it now.\n\nOn 12/29/21, da-woods ***@***.***> wrote:\n>> How could a format string get overwritten? Shouldn't it be a constant?\n>\n> Unintentionally, for example, by something writing beyond the end of an\n> array. It is a guess at what might have gone wrong though\n>\n> --\n> Reply to this email directly or view it on GitHub:\n> https://github.com/cython/cython/issues/4521#issuecomment-1002734426\n> You are receiving this because you authored the thread.\n>\n> Message ID: ***@***.***>\n",
            "created_at": "2022-01-04T19:20:12Z",
            "html_url": "https://github.com/cython/cython/issues/4521#issuecomment-1005102609",
            "id": 1005102609,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4521",
            "node_id": "IC_kwDOABDGAc476KYR",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1005102609/reactions"
            },
            "updated_at": "2022-01-04T19:20:12Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1005102609",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/47483928?v=4",
                "events_url": "https://api.github.com/users/Keithcat1/events{/privacy}",
                "followers_url": "https://api.github.com/users/Keithcat1/followers",
                "following_url": "https://api.github.com/users/Keithcat1/following{/other_user}",
                "gists_url": "https://api.github.com/users/Keithcat1/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Keithcat1",
                "id": 47483928,
                "login": "Keithcat1",
                "node_id": "MDQ6VXNlcjQ3NDgzOTI4",
                "organizations_url": "https://api.github.com/users/Keithcat1/orgs",
                "received_events_url": "https://api.github.com/users/Keithcat1/received_events",
                "repos_url": "https://api.github.com/users/Keithcat1/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Keithcat1/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Keithcat1/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Keithcat1"
            }
        },
        {
            "author_association": "NONE",
            "body": "I've run into a similar problem using memoryviews when trying to enable automatic encoding/decoding of C strings as UTF-8. The `.pyx` file in the example provided by @Keithcat1 above includes the directives to enable this feature, as described [here](https://cython.readthedocs.io/en/latest/src/tutorial/strings.html#auto-encoding-and-decoding):\r\n```py\r\n# cython: embedsignature=True, auto_pickle=False, c_string_encoding=\"utf-8\", c_string_type=str\r\n```\r\nRemoving the last two directives, I was able to compile and run the example. I think it was successful, anyway -- it just prints out a long stream of floating point numbers.\r\n\r\n---\r\n\r\nThe case where I encountered this error is with a function like the following:\r\n```pyx\r\ncdef void callback_v_dp(PyFuncInfo& funcInfo, size_array1 sizes, double* arg):\r\n    cdef double[:] view = <double[:sizes[0]]>arg if sizes[0] else None\r\n```\r\nwhere `size_array1` is a typedef for `std::array<size_t, 1>` and the exception thrown is a `ValueError` with no additional info.\r\n\r\nIf I try using `arg` to initialize a numpy array as:\r\n```pyx\r\n    data = np.asarray(<double[:sizes[0]]>arg)\r\n```\r\nThen I get the exception:\r\n```\r\nUnicodeDecodeError: 'utf-8' codec can't decode byte 0xe4 in position 0: unexpected end of data\r\n```\r\nwhich is what led me here. The code above works fine when not including these string encoding directives.\r\n",
            "created_at": "2023-03-17T15:47:08Z",
            "html_url": "https://github.com/cython/cython/issues/4521#issuecomment-1474039811",
            "id": 1474039811,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4521",
            "node_id": "IC_kwDOABDGAc5X3BAD",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1474039811/reactions"
            },
            "updated_at": "2023-03-17T15:47:08Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1474039811",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/644977?v=4",
                "events_url": "https://api.github.com/users/speth/events{/privacy}",
                "followers_url": "https://api.github.com/users/speth/followers",
                "following_url": "https://api.github.com/users/speth/following{/other_user}",
                "gists_url": "https://api.github.com/users/speth/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/speth",
                "id": 644977,
                "login": "speth",
                "node_id": "MDQ6VXNlcjY0NDk3Nw==",
                "organizations_url": "https://api.github.com/users/speth/orgs",
                "received_events_url": "https://api.github.com/users/speth/received_events",
                "repos_url": "https://api.github.com/users/speth/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/speth/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/speth/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/speth"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4521/comments",
    "created_at": "2021-12-23T21:44:57Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/47483928?v=4",
                "events_url": "https://api.github.com/users/Keithcat1/events{/privacy}",
                "followers_url": "https://api.github.com/users/Keithcat1/followers",
                "following_url": "https://api.github.com/users/Keithcat1/following{/other_user}",
                "gists_url": "https://api.github.com/users/Keithcat1/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Keithcat1",
                "id": 47483928,
                "login": "Keithcat1",
                "node_id": "MDQ6VXNlcjQ3NDgzOTI4",
                "organizations_url": "https://api.github.com/users/Keithcat1/orgs",
                "received_events_url": "https://api.github.com/users/Keithcat1/received_events",
                "repos_url": "https://api.github.com/users/Keithcat1/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Keithcat1/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Keithcat1/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Keithcat1"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-03-17T15:47:09Z",
            "event": "mentioned",
            "id": 8779867394,
            "node_id": "MEE_lADOABDGAc5A2aqfzwAAAAILUiUC",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/8779867394"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/47483928?v=4",
                "events_url": "https://api.github.com/users/Keithcat1/events{/privacy}",
                "followers_url": "https://api.github.com/users/Keithcat1/followers",
                "following_url": "https://api.github.com/users/Keithcat1/following{/other_user}",
                "gists_url": "https://api.github.com/users/Keithcat1/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/Keithcat1",
                "id": 47483928,
                "login": "Keithcat1",
                "node_id": "MDQ6VXNlcjQ3NDgzOTI4",
                "organizations_url": "https://api.github.com/users/Keithcat1/orgs",
                "received_events_url": "https://api.github.com/users/Keithcat1/received_events",
                "repos_url": "https://api.github.com/users/Keithcat1/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/Keithcat1/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/Keithcat1/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/Keithcat1"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-03-17T15:47:09Z",
            "event": "subscribed",
            "id": 8779867412,
            "node_id": "SE_lADOABDGAc5A2aqfzwAAAAILUiUU",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/8779867412"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4521/events",
    "html_url": "https://github.com/cython/cython/issues/4521",
    "id": 1088006815,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4521/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5A2aqf",
    "number": 4521,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4521/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4521/timeline",
    "title": "[BUG] Converting a pointer from a C callback to a memory view causes an exception when trying to index into the array",
    "updated_at": "2023-03-17T15:47:09Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4521",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/47483928?v=4",
        "events_url": "https://api.github.com/users/Keithcat1/events{/privacy}",
        "followers_url": "https://api.github.com/users/Keithcat1/followers",
        "following_url": "https://api.github.com/users/Keithcat1/following{/other_user}",
        "gists_url": "https://api.github.com/users/Keithcat1/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/Keithcat1",
        "id": 47483928,
        "login": "Keithcat1",
        "node_id": "MDQ6VXNlcjQ3NDgzOTI4",
        "organizations_url": "https://api.github.com/users/Keithcat1/orgs",
        "received_events_url": "https://api.github.com/users/Keithcat1/received_events",
        "repos_url": "https://api.github.com/users/Keithcat1/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/Keithcat1/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/Keithcat1/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/Keithcat1"
    }
}