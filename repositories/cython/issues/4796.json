{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "In PyArrow we have two helper functions looking like this:\r\n```cython\r\ncdef int check_status(const CStatus& status) nogil except -1\r\n\r\ncdef int plasma_check_status(const CStatus& status) nogil except -1:\r\n    if status.ok():\r\n        return 0\r\n\r\n    with gil:\r\n        message = frombytes(status.message())\r\n        if IsPlasmaObjectExists(status):\r\n            raise PlasmaObjectExists(message)\r\n        elif IsPlasmaObjectNotFound(status):\r\n            raise PlasmaObjectNotFound(message)\r\n        elif IsPlasmaStoreFull(status):\r\n            raise PlasmaStoreFull(message)\r\n\r\n    return check_status(status)\r\n```\r\n\r\nStarting with 0.29.29, Cython generates an incorrect epilog for `plasma_check_status`:\r\n```c++\r\n  /* \"pyarrow/_plasma.pyx\":275\r\n * \r\n * \r\n * cdef int plasma_check_status(const CStatus& status) nogil except -1:             # <<<<<<<<<<<<<<\r\n *     if status.ok():\r\n *         return 0\r\n */\r\n\r\n  /* function exit code */\r\n  __pyx_L1_error:;\r\n  __Pyx_XDECREF(__pyx_t_2);\r\n  __Pyx_XDECREF(__pyx_t_3);\r\n  __Pyx_XDECREF(__pyx_t_4);\r\n  __Pyx_XDECREF(__pyx_t_5);\r\n  #ifdef WITH_THREAD\r\n  __pyx_gilstate_save = __Pyx_PyGILState_Ensure();\r\n  #endif\r\n  __Pyx_AddTraceback(\"pyarrow._plasma.plasma_check_status\", __pyx_clineno, __pyx_lineno, __pyx_filename);\r\n  __pyx_r = -1;\r\n  #ifdef WITH_THREAD\r\n  __Pyx_PyGILState_Release(__pyx_gilstate_save);\r\n  #endif\r\n  __pyx_L0:;\r\n  __Pyx_XDECREF(__pyx_v_message);\r\n  return __pyx_r;\r\n```\r\n\r\nNotice that `__Pyx_XDECREF` is called *after* releasing the GIL.\r\n\r\nHere's the diff between 0.29.28 and 0.29.29 generated code:\r\n```diff\r\n   /* function exit code */\r\n-  __pyx_r = 0;\r\n-  goto __pyx_L0;\r\n   __pyx_L1_error:;\r\n   __Pyx_XDECREF(__pyx_t_2);\r\n   __Pyx_XDECREF(__pyx_t_3);\r\n   __Pyx_XDECREF(__pyx_t_4);\r\n   __Pyx_XDECREF(__pyx_t_5);\r\n+  #ifdef WITH_THREAD\r\n+  __pyx_gilstate_save = __Pyx_PyGILState_Ensure();\r\n+  #endif\r\n   __Pyx_AddTraceback(\"pyarrow._plasma.plasma_check_status\", __pyx_clineno, __pyx_lineno, __pyx_filename);\r\n   __pyx_r = -1;\r\n-  __pyx_L0:;\r\n-  __Pyx_XDECREF(__pyx_v_message);\r\n   #ifdef WITH_THREAD\r\n   __Pyx_PyGILState_Release(__pyx_gilstate_save);\r\n   #endif\r\n+  __pyx_L0:;\r\n+  __Pyx_XDECREF(__pyx_v_message);\r\n   return __pyx_r;\r\n```\r\n",
    "closed_at": "2022-05-17T14:42:55Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "I forgot to mention the symptom is a fatal error:\r\n```\r\nFatal Python error: Python memory allocator called without holding the GIL\r\n```\r\n\r\nand the GDB backtrace looks like this:\r\n```\r\n#0  0x00007f32630e703b in raise () from /lib/x86_64-linux-gnu/libc.so.6\r\n#1  0x00007f32630c6859 in abort () from /lib/x86_64-linux-gnu/libc.so.6\r\n#2  0x00000000004a2f15 in ?? ()\r\n#3  0x00000000004a2f31 in Py_FatalError ()\r\n#4  0x00000000004d9cd3 in ?? ()\r\n#5  0x000000000064987f in _PyFaulthandler_Fini ()\r\n#6  0x00000000004a2efe in ?? ()\r\n#7  0x00000000004a2f31 in Py_FatalError ()\r\n#8  0x00000000004d9cd3 in ?? ()\r\n#9  0x00007f321184075c in _Py_DECREF (filename=0x7f321186c000 \"/usr/include/python3.8/object.h\", lineno=541, op=0x7f3211313e40)\r\n    at /usr/include/python3.8/object.h:478\r\n#10 0x00007f32118407ac in _Py_XDECREF (op=0x7f3211313e40) at /usr/include/python3.8/object.h:541\r\n#11 0x00007f3211844b4d in __pyx_f_7pyarrow_7_plasma_plasma_check_status (__pyx_v_status=...) at _plasma.cpp:6523\r\n#12 0x00007f32118545b8 in __pyx_pf_7pyarrow_7_plasma_4connect (__pyx_self=0x0, __pyx_v_store_socket_name=0x7f32118a28e0, __pyx_v_num_retries=1) at _plasma.cpp:12132\r\n#13 0x00007f32118541a6 in __pyx_pw_7pyarrow_7_plasma_5connect (__pyx_self=0x0, __pyx_args=0x7f32112a1a00, __pyx_kwds=0x7f321153c650) at _plasma.cpp:12051\r\n#14 0x00000000005f3989 in PyCFunction_Call ()\r\n```",
            "created_at": "2022-05-17T11:44:21Z",
            "html_url": "https://github.com/cython/cython/issues/4796#issuecomment-1128767081",
            "id": 1128767081,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4796",
            "node_id": "IC_kwDOABDGAc5DR55p",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1128767081/reactions"
            },
            "updated_at": "2022-05-17T11:44:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1128767081",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1721820?v=4",
                "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
                "followers_url": "https://api.github.com/users/pitrou/followers",
                "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
                "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pitrou",
                "id": 1721820,
                "login": "pitrou",
                "node_id": "MDQ6VXNlcjE3MjE4MjA=",
                "organizations_url": "https://api.github.com/users/pitrou/orgs",
                "received_events_url": "https://api.github.com/users/pitrou/received_events",
                "repos_url": "https://api.github.com/users/pitrou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pitrou"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Thanks for the quick report. I've reverted #4749 in https://github.com/cython/cython/commit/7fbf5eeeb19983aa65938fd262508d8758f47da8 in the 0.29.x branch. Could you please verify that this fixes the issue?",
            "created_at": "2022-05-17T14:17:23Z",
            "html_url": "https://github.com/cython/cython/issues/4796#issuecomment-1128929208",
            "id": 1128929208,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4796",
            "node_id": "IC_kwDOABDGAc5DShe4",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1128929208/reactions"
            },
            "updated_at": "2022-05-17T14:18:45Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1128929208",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "> Thanks for the quick report. I've reverted #4749 in [7fbf5ee](https://github.com/cython/cython/commit/7fbf5eeeb19983aa65938fd262508d8758f47da8) in the 0.29.x branch. Could you please verify that this fixes the issue?\r\n\r\nIt does, thank you!",
            "created_at": "2022-05-17T14:24:08Z",
            "html_url": "https://github.com/cython/cython/issues/4796#issuecomment-1128937472",
            "id": 1128937472,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4796",
            "node_id": "IC_kwDOABDGAc5DSjgA",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1128937472/reactions"
            },
            "updated_at": "2022-05-17T14:24:08Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1128937472",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1721820?v=4",
                "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
                "followers_url": "https://api.github.com/users/pitrou/followers",
                "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
                "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/pitrou",
                "id": 1721820,
                "login": "pitrou",
                "node_id": "MDQ6VXNlcjE3MjE4MjA=",
                "organizations_url": "https://api.github.com/users/pitrou/orgs",
                "received_events_url": "https://api.github.com/users/pitrou/received_events",
                "repos_url": "https://api.github.com/users/pitrou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/pitrou"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4796/comments",
    "created_at": "2022-05-17T11:39:54Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2022-05-17T14:16:34Z",
            "event": "milestoned",
            "id": 6624925841,
            "milestone": {
                "title": "0.29.30"
            },
            "node_id": "MIE_lADOABDGAc5J0in8zwAAAAGK4FiR",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6624925841"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2022-05-17T14:16:40Z",
            "event": "labeled",
            "id": 6624926860,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "node_id": "LE_lADOABDGAc5J0in8zwAAAAGK4FyM",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6624926860"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2022-05-17T14:16:41Z",
            "event": "labeled",
            "id": 6624926865,
            "label": {
                "color": "444444",
                "name": "Code Generation"
            },
            "node_id": "LE_lADOABDGAc5J0in8zwAAAAGK4FyR",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6624926865"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2022-05-17T14:42:55Z",
            "event": "closed",
            "id": 6625163830,
            "node_id": "CE_lADOABDGAc5J0in8zwAAAAGK4_o2",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6625163830"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4796/events",
    "html_url": "https://github.com/cython/cython/issues/4796",
    "id": 1238510076,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425553654,
            "name": "defect",
            "node_id": "MDU6TGFiZWw0MjU1NTM2NTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        },
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425556330,
            "name": "Code Generation",
            "node_id": "MDU6TGFiZWw0MjU1NTYzMzA=",
            "url": "https://api.github.com/repos/cython/cython/labels/Code%20Generation"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4796/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": "2022-05-17T14:44:48Z",
        "closed_issues": 1,
        "created_at": "2022-05-17T10:50:07Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
            "events_url": "https://api.github.com/users/scoder/events{/privacy}",
            "followers_url": "https://api.github.com/users/scoder/followers",
            "following_url": "https://api.github.com/users/scoder/following{/other_user}",
            "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/scoder",
            "id": 491659,
            "login": "scoder",
            "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
            "organizations_url": "https://api.github.com/users/scoder/orgs",
            "received_events_url": "https://api.github.com/users/scoder/received_events",
            "repos_url": "https://api.github.com/users/scoder/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/scoder"
        },
        "description": "",
        "due_on": null,
        "html_url": "https://github.com/cython/cython/milestone/90",
        "id": 7988471,
        "labels_url": "https://api.github.com/repos/cython/cython/milestones/90/labels",
        "node_id": "MI_kwDOABDGAc4AeeT3",
        "number": 90,
        "open_issues": 0,
        "state": "closed",
        "title": "0.29.30",
        "updated_at": "2022-05-17T14:45:26Z",
        "url": "https://api.github.com/repos/cython/cython/milestones/90"
    },
    "node_id": "I_kwDOABDGAc5J0in8",
    "number": 4796,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4796/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4796/timeline",
    "title": "[BUG] 0.29.29 regression: Python memory allocator called without holding the GIL",
    "updated_at": "2022-05-17T14:42:55Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4796",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1721820?v=4",
        "events_url": "https://api.github.com/users/pitrou/events{/privacy}",
        "followers_url": "https://api.github.com/users/pitrou/followers",
        "following_url": "https://api.github.com/users/pitrou/following{/other_user}",
        "gists_url": "https://api.github.com/users/pitrou/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/pitrou",
        "id": 1721820,
        "login": "pitrou",
        "node_id": "MDQ6VXNlcjE3MjE4MjA=",
        "organizations_url": "https://api.github.com/users/pitrou/orgs",
        "received_events_url": "https://api.github.com/users/pitrou/received_events",
        "repos_url": "https://api.github.com/users/pitrou/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/pitrou/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/pitrou/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/pitrou"
    }
}