{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "<!--\r\n**PLEASE READ THIS FIRST:**\r\n- Do not use the bug and feature tracker for support requests. Use the `cython-users` mailing list instead.\r\n- Did you search for similar issues already? Please do, it helps to save us precious time that we otherwise could not invest into development.\r\n- Did you try the latest master branch or pre-release? It might already have what you want to report. Also see the [Changelog](https://github.com/cython/cython/blob/master/CHANGES.rst) regarding recent changes.\r\n-->\r\n\r\n**Describe the bug**\r\nThe current alpha for Cython 3 crashes on a nested class definition in a py+pxd setup.\r\n\r\n**To Reproduce**\r\nCode to reproduce the behaviour:\r\n```\r\n$ cat _red.py\r\nclass R:\r\n    class watch_key_states:\r\n        pass\r\n$ cat _red.pxd\r\ncdef class R:\r\n    pass\r\n$ cython -3 --line-directives -X infer_types=True _red.py\r\n/home/jelle/ans/venv/lib/python3.6/site-packages/Cython/Compiler/Main.py:346: FutureWarning: Cython directive 'language_level' not set, using '3str' for now (Py3). This has changed from earlier releases! File: /home/jelle/ans/web/lib/qclient/databox/_red.pxd\r\n  tree = Parsing.p_module(s, pxd, full_module_name)\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nclass R:\r\n    class watch_key_states:\r\n   ^\r\n------------------------------------------------------------\r\n\r\n_red.py:2:4: Compiler crash in ControlFlowAnalysis\r\n\r\nModuleNode.body = StatListNode(_red.py:1:0)\r\nCClassDefNode.body = StatListNode(_red.py:2:4)\r\n\r\nCompiler crash traceback from this point on:\r\n  File \"/home/jelle/ans/venv/lib/python3.6/site-packages/Cython/Compiler/Visitor.py\", line 180, in _visit\r\n    return handler_method(obj)\r\n  File \"/home/jelle/ans/venv/lib/python3.6/site-packages/Cython/Compiler/FlowControl.py\", line 1335, in visit_PyClassDefNode\r\n    self.env.lookup(node.target.name))\r\n  File \"/home/jelle/ans/venv/lib/python3.6/site-packages/Cython/Compiler/FlowControl.py\", line 174, in mark_assignment\r\n    if self.block and self.is_tracked(entry):\r\n  File \"/home/jelle/ans/venv/lib/python3.6/site-packages/Cython/Compiler/FlowControl.py\", line 152, in is_tracked\r\n    if entry.is_anonymous:\r\nAttributeError: 'NoneType' object has no attribute 'is_anonymous'\r\n$ cython --version\r\nCython version 3.0.0a10\r\n```\r\n\r\n**Expected behavior**\r\nDon't crash\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Ubuntu\r\n - Python version 3.6.10\r\n - Cython 3.0.0a10\r\n\r\n**Additional context**\r\nThis works fine on 0.29.x.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "COLLABORATOR",
            "body": "So if you _don't_ use pure Python mode, the following fails in both master and 0.29.x:\r\n\r\n```\r\ncdef class R:\r\n    class watch_key_states:\r\n        pass\r\n```\r\n\r\nwith the (correct) error `class definition not allowed here`\r\n\r\nThe `cython.cclass` decorator fails (but that's expected because it'll apply to the inner class too). It also gives an unhelpful compiler crash though.\r\n\r\nYour code does appear to work for me in 0.29.x though.\r\n\r\n------------------------------------\r\n\r\nPersonally I think we should be consistent. Either we should say:\r\n* a class inside a cdef class was never intended to work. We should ban it (in both pyx and in pure Python mode)\r\n* since it appears to work, we should allow it.\r\n\r\nI'm mildly in favour of banning it. Regular classes are normal Python code, and they do take values from their outer scope. I don't think this can work reliably inside cdef classes so there are lots of things that can go wrong when defining classes there.\r\n",
            "created_at": "2022-01-15T14:57:41Z",
            "html_url": "https://github.com/cython/cython/issues/4572#issuecomment-1013695779",
            "id": 1013695779,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4572",
            "node_id": "IC_kwDOABDGAc48a8Uj",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1013695779/reactions"
            },
            "updated_at": "2022-01-15T14:57:41Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1013695779",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> Regular classes are normal Python code, and they do take values from their outer scope\r\n\r\nClass scopes do not nest, so that's not an issue.\r\n```python\r\n>>> class A:\r\n...   x = 1\r\n...   class B:\r\n...     y = x + 1\r\n... \r\nTraceback (most recent call last):\r\nNameError: name 'x' is not defined\r\n```\r\n\r\nI don't think there is anything inherently wrong with defining a Python class inside of a cdef class, compared to defining a regular class variable.\r\n",
            "created_at": "2022-01-15T15:34:37Z",
            "html_url": "https://github.com/cython/cython/issues/4572#issuecomment-1013702327",
            "id": 1013702327,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4572",
            "node_id": "IC_kwDOABDGAc48a963",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1013702327/reactions"
            },
            "updated_at": "2022-01-15T15:34:37Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1013702327",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> The `cython.cclass` decorator fails (but that's expected because it'll apply to the inner class too). It also gives an unhelpful compiler crash though.\r\n\r\nThe `@cython.cclass` decorator should not be inherited by nested classes.",
            "created_at": "2022-01-15T15:37:17Z",
            "html_url": "https://github.com/cython/cython/issues/4572#issuecomment-1013702765",
            "id": 1013702765,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4572",
            "node_id": "IC_kwDOABDGAc48a-Bt",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1013702765/reactions"
            },
            "updated_at": "2022-01-15T15:37:17Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1013702765",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "> The `@cython.cclass` decorator should not be inherited by nested classes.\r\n\r\nRelated: https://github.com/cython/cython/issues/4092 (I agree it shouldn't be but it was surprisingly fiddly to fix)",
            "created_at": "2022-01-15T15:39:02Z",
            "html_url": "https://github.com/cython/cython/issues/4572#issuecomment-1013703028",
            "id": 1013703028,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4572",
            "node_id": "IC_kwDOABDGAc48a-F0",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1013703028/reactions"
            },
            "updated_at": "2022-01-15T15:39:02Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1013703028",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4572/comments",
    "created_at": "2022-01-15T03:34:54Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": "5b1bb0f27acce071a8d03fd3d2fcbdd161594675",
            "commit_url": "https://api.github.com/repos/da-woods/cython/commits/5b1bb0f27acce071a8d03fd3d2fcbdd161594675",
            "created_at": "2022-01-16T09:48:42Z",
            "event": "referenced",
            "id": 5900080823,
            "node_id": "REFE_lADOABDGAc5B0pdFzwAAAAFfrBa3",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5900080823"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4572/events",
    "html_url": "https://github.com/cython/cython/issues/4572",
    "id": 1104320325,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4572/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5B0pdF",
    "number": 4572,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4572/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4572/timeline",
    "title": "[BUG] Compiler crash on nested class",
    "updated_at": "2022-01-15T15:39:02Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4572",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/906600?v=4",
        "events_url": "https://api.github.com/users/JelleZijlstra/events{/privacy}",
        "followers_url": "https://api.github.com/users/JelleZijlstra/followers",
        "following_url": "https://api.github.com/users/JelleZijlstra/following{/other_user}",
        "gists_url": "https://api.github.com/users/JelleZijlstra/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/JelleZijlstra",
        "id": 906600,
        "login": "JelleZijlstra",
        "node_id": "MDQ6VXNlcjkwNjYwMA==",
        "organizations_url": "https://api.github.com/users/JelleZijlstra/orgs",
        "received_events_url": "https://api.github.com/users/JelleZijlstra/received_events",
        "repos_url": "https://api.github.com/users/JelleZijlstra/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/JelleZijlstra/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/JelleZijlstra"
    }
}