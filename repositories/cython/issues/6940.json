{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nI guess it is not really a Cython bug but the releases of  Cython 3.1 and Cython 3.1.1 break something that was working fine before.\n\nCurrently, `pip install mpi4py` builds a wheel and uses Cython.\n\nUnfortunately, with Cython 3.1, this leads on Debian 12 Bookworm (i.e. currently Debian stable and also used by default for Python docker image) and Fedora 37 to a huge memory consumption leading to OOM. This has been reported in https://github.com/mpi4py/mpi4py/issues/651 and https://github.com/mpi4py/mpi4py/issues/652.\n\nI think that it is related to an issue with gcc 12 with code generated by Cython 3.1 with flags `-g -02` (https://github.com/mpi4py/mpi4py/issues/652#issuecomment-2936030256).\n\nUnfortunately, it is not simple for users to avoid this problem since it is quite common to not be able to control the versions of the build dependencies of mpi4py (to compile it with Cython 3.0).\n\nGiven that Debian 12 is still important, such incompatibility with the most recent stable version of Cython is an issue. Fortunately, this is mostly a problem for mpi4py since most other projects upload wheels on PyPI so users do not need to compile them.\n\nI guess a reasonable answer from the point of view of Cython could be \"This is not our business. Cython 3.1 generates correct code and we are not responsible for bugs in gcc 12 used by Debian 12.\" However, it could be nice to understand which changes in Cython generated code lead to this issue and maybe to avoid this as long as it impacts Debian stable users.\n\nThere are different ways to deal with such problem of incompatibility:\n\n1. provide a workaround usable by users (not nice for users)\n2. fix gcc 12 and patch the Debian package (I guess very difficult and )\n3. change cython 3.1 to avoid the issue with gcc 12 (might be doable and nice)\n4. change mpi4py to pin a build dependency to Cython 3.0 (seems quite simple and reasonable)\n\nI tend to think that the fourth solution is the best. I would be interested to have the points of view of Cython maintainers.\n\n### Code to reproduce the behaviour:\n\n```sh\npip install mpi4py\n```\n### Expected behaviour\n\nBuild and install mpi4py\n\n### OS\n\nDebian 12\n\n### Python version\n\n3.11\n\n### Cython version\n\n3.1.1\n",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "My uninformed guess would be that it's probably just a single thing that's tripping GCC up (and not many cumulative things). If that's the case we could try to fix it.\n\nThere's definitely [a bunch of GCC options](https://gcc.gnu.org/onlinedocs/gcc/Developer-Options.html) that print diagnostic info which might help to work out where it is. But I've never seriously used any of those (and when I've non-seriously used them, I haven't got much out of them).\n\nThe other useful thing might be a bisect to a specific Cython change (assuming it's a single refactoring that triggered it).",
            "created_at": "2025-06-04T10:54:16Z",
            "html_url": "https://github.com/cython/cython/issues/6940#issuecomment-2939559413",
            "id": 2939559413,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6940",
            "node_id": "IC_kwDOABDGAc6vNh31",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2939559413/reactions"
            },
            "updated_at": "2025-06-04T11:10:17Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2939559413",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "We haven't had time to investigate yet, but we do observe that on Linux updating to 3.1.x causes at least 2x slowdown in the (gcc) compile time: https://github.com/NVIDIA/cuda-python/issues/642. Interestingly, on Windows there is no human-noticeable speed change. I suspect the long build time observed there is correlated to the high memory usage here.",
            "created_at": "2025-06-04T17:26:13Z",
            "html_url": "https://github.com/cython/cython/issues/6940#issuecomment-2940827777",
            "id": 2940827777,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6940",
            "node_id": "IC_kwDOABDGAc6vSXiB",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2940827777/reactions"
            },
            "updated_at": "2025-06-04T17:27:03Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2940827777",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5534781?v=4",
                "events_url": "https://api.github.com/users/leofang/events{/privacy}",
                "followers_url": "https://api.github.com/users/leofang/followers",
                "following_url": "https://api.github.com/users/leofang/following{/other_user}",
                "gists_url": "https://api.github.com/users/leofang/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/leofang",
                "id": 5534781,
                "login": "leofang",
                "node_id": "MDQ6VXNlcjU1MzQ3ODE=",
                "organizations_url": "https://api.github.com/users/leofang/orgs",
                "received_events_url": "https://api.github.com/users/leofang/received_events",
                "repos_url": "https://api.github.com/users/leofang/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/leofang/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/leofang/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/leofang",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> We haven't had time to investigate yet, but we do observe that on Linux updating to 3.1.x causes at least 2x slowdown in the (gcc) compile time\n\nDo you know what version of GCC you're using? Is it 12 (like this bug report) or something else?\n",
            "created_at": "2025-06-04T17:28:53Z",
            "html_url": "https://github.com/cython/cython/issues/6940#issuecomment-2940834795",
            "id": 2940834795,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6940",
            "node_id": "IC_kwDOABDGAc6vSZPr",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2940834795/reactions"
            },
            "updated_at": "2025-06-04T17:28:53Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2940834795",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "> Do you know what version of GCC you're using? Is it 12 (like this bug report) or something else?\n\n@da-woods We use the manylinux2014 image so it seems to be GCC 10 based on the public info:\nhttps://github.com/pypa/manylinux#manylinux2014-centos-7-based-glibc-217\nI can double check once I am back to my desk.",
            "created_at": "2025-06-05T03:34:59Z",
            "html_url": "https://github.com/cython/cython/issues/6940#issuecomment-2942629593",
            "id": 2942629593,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6940",
            "node_id": "IC_kwDOABDGAc6vZPbZ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2942629593/reactions"
            },
            "updated_at": "2025-06-05T03:34:59Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2942629593",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5534781?v=4",
                "events_url": "https://api.github.com/users/leofang/events{/privacy}",
                "followers_url": "https://api.github.com/users/leofang/followers",
                "following_url": "https://api.github.com/users/leofang/following{/other_user}",
                "gists_url": "https://api.github.com/users/leofang/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/leofang",
                "id": 5534781,
                "login": "leofang",
                "node_id": "MDQ6VXNlcjU1MzQ3ODE=",
                "organizations_url": "https://api.github.com/users/leofang/orgs",
                "received_events_url": "https://api.github.com/users/leofang/received_events",
                "repos_url": "https://api.github.com/users/leofang/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/leofang/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/leofang/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/leofang",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I haven't tried either of your specific projects but I've had a go at bisecting compiling Cython/Compiler/ParseTreeTransforms.py with gcc12.4 (running `/usr/bin/time -f '%M'  gcc -O2 -g -c Cython/Compiler/ParseTreeTransforms.c -I /usr/include/python3.13/ -o something.o`)\n\nI can see a bit of a jump at commit 7b8ad1c65bf27dc558e19a9191f09eac7749f490 (but fairly small - ~5% so nothing like the 2x that you described).\n\nHowever, on GCC 14 Cython 3.1 seems generate code that uses less memory to compile than 3.0. I haven't had a detailed look at bisecting that though because it's all pretty slow.\n\nThat suggests to me that you're doing something specific to triggers it that not every module has. And it probably needs bisecting with something that we know triggers it.",
            "created_at": "2025-06-05T22:08:19Z",
            "html_url": "https://github.com/cython/cython/issues/6940#issuecomment-2946508078",
            "id": 2946508078,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6940",
            "node_id": "IC_kwDOABDGAc6voCUu",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2946508078/reactions"
            },
            "updated_at": "2025-06-05T22:35:45Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2946508078",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "Thanks for looking into it. We'll try to bisect on our side too.\n\n> I can double check once I am back to my desk.\n\nFor posterity, it's GCC 10.2.1:\n```shell\n$ docker run -it --rm quay.io/pypa/manylinux2014_x86_64\n[root@2dfd10857afd /]# which gcc\n/opt/rh/devtoolset-10/root/usr/bin/gcc\n[root@2dfd10857afd /]# gcc --version\ngcc (GCC) 10.2.1 20210130 (Red Hat 10.2.1-11)\nCopyright (C) 2020 Free Software Foundation, Inc.\nThis is free software; see the source for copying conditions.  There is NO\nwarranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.\n```",
            "created_at": "2025-06-06T02:34:50Z",
            "html_url": "https://github.com/cython/cython/issues/6940#issuecomment-2947869789",
            "id": 2947869789,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6940",
            "node_id": "IC_kwDOABDGAc6vtOxd",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2947869789/reactions"
            },
            "updated_at": "2025-06-06T02:35:28Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2947869789",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5534781?v=4",
                "events_url": "https://api.github.com/users/leofang/events{/privacy}",
                "followers_url": "https://api.github.com/users/leofang/followers",
                "following_url": "https://api.github.com/users/leofang/following{/other_user}",
                "gists_url": "https://api.github.com/users/leofang/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/leofang",
                "id": 5534781,
                "login": "leofang",
                "node_id": "MDQ6VXNlcjU1MzQ3ODE=",
                "organizations_url": "https://api.github.com/users/leofang/orgs",
                "received_events_url": "https://api.github.com/users/leofang/received_events",
                "repos_url": "https://api.github.com/users/leofang/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/leofang/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/leofang/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/leofang",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6940/comments",
    "created_at": "2025-06-04T09:46:00Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5534781?v=4",
                "events_url": "https://api.github.com/users/leofang/events{/privacy}",
                "followers_url": "https://api.github.com/users/leofang/followers",
                "following_url": "https://api.github.com/users/leofang/following{/other_user}",
                "gists_url": "https://api.github.com/users/leofang/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/leofang",
                "id": 5534781,
                "login": "leofang",
                "node_id": "MDQ6VXNlcjU1MzQ3ODE=",
                "organizations_url": "https://api.github.com/users/leofang/orgs",
                "received_events_url": "https://api.github.com/users/leofang/received_events",
                "repos_url": "https://api.github.com/users/leofang/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/leofang/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/leofang/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/leofang",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-06-04T12:39:49Z",
            "event": "subscribed",
            "id": 17980977727,
            "node_id": "SE_lADOABDGAc65zKqHzwAAAAQvv_I_",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/17980977727"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-06-05T03:35:00Z",
            "event": "mentioned",
            "id": 17992555048,
            "node_id": "MEE_lADOABDGAc65zKqHzwAAAAQwcJoo",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/17992555048"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-06-05T03:35:00Z",
            "event": "subscribed",
            "id": 17992555054,
            "node_id": "SE_lADOABDGAc65zKqHzwAAAAQwcJou",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/17992555054"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6940/events",
    "html_url": "https://github.com/cython/cython/issues/6940",
    "id": 3117197959,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6940/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc65zKqH",
    "number": 6940,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6940/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6940/timeline",
    "title": "[BUG] huge memory consumption for mpi4py builds on Debian 12 (stable) with Cython 3.1",
    "type": null,
    "updated_at": "2025-06-06T02:35:29Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6940",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/8842662?v=4",
        "events_url": "https://api.github.com/users/paugier/events{/privacy}",
        "followers_url": "https://api.github.com/users/paugier/followers",
        "following_url": "https://api.github.com/users/paugier/following{/other_user}",
        "gists_url": "https://api.github.com/users/paugier/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/paugier",
        "id": 8842662,
        "login": "paugier",
        "node_id": "MDQ6VXNlcjg4NDI2NjI=",
        "organizations_url": "https://api.github.com/users/paugier/orgs",
        "received_events_url": "https://api.github.com/users/paugier/received_events",
        "repos_url": "https://api.github.com/users/paugier/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/paugier/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/paugier/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/paugier",
        "user_view_type": "public"
    }
}