{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "<!--\r\n**PLEASE READ THIS FIRST:**\r\n- DO NOT use the bug and feature tracker for general questions and support requests.\r\n  Use the `cython-users` mailing list instead.\r\n  It has a wider audience, so you get more and better answers.\r\n- Did you search for similar issues already?\r\n  Please do, it helps to save us precious time that we otherwise could not invest into development.\r\n- Did you try the latest master branch or pre-release?\r\n  It might already have what you want to report.\r\n  Also see the [Changelog](https://github.com/cython/cython/blob/master/CHANGES.rst) regarding recent changes.\r\n-->\r\n\r\n**Describe the bug**\r\nA clear and concise description of what the bug is.\r\n\r\nIn generated c code, the generated macro __Pyx_PyFrame_SetLineNumber still uses fields of PyFrameObject, but PyFrameObject has moved to internal API.  \r\nI was fixing the reported bug https://bugzilla.redhat.com/show_bug.cgi?id=2062338\r\nbut it appears that the problem comes from the generated code by cython. \r\n\r\npython 3.10 and cython works fine on this code.\r\n\r\nAfter removing some warnings, I still obtain this error with the last docker image of python : 3.11-rc-bullseye\r\n```shell\r\ngcc -I../../src -g -O2 -Wsign-compare -DNDEBUG -g -fwrapv -O3 -Wall -fPIC -I/calceph/src -I/usr/local/include/python3.11 -c calcephpy.c -o build/temp.linux-x86_64-3.11/calcephpy.o\r\ncalcephpy.c: In function ‘__Pyx_AddTraceback’:\r\ncalcephpy.c:438:62: error: invalid use of incomplete typedef ‘PyFrameObject’ {aka ‘struct _frame’}\r\n  438 |   #define __Pyx_PyFrame_SetLineNumber(frame, lineno)  (frame)->f_lineno = (lineno)\r\n      |                                                              ^~\r\ncalcephpy.c:23634:5: note: in expansion of macro ‘__Pyx_PyFrame_SetLineNumber’\r\n23634 |     __Pyx_PyFrame_SetLineNumber(py_frame, py_line);\r\n      |     ^~~~~~~~~~~~~~~~~~~~~~~~~~~\r\n```\r\n\r\n**To Reproduce**\r\nCode to reproduce the behaviour:\r\n```shell\r\nwget https://www.imcce.fr/content/medias/recherche/equipes/asd/calceph/calceph-3.5.1.tar.gz\r\ntar xzf calceph-3.5.1.tar.gz\r\ncd calceph-3.5.1\r\ncd pythonapi/src\r\ncython -3 calcephpy.pyx\r\ncd ../..\r\n./configure --enable-python=yes --enable-fortran=no && make\r\n```\r\n\r\n**Expected behavior**\r\nA clear and concise description of what you expected to happen.\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Linux\r\n - Python version 3.11.0a6\r\n - Cython version 0.29.28\r\n\r\n**Additional context**\r\nAdd any other context about the problem here.\r\n\r\nAnother project has maybe the same issue :\r\n https://www.mail-archive.com/freebsd-pkg-fallout@freebsd.org/msg1906195.html",
    "closed_at": "2022-03-14T18:01:29Z",
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "It's related to \r\nhttps://bugs.python.org/issue40421#msg414314\r\nhttps://github.com/faster-cpython/ideas/issues/309\r\n\r\n",
            "created_at": "2022-03-14T17:42:39Z",
            "html_url": "https://github.com/cython/cython/issues/4681#issuecomment-1067108342",
            "id": 1067108342,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4681",
            "node_id": "IC_kwDOABDGAc4_msf2",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1067108342/reactions"
            },
            "updated_at": "2022-03-14T17:42:39Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1067108342",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/7082636?v=4",
                "events_url": "https://api.github.com/users/gastineau/events{/privacy}",
                "followers_url": "https://api.github.com/users/gastineau/followers",
                "following_url": "https://api.github.com/users/gastineau/following{/other_user}",
                "gists_url": "https://api.github.com/users/gastineau/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/gastineau",
                "id": 7082636,
                "login": "gastineau",
                "node_id": "MDQ6VXNlcjcwODI2MzY=",
                "organizations_url": "https://api.github.com/users/gastineau/orgs",
                "received_events_url": "https://api.github.com/users/gastineau/received_events",
                "repos_url": "https://api.github.com/users/gastineau/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/gastineau/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/gastineau/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/gastineau"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "I'm pretty sure this was fixed in https://github.com/cython/cython/commit/7537910a2d2e3892359ef639fe9262f017634461 and https://github.com/cython/cython/commit/afc00fc3ba5d43c67151c0039847a526e7b627a5 (depending on the Cython version) - it just hasn't made it into a release yet.",
            "created_at": "2022-03-14T18:01:29Z",
            "html_url": "https://github.com/cython/cython/issues/4681#issuecomment-1067125244",
            "id": 1067125244,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4681",
            "node_id": "IC_kwDOABDGAc4_mwn8",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1067125244/reactions"
            },
            "updated_at": "2022-03-14T18:01:29Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1067125244",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4681/comments",
    "created_at": "2022-03-14T17:37:06Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2022-03-14T18:01:29Z",
            "event": "closed",
            "id": 6237632897,
            "node_id": "CE_lADOABDGAc5FqPfhzwAAAAFzyrmB",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/6237632897"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4681/events",
    "html_url": "https://github.com/cython/cython/issues/4681",
    "id": 1168701409,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4681/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5FqPfh",
    "number": 4681,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4681/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4681/timeline",
    "title": "[BUG] use of incomplete type PyFrameObject in __Pyx_PyFrame_SetLineNumber/__Pyx_AddTraceback",
    "updated_at": "2022-03-14T18:01:29Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4681",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/7082636?v=4",
        "events_url": "https://api.github.com/users/gastineau/events{/privacy}",
        "followers_url": "https://api.github.com/users/gastineau/followers",
        "following_url": "https://api.github.com/users/gastineau/following{/other_user}",
        "gists_url": "https://api.github.com/users/gastineau/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/gastineau",
        "id": 7082636,
        "login": "gastineau",
        "node_id": "MDQ6VXNlcjcwODI2MzY=",
        "organizations_url": "https://api.github.com/users/gastineau/orgs",
        "received_events_url": "https://api.github.com/users/gastineau/received_events",
        "repos_url": "https://api.github.com/users/gastineau/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/gastineau/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/gastineau/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/gastineau"
    }
}