{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\r\n\r\nCython raises a `TypeError` that there's a signature mismatch, even if the only difference is that the runtime function has `const` in some of the arguments, while the built function does not. This is something that C/C++ semantics allow, but Cython currently doesn't. Is it expected?\r\n\r\nI've created a [minimal easily-reproducible project](https://github.com/lysnikolaou/const-cython) that showcases all of this. I'm copying the `README` from that project here, so that it's more easily accessible.\r\n\r\n---------------------------------------------\r\nThis project aims to create a small easily-reproducible example of how Cython does not support\r\nthe following scenario:\r\n\r\n- A library package `libcythonconst` defines a Cython `cdef` function that does not have `const`\r\n  in its arguments in version 1.0.0. In version 1.0.1, it adds `const` to the function.\r\n- A client package `cythonconst` depends on `libcythonconst` and, specifically, to the\r\n  above-mentioned function. It is built against version 1.0.0 (without `const`), but it's installed alongside\r\n  version 1.0.1 (with `const`).\r\n  \r\nImporting `cythonconst` in this scenario fails. *This is in contrast to C/C++ semantics, which would allow it.*\r\nHere's the stack trace:\r\n\r\n```python3\r\nconst-cython on  main via 🐍 pyenv 3.11.3 (venv) \r\n❯ python\r\nPython 3.11.3 (main, May  8 2023, 13:16:43) [Clang 14.0.3 (clang-1403.0.22.14.1)] on darwin\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> import cythonconst\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/Users/lysnikolaou/repos/python/const-cython/venv/lib/python3.11/site-packages/cythonconst/__init__.py\", line 1, in <module>\r\n    from cythonconst.plus import plus_1\r\n  File \"cythonconst/plus.pyx\", line 1, in init cythonconst.plus\r\nTypeError: C function libcythonconst.lsum.lsum has wrong signature (expected PyObject *(int, int), got PyObject *(int const , int const ))\r\n```\r\n\r\nIn order to reproduce this, you can do the following (or run `make test`):\r\n\r\n```zsh\r\nconst-cython on  main via 🐍 pyenv 3.11.3\r\n❯ python -m venv venv\r\n\r\nconst-cython on  main [?] via 🐍 pyenv 3.11.3 took 2s\r\n❯ source venv/bin/activate\r\n\r\nconst-cython on  main [?] via 🐍 pyenv 3.11.3 (venv)\r\n❯ python -m pip install cythonconst\r\nCollecting cythonconst\r\n  Using cached cythonconst-1.1.0-cp311-cp311-macosx_13_0_arm64.whl (29 kB)\r\nCollecting libcythonconst\r\n  Using cached libcythonconst-1.0.1-cp311-cp311-macosx_13_0_arm64.whl (27 kB)\r\nInstalling collected packages: libcythonconst, cythonconst\r\nSuccessfully installed cythonconst-1.1.0 libcythonconst-1.0.1\r\n\r\n[notice] A new release of pip available: 22.3.1 -> 23.1.2\r\n[notice] To update, run: pip install --upgrade pip\r\n\r\nconst-cython on  main [?] via 🐍 pyenv 3.11.3 (.venv)\r\n❯ python\r\nPython 3.11.3 (main, May  8 2023, 13:16:43) [Clang 14.0.3 (clang-1403.0.22.14.1)] on darwin\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> import cythonconst\r\nTraceback (most recent call last):\r\n  File \"<stdin>\", line 1, in <module>\r\n  File \"/Users/lysnikolaou/repos/python/const-cython/.venv/lib/python3.11/site-packages/cythonconst/__init__.py\", line 1, in <module>\r\n    from cythonconst.plus import plus_1\r\n  File \"cythonconst/plus.pyx\", line 1, in init cythonconst.plus\r\nTypeError: C function libcythonconst.lsum.lsum has wrong signature (expected PyObject *(int const , int const ), got PyObject *(int, int))\r\n```\r\n\r\nSee [`pyproject.toml` in client](https://github.com/lysnikolaou/const-cython/tree/main/client/pyproject.toml) for some extra info on how this is built to fail.\r\n\r\n### Expected behaviour\r\n\r\nNo `TypeError` raised.\r\n\r\n### OS\r\n\r\nmacOS\r\n\r\n### Python version\r\n\r\n3.11.3\r\n\r\n### Cython version\r\n\r\n0.29.35\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I think we just do a dumb string comparison for these functions. And we'd probably be reluctant to change that (because dumb string comparisons are easy).\r\n\r\nIn principle we could strip the consts from the function arguments when generating the string, but that'd break existing code in a very similar way. I guess we could have a stripped and unstripped string and check both. Still probably hard to do that without breaking existing code though.\r\n\r\nIf it were to be fixed it probably wouldn't be done in the 0.29.x branch since I don't think it's a regression. Cython 3.0 would be a convenient time to do it with minimal breakage, but I doubt that we want this to block the release.",
            "created_at": "2023-06-15T18:09:44Z",
            "html_url": "https://github.com/cython/cython/issues/5488#issuecomment-1593519662",
            "id": 1593519662,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5488",
            "node_id": "IC_kwDOABDGAc5e-y4u",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1593519662/reactions"
            },
            "updated_at": "2023-06-15T18:09:44Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1593519662",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "Understood.\r\n\r\nThe context here, which might be interesting, is that we're trying to add `const` to the Cython wrappers of BLAS and Lapack on SciPy. Without this, it'd be impossible, since we would be breaking downstream packages built without the `const` in the signature (more info in [this scipy issue](https://github.com/scipy/scipy/issues/18377)).",
            "created_at": "2023-06-16T08:44:26Z",
            "html_url": "https://github.com/cython/cython/issues/5488#issuecomment-1594336854",
            "id": 1594336854,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5488",
            "node_id": "IC_kwDOABDGAc5fB6ZW",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1594336854/reactions"
            },
            "updated_at": "2023-06-16T08:44:26Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1594336854",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/20306270?v=4",
                "events_url": "https://api.github.com/users/lysnikolaou/events{/privacy}",
                "followers_url": "https://api.github.com/users/lysnikolaou/followers",
                "following_url": "https://api.github.com/users/lysnikolaou/following{/other_user}",
                "gists_url": "https://api.github.com/users/lysnikolaou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lysnikolaou",
                "id": 20306270,
                "login": "lysnikolaou",
                "node_id": "MDQ6VXNlcjIwMzA2Mjcw",
                "organizations_url": "https://api.github.com/users/lysnikolaou/orgs",
                "received_events_url": "https://api.github.com/users/lysnikolaou/received_events",
                "repos_url": "https://api.github.com/users/lysnikolaou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lysnikolaou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lysnikolaou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lysnikolaou"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I wonder if we could use the PyCapsule \"context\" pointer to store a const-free version of the signature and use that as a secondary match. I'd propose allowing a colon separated string in case we need to add other compatible signatures in future. That seems to be the most obvious way of loading extra information into our existing mechanism.\r\n\r\nDefinitely can't promise that it can be done in the near future, but that's my proposal for how it could be done without breaking backwards compatibility on our end.",
            "created_at": "2023-06-16T17:14:24Z",
            "html_url": "https://github.com/cython/cython/issues/5488#issuecomment-1595001134",
            "id": 1595001134,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5488",
            "node_id": "IC_kwDOABDGAc5fEcku",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 1,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 1,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1595001134/reactions"
            },
            "updated_at": "2023-06-16T17:14:24Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1595001134",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "Thanks for taking the time to look into how this could be implemented @da-woods!",
            "created_at": "2023-06-19T09:36:02Z",
            "html_url": "https://github.com/cython/cython/issues/5488#issuecomment-1596847101",
            "id": 1596847101,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5488",
            "node_id": "IC_kwDOABDGAc5fLfP9",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1596847101/reactions"
            },
            "updated_at": "2023-06-19T09:36:02Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1596847101",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/20306270?v=4",
                "events_url": "https://api.github.com/users/lysnikolaou/events{/privacy}",
                "followers_url": "https://api.github.com/users/lysnikolaou/followers",
                "following_url": "https://api.github.com/users/lysnikolaou/following{/other_user}",
                "gists_url": "https://api.github.com/users/lysnikolaou/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/lysnikolaou",
                "id": 20306270,
                "login": "lysnikolaou",
                "node_id": "MDQ6VXNlcjIwMzA2Mjcw",
                "organizations_url": "https://api.github.com/users/lysnikolaou/orgs",
                "received_events_url": "https://api.github.com/users/lysnikolaou/received_events",
                "repos_url": "https://api.github.com/users/lysnikolaou/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/lysnikolaou/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/lysnikolaou/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/lysnikolaou"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5488/comments",
    "created_at": "2023-06-15T10:54:26Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-06-19T09:36:03Z",
            "event": "mentioned",
            "id": 9566033477,
            "node_id": "MEE_lADOABDGAc5o0Yy6zwAAAAI6LhZF",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/9566033477"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-06-19T09:36:03Z",
            "event": "subscribed",
            "id": 9566033498,
            "node_id": "SE_lADOABDGAc5o0Yy6zwAAAAI6LhZa",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/9566033498"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5488/events",
    "html_url": "https://github.com/cython/cython/issues/5488",
    "id": 1758563514,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5488/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5o0Yy6",
    "number": 5488,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5488/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5488/timeline",
    "title": "[BUG] Signature mismatch TypeError with const arguments",
    "updated_at": "2023-06-19T09:36:03Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5488",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/20306270?v=4",
        "events_url": "https://api.github.com/users/lysnikolaou/events{/privacy}",
        "followers_url": "https://api.github.com/users/lysnikolaou/followers",
        "following_url": "https://api.github.com/users/lysnikolaou/following{/other_user}",
        "gists_url": "https://api.github.com/users/lysnikolaou/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/lysnikolaou",
        "id": 20306270,
        "login": "lysnikolaou",
        "node_id": "MDQ6VXNlcjIwMzA2Mjcw",
        "organizations_url": "https://api.github.com/users/lysnikolaou/orgs",
        "received_events_url": "https://api.github.com/users/lysnikolaou/received_events",
        "repos_url": "https://api.github.com/users/lysnikolaou/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/lysnikolaou/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/lysnikolaou/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/lysnikolaou"
    }
}