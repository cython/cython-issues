{
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "CCOMPLEX_CYTHON is defined [as follows](https://github.com/cython/cython/blob/e6315294395ad44e667a804710938ee799575296/Cython/Utility/Complex.c#L4):\r\n\r\n```\r\n#if !defined(CYTHON_CCOMPLEX)\r\n  #if defined(__cplusplus)\r\n    #define CYTHON_CCOMPLEX 1\r\n  #elif defined(_Complex_I)\r\n    #define CYTHON_CCOMPLEX 1\r\n  #else\r\n    #define CYTHON_CCOMPLEX 0\r\n  #endif\r\n#endif\r\n\r\n#if CYTHON_CCOMPLEX\r\n  #ifdef __cplusplus\r\n    #include <complex>\r\n  #else\r\n    #include <complex.h>\r\n  #endif\r\n#endif\r\n```\r\n\r\nIf I understand it correctly `_Complex_I` is defined in `complex.h`, so basically for C `CYTHON_COMPLEX` is always 0 (as long as `Python.h` doesn't include complex.h, which seems not to be the case at least with Python-3.6) and thus the resulting code doesn't uses `double complex` in this case but the [Cython's fall back solution](https://github.com/cython/cython/blob/e6315294395ad44e667a804710938ee799575296/Cython/Utility/Complex.c#L63).\r\n\r\n`complex.h` is here since C99, so maybe something like this would make sense?\r\n\r\n```\r\n#ifdef __cplusplus\r\n    #include <complex>\r\n#elif defined (__STDC_VERSION__) && __STDC_VERSION__ >= 199901L\r\n     #include <complex.h>\r\n#endif\r\n\r\n#if !defined(CYTHON_CCOMPLEX)\r\n  #if defined(__cplusplus)\r\n    #define CYTHON_CCOMPLEX 1\r\n  #elif defined(_Complex_I)\r\n    #define CYTHON_CCOMPLEX 1\r\n  #else\r\n    #define CYTHON_CCOMPLEX 0\r\n  #endif\r\n#endif\r\n```",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "My _guess_ is that the original intention was something like: \"if the user includes 'complex.h' then use it automatically\".\r\n\r\nI don't have a problem with using a header that is guaranteed to be there â€“ as long as it does not get in the way of something that users might want instead.\r\n\r\nIn any case, though, `CYTHON_CCOMPLEX` should always be checked first, since users can set it to 1/0 if they feel like it.",
            "created_at": "2018-07-23T22:43:09Z",
            "html_url": "https://github.com/cython/cython/issues/2513#issuecomment-407224239",
            "id": 407224239,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2513",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQwNzIyNDIzOQ==",
            "updated_at": "2018-07-23T22:43:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/407224239",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "As always, this doesn't seem to be clearcut: The way (at least) the multiplication of complex numbers is defined in C99 is not the way this multiplication is implemented in CPython3. \r\n\r\nI think the way of least surprise would be to use the Cython's fallback per default (for C and CPP backends) and only switch to native complex operations is the user explicitly triggers it.\r\n\r\nFor exaple, the result of the following multiplication\r\n\r\n`(1.0+0.0j)*(inf+inf*j)`\r\n\r\nis:\r\n\r\n**Python**:\r\n\r\n   Python uses the formula from the school and gets: `nan+nan*j` as result.\r\n\r\n**On Linux:**\r\n\r\n  1. C-backend, gcc and clang are C99 compliant. As result, for example `inf+inf*j` is  possible.\r\n  2. CPP-backend. As far as I know (don't take my word for it), c++-standard doesn't define the complex multiplication. gcc and clang use C99-variant. A possible result is like above `inf+inf*j`\r\n\r\nThus on Linux + Cython we have the following behavior:\r\n\r\n```\r\n%%cython\r\ndef c_mult(double complex a, double complex b):\r\n    return a*b\r\n\r\n%%cython --cplus\r\ndef cpp_mult(double complex a, double complex b):\r\n    return a*b\r\n\r\na=1.0+0.0j\r\nb=(1.0+1.0j)*float(\"inf\")\r\nprint(\"Python\", a*b)\r\nprint(\"C-Cython\", c_mult(a,b))\r\nprint(\"Cpp-Cython\", cpp_mult(a,b))\r\n```\r\n```\r\nPython (nan+nanj)\r\nC-Cython (nan+nanj)\r\nCpp-Cython (inf+infj)\r\n```\r\n\r\nC-version has the same behavior as CPython, because it uses Cython-fallback. CPP-version uses the native multiplication and the result isn't consistent with other two.\r\n\r\n**On Windows:**\r\n \r\n1. C-backend. MSVC doesn't support complex from C99 (At least with 2015 version), so Cython has to use its fallback here in any case.\r\n2. CPP-backend. The c++-complex multiplication of MSVC doesn't  comply with C99 (via cpp-standard it doesn't have to). It uses the simple formula from the school as far as I understand.\r\n\r\nThus, C-backend and CPP-backend are consistent with CPython implementation on Windows.",
            "created_at": "2018-07-24T21:07:42Z",
            "html_url": "https://github.com/cython/cython/issues/2513#issuecomment-407552578",
            "id": 407552578,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2513",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQwNzU1MjU3OA==",
            "updated_at": "2018-07-24T21:08:08Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/407552578",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/17513912?v=4",
                "events_url": "https://api.github.com/users/realead/events{/privacy}",
                "followers_url": "https://api.github.com/users/realead/followers",
                "following_url": "https://api.github.com/users/realead/following{/other_user}",
                "gists_url": "https://api.github.com/users/realead/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/realead",
                "id": 17513912,
                "login": "realead",
                "node_id": "MDQ6VXNlcjE3NTEzOTEy",
                "organizations_url": "https://api.github.com/users/realead/orgs",
                "received_events_url": "https://api.github.com/users/realead/received_events",
                "repos_url": "https://api.github.com/users/realead/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/realead/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/realead/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/realead"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2513/comments",
    "created_at": "2018-07-23T21:45:20Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2513/events",
    "html_url": "https://github.com/cython/cython/issues/2513",
    "id": 343807322,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2513/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUzNDM4MDczMjI=",
    "number": 2513,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Definition of CYTHON_CCOMPLEX",
    "updated_at": "2018-07-24T21:08:08Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2513",
    "user": {
        "avatar_url": "https://avatars2.githubusercontent.com/u/17513912?v=4",
        "events_url": "https://api.github.com/users/realead/events{/privacy}",
        "followers_url": "https://api.github.com/users/realead/followers",
        "following_url": "https://api.github.com/users/realead/following{/other_user}",
        "gists_url": "https://api.github.com/users/realead/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/realead",
        "id": 17513912,
        "login": "realead",
        "node_id": "MDQ6VXNlcjE3NTEzOTEy",
        "organizations_url": "https://api.github.com/users/realead/orgs",
        "received_events_url": "https://api.github.com/users/realead/received_events",
        "repos_url": "https://api.github.com/users/realead/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/realead/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/realead/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/realead"
    }
}