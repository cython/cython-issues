{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "**Description**\r\nI'm trying to use a fused typedef throughout the code. Specifically, I wanted to have a struct with one of its attributes a fused type. That's not possible though. So instead I went on to create a class holding the fused type as an attribute and then I'll perform the conversion to/from a Python object by myself.\r\nHowever, the following basic definitions already fail with the message:\r\n```\r\n...\r\n  File \"/home/orp/dev/oasis/.venv/lib/python3.8/site-packages/Cython/Compiler/ModuleNode.py\", line 940, in generate_cpp_class_definition\r\n    code.putln(\"%s;\" % attr.type.declaration_code(attr.cname))\r\n  File \"/home/orp/dev/oasis/.venv/lib/python3.8/site-packages/Cython/Compiler/PyrexTypes.py\", line 1649, in declaration_code\r\n    raise Exception(\"This may never happen, please report a bug\")\r\nException: This may never happen, please report a bug\r\n```\r\n\r\n**To Reproduce**\r\nCode to reproduce the behaviour:\r\n```cython\r\ncimport numpy as np\r\nfrom libcpp.vector cimport vector\r\n\r\nctypedef fused FLOAT:\r\n    np.float32_t\r\n    np.float_t\r\n\r\n\r\ncdef cppclass Pool:\r\n    FLOAT v\r\n\r\n    Pool() except +\r\n\r\n\r\ncdef class VectorPool:\r\n    cdef vector[Pool] P\r\n\r\n    def push(self, x):\r\n        cdef Pool P = Pool()\r\n```\r\n\r\n**Environment:**\r\n - OS: Windows WSL2 Ubuntu 20.04\r\n - Python 3.8.5\r\n - Cython version 0.29.24",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "COLLABORATOR",
            "body": "It definitely shouldn't fail with \"Exception: This may never happen, please report a bug\" - it should output a nicer explanatory error message.\r\n\r\nWhat you're trying to do isn't supported. Fused types work as function arguments. You can not define structs, cdef class, cppclasses or anything similar with fused types.\r\n\r\nWe've usually recommended people use some sort of string manipulation to generate their source code for this kind of problem. If you need more concrete suggestions then the [cython-users mailing list](https://groups.google.com/forum/#!forum/cython-users) is a good place to ask.",
            "created_at": "2021-10-09T16:33:29Z",
            "html_url": "https://github.com/cython/cython/issues/4401#issuecomment-939324138",
            "id": 939324138,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4401",
            "node_id": "IC_kwDOABDGAc43_PLq",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/939324138/reactions"
            },
            "updated_at": "2021-10-09T16:33:29Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/939324138",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "Understood. I'm not sure I'm getting the error just for using the fused type in the cppclass or if it's something in the rest of the code.\r\nI'll check out the mailing list, thanks.",
            "created_at": "2021-10-10T07:12:36Z",
            "html_url": "https://github.com/cython/cython/issues/4401#issuecomment-939420690",
            "id": 939420690,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4401",
            "node_id": "IC_kwDOABDGAc43_mwS",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/939420690/reactions"
            },
            "updated_at": "2021-10-10T07:12:36Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/939420690",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/20698781?v=4",
                "events_url": "https://api.github.com/users/orpinchasov/events{/privacy}",
                "followers_url": "https://api.github.com/users/orpinchasov/followers",
                "following_url": "https://api.github.com/users/orpinchasov/following{/other_user}",
                "gists_url": "https://api.github.com/users/orpinchasov/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/orpinchasov",
                "id": 20698781,
                "login": "orpinchasov",
                "node_id": "MDQ6VXNlcjIwNjk4Nzgx",
                "organizations_url": "https://api.github.com/users/orpinchasov/orgs",
                "received_events_url": "https://api.github.com/users/orpinchasov/received_events",
                "repos_url": "https://api.github.com/users/orpinchasov/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/orpinchasov/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/orpinchasov/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/orpinchasov"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4401/comments",
    "created_at": "2021-10-09T10:07:14Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-10-09T16:29:09Z",
            "event": "labeled",
            "id": 5438304012,
            "label": {
                "color": "444444",
                "name": "Error Reporting"
            },
            "node_id": "LE_lADOABDGAc485Wq9zwAAAAFEJe8M",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5438304012"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4401/events",
    "html_url": "https://github.com/cython/cython/issues/4401",
    "id": 1021668029,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425557478,
            "name": "Error Reporting",
            "node_id": "MDU6TGFiZWw0MjU1NTc0Nzg=",
            "url": "https://api.github.com/repos/cython/cython/labels/Error%20Reporting"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4401/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc485Wq9",
    "number": 4401,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4401/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4401/timeline",
    "title": "[BUG] Usage of fused types in a class results in Cython assertion error",
    "updated_at": "2021-10-10T07:12:36Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4401",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/20698781?v=4",
        "events_url": "https://api.github.com/users/orpinchasov/events{/privacy}",
        "followers_url": "https://api.github.com/users/orpinchasov/followers",
        "following_url": "https://api.github.com/users/orpinchasov/following{/other_user}",
        "gists_url": "https://api.github.com/users/orpinchasov/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/orpinchasov",
        "id": 20698781,
        "login": "orpinchasov",
        "node_id": "MDQ6VXNlcjIwNjk4Nzgx",
        "organizations_url": "https://api.github.com/users/orpinchasov/orgs",
        "received_events_url": "https://api.github.com/users/orpinchasov/received_events",
        "repos_url": "https://api.github.com/users/orpinchasov/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/orpinchasov/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/orpinchasov/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/orpinchasov"
    }
}