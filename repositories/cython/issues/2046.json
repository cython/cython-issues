{
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "Since 0.27.1, declaring Py_buffer variables in pure-python mode ceased working. This applies to 0.27.1, 0.27.2 and 0.27.3.\r\n\r\n``` python\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\ndef f():\r\n    return cython.cast(int, cython.address(pybuf))\r\n\r\nprint f()\r\n```\r\n\r\nI know this isn't really useful code, but it illustrates the issue with a minimal example. I'm getting this error in actual working (with 0.27.0) code.\r\n\r\nWhen compiling with cython 0.27.2 (and .3), gives:\r\n\r\n```\r\n(cython)claudiofreire@klaumpptophp:~> cython buffer_bug.py\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\n                      ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:3:23: Not a type\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\ndef f():\r\n    return cython.cast(int, cython.address(pybuf))\r\n                                          ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:5:43: undeclared name not builtin: pybuf\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\ndef f():\r\n    return cython.cast(int, cython.address(pybuf))\r\n                                 ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:5:34: Taking address of non-lvalue (type Python object)\r\n```\r\n\r\nIn cython 0.27.0, however, it builds correctly, generating the following code:\r\n\r\n``` C\r\n  __pyx_t_1 = __Pyx_PyInt_From_int(((int)(&__pyx_v_pybuf))); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 5, __pyx_L1_error)\r\n  __Pyx_GOTREF(__pyx_t_1);\r\n  __pyx_r = __pyx_t_1;\r\n  __pyx_t_1 = 0;\r\n  goto __pyx_L0;\r\n```\r\n\r\nI could find no directly relatable changes in the commit history, but I'm not that familiar with this code, so maybe someone else can figure this out.\r\n\r\nTo clarify, in non-pure-python mode it works correctly:\r\n\r\n``` python\r\nfrom cpython cimport Py_buffer\r\n\r\ndef f():\r\n    cdef Py_buffer pybuf\r\n    return <int>&pybuf\r\n\r\nprint f()\r\n```\r\n\r\nCompiles in all versions.\r\n\r\nAdding the cimport to buffer_bug.pxd in pure-python mode doesn't change a thing.\r\n\r\nFTR, I realize Py_buffer is unusable in pure python. The use case for this always involves compiled-only code paths:\r\n\r\n``` python\r\nif cython.compiled:\r\n    # do something with Py_buffer\r\nelse:\r\n    # do it the slower pure-python way\r\n```\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "The `pybuf` variable is not actually defined in your example. According to Python semantics, a local variable does not exist before it is assigned. Is that related, or do you also see this in code that correctly creates your variable?",
            "created_at": "2018-01-12T19:48:06Z",
            "html_url": "https://github.com/cython/cython/issues/2046#issuecomment-357336511",
            "id": 357336511,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2046",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1NzMzNjUxMQ==",
            "updated_at": "2018-01-12T19:48:06Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/357336511",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "You cannot assign a Py_buffer, as it is a struct intended to be used by passing pointers to it.\r\n\r\nThus, most real-world use cases will not contain assignments.\r\n\r\nThat said, adding no-op assignments to make it local without actually executing the assignment doesn't work either:\r\n\r\n``` python\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\ndef f():\r\n    pybuf = pybuf\r\n    return cython.cast(int, cython.address(pybuf))\r\n\r\nprint f()\r\n```\r\n\r\n```\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\n                      ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:3:23: Not a type\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\ndef f():\r\n    pybuf = pybuf\r\n           ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:5:12: local variable 'pybuf' referenced before assignment\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\n@cython.locals(pybuf = 'Py_buffer')\r\ndef f():\r\n    pybuf = pybuf\r\n    return cython.cast(int, cython.address(pybuf))\r\n                                 ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:6:34: Cannot take address of Python variable 'pybuf'\r\n```\r\n\r\nUsing an alternative declaration syntax doesn't work either in 0.27.3, yet it does in 0.27.0:\r\n\r\n``` python\r\nimport cython\r\n\r\ndef f():\r\n    pybuf = cython.declare('Py_buffer')\r\n    return cython.cast(int, cython.address(pybuf))\r\n\r\nprint f()\r\n```\r\n\r\n```\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\ndef f():\r\n    pybuf = cython.declare('Py_buffer')\r\n                          ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:4:27: Unknown type\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\ndef f():\r\n    pybuf = cython.declare('Py_buffer')\r\n                 ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:4:18: 'declare' not a valid cython language construct\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\ndef f():\r\n    pybuf = cython.declare('Py_buffer')\r\n                 ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:4:18: 'declare' not a valid cython attribute or is being used incorrectly\r\n\r\nError compiling Cython file:\r\n------------------------------------------------------------\r\n...\r\nimport cython\r\n\r\ndef f():\r\n    pybuf = cython.declare('Py_buffer')\r\n   ^\r\n------------------------------------------------------------\r\n\r\nbuffer_bug.py:4:4: Compiler crash in AnalyseExpressionsTransform\r\n\r\nModuleNode.body = StatListNode(buffer_bug.py:1:0)\r\nStatListNode.stats[1] = StatListNode(buffer_bug.py:3:0)\r\nStatListNode.stats[0] = DefNode(buffer_bug.py:3:0,\r\n    is_cyfunction = True,\r\n    modifiers = [...]/0,\r\n    name = u'f',\r\n    np_args_idx = [...]/0,\r\n    py_wrapper_required = True,\r\n    reqd_kw_flags_cname = '0',\r\n    used = True)\r\nFile 'Nodes.py', line 422, in analyse_expressions: StatListNode(buffer_bug.py:4:4,\r\n    is_terminator = True)\r\nFile 'Nodes.py', line 4863, in analyse_expressions: SingleAssignmentNode(buffer_bug.py:4:26)\r\nFile 'Nodes.py', line 4989, in analyse_types: SingleAssignmentNode(buffer_bug.py:4:26)\r\nFile 'ExprNodes.py', line 1944, in analyse_target_types: NameNode(buffer_bug.py:4:4,\r\n    cf_maybe_null = True,\r\n    is_name = True,\r\n    name = u'pybuf',\r\n    result_is_used = True,\r\n    use_managed_ref = True)\r\nFile 'ExprNodes.py', line 2003, in analyse_entry: NameNode(buffer_bug.py:4:4,\r\n    cf_maybe_null = True,\r\n    is_name = True,\r\n    name = u'pybuf',\r\n    result_is_used = True,\r\n    use_managed_ref = True)\r\nFile 'ExprNodes.py', line 2017, in check_identifier_kind: NameNode(buffer_bug.py:4:4,\r\n    cf_maybe_null = True,\r\n    is_name = True,\r\n    name = u'pybuf',\r\n    result_is_used = True,\r\n    use_managed_ref = True)\r\n\r\nCompiler crash traceback from this point on:\r\n  File \"/home/claudiofreire/venv/cython/lib/python2.7/site-packages/Cython/Compiler/ExprNodes.py\", line 2017, in check_identifier_kind\r\n    if entry.is_type and entry.type.is_extension_type:\r\nAttributeError: 'NoneType' object has no attribute 'is_type'\r\n```",
            "created_at": "2018-01-12T22:56:53Z",
            "html_url": "https://github.com/cython/cython/issues/2046#issuecomment-357377307",
            "id": 357377307,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2046",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1NzM3NzMwNw==",
            "updated_at": "2018-01-12T22:57:29Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/357377307",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1746892?v=4",
                "events_url": "https://api.github.com/users/klaussfreire/events{/privacy}",
                "followers_url": "https://api.github.com/users/klaussfreire/followers",
                "following_url": "https://api.github.com/users/klaussfreire/following{/other_user}",
                "gists_url": "https://api.github.com/users/klaussfreire/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/klaussfreire",
                "id": 1746892,
                "login": "klaussfreire",
                "node_id": "MDQ6VXNlcjE3NDY4OTI=",
                "organizations_url": "https://api.github.com/users/klaussfreire/orgs",
                "received_events_url": "https://api.github.com/users/klaussfreire/received_events",
                "repos_url": "https://api.github.com/users/klaussfreire/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/klaussfreire/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/klaussfreire/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/klaussfreire"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Real-world code can be [found here](https://github.com/jampp/sharedbuffers/blob/master/sharedbuffers/mapped_struct.py#L107)",
            "created_at": "2018-01-12T22:58:07Z",
            "html_url": "https://github.com/cython/cython/issues/2046#issuecomment-357377540",
            "id": 357377540,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2046",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM1NzM3NzU0MA==",
            "updated_at": "2018-01-12T22:58:07Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/357377540",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1746892?v=4",
                "events_url": "https://api.github.com/users/klaussfreire/events{/privacy}",
                "followers_url": "https://api.github.com/users/klaussfreire/followers",
                "following_url": "https://api.github.com/users/klaussfreire/following{/other_user}",
                "gists_url": "https://api.github.com/users/klaussfreire/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/klaussfreire",
                "id": 1746892,
                "login": "klaussfreire",
                "node_id": "MDQ6VXNlcjE3NDY4OTI=",
                "organizations_url": "https://api.github.com/users/klaussfreire/orgs",
                "received_events_url": "https://api.github.com/users/klaussfreire/received_events",
                "repos_url": "https://api.github.com/users/klaussfreire/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/klaussfreire/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/klaussfreire/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/klaussfreire"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "This still happens in 0.28.3",
            "created_at": "2018-06-08T16:02:23Z",
            "html_url": "https://github.com/cython/cython/issues/2046#issuecomment-395807770",
            "id": 395807770,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2046",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5NTgwNzc3MA==",
            "updated_at": "2018-06-08T16:02:23Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/395807770",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1746892?v=4",
                "events_url": "https://api.github.com/users/klaussfreire/events{/privacy}",
                "followers_url": "https://api.github.com/users/klaussfreire/followers",
                "following_url": "https://api.github.com/users/klaussfreire/following{/other_user}",
                "gists_url": "https://api.github.com/users/klaussfreire/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/klaussfreire",
                "id": 1746892,
                "login": "klaussfreire",
                "node_id": "MDQ6VXNlcjE3NDY4OTI=",
                "organizations_url": "https://api.github.com/users/klaussfreire/orgs",
                "received_events_url": "https://api.github.com/users/klaussfreire/received_events",
                "repos_url": "https://api.github.com/users/klaussfreire/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/klaussfreire/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/klaussfreire/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/klaussfreire"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Create #2317 which seems to fix this",
            "created_at": "2018-06-08T19:53:00Z",
            "html_url": "https://github.com/cython/cython/issues/2046#issuecomment-395871445",
            "id": 395871445,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2046",
            "node_id": "MDEyOklzc3VlQ29tbWVudDM5NTg3MTQ0NQ==",
            "updated_at": "2018-06-08T19:53:00Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/395871445",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/1746892?v=4",
                "events_url": "https://api.github.com/users/klaussfreire/events{/privacy}",
                "followers_url": "https://api.github.com/users/klaussfreire/followers",
                "following_url": "https://api.github.com/users/klaussfreire/following{/other_user}",
                "gists_url": "https://api.github.com/users/klaussfreire/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/klaussfreire",
                "id": 1746892,
                "login": "klaussfreire",
                "node_id": "MDQ6VXNlcjE3NDY4OTI=",
                "organizations_url": "https://api.github.com/users/klaussfreire/orgs",
                "received_events_url": "https://api.github.com/users/klaussfreire/received_events",
                "repos_url": "https://api.github.com/users/klaussfreire/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/klaussfreire/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/klaussfreire/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/klaussfreire"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2046/comments",
    "created_at": "2017-12-18T16:33:39Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2046/events",
    "html_url": "https://github.com/cython/cython/issues/2046",
    "id": 282941514,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2046/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUyODI5NDE1MTQ=",
    "number": 2046,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Py_buffer builtin struct unusable after 0.27.0",
    "updated_at": "2018-06-08T19:53:01Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2046",
    "user": {
        "avatar_url": "https://avatars2.githubusercontent.com/u/1746892?v=4",
        "events_url": "https://api.github.com/users/klaussfreire/events{/privacy}",
        "followers_url": "https://api.github.com/users/klaussfreire/followers",
        "following_url": "https://api.github.com/users/klaussfreire/following{/other_user}",
        "gists_url": "https://api.github.com/users/klaussfreire/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/klaussfreire",
        "id": 1746892,
        "login": "klaussfreire",
        "node_id": "MDQ6VXNlcjE3NDY4OTI=",
        "organizations_url": "https://api.github.com/users/klaussfreire/orgs",
        "received_events_url": "https://api.github.com/users/klaussfreire/received_events",
        "repos_url": "https://api.github.com/users/klaussfreire/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/klaussfreire/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/klaussfreire/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/klaussfreire"
    }
}