{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nI maintain a codebase where I require 100% coverage from the tests. I'm experiencing an issue where when I install the Cython nightly from https://pypi.anaconda.org/scientific-python-nightly-wheels/simple, suddenly some lines in the tests are no longer being marked as covered. \r\n\r\nI'm not completely sure what the pattern is, but it seems like these lines all involve Cython code. For instance, many lines are asserts involving an `__eq__` method defined in a cythonized class. I'm not completely sure if every line involving Cython code is always missed by the coverage or if it only happens sometimes (the tests use hypothesis and only a subset of the classes are Cythonized, which makes this difficult to determine). \r\n\r\nThis happens whenever I enable coverage in the Cython module (i.e., `linetrace=True`, `CYTHON_TRACE_NOGIL=1`). However, it does not seem to matter whether or not I actually enable the Cython coverage plugin itself. \n\n### Code to reproduce the behaviour:\n\nYou can reproduce with the code at this PR https://github.com/Quansight-Labs/ndindex/pull/183.\r\n\r\n1. Install the dependencies in `requirements-dev.txt`. \r\n2. Install the Cython nightly.\r\n3. Build ndindex without Cython coverage enabled, and run the tests:\r\n\r\n   ```\r\n   python setup.py build_ext --inplace\r\n   pytest\r\n   ```\r\n\r\n   This should output a 100% coverage report at the end\r\n\r\n4. Rebuild ndindex with Cython coverage enabled (this sets `linetrace=True`, `CYTHON_TRACE_NOGIL=1`):\r\n\r\n   ```\r\n   python setup.py clean\r\n   CYTHON_COVERAGE=1 python setup.py build_ext --inplace\r\n   pytest\r\n   ```\r\n\r\n   This should result in a coverage report with several lines that are not being covered. You can manually put print statements on these lines and run pytest with `-s` to confirm that they are indeed being run. \r\n\r\nYou can also observe this on the builds on CI, e.g., [here](https://github.com/Quansight-Labs/ndindex/actions/runs/10908689579/job/30275243626?pr=183).\r\n\r\nThis does not seem to depend on the Python version (although I would avoid testing this with Python 3.12 as it has a serious performance regression when running coverage that will just make the tests take twice as long to run). \n\n### Expected behaviour\n\n_No response_\n\n### OS\n\nReproduced on Linux (GitHub Actions) and macOS\n\n### Python version\n\n_No response_\n\n### Cython version\n\n3.1.0a0\n\n### Additional context\n\n_No response_",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Is this a regression against Cython 3.0 or a regression against just running it in Python?",
            "created_at": "2024-09-17T21:25:15Z",
            "html_url": "https://github.com/cython/cython/issues/6399#issuecomment-2356963600",
            "id": 2356963600,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6399",
            "node_id": "IC_kwDOABDGAc6MfGkQ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2356963600/reactions"
            },
            "updated_at": "2024-09-17T21:25:15Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2356963600",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "This is a regression against Cython 3.0.10. ",
            "created_at": "2024-09-17T22:10:46Z",
            "html_url": "https://github.com/cython/cython/issues/6399#issuecomment-2357023768",
            "id": 2357023768,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6399",
            "node_id": "IC_kwDOABDGAc6MfVQY",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2357023768/reactions"
            },
            "updated_at": "2024-09-17T22:10:46Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2357023768",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/71486?v=4",
                "events_url": "https://api.github.com/users/asmeurer/events{/privacy}",
                "followers_url": "https://api.github.com/users/asmeurer/followers",
                "following_url": "https://api.github.com/users/asmeurer/following{/other_user}",
                "gists_url": "https://api.github.com/users/asmeurer/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/asmeurer",
                "id": 71486,
                "login": "asmeurer",
                "node_id": "MDQ6VXNlcjcxNDg2",
                "organizations_url": "https://api.github.com/users/asmeurer/orgs",
                "received_events_url": "https://api.github.com/users/asmeurer/received_events",
                "repos_url": "https://api.github.com/users/asmeurer/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/asmeurer/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/asmeurer/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/asmeurer",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Thanks for the report, that's certainly a bug in the new monitoring implementation: https://github.com/cython/cython/pull/6144\r\n\r\nAs a first guess, this sounds like it's not exiting from a function scope correctly, so that coverage thinks it's still in code that it doesn't need to analyse.",
            "created_at": "2024-09-18T08:50:28Z",
            "html_url": "https://github.com/cython/cython/issues/6399#issuecomment-2357875864",
            "id": 2357875864,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6399",
            "node_id": "IC_kwDOABDGAc6MilSY",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2357875864/reactions"
            },
            "updated_at": "2024-09-18T08:50:28Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2357875864",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "NONE",
            "body": "Isn't sys.monitoring Python 3.12 only? That's the only version I haven't tested this on (because coverage's sys.monitoring support does not yet support extensions).  ",
            "created_at": "2024-09-18T08:59:39Z",
            "html_url": "https://github.com/cython/cython/issues/6399#issuecomment-2357895509",
            "id": 2357895509,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6399",
            "node_id": "IC_kwDOABDGAc6MiqFV",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2357895509/reactions"
            },
            "updated_at": "2024-09-18T08:59:39Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2357895509",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/71486?v=4",
                "events_url": "https://api.github.com/users/asmeurer/events{/privacy}",
                "followers_url": "https://api.github.com/users/asmeurer/followers",
                "following_url": "https://api.github.com/users/asmeurer/following{/other_user}",
                "gists_url": "https://api.github.com/users/asmeurer/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/asmeurer",
                "id": 71486,
                "login": "asmeurer",
                "node_id": "MDQ6VXNlcjcxNDg2",
                "organizations_url": "https://api.github.com/users/asmeurer/orgs",
                "received_events_url": "https://api.github.com/users/asmeurer/received_events",
                "repos_url": "https://api.github.com/users/asmeurer/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/asmeurer/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/asmeurer/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/asmeurer",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6399/comments",
    "created_at": "2024-09-17T20:16:19Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-10-19T20:27:56Z",
            "event": "milestoned",
            "id": 14739344449,
            "milestone": {
                "title": "3.1"
            },
            "node_id": "MIE_lADOABDGAc6W7DHVzwAAAANuiIxB",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/14739344449"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-10-19T20:28:05Z",
            "event": "labeled",
            "id": 14739344701,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "node_id": "LE_lADOABDGAc6W7DHVzwAAAANuiI09",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/14739344701"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2024-10-19T20:28:05Z",
            "event": "labeled",
            "id": 14739344702,
            "label": {
                "color": "000000",
                "name": "Coverage"
            },
            "node_id": "LE_lADOABDGAc6W7DHVzwAAAANuiI0-",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/14739344702"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6399/events",
    "html_url": "https://github.com/cython/cython/issues/6399",
    "id": 2532061653,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425553654,
            "name": "defect",
            "node_id": "MDU6TGFiZWw0MjU1NTM2NTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        },
        {
            "color": "000000",
            "default": false,
            "description": "",
            "id": 3512231455,
            "name": "Coverage",
            "node_id": "LA_kwDOABDGAc7RWGYf",
            "url": "https://api.github.com/repos/cython/cython/labels/Coverage"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6399/labels{/name}",
    "locked": false,
    "milestone": {
        "closed_at": null,
        "closed_issues": 249,
        "created_at": "2019-02-24T14:21:23Z",
        "creator": {
            "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
            "events_url": "https://api.github.com/users/scoder/events{/privacy}",
            "followers_url": "https://api.github.com/users/scoder/followers",
            "following_url": "https://api.github.com/users/scoder/following{/other_user}",
            "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
            "gravatar_id": "",
            "html_url": "https://github.com/scoder",
            "id": 491659,
            "login": "scoder",
            "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
            "organizations_url": "https://api.github.com/users/scoder/orgs",
            "received_events_url": "https://api.github.com/users/scoder/received_events",
            "repos_url": "https://api.github.com/users/scoder/repos",
            "site_admin": false,
            "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
            "type": "User",
            "url": "https://api.github.com/users/scoder",
            "user_view_type": "public"
        },
        "description": "* Remove code for Python 2 and Python < 3.7.\r\n* Integrate better with Python 3.\r\n* Improve support for the Limited API.\r\n* Start supporting GIL-free Python 3.13.\r\n* Support the Py3.13 `sys.monitoring` API.\r\n* Support and use `am_send` for coroutines.",
        "due_on": null,
        "html_url": "https://github.com/cython/cython/milestone/65",
        "id": 4082235,
        "labels_url": "https://api.github.com/repos/cython/cython/milestones/65/labels",
        "node_id": "MDk6TWlsZXN0b25lNDA4MjIzNQ==",
        "number": 65,
        "open_issues": 18,
        "state": "open",
        "title": "3.1",
        "updated_at": "2024-10-19T20:27:56Z",
        "url": "https://api.github.com/repos/cython/cython/milestones/65"
    },
    "node_id": "I_kwDOABDGAc6W7DHV",
    "number": 6399,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6399/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6399/timeline",
    "title": "[BUG] 3.1.0a0 breaks coverage for pure Python code",
    "updated_at": "2024-10-19T20:28:05Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6399",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/71486?v=4",
        "events_url": "https://api.github.com/users/asmeurer/events{/privacy}",
        "followers_url": "https://api.github.com/users/asmeurer/followers",
        "following_url": "https://api.github.com/users/asmeurer/following{/other_user}",
        "gists_url": "https://api.github.com/users/asmeurer/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/asmeurer",
        "id": 71486,
        "login": "asmeurer",
        "node_id": "MDQ6VXNlcjcxNDg2",
        "organizations_url": "https://api.github.com/users/asmeurer/orgs",
        "received_events_url": "https://api.github.com/users/asmeurer/received_events",
        "repos_url": "https://api.github.com/users/asmeurer/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/asmeurer/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/asmeurer/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/asmeurer",
        "user_view_type": "public"
    }
}