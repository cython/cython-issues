{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "Have really enjoyed using the pure Python mode annotation support that Cython provides. It has been really great being able to optimize code while still being to engage with other devs in Python.\r\n\r\nWhile most things are already supported in some form or another, there have been a couple things that are missing. One is being able to annotate module variables.\r\n\r\n**Is your feature request related to a problem? Please describe.**\r\n\r\nIn particular I'd like to type `x` and have that type used later in the code. AFAICT Cython currently treats `x` as an `object` instead of a `double`. This also means later code needs to coerce both variables into Python or C types before computing the result.\r\n\r\n```cython\r\nx: double = 5.0\r\n\r\ndef add_y(y: double) -> double:\r\n    return x + y\r\n```\r\n\r\n**Describe the solution you'd like**\r\n\r\nIdeally annotation like that shown above would result in a variable (like `x`) being typed as a C `double`.\r\n\r\n**Describe alternatives you've considered**\r\n\r\nCython has other pure Python acceptable code like `cython.declare`. AFAICT writing code using `declare` does seem to work correctly at the global level.\r\n\r\n```cython\r\nfrom cython import declare\r\n\r\ndeclare(x=double)\r\n\r\nx = 5.0\r\n\r\ndef add_y(y: double) -> double:\r\n    return x + y\r\n```\r\n\r\n**Additional context**\r\n\r\nNA",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "COLLABORATOR",
            "body": "I think the reason for not doing so is that it changes `x` from a public attribute of the module to something that's only visible from Cython within the module. For most users that would be quite a dramatic change to happen just because they have an annotation.\r\n\r\nWith that said, there should possibly be an option to turn it on for people who want to use module annotations.\r\n\r\nIt might also be possible to make the attribute typed and public with pep562 so that the external interface wouldn't need to change (for people who are using newer Python versions)",
            "created_at": "2020-12-14T06:55:16Z",
            "html_url": "https://github.com/cython/cython/issues/3944#issuecomment-744217021",
            "id": 744217021,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3944",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc0NDIxNzAyMQ==",
            "performed_via_github_app": null,
            "updated_at": "2020-12-14T06:55:16Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/744217021",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Yeah that makes sense.\n\nI guess with `class` attributes one can manually add `@property` methods or use `declare` (though the latter is an option here).\n\nWhat if there was a way to include visibility in the annotation like...\n\n```cython\nfrom cython import public\n\nx: public[double]\n```\n\n...or similar?",
            "created_at": "2020-12-14T07:34:38Z",
            "html_url": "https://github.com/cython/cython/issues/3944#issuecomment-744237871",
            "id": 744237871,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3944",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc0NDIzNzg3MQ==",
            "performed_via_github_app": null,
            "updated_at": "2020-12-14T07:34:38Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/744237871",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3019665?v=4",
                "events_url": "https://api.github.com/users/jakirkham/events{/privacy}",
                "followers_url": "https://api.github.com/users/jakirkham/followers",
                "following_url": "https://api.github.com/users/jakirkham/following{/other_user}",
                "gists_url": "https://api.github.com/users/jakirkham/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jakirkham",
                "id": 3019665,
                "login": "jakirkham",
                "node_id": "MDQ6VXNlcjMwMTk2NjU=",
                "organizations_url": "https://api.github.com/users/jakirkham/orgs",
                "received_events_url": "https://api.github.com/users/jakirkham/received_events",
                "repos_url": "https://api.github.com/users/jakirkham/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jakirkham/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jakirkham/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jakirkham"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "Well at the moment I don't think we can support public module attributes with any type other than `object` - I was just noting that it _might_ be possible in future.\r\n\r\nI'd be inclined not to load too much into the annotation - Cython-specific annotations are less useful to anyone else (so might as well just be `declare` or similar)",
            "created_at": "2020-12-14T07:43:27Z",
            "html_url": "https://github.com/cython/cython/issues/3944#issuecomment-744243213",
            "id": 744243213,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3944",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc0NDI0MzIxMw==",
            "performed_via_github_app": null,
            "updated_at": "2020-12-14T07:43:27Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/744243213",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Have another question regarding this. Should it be possible to `from ... import x` assuming we've declared it with `visibility=\"public\"`? Or is there more needed? For example should this work?\r\n\r\n```python\r\n# mymod.py\r\n\r\nfrom cython import declare, double\r\n\r\nx = declare(double, 5.0, visibility=\"public\")\r\n```\r\n\r\n```python\r\nIn [1]: from mymod import x\r\n```\r\n\r\nRight now this is causing an `ImportError`, but am guessing I'm doing something wrong.",
            "created_at": "2021-01-26T06:42:11Z",
            "html_url": "https://github.com/cython/cython/issues/3944#issuecomment-767338699",
            "id": 767338699,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3944",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc2NzMzODY5OQ==",
            "performed_via_github_app": null,
            "updated_at": "2021-01-26T06:42:11Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/767338699",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3019665?v=4",
                "events_url": "https://api.github.com/users/jakirkham/events{/privacy}",
                "followers_url": "https://api.github.com/users/jakirkham/followers",
                "following_url": "https://api.github.com/users/jakirkham/following{/other_user}",
                "gists_url": "https://api.github.com/users/jakirkham/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jakirkham",
                "id": 3019665,
                "login": "jakirkham",
                "node_id": "MDQ6VXNlcjMwMTk2NjU=",
                "organizations_url": "https://api.github.com/users/jakirkham/orgs",
                "received_events_url": "https://api.github.com/users/jakirkham/received_events",
                "repos_url": "https://api.github.com/users/jakirkham/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jakirkham/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jakirkham/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jakirkham"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "In the event that \"public\" is implemented for module variables then it should be possible to `from mod import var` them.\r\n\r\nHowever there's currently no way to expose a C module variable to Python (and it isn't hugely easy to implement either) so it doesn't work right now",
            "created_at": "2021-01-26T07:36:09Z",
            "html_url": "https://github.com/cython/cython/issues/3944#issuecomment-767361024",
            "id": 767361024,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3944",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc2NzM2MTAyNA==",
            "performed_via_github_app": null,
            "updated_at": "2021-01-26T07:36:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/767361024",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "CONTRIBUTOR",
            "body": "Yeah that makes sense. Is this still the case if they are actually `PyObject*` like so?\r\n\r\n```python\r\n# mymod.py\r\n\r\nfrom cython import declare\r\n\r\nd = declare(dict, {\"a\": 1}, visibility=\"public\")\r\n```\r\n\r\nFor now have done something sort of hacky like this...\r\n\r\n```diff\r\ndiff --git a/mymod.py b/mymod.py\r\nindex 307fcd7..60bb9c3 100644\r\n--- a/mymod.py\r\n+++ b/mymod.py\r\n@@ -1,3 +1,5 @@\r\n from cython import declare\r\n+import sys\r\n \r\n d = declare(dict, {\"a\": 1}, visibility=\"public\")\r\n+sys.modules[__name__].d = d\r\n```\r\n\r\nThis seems to work, but just want to make sure I'm not overlooking a better option.",
            "created_at": "2021-01-26T07:42:36Z",
            "html_url": "https://github.com/cython/cython/issues/3944#issuecomment-767363750",
            "id": 767363750,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3944",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc2NzM2Mzc1MA==",
            "performed_via_github_app": null,
            "updated_at": "2021-01-26T07:42:36Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/767363750",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3019665?v=4",
                "events_url": "https://api.github.com/users/jakirkham/events{/privacy}",
                "followers_url": "https://api.github.com/users/jakirkham/followers",
                "following_url": "https://api.github.com/users/jakirkham/following{/other_user}",
                "gists_url": "https://api.github.com/users/jakirkham/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jakirkham",
                "id": 3019665,
                "login": "jakirkham",
                "node_id": "MDQ6VXNlcjMwMTk2NjU=",
                "organizations_url": "https://api.github.com/users/jakirkham/orgs",
                "received_events_url": "https://api.github.com/users/jakirkham/received_events",
                "repos_url": "https://api.github.com/users/jakirkham/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jakirkham/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jakirkham/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jakirkham"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "Yes it's still the case for PyObject. The issue would be that if it was exposed as a public attribute then anyone could assign whatever they like to it (we have no way of controlling this). Therefore the `dict` type would be meaningless. Thus a variable can either be untyped and added to the module dict or typed and private to the module.\r\n\r\nI suspect you could use `globals` rather than `sys.modules` in your workaround. But it's very fragile. If another module reassigns the variable then the private and public version are out of sync",
            "created_at": "2021-01-26T08:26:42Z",
            "html_url": "https://github.com/cython/cython/issues/3944#issuecomment-767383778",
            "id": 767383778,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3944",
            "node_id": "MDEyOklzc3VlQ29tbWVudDc2NzM4Mzc3OA==",
            "performed_via_github_app": null,
            "updated_at": "2021-01-26T08:30:39Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/767383778",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 7,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/3944/comments",
    "created_at": "2020-12-13T23:18:36Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/5534781?v=4",
                "events_url": "https://api.github.com/users/leofang/events{/privacy}",
                "followers_url": "https://api.github.com/users/leofang/followers",
                "following_url": "https://api.github.com/users/leofang/following{/other_user}",
                "gists_url": "https://api.github.com/users/leofang/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/leofang",
                "id": 5534781,
                "login": "leofang",
                "node_id": "MDQ6VXNlcjU1MzQ3ODE=",
                "organizations_url": "https://api.github.com/users/leofang/orgs",
                "received_events_url": "https://api.github.com/users/leofang/received_events",
                "repos_url": "https://api.github.com/users/leofang/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/leofang/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/leofang/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/leofang"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2020-12-14T13:13:29Z",
            "event": "subscribed",
            "id": 4109147908,
            "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDQxMDkxNDc5MDg=",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/4109147908"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/3944/events",
    "html_url": "https://github.com/cython/cython/issues/3944",
    "id": 765696944,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/3944/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU3NjU2OTY5NDQ=",
    "number": 3944,
    "performed_via_github_app": null,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "[ENH] Annotation of module variables",
    "updated_at": "2021-01-26T08:30:39Z",
    "url": "https://api.github.com/repos/cython/cython/issues/3944",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/3019665?v=4",
        "events_url": "https://api.github.com/users/jakirkham/events{/privacy}",
        "followers_url": "https://api.github.com/users/jakirkham/followers",
        "following_url": "https://api.github.com/users/jakirkham/following{/other_user}",
        "gists_url": "https://api.github.com/users/jakirkham/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/jakirkham",
        "id": 3019665,
        "login": "jakirkham",
        "node_id": "MDQ6VXNlcjMwMTk2NjU=",
        "organizations_url": "https://api.github.com/users/jakirkham/orgs",
        "received_events_url": "https://api.github.com/users/jakirkham/received_events",
        "repos_url": "https://api.github.com/users/jakirkham/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/jakirkham/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/jakirkham/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/jakirkham"
    }
}