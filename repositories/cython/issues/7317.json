{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "### Describe your issue\n\nI'm working on [preshed](https://github.com/explosion/preshed) to add free-threaded support.\n\nI tried to adapt the [`items` method](https://github.com/explosion/preshed/blob/465ad7de986927b24ca4e463643f12ea4ae83e63/preshed/maps.pyx#L40-L45) like so:\n\n```\n    def items(self):\n        cdef key_t key\n        cdef void* value\n        cdef int i = 0\n        while True:\n            with cython.critical_section(self):\n                if map_iter(self.c_map, &i, &key, &value):\n                    yield key, <size_t>value\n                else:\n                    break\n```\n\nBut this leads to crashes:\n\n```\npreshed/tests/test_multithreaded.py::test_multithreaded_map_sharing Fatal Python error: PyMutex_Unlock: unlocking mutex that is not locked\nPython runtime state: initialized\n\nStack (most recent call first):\n  File \"/Users/goldbaum/Documents/preshed/preshed/tests/test_multithreaded.py\", line 76 in worker\n  File \"/Users/goldbaum/.pyenv/versions/3.14t-dev-asan-debug/lib/python3.14t/concurrent/futures/thread.py\", line 73 in run\n  File \"/Users/goldbaum/.pyenv/versions/3.14t-dev-asan-debug/lib/python3.14t/concurrent/futures/thread.py\", line 86 in run\n  File \"/Users/goldbaum/.pyenv/versions/3.14t-dev-asan-debug/lib/python3.14t/concurrent/futures/thread.py\", line 119 in _worker\n  File \"/Users/goldbaum/.pyenv/versions/3.14t-dev-asan-debug/lib/python3.14t/threading.py\", line 1024 in run\n  File \"/Users/goldbaum/.pyenv/versions/3.14t-dev-asan-debug/lib/python3.14t/threading.py\", line 1082 in _bootstrap_inner\n  File \"/Users/goldbaum/.pyenv/versions/3.14t-dev-asan-debug/lib/python3.14t/threading.py\", line 1044 in _bootstrap\n\nExtension modules: cymem.cymem, murmurhash.mrmr, preshed.bloom, preshed.maps, preshed.counter (total: 5)\n[1]    63798 abort      PYTHON_GIL=0 pytest -svx\n```\n\nIf I rewrite the method like this:\n\n```\ndef items(self):\n        cdef key_t key\n        cdef void* value\n        cdef int i = 0\n        while True:\n            with cython.critical_section(self):\n                it = map_iter(self.c_map, &i, &key, &value)\n            if it:\n                yield key, <size_t>value\n            else:\n                break\n```\n\nThen I avoid the crash.\n\nI'll try to make a runnable test tomorrow but I'm running out of steam on this today.\n\nSee https://github.com/ngoldbaum/preshed/pull/4 for code context for this.",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Thanks for the report. The reason for the crash is that we do not store away the CS state when returning from the generator, thus entering it with a fresh CS state on resume.\n\nI find it generally questionable to allow yielding from a critical section. It seems very likely that the CS will be broken outside of the coroutine, which renders the semantics rather unclear.\n\nI think we should disallow `yield` inside of a critical section and force users to use your rewritten replacement instead.",
            "created_at": "2025-11-12T07:32:17Z",
            "html_url": "https://github.com/cython/cython/issues/7317#issuecomment-3520444587",
            "id": 3520444587,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7317",
            "node_id": "IC_kwDOABDGAc7R1bir",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3520444587/reactions"
            },
            "updated_at": "2025-11-12T07:32:17Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3520444587",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "yield inside a `pymutex` is definitely banned because that's so easy to end up in a deadlock mess.\n\nI'd originally not banned `yield` inside a critical section on the basis that it wouldn't deadlock (even if it did get broken). Although I clearly didn't add tests to check that it worked.\n\nI don't think there's a way to write it safely that doesn't involve Cython deliberately releasing and re-acquiring it. So we can't even give the benefit of \"optimistically it might not be broken\".\n\nThat suggests it should probably be disallowed.",
            "created_at": "2025-11-12T07:38:16Z",
            "html_url": "https://github.com/cython/cython/issues/7317#issuecomment-3520467802",
            "id": 3520467802,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7317",
            "node_id": "IC_kwDOABDGAc7R1hNa",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3520467802/reactions"
            },
            "updated_at": "2025-11-12T07:38:16Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3520467802",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> we can't even give the benefit of \"optimistically it might not be broken\".\n\nAt the very least, it easily raises false expectations to allow it, which makes the code that users write look safer than it effectively is. That's a high risk in the freethreading world and we should make it difficult for users to write unclear and risky concurrent code.",
            "created_at": "2025-11-12T07:58:04Z",
            "html_url": "https://github.com/cython/cython/issues/7317#issuecomment-3520530274",
            "id": 3520530274,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/7317",
            "node_id": "IC_kwDOABDGAc7R1wdi",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/3520530274/reactions"
            },
            "updated_at": "2025-11-12T07:58:04Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/3520530274",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/7317/comments",
    "created_at": "2025-11-11T23:32:30Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-11-12T07:25:04Z",
            "event": "labeled",
            "id": 20881246259,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "node_id": "LE_lADOABDGAc7XbVQtzwAAAATcnogz",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/20881246259"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder",
                "user_view_type": "public"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2025-11-12T07:25:04Z",
            "event": "labeled",
            "id": 20881246263,
            "label": {
                "color": "444444",
                "name": "Cython Language Feature"
            },
            "node_id": "LE_lADOABDGAc7XbVQtzwAAAATcnog3",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/20881246263"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/7317/events",
    "html_url": "https://github.com/cython/cython/issues/7317",
    "id": 3614266413,
    "issue_dependencies_summary": {
        "blocked_by": 0,
        "blocking": 0,
        "total_blocked_by": 0,
        "total_blocking": 0
    },
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425553654,
            "name": "defect",
            "node_id": "MDU6TGFiZWw0MjU1NTM2NTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        },
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425559948,
            "name": "Cython Language Feature",
            "node_id": "MDU6TGFiZWw0MjU1NTk5NDg=",
            "url": "https://api.github.com/repos/cython/cython/labels/Cython%20Language%20Feature"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/7317/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc7XbVQt",
    "number": 7317,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/7317/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "sub_issues_summary": {
        "completed": 0,
        "percent_completed": 0,
        "total": 0
    },
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/7317/timeline",
    "title": "[BUG] yielding while holding a critical section crashes 3.14t",
    "type": null,
    "updated_at": "2025-11-12T07:58:04Z",
    "url": "https://api.github.com/repos/cython/cython/issues/7317",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/3126246?v=4",
        "events_url": "https://api.github.com/users/ngoldbaum/events{/privacy}",
        "followers_url": "https://api.github.com/users/ngoldbaum/followers",
        "following_url": "https://api.github.com/users/ngoldbaum/following{/other_user}",
        "gists_url": "https://api.github.com/users/ngoldbaum/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ngoldbaum",
        "id": 3126246,
        "login": "ngoldbaum",
        "node_id": "MDQ6VXNlcjMxMjYyNDY=",
        "organizations_url": "https://api.github.com/users/ngoldbaum/orgs",
        "received_events_url": "https://api.github.com/users/ngoldbaum/received_events",
        "repos_url": "https://api.github.com/users/ngoldbaum/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ngoldbaum/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ngoldbaum/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ngoldbaum",
        "user_view_type": "public"
    }
}