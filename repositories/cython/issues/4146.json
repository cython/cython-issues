{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "COLLABORATOR",
    "body": "<!--\r\n**PLEASE READ THIS FIRST:**\r\n- Do not use the bug and feature tracker for support requests. Use the `cython-users` mailing list instead.\r\n- Did you search for similar issues already? Please do, it helps to save us precious time that we otherwise could not invest into development.\r\n- Did you try the latest master branch or pre-release? It might already have what you want to report. Also see the [Changelog](https://github.com/cython/cython/blob/master/CHANGES.rst) regarding recent changes.\r\n-->\r\n\r\n**Describe the bug**\r\n\r\nFor an operator of the form\r\n\r\n```\r\na + something_that_changes_a()\r\n```\r\n\r\nthe changed form of `a` is used on both sides (because Cython just uses the name and doesn't assign it to a temp first). This contradicts what Python does.\r\n\r\n**To Reproduce**\r\nCode to reproduce the behaviour:\r\n```cython\r\ndef o1(x):\r\n    def inner():\r\n        nonlocal x\r\n        x *= 2\r\n        return x\r\n    return x+inner()\r\n\r\n# or equivalently (but doesn't work in current Cython!)\r\n#def o2(x):\r\n#  return x+(x:=x*2)\r\n\r\nprint(o1(5))\r\n```\r\n\r\n**Expected behavior**\r\nPython returns 15 while Cython returns 20.\r\n\r\n**Environment (please complete the following information):**\r\n - OS: Linux\r\n - Python version 3.8.9\r\n - Cython version current master (https://github.com/cython/cython/commit/bc3dd1a2ece6e72d80e2796af3737a1cb65b6142)\r\n\r\n**Additional context**\r\n\r\nI found this while looking at corner-cases for assignment expressions (which provide a much easier way to demonstrate this bug). To fix it would require using a lot more temporaries pretty much everywhere. I'm considering it well beyond the scope of #3691 (although it'll be a lot easier to generate this type of bug with assignment expressions)",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Oh well. Yeah, that would be quite an annoying change that could hinder performance in some cases. For all Python objects, keeping a temporary means ref-counting it up and down, just to throw it away in many (if not most) cases.\r\n\r\n(For low-level types, it's less of a problem. The C compiler would just alias the temps in most cases.)",
            "created_at": "2021-05-07T19:58:06Z",
            "html_url": "https://github.com/cython/cython/issues/4146#issuecomment-834736980",
            "id": 834736980,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4146",
            "node_id": "MDEyOklzc3VlQ29tbWVudDgzNDczNjk4MA==",
            "performed_via_github_app": null,
            "updated_at": "2021-05-07T20:00:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/834736980",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "I think for the assignment expression case it should be possible to identify and avoid it. I think an extra transform could track which names are reassigned (since assignment expressions can only be used on names), and coerce those specific arguments to temps. That'd keep the current performance generally and not be too difficult to do. For the sake of simplicity I'll leave it out of the initial version of assignment expressions though.\r\n\r\nIt might be possible to include a best-effort fix for the \"nonlocal\" case in this too (by treating closured variables as \"liable to change\" and coercing them to temp). I suspect it would be difficult to make perfect though",
            "created_at": "2021-05-08T09:05:57Z",
            "html_url": "https://github.com/cython/cython/issues/4146#issuecomment-835229009",
            "id": 835229009,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4146",
            "node_id": "MDEyOklzc3VlQ29tbWVudDgzNTIyOTAwOQ==",
            "performed_via_github_app": null,
            "updated_at": "2021-05-08T09:09:58Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/835229009",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "Isn't that mixed with a difference in scoping? The assignment-expression does not (IIUC) correctly the outer `x`. Renaming the assignment expression to `y` shows that this still returns 15:\r\n```\r\n>python\r\nPython 3.8.8 | packaged by conda-forge | (default, Feb 20 2021, 15:50:08) [MSC v.1916 64 bit (AMD64)] on win32\r\nType \"help\", \"copyright\", \"credits\" or \"license\" for more information.\r\n>>> def func(x):\r\n...     return x+(y:=x*2)\r\n...\r\n>>> func(5)\r\n15\r\n```",
            "created_at": "2021-05-08T18:13:19Z",
            "html_url": "https://github.com/cython/cython/issues/4146#issuecomment-835455648",
            "id": 835455648,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4146",
            "node_id": "MDEyOklzc3VlQ29tbWVudDgzNTQ1NTY0OA==",
            "performed_via_github_app": null,
            "updated_at": "2021-05-08T18:13:19Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/835455648",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/33685575?v=4",
                "events_url": "https://api.github.com/users/h-vetinari/events{/privacy}",
                "followers_url": "https://api.github.com/users/h-vetinari/followers",
                "following_url": "https://api.github.com/users/h-vetinari/following{/other_user}",
                "gists_url": "https://api.github.com/users/h-vetinari/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/h-vetinari",
                "id": 33685575,
                "login": "h-vetinari",
                "node_id": "MDQ6VXNlcjMzNjg1NTc1",
                "organizations_url": "https://api.github.com/users/h-vetinari/orgs",
                "received_events_url": "https://api.github.com/users/h-vetinari/received_events",
                "repos_url": "https://api.github.com/users/h-vetinari/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/h-vetinari/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/h-vetinari/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/h-vetinari"
            }
        },
        {
            "author_association": "COLLABORATOR",
            "body": "@h-vetinari 15 is correct in both cases. The problem is that the code should be equivalent to:\r\n\r\n```\r\ntmp1 = x\r\ntmp2 = x = x*2\r\nreturn tmp1+tmp2\r\n```\r\n\r\nBut Cython generates\r\n```\r\ntmp2 = x = x*2\r\nreturn x+tmp2\r\n```\r\n\r\n(The assignment expression code isn't _yet_ a bug because it's currently in an unmerged PR, but my claim is you can reproduce it with a different approach)",
            "created_at": "2021-05-08T18:22:45Z",
            "html_url": "https://github.com/cython/cython/issues/4146#issuecomment-835459142",
            "id": 835459142,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4146",
            "node_id": "MDEyOklzc3VlQ29tbWVudDgzNTQ1OTE0Mg==",
            "performed_via_github_app": null,
            "updated_at": "2021-05-08T18:31:26Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/835459142",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "We can probably mitigate it somewhat by only assigning all(!) operands to temps iff one of the operands is not \"simple\", such as a function call or a Python attribute lookup. I think that would usually be acceptable.",
            "created_at": "2021-06-09T09:21:09Z",
            "html_url": "https://github.com/cython/cython/issues/4146#issuecomment-857534681",
            "id": 857534681,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4146",
            "node_id": "MDEyOklzc3VlQ29tbWVudDg1NzUzNDY4MQ==",
            "performed_via_github_app": null,
            "updated_at": "2021-06-09T09:21:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/857534681",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 5,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4146/comments",
    "created_at": "2021-05-07T19:26:47Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-05-07T19:27:21Z",
            "event": "labeled",
            "id": 4704195224,
            "label": {
                "color": "444444",
                "name": "Python Semantics"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDQ3MDQxOTUyMjQ=",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/4704195224"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-05-07T19:57:40Z",
            "event": "labeled",
            "id": 4704350902,
            "label": {
                "color": "444444",
                "name": "defect"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDQ3MDQzNTA5MDI=",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/4704350902"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/33685575?v=4",
                "events_url": "https://api.github.com/users/h-vetinari/events{/privacy}",
                "followers_url": "https://api.github.com/users/h-vetinari/followers",
                "following_url": "https://api.github.com/users/h-vetinari/following{/other_user}",
                "gists_url": "https://api.github.com/users/h-vetinari/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/h-vetinari",
                "id": 33685575,
                "login": "h-vetinari",
                "node_id": "MDQ6VXNlcjMzNjg1NTc1",
                "organizations_url": "https://api.github.com/users/h-vetinari/orgs",
                "received_events_url": "https://api.github.com/users/h-vetinari/received_events",
                "repos_url": "https://api.github.com/users/h-vetinari/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/h-vetinari/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/h-vetinari/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/h-vetinari"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-05-08T18:22:45Z",
            "event": "mentioned",
            "id": 4708472597,
            "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50NDcwODQ3MjU5Nw==",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/4708472597"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/33685575?v=4",
                "events_url": "https://api.github.com/users/h-vetinari/events{/privacy}",
                "followers_url": "https://api.github.com/users/h-vetinari/followers",
                "following_url": "https://api.github.com/users/h-vetinari/following{/other_user}",
                "gists_url": "https://api.github.com/users/h-vetinari/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/h-vetinari",
                "id": 33685575,
                "login": "h-vetinari",
                "node_id": "MDQ6VXNlcjMzNjg1NTc1",
                "organizations_url": "https://api.github.com/users/h-vetinari/orgs",
                "received_events_url": "https://api.github.com/users/h-vetinari/received_events",
                "repos_url": "https://api.github.com/users/h-vetinari/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/h-vetinari/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/h-vetinari/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/h-vetinari"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-05-08T18:22:45Z",
            "event": "subscribed",
            "id": 4708472600,
            "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDQ3MDg0NzI2MDA=",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/4708472600"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4146/events",
    "html_url": "https://github.com/cython/cython/issues/4146",
    "id": 879595843,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425556315,
            "name": "Python Semantics",
            "node_id": "MDU6TGFiZWw0MjU1NTYzMTU=",
            "url": "https://api.github.com/repos/cython/cython/labels/Python%20Semantics"
        },
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425553654,
            "name": "defect",
            "node_id": "MDU6TGFiZWw0MjU1NTM2NTQ=",
            "url": "https://api.github.com/repos/cython/cython/labels/defect"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4146/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU4Nzk1OTU4NDM=",
    "number": 4146,
    "performed_via_github_app": null,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "[BUG] operator evaluation order",
    "updated_at": "2021-06-09T09:21:09Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4146",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
        "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
        "followers_url": "https://api.github.com/users/da-woods/followers",
        "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
        "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/da-woods",
        "id": 10536947,
        "login": "da-woods",
        "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
        "organizations_url": "https://api.github.com/users/da-woods/orgs",
        "received_events_url": "https://api.github.com/users/da-woods/received_events",
        "repos_url": "https://api.github.com/users/da-woods/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/da-woods"
    }
}