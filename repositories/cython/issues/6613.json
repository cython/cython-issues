{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "MEMBER",
    "body": "### Describe your issue\n\n1. Do we need to add `CYTHON_USE_MODULE_STATE` to the `CYTHON_ABI` suffix? I think it might be OK without but there's the potential to go wrong.\r\n2. Is there a lifetime issue? In principle modules can now be unloaded (although in practice I don't think our reference counting is accurate enough for this to happen...). If we store CyFunction in our shared ABI based on loading it from module `a`, and then unload module `a` does this cause a problem? I think it might.\r\n3. `__Pyx_Coroutine_get_frame` will always get the globals from whichever module added it to the shared ABI.\r\n\r\nI think this is all mostly a theoretical problem, but it's all a bit dubious.",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "For point 2 - I think we need to disable *internal* type-checks with CYTHON_USE_MODULE_STATE. i.e. it's fine for other utility code to check if something is a CyFunction, but it's not fine for CyFunctions to check if something is a CyFunction (although for CyFunction specifically there might be a way of doing it).\r\n\r\nI think that mainly affects Coroutines and related types. I think these checks are only an optimization though so they're OK to drop.",
            "created_at": "2025-01-12T09:46:52Z",
            "html_url": "https://github.com/cython/cython/issues/6613#issuecomment-2585663801",
            "id": 2585663801,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6613",
            "node_id": "IC_kwDOABDGAc6aHhk5",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2585663801/reactions"
            },
            "updated_at": "2025-01-12T09:46:52Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2585663801",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I'm also not convinced `__Pyx_Coroutine_Check` and `__Pyx_Coroutine_CheckExact` are used correctly in all cases even without module state. They're _mostly_  just used for optimization (where it doesn't really matter if it misses) but there's a few cases where it affects behaviour. Can't see an obvious way around that though.",
            "created_at": "2025-01-12T12:43:18Z",
            "html_url": "https://github.com/cython/cython/issues/6613#issuecomment-2585719557",
            "id": 2585719557,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/6613",
            "node_id": "IC_kwDOABDGAc6aHvMF",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2585719557/reactions"
            },
            "updated_at": "2025-01-12T12:43:18Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2585719557",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/6613/comments",
    "created_at": "2025-01-12T09:19:13Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/6613/events",
    "html_url": "https://github.com/cython/cython/issues/6613",
    "id": 2782367492,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/6613/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc6l148E",
    "number": 6613,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/6613/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/6613/timeline",
    "title": "[BUG?] Investigate shared ABI and module state",
    "updated_at": "2025-01-12T12:43:18Z",
    "url": "https://api.github.com/repos/cython/cython/issues/6613",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
        "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
        "followers_url": "https://api.github.com/users/da-woods/followers",
        "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
        "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/da-woods",
        "id": 10536947,
        "login": "da-woods",
        "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
        "organizations_url": "https://api.github.com/users/da-woods/orgs",
        "received_events_url": "https://api.github.com/users/da-woods/received_events",
        "repos_url": "https://api.github.com/users/da-woods/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/da-woods",
        "user_view_type": "public"
    }
}