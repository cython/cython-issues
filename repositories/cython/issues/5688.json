{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\n\nI'm currently debugging performance regressions when transitioning to Cython 3.x. Many of them seem to be tied to GIL acquires in memoryview use. Some of the issues were identified and I think fixed in #5670 and #5678 by @matusvalo. However, it seems that `__pyx_memoryview_slice_memviewslice` is creating a ref nanny and always acquiring the GIL if I'm reading things correctly.\r\n\r\nPossibly related: https://github.com/cython/cython/pull/5685\r\n\r\nNote: This is not the same issue as discussed in #5686, just that I found it while deciphering that one.\n\n### Code to reproduce the behaviour:\n\n```cython\r\n# cython: language_level=3, boundscheck=False, cdivision=True, wraparound=False, initializedcheck=False, nonecheck=False\r\ncimport cython\r\nimport numpy as np\r\ncimport numpy as np\r\n\r\nnp.import_array()\r\n\r\ndef test_func():\r\n    cdef np.ndarray[float, ndim=2] arr = np.zeros((5, 5), dtype=np.float32)\r\n    cdef float[:, ::1] arr_view = arr\r\n    _run(arr_view)\r\n\r\ncdef void _run(float[:, ::1] arr_view) noexcept nogil:\r\n    cdef float[:, :] tmp = _get_upper_left_corner(arr_view)\r\n\r\ncdef inline float[:, :] _get_upper_left_corner(float[:, ::1] arr) noexcept nogil:\r\n    return arr[:1, :1]\r\n\r\n```\r\n\r\nProduces this for the `__pyx_memoryview_slice_memviewslice` function (just the top):\r\n\r\n```c\r\n/* \"View.MemoryView\":793\r\n *\r\n * @cname('__pyx_memoryview_slice_memviewslice')\r\n * cdef int slice_memviewslice(             # <<<<<<<<<<<<<<\r\n *         __Pyx_memviewslice *dst,\r\n *         Py_ssize_t shape, Py_ssize_t stride, Py_ssize_t suboffset,\r\n */\r\n\r\nstatic int __pyx_memoryview_slice_memviewslice(__Pyx_memviewslice *__pyx_v_dst, Py_ssize_t __pyx_v_shape, Py_ssize_t __pyx_v_stride, Py_ssize_t __pyx_v_suboffset, int __pyx_v_dim, int __pyx_v_new_ndim, int *__pyx_v_suboffset_dim, Py_ssize_t __pyx_v_start, Py_ssize_t __pyx_v_stop, Py_ssize_t __pyx_v_step, int __pyx_v_have_start, int __pyx_v_have_stop, int __pyx_v_have_step, int __pyx_v_is_slice) {\r\n  Py_ssize_t __pyx_v_new_shape;\r\n  int __pyx_v_negative_step;\r\n  int __pyx_r;\r\n  __Pyx_RefNannyDeclarations\r\n  int __pyx_t_1;\r\n  int __pyx_t_2;\r\n  int __pyx_t_3;\r\n  int __pyx_lineno = 0;\r\n  const char *__pyx_filename = NULL;\r\n  int __pyx_clineno = 0;\r\n  #ifdef WITH_THREAD\r\n  PyGILState_STATE __pyx_gilstate_save;\r\n  #endif\r\n  __Pyx_RefNannySetupContext(\"slice_memviewslice\", 1);\r\n\r\n  /* \"View.MemoryView\":813\r\n *     cdef bint negative_step\r\n *\r\n *     if not is_slice:             # <<<<<<<<<<<<<<\r\n *\r\n *         if start < 0:\r\n */\r\n  __pyx_t_1 = (!__pyx_v_is_slice);\r\n  if (__pyx_t_1) {\r\n\r\n```\r\n\r\nThe def of ref nanny is:\r\n\r\n```c\r\n#ifdef WITH_THREAD\r\n  #define __Pyx_RefNannySetupContext(name, acquire_gil)\\\r\n          if (acquire_gil) {\\\r\n              PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();\\\r\n              __pyx_refnanny = __Pyx_RefNanny->SetupContext((name), (__LINE__), (__FILE__));\\\r\n              PyGILState_Release(__pyx_gilstate_save);\\\r\n          } else {\\\r\n              __pyx_refnanny = __Pyx_RefNanny->SetupContext((name), (__LINE__), (__FILE__));\\\r\n          }\r\n  #define __Pyx_RefNannyFinishContextNogil() {\\\r\n              PyGILState_STATE __pyx_gilstate_save = PyGILState_Ensure();\\\r\n              __Pyx_RefNannyFinishContext();\\\r\n              PyGILState_Release(__pyx_gilstate_save);\\\r\n          }\r\n```\r\n\r\nI don't know anythin about the ref nanny, but why does memory slicing require it and require the GIL?\n\n### Expected behaviour\n\nNo GIL acquire during most (all?) memoryview usage.\n\n### OS\n\nLinux\n\n### Python version\n\n3.11\n\n### Cython version\n\n3.0.2 (actually github master)\n\n### Additional context\n\nNOTE: This is from `master` installed yesterday afternoon with `pip install git+https://github.com/cython/cython --no-deps`.",
    "closed_at": "2023-09-08T16:47:04Z",
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Refnanny is used for our internal testing.\r\n\r\nThe definitions you show are guarded by `#if CYTHON_REFNANNY` which won't be set in your code. It's a no-op when compiling normally.\r\n\r\nIt might possibly be unnecessary here, but it won't be an issue in real code.",
            "created_at": "2023-09-08T16:44:07Z",
            "html_url": "https://github.com/cython/cython/issues/5688#issuecomment-1711955550",
            "id": 1711955550,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5688",
            "node_id": "IC_kwDOABDGAc5mCl5e",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1711955550/reactions"
            },
            "updated_at": "2023-09-08T16:44:07Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1711955550",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "Oooohhhh! Ok. So this block:\r\n\r\n```c\r\n#else\r\n  #define __Pyx_RefNannyDeclarations\r\n  #define __Pyx_RefNannySetupContext(name, acquire_gil)\r\n  #define __Pyx_RefNannyFinishContextNogil()\r\n  #define __Pyx_RefNannyFinishContext()\r\n  #define __Pyx_INCREF(r) Py_INCREF(r)\r\n  #define __Pyx_DECREF(r) Py_DECREF(r)\r\n  #define __Pyx_GOTREF(r)\r\n  #define __Pyx_GIVEREF(r)\r\n  #define __Pyx_XINCREF(r) Py_XINCREF(r)\r\n  #define __Pyx_XDECREF(r) Py_XDECREF(r)\r\n  #define __Pyx_XGOTREF(r)\r\n  #define __Pyx_XGIVEREF(r)\r\n#endif\r\n```\r\n\r\nis basically no-op'ing all that stuff during normal compilation where CYTHON_REFNANNY should be 0. Sounds good. Thanks.",
            "created_at": "2023-09-08T16:47:04Z",
            "html_url": "https://github.com/cython/cython/issues/5688#issuecomment-1711958921",
            "id": 1711958921,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5688",
            "node_id": "IC_kwDOABDGAc5mCmuJ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1711958921/reactions"
            },
            "updated_at": "2023-09-08T16:47:04Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1711958921",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1828519?v=4",
                "events_url": "https://api.github.com/users/djhoese/events{/privacy}",
                "followers_url": "https://api.github.com/users/djhoese/followers",
                "following_url": "https://api.github.com/users/djhoese/following{/other_user}",
                "gists_url": "https://api.github.com/users/djhoese/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/djhoese",
                "id": 1828519,
                "login": "djhoese",
                "node_id": "MDQ6VXNlcjE4Mjg1MTk=",
                "organizations_url": "https://api.github.com/users/djhoese/orgs",
                "received_events_url": "https://api.github.com/users/djhoese/received_events",
                "repos_url": "https://api.github.com/users/djhoese/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/djhoese/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/djhoese/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/djhoese"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Exactly. It just points out (some) reference counting errors when turned on, but it's off by default (and there's no reason for you as a user to turn it on)",
            "created_at": "2023-09-08T16:48:31Z",
            "html_url": "https://github.com/cython/cython/issues/5688#issuecomment-1711961095",
            "id": 1711961095,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5688",
            "node_id": "IC_kwDOABDGAc5mCnQH",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1711961095/reactions"
            },
            "updated_at": "2023-09-08T16:48:54Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1711961095",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 3,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5688/comments",
    "created_at": "2023-09-08T16:35:37Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/827060?v=4",
                "events_url": "https://api.github.com/users/matusvalo/events{/privacy}",
                "followers_url": "https://api.github.com/users/matusvalo/followers",
                "following_url": "https://api.github.com/users/matusvalo/following{/other_user}",
                "gists_url": "https://api.github.com/users/matusvalo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matusvalo",
                "id": 827060,
                "login": "matusvalo",
                "node_id": "MDQ6VXNlcjgyNzA2MA==",
                "organizations_url": "https://api.github.com/users/matusvalo/orgs",
                "received_events_url": "https://api.github.com/users/matusvalo/received_events",
                "repos_url": "https://api.github.com/users/matusvalo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matusvalo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matusvalo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matusvalo"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-09-08T16:35:38Z",
            "event": "mentioned",
            "id": 10320189752,
            "node_id": "MEE_lADOABDGAc5wiJJJzwAAAAJnIZk4",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/10320189752"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/827060?v=4",
                "events_url": "https://api.github.com/users/matusvalo/events{/privacy}",
                "followers_url": "https://api.github.com/users/matusvalo/followers",
                "following_url": "https://api.github.com/users/matusvalo/following{/other_user}",
                "gists_url": "https://api.github.com/users/matusvalo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/matusvalo",
                "id": 827060,
                "login": "matusvalo",
                "node_id": "MDQ6VXNlcjgyNzA2MA==",
                "organizations_url": "https://api.github.com/users/matusvalo/orgs",
                "received_events_url": "https://api.github.com/users/matusvalo/received_events",
                "repos_url": "https://api.github.com/users/matusvalo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/matusvalo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/matusvalo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/matusvalo"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-09-08T16:35:38Z",
            "event": "subscribed",
            "id": 10320189765,
            "node_id": "SE_lADOABDGAc5wiJJJzwAAAAJnIZlF",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/10320189765"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/1828519?v=4",
                "events_url": "https://api.github.com/users/djhoese/events{/privacy}",
                "followers_url": "https://api.github.com/users/djhoese/followers",
                "following_url": "https://api.github.com/users/djhoese/following{/other_user}",
                "gists_url": "https://api.github.com/users/djhoese/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/djhoese",
                "id": 1828519,
                "login": "djhoese",
                "node_id": "MDQ6VXNlcjE4Mjg1MTk=",
                "organizations_url": "https://api.github.com/users/djhoese/orgs",
                "received_events_url": "https://api.github.com/users/djhoese/received_events",
                "repos_url": "https://api.github.com/users/djhoese/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/djhoese/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/djhoese/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/djhoese"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2023-09-08T16:47:05Z",
            "event": "closed",
            "id": 10320296298,
            "node_id": "CE_lADOABDGAc5wiJJJzwAAAAJnIzlq",
            "performed_via_github_app": null,
            "state_reason": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/10320296298"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5688/events",
    "html_url": "https://github.com/cython/cython/issues/5688",
    "id": 1887998537,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5688/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5wiJJJ",
    "number": 5688,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5688/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "state_reason": "completed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5688/timeline",
    "title": "[BUG] \"__pyx_memoryview_slice_memviewslice\" always acquires GIL",
    "updated_at": "2023-09-08T16:48:54Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5688",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/1828519?v=4",
        "events_url": "https://api.github.com/users/djhoese/events{/privacy}",
        "followers_url": "https://api.github.com/users/djhoese/followers",
        "following_url": "https://api.github.com/users/djhoese/following{/other_user}",
        "gists_url": "https://api.github.com/users/djhoese/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/djhoese",
        "id": 1828519,
        "login": "djhoese",
        "node_id": "MDQ6VXNlcjE4Mjg1MTk=",
        "organizations_url": "https://api.github.com/users/djhoese/orgs",
        "received_events_url": "https://api.github.com/users/djhoese/received_events",
        "repos_url": "https://api.github.com/users/djhoese/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/djhoese/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/djhoese/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/djhoese"
    }
}