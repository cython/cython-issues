{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "minimal repro case:\r\n\r\n```python\r\nIn [1]: %load_ext Cython\r\n\r\nIn [2]: %%cython\r\n   ...: cimport numpy as np\r\n   ...: import numpy as np\r\n   ...: \r\n   ...: cpdef np.ndarray[object] encode_as_object(np.ndarray[object] ndarray,\r\n   ...:                                           str encoding='utf-8',\r\n   ...:                                           str errors='strict'):\r\n   ...:     cdef np.ndarray[object] out = np.empty_like(ndarray, dtype='object')\r\n   ...:     cdef Py_ssize_t n\r\n   ...:     for n in range(len(ndarray)):\r\n   ...:         out[n] = ndarray[n].encode(encoding, errors)\r\n   ...:     return out\r\nIn file included from /home/joe/.virtualenvs/fundamentals/lib/python3.6/site-packages/numpy/core/include/numpy/ndarraytypes.h:1788:0,\r\n                 from /home/joe/.virtualenvs/fundamentals/lib/python3.6/site-packages/numpy/core/include/numpy/ndarrayobject.h:18,\r\n                 from /home/joe/.virtualenvs/fundamentals/lib/python3.6/site-packages/numpy/core/include/numpy/arrayobject.h:4,\r\n                 from /home/joe/.cache/ipython/cython/_cython_magic_feb79cc694e6859260d24b21c1ab7c0b.c:451:\r\n/home/joe/.virtualenvs/fundamentals/lib/python3.6/site-packages/numpy/core/include/numpy/npy_1_7_deprecated_api.h:15:2: warning: #warning \"Using deprecated NumPy API, disable it by \" \"#defining NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION\" [-Wcpp]\r\n #warning \"Using deprecated NumPy API, disable it by \" \\\r\n  ^~~~~~~\r\n\r\nIn [3]: array = np.array(['a', 'b', 'c'], dtype=object)\r\n\r\nIn [4]: encode_as_object(array)\r\nSegmentation fault (core dumped)\r\n```\r\n\r\nThis code works if you remove the `object` dtype qualifier from the output array even if I leave the return type as `np.ndarray[object]`\r\n\r\nMy env looks like like: (tested with gcc and clang to be safe)\r\ngnu+linux\r\ncython git commit 935b691c5\r\n`python --version`: Python 3.6.0\r\n`gcc --version`: gcc (GCC) 7.0.1 20170210\r\n`clang --version`: 3.9.1",
    "closed_at": null,
    "closed_by": null,
    "comment_data": [
        {
            "author_association": "CONTRIBUTOR",
            "body": "Think the issue here is just that `np.import_array()` needs to be called when using the NumPy C API\r\n\r\nAdding that to the code snippet seems to work ok\r\n\r\n```\r\n% ipython\r\nPython 3.12.7 | packaged by conda-forge | (main, Oct  4 2024, 15:57:01) [Clang 17.0.6 ]\r\nType 'copyright', 'credits' or 'license' for more information\r\nIPython 8.22.2 -- An enhanced Interactive Python. Type '?' for help.\r\n```\r\n\r\n```python\r\nIn [1]: %load_ext cython\r\n\r\nIn [2]: %%cython\r\n   ...: cimport numpy as np\r\n   ...: import numpy as np\r\n   ...: \r\n   ...: np.import_array()\r\n   ...: \r\n   ...: cpdef np.ndarray[object] encode_as_object(np.ndarray[object] ndarray,\r\n   ...:                                           str encoding='utf-8',\r\n   ...:                                           str errors='strict'):\r\n   ...:     cdef np.ndarray[object] out = np.empty_like(ndarray, dtype='object')\r\n   ...: \r\n   ...:     cdef Py_ssize_t n\r\n   ...:     for n in range(len(ndarray)):\r\n   ...:         out[n] = ndarray[n].encode(encoding, errors)\r\n   ...:     return out\r\n   ...: \r\n\r\nIn [3]: array = np.array(['a', 'b', 'c'], dtype=object)\r\n\r\nIn [4]: encode_as_object(array)\r\nOut[4]: array([b'a', b'b', b'c'], dtype=object)\r\n```",
            "created_at": "2024-11-15T09:10:13Z",
            "html_url": "https://github.com/cython/cython/issues/1608#issuecomment-2478298569",
            "id": 2478298569,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/1608",
            "node_id": "IC_kwDOABDGAc6Tt9XJ",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/2478298569/reactions"
            },
            "updated_at": "2024-11-15T09:10:13Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/2478298569",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/3019665?v=4",
                "events_url": "https://api.github.com/users/jakirkham/events{/privacy}",
                "followers_url": "https://api.github.com/users/jakirkham/followers",
                "following_url": "https://api.github.com/users/jakirkham/following{/other_user}",
                "gists_url": "https://api.github.com/users/jakirkham/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/jakirkham",
                "id": 3019665,
                "login": "jakirkham",
                "node_id": "MDQ6VXNlcjMwMTk2NjU=",
                "organizations_url": "https://api.github.com/users/jakirkham/orgs",
                "received_events_url": "https://api.github.com/users/jakirkham/received_events",
                "repos_url": "https://api.github.com/users/jakirkham/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/jakirkham/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/jakirkham/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/jakirkham",
                "user_view_type": "public"
            }
        }
    ],
    "comments": 1,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/1608/comments",
    "created_at": "2017-02-17T04:17:26Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/1608/events",
    "html_url": "https://github.com/cython/cython/issues/1608",
    "id": 208331184,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/1608/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUyMDgzMzExODQ=",
    "number": 1608,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/1608/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/1608/timeline",
    "title": "segfault using ndarray[object]",
    "updated_at": "2024-11-15T09:10:13Z",
    "url": "https://api.github.com/repos/cython/cython/issues/1608",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/3064397?v=4",
        "events_url": "https://api.github.com/users/llllllllll/events{/privacy}",
        "followers_url": "https://api.github.com/users/llllllllll/followers",
        "following_url": "https://api.github.com/users/llllllllll/following{/other_user}",
        "gists_url": "https://api.github.com/users/llllllllll/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/llllllllll",
        "id": 3064397,
        "login": "llllllllll",
        "node_id": "MDQ6VXNlcjMwNjQzOTc=",
        "organizations_url": "https://api.github.com/users/llllllllll/orgs",
        "received_events_url": "https://api.github.com/users/llllllllll/received_events",
        "repos_url": "https://api.github.com/users/llllllllll/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/llllllllll/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/llllllllll/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/llllllllll",
        "user_view_type": "public"
    }
}