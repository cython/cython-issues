{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "body": "**Describe the bug**\r\nWhen CPython is compiled in debug mode, Cython may trigger an assertion related to function flags.\r\n\r\n**To Reproduce**\r\n\r\n* Compile CPython 3.11.0b1 from source `--with-pydebug`\r\n* `pip install asynq` with the newly compiled python\r\n* `python -c 'import asynq'`\r\n* Crash: `Assertion failed: (PyCFunction_Check(func)), function PyCFunction_GET_FLAGS, file methodobject.h, line 59.`\r\n\r\n**Expected behavior**\r\nNo crash\r\n\r\n**Environment (please complete the following information):**\r\n - OS: macOS\r\n - Python version 3.11b1\r\n - Cython version 0.29.30\r\n\r\n**Additional context**\r\n\r\nThe crash is around here: https://github.com/cython/cython/blob/169876872f3cb6198971a1db07e5b8a9d12b3dac/Cython/Utility/ObjectHandling.c#L2237. If `func` is a `CyFunctionObject`, the `__Pyx_IsCyOrPyCFunction` check passes and we call `PyCFunction_GET_FLAGS`, but in release mode that function checks that its arg is exactly a PyCFunction.\r\n\r\nIt appears that this is harmless because the layout of `CyFunctionObject` has a `PyCFunction` at the top, so it's fine at runtime to treat the former as if it's the latter. Therefore, things work fine in non-debug mode.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "> function checks that its arg is exactly a PyCFunction.\r\n\r\nIt isn't even quite that. It doesn't do an \"exact\" check. I think the issues is that `CyFunction` is structured as if it inherits from `PyCFunction` (it has `PyCFunction` as the first element of the struct) but doesn't set `tp_base`.\r\n",
            "created_at": "2022-05-22T06:01:34Z",
            "html_url": "https://github.com/cython/cython/issues/4804#issuecomment-1133825107",
            "id": 1133825107,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4804",
            "node_id": "IC_kwDOABDGAc5DlMxT",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1133825107/reactions"
            },
            "updated_at": "2022-05-22T06:01:34Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1133825107",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Since CPython 3.9, it is possible to inherit from PyCFunction. We could try if we can do this for CyFunction. There is a certain risk of triggering incorrect special handling code somewhere in CPython or third party modules, since such code might not have been written with actual PyCFunction subtypes in mind that behave differently. But if that happens, it probably wouldn't be on Cython's plate to fix it. We're still in alpha, let's see if we can do this.",
            "created_at": "2022-05-25T10:32:49Z",
            "html_url": "https://github.com/cython/cython/issues/4804#issuecomment-1137075123",
            "id": 1137075123,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4804",
            "node_id": "IC_kwDOABDGAc5DxmOz",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1137075123/reactions"
            },
            "updated_at": "2022-05-25T10:32:49Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1137075123",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "Because the assertion is in an inline function in a header file, it affects any module which is built in debug mode, regardless of how Python itself was built.\r\n\r\nI got the above crash with:\r\n\r\n* CPython 3.11.0rc1, **not** built in debug mode\r\n* A module generated by Cython 0.29.32, built in debug mode\r\n\r\nDefining NDEBUG while compiling the Cython module fixed the problem, but this obviously disables all other assertions as well, which isn't ideal.",
            "created_at": "2022-09-15T19:13:17Z",
            "html_url": "https://github.com/cython/cython/issues/4804#issuecomment-1248507136",
            "id": 1248507136,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4804",
            "node_id": "IC_kwDOABDGAc5KarUA",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1248507136/reactions"
            },
            "updated_at": "2022-09-15T19:15:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1248507136",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/166954?v=4",
                "events_url": "https://api.github.com/users/mhsmith/events{/privacy}",
                "followers_url": "https://api.github.com/users/mhsmith/followers",
                "following_url": "https://api.github.com/users/mhsmith/following{/other_user}",
                "gists_url": "https://api.github.com/users/mhsmith/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mhsmith",
                "id": 166954,
                "login": "mhsmith",
                "node_id": "MDQ6VXNlcjE2Njk1NA==",
                "organizations_url": "https://api.github.com/users/mhsmith/orgs",
                "received_events_url": "https://api.github.com/users/mhsmith/received_events",
                "repos_url": "https://api.github.com/users/mhsmith/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mhsmith/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mhsmith/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mhsmith"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I think we've given up on inheriting from CyFunction (at least for the moment) so I suspect practically we need `__pyx_CyOrPyCFunction_GET_FLAGS` with a slightly different path for debug mode. Or possibly to disable the shortcut path in debug mode (which might be easier)",
            "created_at": "2022-09-15T19:53:11Z",
            "html_url": "https://github.com/cython/cython/issues/4804#issuecomment-1248543812",
            "id": 1248543812,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4804",
            "node_id": "IC_kwDOABDGAc5Ka0RE",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1248543812/reactions"
            },
            "updated_at": "2022-09-15T21:12:31Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1248543812",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 4,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4804/comments",
    "created_at": "2022-05-22T04:10:25Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": "9863293a8377085e683a0de3aac9a841da1cbce8",
            "commit_url": "https://api.github.com/repos/da-woods/cython/commits/9863293a8377085e683a0de3aac9a841da1cbce8",
            "created_at": "2022-09-15T21:11:17Z",
            "event": "referenced",
            "id": 7398378221,
            "node_id": "REFE_lADOABDGAc5KKBiKzwAAAAG4-krt",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/7398378221"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4804/events",
    "html_url": "https://github.com/cython/cython/issues/4804",
    "id": 1244141706,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4804/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5KKBiK",
    "number": 4804,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4804/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4804/timeline",
    "title": "[BUG] Assertion failure in PyCFunction_GET_FLAGS on debug mode",
    "updated_at": "2022-09-15T21:12:31Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4804",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/906600?v=4",
        "events_url": "https://api.github.com/users/JelleZijlstra/events{/privacy}",
        "followers_url": "https://api.github.com/users/JelleZijlstra/followers",
        "following_url": "https://api.github.com/users/JelleZijlstra/following{/other_user}",
        "gists_url": "https://api.github.com/users/JelleZijlstra/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/JelleZijlstra",
        "id": 906600,
        "login": "JelleZijlstra",
        "node_id": "MDQ6VXNlcjkwNjYwMA==",
        "organizations_url": "https://api.github.com/users/JelleZijlstra/orgs",
        "received_events_url": "https://api.github.com/users/JelleZijlstra/received_events",
        "repos_url": "https://api.github.com/users/JelleZijlstra/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/JelleZijlstra/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/JelleZijlstra/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/JelleZijlstra"
    }
}