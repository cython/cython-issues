{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "Original issue was created for numpy (numpy/numpy#13237) as I thought this was specific to numpy, but they believe this to be a Cython issue.  This issue was uncovered during development of pandas.  Below is the issue as opened in the numpy repository:\r\n\r\nWhen using an ndarray as an arg to a `cdef` function, and that `ndarray` is not used in the function, that object is never properly garbage collected and causes a memory leak.\r\n\r\nIf the `ndarray` is used in the function, it is collected properly.\r\n\r\n### Reproducing code example:\r\n\r\nmemleak.pyx\r\n```\r\nimport numpy as np\r\ncimport numpy as cnp\r\nfrom numpy cimport ndarray\r\ncnp.import_array()\r\n\r\ncdef inline void caller():\r\n    cdef:\r\n        ndarray[int] x\r\n    x = np.asarray(range(10000))\r\n    dont_use_x(x)\r\n\r\ncdef inline void dont_use_x(ndarray[int] x):\r\n    pass\r\n\r\nwhile True:\r\n    caller()\r\n```\r\n\r\nsetup.py:\r\n```\r\nfrom distutils.core import setup\r\nfrom Cython.Build import cythonize\r\nimport numpy\r\n\r\nsetup(\r\n    ext_modules = cythonize(\"memleak.pyx\"),\r\n    include_dirs=[numpy.get_include()]\r\n)\r\n```\r\n\r\nto run:\r\n```\r\npython setup.py build_ext --inplace\r\npython\r\nimport memleak\r\n```\r\n\r\n### Numpy/Python version information:\r\n\r\n`1.16.2 3.7.1 (default, Dec 10 2018, 22:54:23) [MSC v.1915 64 bit (AMD64)]`\r\n\r\n",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "Thanks for the report. Sounds like the issue might be Cython's detection of unused variables. It could be that they are handled differently (or not at all) on cleanup. However, the report suggests that buffer / memory-view variables require the usual cleanup here.",
            "created_at": "2019-07-18T19:01:09Z",
            "html_url": "https://github.com/cython/cython/issues/3046#issuecomment-512945142",
            "id": 512945142,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3046",
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxMjk0NTE0Mg==",
            "updated_at": "2019-07-18T19:01:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/512945142",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "With regards to memoryview, if you replace the line:\r\n`cdef inline void dont_use_x(ndarray[int] x):`\r\nwith:\r\n`cdef inline void dont_use_x(long[:] x):`\r\nthe issue goes away.  There is no memory leak.",
            "created_at": "2019-07-18T20:15:45Z",
            "html_url": "https://github.com/cython/cython/issues/3046#issuecomment-512970664",
            "id": 512970664,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/3046",
            "node_id": "MDEyOklzc3VlQ29tbWVudDUxMjk3MDY2NA==",
            "updated_at": "2019-07-18T20:15:45Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/512970664",
            "user": {
                "avatar_url": "https://avatars1.githubusercontent.com/u/25773476?v=4",
                "events_url": "https://api.github.com/users/ArtificialQualia/events{/privacy}",
                "followers_url": "https://api.github.com/users/ArtificialQualia/followers",
                "following_url": "https://api.github.com/users/ArtificialQualia/following{/other_user}",
                "gists_url": "https://api.github.com/users/ArtificialQualia/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/ArtificialQualia",
                "id": 25773476,
                "login": "ArtificialQualia",
                "node_id": "MDQ6VXNlcjI1NzczNDc2",
                "organizations_url": "https://api.github.com/users/ArtificialQualia/orgs",
                "received_events_url": "https://api.github.com/users/ArtificialQualia/received_events",
                "repos_url": "https://api.github.com/users/ArtificialQualia/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/ArtificialQualia/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/ArtificialQualia/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/ArtificialQualia"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/3046/comments",
    "created_at": "2019-07-17T20:19:29Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/3046/events",
    "html_url": "https://github.com/cython/cython/issues/3046",
    "id": 469424137,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/3046/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWU0Njk0MjQxMzc=",
    "number": 3046,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Memory leak with ndarray as function arg in Cython",
    "updated_at": "2019-07-18T20:15:45Z",
    "url": "https://api.github.com/repos/cython/cython/issues/3046",
    "user": {
        "avatar_url": "https://avatars1.githubusercontent.com/u/25773476?v=4",
        "events_url": "https://api.github.com/users/ArtificialQualia/events{/privacy}",
        "followers_url": "https://api.github.com/users/ArtificialQualia/followers",
        "following_url": "https://api.github.com/users/ArtificialQualia/following{/other_user}",
        "gists_url": "https://api.github.com/users/ArtificialQualia/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/ArtificialQualia",
        "id": 25773476,
        "login": "ArtificialQualia",
        "node_id": "MDQ6VXNlcjI1NzczNDc2",
        "organizations_url": "https://api.github.com/users/ArtificialQualia/orgs",
        "received_events_url": "https://api.github.com/users/ArtificialQualia/received_events",
        "repos_url": "https://api.github.com/users/ArtificialQualia/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/ArtificialQualia/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/ArtificialQualia/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/ArtificialQualia"
    }
}