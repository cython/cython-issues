{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "### Describe the bug\r\n\r\nWhen a cpdef enum is used and has duplicate values, Cython fails to compile the *.pyx file.\r\n\r\nFor example:\r\n\r\n```\r\ncdef enum SomeType:\r\n    BYTE = 1\r\n    UINT8 = 1\r\n    UINT16 = 2\r\n    UINT32 = 3\r\n```\r\n\r\nI belive this is because a switch is being used during optimization (maybe here? https://github.com/cython/cython/blob/master/Cython/Utility/CpdefEnums.pyx#L154)\r\n\r\nPerhaps a bug with enums here: https://github.com/cython/cython/blob/master/Cython/Compiler/Optimize.py#L1246\r\n\r\n### Code to reproduce the behaviour:\r\n\r\n```diff\r\ndiff --git a/tests/run/switch.pyx b/tests/run/switch.pyx\r\nindex dfd734f..a88e679 100644\r\n--- a/tests/run/switch.pyx\r\n+++ b/tests/run/switch.pyx\r\n@@ -333,7 +333,7 @@ def compile_time_tuple_constant(int x):\r\n \r\n cdef enum X:\r\n     a = 1\r\n-    b\r\n+    b = 1\r\n     c\r\n     d\r\n     e = 10\r\n```\r\n\r\n```\r\n$  python3 runtests.py -vv switch\r\n\r\nCompiler output:\r\nswitch.cpp:5165:10: error: duplicate case value: '__pyx_e_6switch_a' and '__pyx_e_6switch_b' both equal '1'\r\n    case __pyx_e_6switch_b:\r\n         ^\r\nswitch.cpp:5163:10: note: previous case defined here\r\n    case __pyx_e_6switch_a:\r\n         ^\r\nswitch.cpp:5356:10: error: duplicate case value: '__pyx_e_6switch_a' and '__pyx_e_6switch_b' both equal '1'\r\n    case __pyx_e_6switch_b:\r\n         ^\r\nswitch.cpp:5354:10: note: previous case defined here\r\n    case __pyx_e_6switch_a:\r\n         ^\r\nswitch.cpp:5601:10: error: duplicate case value: '__pyx_e_6switch_a' and '__pyx_e_6switch_b' both equal '1'\r\n    case __pyx_e_6switch_b:\r\n         ^\r\nswitch.cpp:5599:10: note: previous case defined here\r\n    case __pyx_e_6switch_a:\r\n         ^\r\n3 errors generated.\r\n\r\n```\r\n\r\n\r\n### Expected behaviour\r\n\r\nShould be valid and compile. Nothing prevents C or C++ enums from having duplicate values. This breaks existing code during upgrade.\r\n\r\n### OS\r\n\r\nLinux and macos\r\n\r\n### Python version\r\n\r\ntested 3.8 and 3.11\r\n\r\n### Cython version\r\n\r\n3.0.0b2\r\n\r\n### Additional context\r\n\r\n_No response_",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "NONE",
            "body": "I'm guessing somewhere in `NameNode` there should be an extra analysis to set a `self.constant_result`",
            "created_at": "2023-04-23T15:13:21Z",
            "html_url": "https://github.com/cython/cython/issues/5400#issuecomment-1519090194",
            "id": 1519090194,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5400",
            "node_id": "IC_kwDOABDGAc5ai3oS",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1519090194/reactions"
            },
            "updated_at": "2023-04-23T15:13:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1519090194",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/9659800?v=4",
                "events_url": "https://api.github.com/users/mikelui/events{/privacy}",
                "followers_url": "https://api.github.com/users/mikelui/followers",
                "following_url": "https://api.github.com/users/mikelui/following{/other_user}",
                "gists_url": "https://api.github.com/users/mikelui/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/mikelui",
                "id": 9659800,
                "login": "mikelui",
                "node_id": "MDQ6VXNlcjk2NTk4MDA=",
                "organizations_url": "https://api.github.com/users/mikelui/orgs",
                "received_events_url": "https://api.github.com/users/mikelui/received_events",
                "repos_url": "https://api.github.com/users/mikelui/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/mikelui/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/mikelui/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/mikelui"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "> I'm guessing somewhere in `NameNode` there should be an extra analysis to set a `self.constant_result`\r\n\r\nI don't necessarily think that solves it - I don't think Cython knows the values of all enums (specifically extern ones can be opaque to Cython).\r\n\r\nI suspect the switch optimization just needs to be more cautious and fail for anything that it doesn't know a constant result for.  It's clearly a general issue, but one that's pretty likely to happen with enums",
            "created_at": "2023-04-23T16:32:53Z",
            "html_url": "https://github.com/cython/cython/issues/5400#issuecomment-1519105740",
            "id": 1519105740,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/5400",
            "node_id": "IC_kwDOABDGAc5ai7bM",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1519105740/reactions"
            },
            "updated_at": "2023-04-23T16:32:53Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1519105740",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/5400/comments",
    "created_at": "2023-04-23T13:18:41Z",
    "event_data": [],
    "events_url": "https://api.github.com/repos/cython/cython/issues/5400/events",
    "html_url": "https://github.com/cython/cython/issues/5400",
    "id": 1680025391,
    "labels": [],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/5400/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5kIycv",
    "number": 5400,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/5400/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "state_reason": null,
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/5400/timeline",
    "title": "[BUG]  cpdef Enum does not support enums with the same value",
    "updated_at": "2023-04-23T16:32:54Z",
    "url": "https://api.github.com/repos/cython/cython/issues/5400",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/9659800?v=4",
        "events_url": "https://api.github.com/users/mikelui/events{/privacy}",
        "followers_url": "https://api.github.com/users/mikelui/followers",
        "following_url": "https://api.github.com/users/mikelui/following{/other_user}",
        "gists_url": "https://api.github.com/users/mikelui/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/mikelui",
        "id": 9659800,
        "login": "mikelui",
        "node_id": "MDQ6VXNlcjk2NTk4MDA=",
        "organizations_url": "https://api.github.com/users/mikelui/orgs",
        "received_events_url": "https://api.github.com/users/mikelui/received_events",
        "repos_url": "https://api.github.com/users/mikelui/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/mikelui/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mikelui/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/mikelui"
    }
}