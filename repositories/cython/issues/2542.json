{
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "Could Cython please add a mode to generate code compatible with Py_LIMITED_API / PEP 384?  This would allow distributing a single binary extension module that works on any Python 3.x version.",
    "closed_at": null,
    "comment_data": [
        {
            "author_association": "MEMBER",
            "body": "I'd be fine with adding the necessary C macro guards and duplicated implementations to the C code that Cython generates. But it's probably a lot of work. The \"limited API\" is really different in many regards, so this means a lot of duplicated C code and quite a bit longer C files. As macro guard, I would suggest a new macro `CYTHON_USE_LIMITED_API` that would `#define Py_LIMITED_API` before including `Python.h`, disable most of the special feature flags in the beginning of `ModuleSetupCode.c`, and activate separate implementations for extension types. We'd then need additional guards around several macro calls in optimised code, and it would probably also conflict with `CyFunction` (`binding=True`), possibly also with generators and coroutines, can't say. Anything that cannot work with the limited API would then simply generate a C compile time `#error`.\r\n\r\nPull request welcome.",
            "created_at": "2018-08-09T19:18:22Z",
            "html_url": "https://github.com/cython/cython/issues/2542#issuecomment-411867215",
            "id": 411867215,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2542",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxMTg2NzIxNQ==",
            "updated_at": "2018-08-09T19:18:22Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/411867215",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "I should add one more thing: while this is a lot of work, it's probably quite easy. Why? Because it should be done at the C code level. That means that for the transformation, you can follow the description in [PEP 384](https://www.python.org/dev/peps/pep-0384/), activate the feature switch macro in the test suite, and the C compiler errors will guide you through the process. And since most of the C code is generated in a single point, it's not even that much code to change overall.\r\n\r\nThere's one caveat: it still needs to generate the same code as before when the feature is disabled, and the code generation must stay maintainable. Some things will therefore have to be duplicated or (preferably) hidden behind new `__Pyx_â€¦` macros, such as extension type slots (a macro like `__Pyx_SLOT(tp_slotname, value)` would simply unfold into `value,` in the normal case and `{\"tp_slot\", value},` if value is not `0` in the limited API case, something like that).\r\n\r\nAgain, pull request welcome.",
            "created_at": "2018-08-10T04:43:25Z",
            "html_url": "https://github.com/cython/cython/issues/2542#issuecomment-411973715",
            "id": 411973715,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2542",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxMTk3MzcxNQ==",
            "updated_at": "2018-08-10T04:46:36Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/411973715",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "To be honest, I'm not sure I'm the best person to work on this, as I haven't even used Cython directly before.  I was just trying to transform another package, which uses Cython, into PEP 384 compatible abi3 extension, because it takes a very long time to compile and would like to compile it only once for all Python 3.x versions.",
            "created_at": "2018-08-10T11:25:16Z",
            "html_url": "https://github.com/cython/cython/issues/2542#issuecomment-412055081",
            "id": 412055081,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2542",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjA1NTA4MQ==",
            "updated_at": "2018-08-10T11:25:16Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/412055081",
            "user": {
                "avatar_url": "https://avatars2.githubusercontent.com/u/2197096?v=4",
                "events_url": "https://api.github.com/users/gjcarneiro/events{/privacy}",
                "followers_url": "https://api.github.com/users/gjcarneiro/followers",
                "following_url": "https://api.github.com/users/gjcarneiro/following{/other_user}",
                "gists_url": "https://api.github.com/users/gjcarneiro/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/gjcarneiro",
                "id": 2197096,
                "login": "gjcarneiro",
                "node_id": "MDQ6VXNlcjIxOTcwOTY=",
                "organizations_url": "https://api.github.com/users/gjcarneiro/orgs",
                "received_events_url": "https://api.github.com/users/gjcarneiro/received_events",
                "repos_url": "https://api.github.com/users/gjcarneiro/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/gjcarneiro/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/gjcarneiro/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/gjcarneiro"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Well, I should mention that there is a drawback to this. If Cython code cannot adapt to the specific CPython (minor) version, nor use CPython internals, it will run slower. I consider the proposed feature a way to make the life of distributors easier, in cases where performance is not critical (e.g. for a wrapper of an I/O bound native library).\r\n\r\nThe reason why the compilation takes a while is because Cython generates code that allows the C compiler to pull all sorts of tricks to specialise and optimise the code for the target platform at hand. Meaning, if it's really just about the compilation time, It's usually worth waiting for the result. :)\r\n\r\nAlso, if you use travis or a parallel Docker manylinux build for the different Python versions, then generating all wheels doesn't take that much longer than generating one, from my experience.",
            "created_at": "2018-08-10T12:03:44Z",
            "html_url": "https://github.com/cython/cython/issues/2542#issuecomment-412062420",
            "id": 412062420,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2542",
            "node_id": "MDEyOklzc3VlQ29tbWVudDQxMjA2MjQyMA==",
            "updated_at": "2018-08-10T12:03:44Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/412062420",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        },
        {
            "author_association": "NONE",
            "body": "@scoder I have a prototype to enable the `LIMITED_API` here: https://github.com/cython/cython/pull/3223.",
            "created_at": "2019-11-01T00:51:09Z",
            "html_url": "https://github.com/cython/cython/issues/2542#issuecomment-548624569",
            "id": 548624569,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2542",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODYyNDU2OQ==",
            "updated_at": "2019-11-01T00:51:09Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/548624569",
            "user": {
                "avatar_url": "https://avatars3.githubusercontent.com/u/5315899?v=4",
                "events_url": "https://api.github.com/users/eduardo-elizondo/events{/privacy}",
                "followers_url": "https://api.github.com/users/eduardo-elizondo/followers",
                "following_url": "https://api.github.com/users/eduardo-elizondo/following{/other_user}",
                "gists_url": "https://api.github.com/users/eduardo-elizondo/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/eduardo-elizondo",
                "id": 5315899,
                "login": "eduardo-elizondo",
                "node_id": "MDQ6VXNlcjUzMTU4OTk=",
                "organizations_url": "https://api.github.com/users/eduardo-elizondo/orgs",
                "received_events_url": "https://api.github.com/users/eduardo-elizondo/received_events",
                "repos_url": "https://api.github.com/users/eduardo-elizondo/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/eduardo-elizondo/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/eduardo-elizondo/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/eduardo-elizondo"
            }
        },
        {
            "author_association": "MEMBER",
            "body": "Nice! A really cool side-effect of having these two compilation modes in Cython is that it allows module authors to easily test and benchmark both, and then decide for themselves if the performance (or maybe also feature) difference is worth the hassle of providing CPython version specific wheels. And, it even allows the CPython devs to get an idea about performance issues in the limited API that they might want to look into. Very much looking forward to including this!",
            "created_at": "2019-11-01T07:36:51Z",
            "html_url": "https://github.com/cython/cython/issues/2542#issuecomment-548695616",
            "id": 548695616,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/2542",
            "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODY5NTYxNg==",
            "updated_at": "2019-11-01T07:36:51Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/548695616",
            "user": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            }
        }
    ],
    "comments": 6,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/2542/comments",
    "created_at": "2018-08-09T18:13:31Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-08-09T19:09:58Z",
            "event": "labeled",
            "id": 1780969579,
            "label": {
                "color": "c2e0c6",
                "name": "feature"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE3ODA5Njk1Nzk=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1780969579"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-08-09T19:09:58Z",
            "event": "labeled",
            "id": 1780969581,
            "label": {
                "color": "444444",
                "name": "Code Generation"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE3ODA5Njk1ODE=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1780969581"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2018-08-09T19:11:18Z",
            "event": "labeled",
            "id": 1780972157,
            "label": {
                "color": "0e8a16",
                "name": "help wanted"
            },
            "node_id": "MDEyOkxhYmVsZWRFdmVudDE3ODA5NzIxNTc=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/1780972157"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-11-01T00:51:09Z",
            "event": "mentioned",
            "id": 2761862983,
            "node_id": "MDE0Ok1lbnRpb25lZEV2ZW50Mjc2MTg2Mjk4Mw==",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2761862983"
        },
        {
            "actor": {
                "avatar_url": "https://avatars0.githubusercontent.com/u/491659?v=4",
                "events_url": "https://api.github.com/users/scoder/events{/privacy}",
                "followers_url": "https://api.github.com/users/scoder/followers",
                "following_url": "https://api.github.com/users/scoder/following{/other_user}",
                "gists_url": "https://api.github.com/users/scoder/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/scoder",
                "id": 491659,
                "login": "scoder",
                "node_id": "MDQ6VXNlcjQ5MTY1OQ==",
                "organizations_url": "https://api.github.com/users/scoder/orgs",
                "received_events_url": "https://api.github.com/users/scoder/received_events",
                "repos_url": "https://api.github.com/users/scoder/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/scoder/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/scoder/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/scoder"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2019-11-01T00:51:09Z",
            "event": "subscribed",
            "id": 2761862984,
            "node_id": "MDE1OlN1YnNjcmliZWRFdmVudDI3NjE4NjI5ODQ=",
            "url": "https://api.github.com/repos/cython/cython/issues/events/2761862984"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/2542/events",
    "html_url": "https://github.com/cython/cython/issues/2542",
    "id": 349234994,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "id": 425556330,
            "name": "Code Generation",
            "node_id": "MDU6TGFiZWw0MjU1NTYzMzA=",
            "url": "https://api.github.com/repos/cython/cython/labels/Code%20Generation"
        },
        {
            "color": "c2e0c6",
            "default": false,
            "id": 414805463,
            "name": "feature",
            "node_id": "MDU6TGFiZWw0MTQ4MDU0NjM=",
            "url": "https://api.github.com/repos/cython/cython/labels/feature"
        },
        {
            "color": "0e8a16",
            "default": true,
            "id": 414800879,
            "name": "help wanted",
            "node_id": "MDU6TGFiZWw0MTQ4MDA4Nzk=",
            "url": "https://api.github.com/repos/cython/cython/labels/help%20wanted"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/2542/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "MDU6SXNzdWUzNDkyMzQ5OTQ=",
    "number": 2542,
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "open",
    "title": "Py_LIMITED_API / PEP 384",
    "updated_at": "2019-11-01T07:36:52Z",
    "url": "https://api.github.com/repos/cython/cython/issues/2542",
    "user": {
        "avatar_url": "https://avatars2.githubusercontent.com/u/2197096?v=4",
        "events_url": "https://api.github.com/users/gjcarneiro/events{/privacy}",
        "followers_url": "https://api.github.com/users/gjcarneiro/followers",
        "following_url": "https://api.github.com/users/gjcarneiro/following{/other_user}",
        "gists_url": "https://api.github.com/users/gjcarneiro/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/gjcarneiro",
        "id": 2197096,
        "login": "gjcarneiro",
        "node_id": "MDQ6VXNlcjIxOTcwOTY=",
        "organizations_url": "https://api.github.com/users/gjcarneiro/orgs",
        "received_events_url": "https://api.github.com/users/gjcarneiro/received_events",
        "repos_url": "https://api.github.com/users/gjcarneiro/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/gjcarneiro/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/gjcarneiro/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/gjcarneiro"
    }
}