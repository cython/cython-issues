{
    "active_lock_reason": null,
    "assignee": null,
    "assignees": [],
    "author_association": "NONE",
    "body": "```\r\nimport time\r\ncdef class Num:\r\n    cdef int n\r\n    def __init__(Num self, int n):\r\n        self.n = n\r\n    def __add__(Num self, Num oth):\r\n        return Num(self.n + oth.n)\r\n    cdef inline Num add(Num self, Num oth):\r\n        return Num(self.n + oth.n)\r\n    cdef inline Num add2(Num self, Num oth):\r\n        cdef Num ret\r\n        ret = Num.__new__(Num)\r\n        ret.n = self.n + oth.n\r\n        return ret\r\n    def __repr__(self):\r\n        return str(self.n)\r\n\r\ncdef cythfun():\r\n    # cdef int i, n\r\n    cdef Num num, res\r\n    i = 0\r\n    n = 10000000\r\n    num = Num(1)\r\n    res = Num(0)\r\n    while i < n:\r\n        res = res.add(num)\r\n        i += 1\r\n    print(res)\r\n\r\ncdef cythfun2():\r\n    # cdef int i, n\r\n    cdef Num num, res\r\n    i = 0\r\n    n = 10000000\r\n    num = Num(1)\r\n    res = Num(0)\r\n    while i < n:\r\n        res = res.add2(num)\r\n        i += 1\r\n    print(res)\r\n\r\ncdef cythop():\r\n    # cdef int i, n\r\n    cdef Num num, res\r\n    i = 0\r\n    n = 10000000\r\n    num = Num(1)\r\n    res = Num(0)\r\n    while i < n:\r\n        res += num\r\n        i += 1\r\n    print(res)\r\n\r\ncdef cythpy():\r\n    # cdef int i, n, num, res\r\n    cdef int num, res\r\n    i = 0\r\n    n = 10000000\r\n    num = 1\r\n    res = 0\r\n    while i < n:\r\n        res += num\r\n        i += 1\r\n    print(res)\r\n\r\ndef rawpy():\r\n    i = 0\r\n    n = 10000000\r\n    num = 1\r\n    res = 0\r\n    while i < n:\r\n        res += num\r\n        i += 1\r\n    print(res)\r\n\r\nt = time.time()\r\ncythfun()\r\nprint(f\"cythfun: {time.time() - t}\")\r\n\r\nt = time.time()\r\ncythfun2()\r\nprint(f\"cythfun2: {time.time() - t}\")\r\n\r\nt = time.time()\r\ncythop()\r\nprint(f\"cythop: {time.time() - t}\")\r\n\r\nt = time.time()\r\ncythpy()\r\nprint(f\"cythpy: {time.time() - t}\")\r\n\r\nt = time.time()\r\nrawpy()\r\nprint(f\"rawpy: {time.time() - t}\")\r\n\r\n\"\"\"\r\n10000000\r\ncythfun: 0.7377910614013672\r\n10000000\r\ncythfun2: 0.3947124481201172\r\n10000000\r\ncythop: 0.7799794673919678\r\n10000000\r\ncythpy: 0.26244568824768066\r\n10000000\r\nrawpy: 0.39959073066711426\r\n\"\"\"\r\n```\r\n\r\nThe Cython version with a cython class fails to even do better than the pure unannotated version.\r\n\r\nIn C++ on the other hand:\r\n```\r\n#include <bits/stdc++.h>\r\nusing namespace std;\r\n\r\nclass Num {\r\npublic:\r\n    int n;\r\n    Num (int n) : n(n) {}\r\n    Num operator+(const Num &oth) {\r\n        return Num(n + oth.n);\r\n    }\r\n    Num & operator+=(const Num &oth) {\r\n        n += oth.n;\r\n        return *this;\r\n    }\r\n};\r\n\r\nvoid fun1() {\r\n    volatile int i = 0;\r\n    volatile int n = 10000000;\r\n    Num num = 1;\r\n    Num res = 0;\r\n    while (i < n) {\r\n        /* res = res + num; */ // equivalent code / time.\r\n        res += num;\r\n        ++i;\r\n    }\r\n    printf(\"%d\\n\", res.n);\r\n}\r\n\r\nvoid fun2() {\r\n    volatile int i = 0;\r\n    volatile int n = 10000000;\r\n    int num = 1;\r\n    int res = 0;\r\n    while (i < n) {\r\n        res += num;\r\n        ++i;\r\n    }\r\n    printf(\"%d\\n\", i);\r\n}\r\n\r\nint main(){\r\n    {\r\n        auto start = chrono::steady_clock::now();\r\n        fun1();\r\n        auto stop = chrono::steady_clock::now();\r\n        auto diff = stop - start;\r\n        printf(\"fun1: %f\\n\", chrono::duration <double, milli> (diff).count());\r\n    }\r\n    {\r\n        auto start = chrono::steady_clock::now();\r\n        fun2();\r\n        auto stop = chrono::steady_clock::now();\r\n        auto diff = stop - start;\r\n        printf(\"fun2: %f\\n\", chrono::duration <double, milli> (diff).count());\r\n    }\r\n/*\r\n10000000\r\nfun1: 22.503149\r\n10000000\r\nfun2: 22.042093\r\n*/\r\n}\r\n```\r\nAs seen in https://godbolt.org/z/zv85EMPdv the code for fun1 and fun2 is equivalent.\r\n\r\nDue to this issue, Cython code that uses simple classes (e.g. for a fixed precision Decimal, or some pair) is inefficient compared to it's potential, or C equivalent code.\r\n\r\n**Expected behaviour**\r\nRunning time of `cythop` and `cythpy` should be the same.\r\n\r\n**Environment**\r\n - Linux 5.15.10\r\n - Python 3.10.1\r\n - Cython 0.29.26\r\n",
    "closed_at": "2021-12-28T21:11:21Z",
    "comment_data": [
        {
            "author_association": "COLLABORATOR",
            "body": "* It's possible that Cython actually does reasonably well at inferring the types for rawpy (I haven't looked at the generated code), so it may not be as \"raw\" as you think.\r\n* `cythop` would probably do notably better if you defined `__iadd__` (it'd avoid memory allocations)\r\n* You might gain something by using `@cython.freelist(8)` on the class (8 is arbitrary though, but probably a sensible number) - it'll remove some memory allocation, and is ideal for these short-lived instances.\r\n\r\nI'm not quite sure what you expect here... A `cdef class` is a Python class so _does_ need reference counting, and _does_ need allocating. It's never going to beat just using C integers directly.\r\n\r\nI guess in principle Cython could spot that the instance can never be returned and allocate it on the heap and skip the reference counting. But that's quite hard to prove - it probably involves inspecting into member functions for example. And it'd need to know that `print` doesn't keep a reference too.\r\n\r\nI'll close this as \"wontfix\" because I'm not sure what we can do (but obviously concrete suggestions are welcome!). You might look at defining `cppclass` instead?",
            "created_at": "2021-12-28T21:11:21Z",
            "html_url": "https://github.com/cython/cython/issues/4543#issuecomment-1002283498",
            "id": 1002283498,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4543",
            "node_id": "IC_kwDOABDGAc47vaHq",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1002283498/reactions"
            },
            "updated_at": "2021-12-28T21:11:21Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1002283498",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            }
        },
        {
            "author_association": "NONE",
            "body": "@da-woods \r\nMakes sense. Thanks for the suggestions, they helped. (esp. `cppclass`, which was what I was after)",
            "created_at": "2021-12-29T18:43:45Z",
            "html_url": "https://github.com/cython/cython/issues/4543#issuecomment-1002730031",
            "id": 1002730031,
            "issue_url": "https://api.github.com/repos/cython/cython/issues/4543",
            "node_id": "IC_kwDOABDGAc47xHIv",
            "performed_via_github_app": null,
            "reactions": {
                "+1": 0,
                "-1": 0,
                "confused": 0,
                "eyes": 0,
                "heart": 0,
                "hooray": 0,
                "laugh": 0,
                "rocket": 0,
                "total_count": 0,
                "url": "https://api.github.com/repos/cython/cython/issues/comments/1002730031/reactions"
            },
            "updated_at": "2021-12-29T18:43:45Z",
            "url": "https://api.github.com/repos/cython/cython/issues/comments/1002730031",
            "user": {
                "avatar_url": "https://avatars.githubusercontent.com/u/12627588?v=4",
                "events_url": "https://api.github.com/users/L1nkus/events{/privacy}",
                "followers_url": "https://api.github.com/users/L1nkus/followers",
                "following_url": "https://api.github.com/users/L1nkus/following{/other_user}",
                "gists_url": "https://api.github.com/users/L1nkus/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/L1nkus",
                "id": 12627588,
                "login": "L1nkus",
                "node_id": "MDQ6VXNlcjEyNjI3NTg4",
                "organizations_url": "https://api.github.com/users/L1nkus/orgs",
                "received_events_url": "https://api.github.com/users/L1nkus/received_events",
                "repos_url": "https://api.github.com/users/L1nkus/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/L1nkus/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/L1nkus/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/L1nkus"
            }
        }
    ],
    "comments": 2,
    "comments_url": "https://api.github.com/repos/cython/cython/issues/4543/comments",
    "created_at": "2021-12-28T20:29:46Z",
    "event_data": [
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-12-28T21:11:21Z",
            "event": "closed",
            "id": 5822663212,
            "node_id": "CE_lADOABDGAc5A-dDNzwAAAAFbDsos",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5822663212"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-12-28T21:11:33Z",
            "event": "labeled",
            "id": 5822663641,
            "label": {
                "color": "444444",
                "name": "R: wontfix"
            },
            "node_id": "LE_lADOABDGAc5A-dDNzwAAAAFbDsvZ",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5822663641"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-12-29T18:43:45Z",
            "event": "mentioned",
            "id": 5825753946,
            "node_id": "MEE_lADOABDGAc5A-dDNzwAAAAFbPfNa",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5825753946"
        },
        {
            "actor": {
                "avatar_url": "https://avatars.githubusercontent.com/u/10536947?v=4",
                "events_url": "https://api.github.com/users/da-woods/events{/privacy}",
                "followers_url": "https://api.github.com/users/da-woods/followers",
                "following_url": "https://api.github.com/users/da-woods/following{/other_user}",
                "gists_url": "https://api.github.com/users/da-woods/gists{/gist_id}",
                "gravatar_id": "",
                "html_url": "https://github.com/da-woods",
                "id": 10536947,
                "login": "da-woods",
                "node_id": "MDQ6VXNlcjEwNTM2OTQ3",
                "organizations_url": "https://api.github.com/users/da-woods/orgs",
                "received_events_url": "https://api.github.com/users/da-woods/received_events",
                "repos_url": "https://api.github.com/users/da-woods/repos",
                "site_admin": false,
                "starred_url": "https://api.github.com/users/da-woods/starred{/owner}{/repo}",
                "subscriptions_url": "https://api.github.com/users/da-woods/subscriptions",
                "type": "User",
                "url": "https://api.github.com/users/da-woods"
            },
            "commit_id": null,
            "commit_url": null,
            "created_at": "2021-12-29T18:43:45Z",
            "event": "subscribed",
            "id": 5825753947,
            "node_id": "SE_lADOABDGAc5A-dDNzwAAAAFbPfNb",
            "performed_via_github_app": null,
            "url": "https://api.github.com/repos/cython/cython/issues/events/5825753947"
        }
    ],
    "events_url": "https://api.github.com/repos/cython/cython/issues/4543/events",
    "html_url": "https://github.com/cython/cython/issues/4543",
    "id": 1090113741,
    "labels": [
        {
            "color": "444444",
            "default": false,
            "description": null,
            "id": 425557400,
            "name": "R: wontfix",
            "node_id": "MDU6TGFiZWw0MjU1NTc0MDA=",
            "url": "https://api.github.com/repos/cython/cython/labels/R:%20wontfix"
        }
    ],
    "labels_url": "https://api.github.com/repos/cython/cython/issues/4543/labels{/name}",
    "locked": false,
    "milestone": null,
    "node_id": "I_kwDOABDGAc5A-dDN",
    "number": 4543,
    "performed_via_github_app": null,
    "reactions": {
        "+1": 0,
        "-1": 0,
        "confused": 0,
        "eyes": 0,
        "heart": 0,
        "hooray": 0,
        "laugh": 0,
        "rocket": 0,
        "total_count": 0,
        "url": "https://api.github.com/repos/cython/cython/issues/4543/reactions"
    },
    "repository_url": "https://api.github.com/repos/cython/cython",
    "state": "closed",
    "timeline_url": "https://api.github.com/repos/cython/cython/issues/4543/timeline",
    "title": "Cython doesn't properly optimize cython classes used in cython only code",
    "updated_at": "2021-12-29T18:43:45Z",
    "url": "https://api.github.com/repos/cython/cython/issues/4543",
    "user": {
        "avatar_url": "https://avatars.githubusercontent.com/u/12627588?v=4",
        "events_url": "https://api.github.com/users/L1nkus/events{/privacy}",
        "followers_url": "https://api.github.com/users/L1nkus/followers",
        "following_url": "https://api.github.com/users/L1nkus/following{/other_user}",
        "gists_url": "https://api.github.com/users/L1nkus/gists{/gist_id}",
        "gravatar_id": "",
        "html_url": "https://github.com/L1nkus",
        "id": 12627588,
        "login": "L1nkus",
        "node_id": "MDQ6VXNlcjEyNjI3NTg4",
        "organizations_url": "https://api.github.com/users/L1nkus/orgs",
        "received_events_url": "https://api.github.com/users/L1nkus/received_events",
        "repos_url": "https://api.github.com/users/L1nkus/repos",
        "site_admin": false,
        "starred_url": "https://api.github.com/users/L1nkus/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/L1nkus/subscriptions",
        "type": "User",
        "url": "https://api.github.com/users/L1nkus"
    }
}